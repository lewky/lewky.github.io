<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>ELK系列(1) - Elasticsearch + Logstash + Kibana + Log4j2快速入门与搭建用例 - Yulin Lewis' Blog</title><meta name=keywords content="雨临Lewis,Java,hugo,hexo,博客"><meta name=Description content="不想当写手的码农不是好咸鱼_(xз」∠)_"><meta property="og:title" content="ELK系列(1) - Elasticsearch + Logstash + Kibana + Log4j2快速入门与搭建用例"><meta property="og:description" content="前言
最近公司分了个ELK相关的任务给我，在一边学习一边工作之余，总结下这些天来的学习历程和踩坑记录。
首先介绍下使用ELK的项目背景：在项目的数据库里有个表用来存储消息队列的消费日志，这些日志用于开发者日后的维护。每当客户端生产一条消息并发送到消息队列后，就会插入一条对应的记录到数据库里。当这条消息被消费之后，又会更新数据库里对应的记录的几个column的值，比如status、updated_on这些常用的column。
由于客户每天生产消费的消息很多，导致数据库里的这个表里的数据很多，长年累月下来，会达到数以亿计。领导决定不再把这些消费日志保存到数据库，而是改为通过Log4j2 + ELK架构把这些日志保存到Elasticsearch里。
ELK简介
ELk是Elasticsearch + Logstash + Kibana的缩写，ELK一般用来收集分布式架构下各个节点的日志，并进行统一地管理。"><meta property="og:type" content="article"><meta property="og:url" content="https://lewky.cn/posts/65db1615.html/"><meta property="og:image" content="https://lewky.cn/logo.png"><meta property="article:published_time" content="2019-05-11T21:14:33+08:00"><meta property="article:modified_time" content="2019-05-11T21:14:33+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://lewky.cn/logo.png"><meta name=twitter:title content="ELK系列(1) - Elasticsearch + Logstash + Kibana + Log4j2快速入门与搭建用例"><meta name=twitter:description content="前言
最近公司分了个ELK相关的任务给我，在一边学习一边工作之余，总结下这些天来的学习历程和踩坑记录。
首先介绍下使用ELK的项目背景：在项目的数据库里有个表用来存储消息队列的消费日志，这些日志用于开发者日后的维护。每当客户端生产一条消息并发送到消息队列后，就会插入一条对应的记录到数据库里。当这条消息被消费之后，又会更新数据库里对应的记录的几个column的值，比如status、updated_on这些常用的column。
由于客户每天生产消费的消息很多，导致数据库里的这个表里的数据很多，长年累月下来，会达到数以亿计。领导决定不再把这些消费日志保存到数据库，而是改为通过Log4j2 + ELK架构把这些日志保存到Elasticsearch里。
ELK简介
ELk是Elasticsearch + Logstash + Kibana的缩写，ELK一般用来收集分布式架构下各个节点的日志，并进行统一地管理。"><meta name=application-name content="雨临Lewis的博客"><meta name=apple-mobile-web-app-title content="雨临Lewis的博客"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://lewky.cn/posts/65db1615.html/><link rel=prev href=https://lewky.cn/posts/a34ffc44.html/><link rel=next href=https://lewky.cn/posts/c85bbf4e.html/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"ELK系列(1) - Elasticsearch + Logstash + Kibana + Log4j2快速入门与搭建用例","inLanguage":"","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/lewky.cn\/posts\/65db1615.html\/"},"genre":"posts","keywords":"ELK系列, Elasticsearch, Logstash, Kibana","wordcount":4690,"url":"https:\/\/lewky.cn\/posts\/65db1615.html\/","datePublished":"2019-05-11T21:14:33+08:00","dateModified":"2019-05-11T21:14:33+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"雨临Lewis","logo":"https:\/\/lewky.cn\/images\/avatar.jpg"},"author":{"@type":"Person","name":"雨临Lewis"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><a href=https://github.com/lewky class=github-corner target=_blank title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="3.5rem" height="3.5rem" viewBox="0 0 250 250" style="fill:#70b7fd;color:#fff;position:absolute;top:0;border:0;left:0;transform:scale(-1,1)" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div class=header-title><a href=/ title="Yulin Lewis' Blog"><span class=header-title-pre><i class="fas fa-fw fa-atom"></i></span>雨临Lewis</a></div><div class=menu><div class=menu-inner><div class=dropdown><a href=/posts/ class="menu-item menu-more dropbtn" title=点击查看所有文章><i class="fas fa-fw fa-archive"></i>归档</a><div class="menu-more-content dropdown-content"><a href=/categories/><i class="fas fa-fw fa-th"></i>分类 </a><a href=/tags/><i class="fas fa-fw fa-tag"></i>标签 </a><a href=/hot/ title=文章热度Top15><i class="fas fa-fw fa-fire"></i>热度 </a><a href=/posts/d65a1577.html/ title=密码是123><i class="fas fa-fw fa-pen-nib"></i>随笔 </a><a href=/about/><i class="fas fa-fw fa-at"></i>关于</a></div></div><a class=menu-item href=/friends/ title=欢迎申请友链><i class="fas fa-fw fa-link"></i>友链</a><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn" title=一些有意思的东东~><i class="fas fa-fw fa-fan fa-spin"></i>趣味</a><div class="menu-more-content dropdown-content"><a href=/funny/high/ title="前方高能♂ 小心外放！" target=_blank rel=noopener><i class="fas fa-fw fa-dizzy"></i>燥起来！ </a><a href=/funny/mikutap/ title=初音未来音乐游戏 target=_blank rel=noopener><i class="fas fa-fw fa-music"></i>在线打碟 </a><a href=/funny/catch-the-cat/ title=逮住那只猫!><i class="fas fa-fw fa-cat"></i>抓住猫咪</a></div></div><div class=dropdown><a href=/ class="menu-item menu-more dropbtn" title=回到首页><i class="fas fa-fw fa-atom"></i>站点</a><div class="menu-more-content dropdown-content"><a href=/bbs/ title=来留言吧~><i class="fas fa-fw fa-comment"></i>公告留言 </a><a href=https://seo.chinaz.com target=_blank rel=noopener><i class="fas fa-fw fa-chart-line"></i>SEO查询 </a><a href=https://www.ping.cn/http/lewky.cn target=_blank rel=noopener><i class="fas fa-fw fa-bezier-curve"></i>网站测速 </a><a href=/posts/e62c38c4.html/><i class="fas fa-fw fa-cog fa-spin"></i>建站日志</a></div></div><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn"><i class="fas fa-fw fa-book"></i>文档</a><div class="menu-more-content dropdown-content"><a href=https://gohugo.io/documentation/ target=_blank rel=noopener><i class="fas fa-fw fa-star"></i>Hugo文档 </a><a href=https://javanote.doc.lewky.cn/ title=尚在完善中~ target=_blank rel=noopener><i class="fab fa-fw fa-java"></i>Java 笔记</a></div></div><a class=menu-item href=/search/ title=渲染搜索结果需要等待几秒钟~><i class="fas fa-fw fa-search"></i>搜索
</a><span class="menu-item delimiter"></span><a href=https://travellings.link target=_blank class=menu-item rel=noopener title=开往-友链接力><i class="fas fa-fw fa-subway"></i></a><a href=https://rssblog.vercel.app/ class=menu-item target=_blank rel=noopener title=RSSBlog><i class="fas fa-fw fa-inbox"></i></a><a href=https://github.com/lewky class=menu-item target=_blank rel=noopener title=GitHub><i class="fab fa-fw fa-github"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Yulin Lewis' Blog"><span class=header-title-pre><i class="fas fa-fw fa-atom"></i></span>雨临Lewis</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=dropdown><a href=/posts/ class="menu-item menu-more dropbtn" title=点击查看所有文章><i class="fas fa-fw fa-archive"></i>归档</a><div class="menu-more-content dropdown-content"><a href=/categories/><i class="fas fa-fw fa-th"></i>分类 </a><a href=/tags/><i class="fas fa-fw fa-tag"></i>标签 </a><a href=/hot/ title=文章热度Top15><i class="fas fa-fw fa-fire"></i>热度 </a><a href=/posts/d65a1577.html/ title=密码是123><i class="fas fa-fw fa-pen-nib"></i>随笔 </a><a href=/about/><i class="fas fa-fw fa-at"></i>关于</a></div></div><a class=menu-item href=/friends/ title=欢迎申请友链><i class="fas fa-fw fa-link"></i>友链</a><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn" title=一些有意思的东东~><i class="fas fa-fw fa-fan fa-spin"></i>趣味</a><div class="menu-more-content dropdown-content"><a href=/funny/high/ title="前方高能♂ 小心外放！" target=_blank rel=noopener><i class="fas fa-fw fa-dizzy"></i>燥起来！ </a><a href=/funny/mikutap/ title=初音未来音乐游戏 target=_blank rel=noopener><i class="fas fa-fw fa-music"></i>在线打碟 </a><a href=/funny/catch-the-cat/ title=逮住那只猫!><i class="fas fa-fw fa-cat"></i>抓住猫咪</a></div></div><div class=dropdown><a href=/ class="menu-item menu-more dropbtn" title=回到首页><i class="fas fa-fw fa-atom"></i>站点</a><div class="menu-more-content dropdown-content"><a href=/bbs/ title=来留言吧~><i class="fas fa-fw fa-comment"></i>公告留言 </a><a href=https://seo.chinaz.com target=_blank rel=noopener><i class="fas fa-fw fa-chart-line"></i>SEO查询 </a><a href=https://www.ping.cn/http/lewky.cn target=_blank rel=noopener><i class="fas fa-fw fa-bezier-curve"></i>网站测速 </a><a href=/posts/e62c38c4.html/><i class="fas fa-fw fa-cog fa-spin"></i>建站日志</a></div></div><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn"><i class="fas fa-fw fa-book"></i>文档</a><div class="menu-more-content dropdown-content"><a href=https://gohugo.io/documentation/ target=_blank rel=noopener><i class="fas fa-fw fa-star"></i>Hugo文档 </a><a href=https://javanote.doc.lewky.cn/ title=尚在完善中~ target=_blank rel=noopener><i class="fab fa-fw fa-java"></i>Java 笔记</a></div></div><a class=menu-item href=/search/ title=渲染搜索结果需要等待几秒钟~><i class="fas fa-fw fa-search"></i>搜索</a>
<a href=https://travellings.link target=_blank class=menu-item rel=noopener title=开往-友链接力><i class="fas fa-fw fa-subway"></i></a><a href=https://rssblog.vercel.app/ class=menu-item target=_blank rel=noopener title=RSSBlog><i class="fas fa-fw fa-inbox"></i></a><a href=https://github.com/lewky class=menu-item target=_blank rel=noopener title=GitHub><i class="fab fa-fw fa-github"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">ELK系列(1) - Elasticsearch + Logstash + Kibana + Log4j2快速入门与搭建用例</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>雨临Lewis</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/elk/><i class="far fa-folder fa-fw"></i>ELK</a></span></div><div class=post-meta-line><i class="far fa-calendar fa-fw"></i>&nbsp;<time datetime=2019-05-11>2019-05-11</time>&nbsp;<i class="far fa-calendar-plus fa-fw"></i>&nbsp;<time datetime=2019-05-11>2019-05-11</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 4690 字
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 10 分钟&nbsp;<span id=/posts/65db1615.html/ class=leancloud_visitors data-flag-title="ELK系列(1) - Elasticsearch + Logstash + Kibana + Log4j2快速入门与搭建用例">
<i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
</span>&nbsp;
<a href=#comments id=post-meta-vcount title=查看评论><i class="fas fa-comment fa-fw"></i>&nbsp;<span id=/posts/65db1615.html/ class=waline-comment-count></span>&nbsp;条评论</a></div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ol><li><a href=#前言>前言</a></li><li><a href=#elk简介>ELK简介</a></li><li><a href=#elk的下载安装与快速入门>ELK的下载安装与快速入门</a><ol><li><a href=#elasticsearch-642>Elasticsearch 6.4.2</a></li><li><a href=#logstash-642>Logstash 6.4.2</a></li><li><a href=#kibana-642>Kibana 6.4.2</a></li></ol></li><li><a href=#logstash--log4j2的快速搭建用例其一>Logstash + Log4j2的快速搭建用例其一</a><ol><li><a href=#配置tcp插件并启动logstash>配置tcp插件并启动Logstash</a></li><li><a href=#使用了socket-appender的log4j2项目demo>使用了Socket Appender的Log4j2项目demo</a></li><li><a href=#注意>注意</a></li></ol></li><li><a href=#logstash--log4j2的快速搭建用例其二>Logstash + Log4j2的快速搭建用例其二</a><ol><li><a href=#配置gelf插件并启动logstash>配置gelf插件并启动Logstash</a></li><li><a href=#在log4j2项目中使用gelf-appender>在Log4j2项目中使用Gelf Appender</a></li></ol></li><li><a href=#elk--log4j2快速搭建用例>ELK + Log4j2快速搭建用例</a><ol><li><a href=#logstash配置elasticsearch插件>Logstash配置Elasticsearch插件</a></li><li><a href=#修改log4j2xml和项目代码>修改log4j2.xml和项目代码</a></li><li><a href=#配置kibana查看elasticsearch的index数据>配置Kibana查看Elasticsearch的index数据</a></li></ol></li><li><a href=#参考链接>参考链接</a></li></ol></nav></div></div><div class=content id=content><h2 id=前言>前言</h2><p>最近公司分了个ELK相关的任务给我，在一边学习一边工作之余，总结下这些天来的学习历程和踩坑记录。</p><p>首先介绍下使用ELK的项目背景：在项目的数据库里有个表用来存储消息队列的消费日志，这些日志用于开发者日后的维护。每当客户端生产一条消息并发送到消息队列后，就会插入一条对应的记录到数据库里。当这条消息被消费之后，又会更新数据库里对应的记录的几个column的值，比如status、updated_on这些常用的column。</p><p>由于客户每天生产消费的消息很多，导致数据库里的这个表里的数据很多，长年累月下来，会达到数以亿计。领导决定不再把这些消费日志保存到数据库，而是改为通过Log4j2 + ELK架构把这些日志保存到Elasticsearch里。</p><h2 id=elk简介>ELK简介</h2><p>ELk是<code>Elasticsearch + Logstash + Kibana</code>的缩写，ELK一般用来收集分布式架构下各个节点的日志，并进行统一地管理。</p><p>Elasticsearch是个开源分布式搜索引擎，提供搜集、分析、存储数据三大功能。它的特点有：分布式，零配置，自动发现，索引自动分片，索引副本机制，restful风格接口，多数据源，自动搜索负载等。</p><p>Logstash主要是用来日志的搜集、分析、过滤日志的工具，支持大量的数据获取方式。一般工作方式为c/s架构，client端安装在需要收集日志的主机上，server端负责将收到的各节点日志进行过滤、修改等操作在一并发往elasticsearch上去。</p><p>Kibana也是一个开源和免费的工具，Kibana可以为Logstash和ElasticSearch提供的日志分析友好的Web界面，可以帮助汇总、分析和搜索重要数据日志。</p><p>上面的官方介绍可能会比较抽象，按我个人的理解，可以简单将ELK理解为一个MVC架构的Java web应用：Elasticsearch对应M，Logstash对应C，Kibana对应V。</p><p>由于项目使用的是6.4.2版本的Elasticsearch，所以整个ELK都采用了同样的版本6.4.2。这三个软件都可以直接从官网下载到，下面是官网地址。</p><p>→ <a href=https://www.elastic.co/downloads/past-releases target=_blank rel="noopener noreffer">官方下载地址</a></p><h2 id=elk的下载安装与快速入门>ELK的下载安装与快速入门</h2><p>本文只是基于Windows平台下，进行简单的快速入门，先搭建好ELK框架并测试通过，后续文章再记录更多的细节。</p><h3 id=elasticsearch-642>Elasticsearch 6.4.2</h3><p>从官网下载了6.4.2版本的Elasticsearch的压缩版后，解压即可使用，使用默认的配置即可。</p><p>在Elasticsearch的安装目录下，进入<code>/bin</code>目录，可以看到有两个文件：</p><ol><li>elaticsearch</li><li>elaticsearch.bat</li></ol><p>这两个文件都可以启动Elasticsearch，暂时没发现在Windows平台下通过这两个文件启动Elasticsearch有什么不同。我一般使用没有后缀名的那个文件来启动Elasticsearch。</p><p>启动成功后，在浏览器输入<code>127.0.0.1:9200</code>，如果访问成功会反馈信息：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>{
  &#34;name&#34; : &#34;erwbgE5&#34;,
  &#34;cluster_name&#34; : &#34;elasticsearch&#34;,
  &#34;cluster_uuid&#34; : &#34;QQvV3hBnSCSGsf-ycD3fng&#34;,
  &#34;version&#34; : {
    &#34;number&#34; : &#34;6.4.2&#34;,
    &#34;build_flavor&#34; : &#34;default&#34;,
    &#34;build_type&#34; : &#34;zip&#34;,
    &#34;build_hash&#34; : &#34;04711c2&#34;,
    &#34;build_date&#34; : &#34;2018-09-26T13:34:09.098244Z&#34;,
    &#34;build_snapshot&#34; : false,
    &#34;lucene_version&#34; : &#34;7.4.0&#34;,
    &#34;minimum_wire_compatibility_version&#34; : &#34;5.6.0&#34;,
    &#34;minimum_index_compatibility_version&#34; : &#34;5.0.0&#34;
  },
  &#34;tagline&#34; : &#34;You Know, for Search&#34;
}
</code></pre></td></tr></table></div></div><p><strong>注意，如果使用Elasticsearch5.X及以上的版本，需要使用jdk 1.8；5.X以下版本使用jdk 1.6或1.7。</strong></p><h3 id=logstash-642>Logstash 6.4.2</h3><p>同样从官网下载6.4.2版本的Logstash安装包，解压之后进入<code>/config</code>目录，创建一个配置文件<code>tcp.conf</code>，内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>input {
    stdin {
    }
}
filter {
}
output {
    stdout {
        codec =&gt; rubydebug
    }
}
</code></pre></td></tr></table></div></div><p>接着进入<code>/bin</code>目录，运行命令如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bat data-lang=bat>logstash -f ../config/test.conf
</code></pre></td></tr></table></div></div><p>当看到<code>Successfully started Logstash API endpoint</code>的字眼时表示启动成功，此时输入任意字符，比如输入<code>hello</code>，可以得到相应的反馈，如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>{
       &#34;message&#34; =&gt; &#34;hello\r&#34;,
    &#34;@timestamp&#34; =&gt; 2019-05-09T14:48:04.033Z,
          &#34;host&#34; =&gt; &#34;DESKTOP-S7HJJKD&#34;,
      &#34;@version&#34; =&gt; &#34;1&#34;
}
</code></pre></td></tr></table></div></div><p>这里解释下，Logstash的配置非常简单，就是一套流程：<code>input -> filter -> output</code>。</p><p>input用来收集信息，这里配置的是<code>stdin</code>插件，即标准输入，也就是刚刚在控制台里输入的字符串。
filter表示过滤信息，这里没有进行任何过滤。
output表示输出信息，这里配置的是<code>stdout</code>插件，即标准输出，也就是将信息输出到控制台上。这里的<code>codec</code>指明使用<code>rubydebug</code>作为编解码器。</p><p>接着是运行的命令，使用了<code>-f</code>参数来指定使用某个配置文件。如果想要热加载的效果，可以加上<code>-r</code>参数，这样就可以在运行Logstash的时候去修改配置文件并自动重加载生效。这个<code>-r</code>参数等同于<code>--config.reload.automatic</code>。如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-bat data-lang=bat>logstash -f ../config/test.conf -r
logstash -f ../config/test.conf --config.reload.automatic
</code></pre></td></tr></table></div></div><p><strong>注意，如果在输入源里使用了<code>stdin</code>或者<code>syslog</code>等输入插件，是不支持热加载的，会一直报错。</strong></p><h3 id=kibana-642>Kibana 6.4.2</h3><p>从官网上下载Kibana6.4.2的压缩包，解压后即可使用。接着进入<code>/bin</code>目录，运行<code>kibana.bat</code>。运行成功后，在浏览器输入<code>localhost:5601</code>，即可访问Kibana的页面，之后就可以通过这个Kibana提供的web界面来对Elasticsearch里的文档进行各种操作。</p><h2 id=logstash--log4j2的快速搭建用例其一>Logstash + Log4j2的快速搭建用例其一</h2><h3 id=配置tcp插件并启动logstash>配置tcp插件并启动Logstash</h3><p>修改之前创建的Logstash的配置文件<code>test.config</code>，内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>input {
    tcp {
        mode =&gt; &#34;server&#34;
        host =&gt; &#34;127.0.0.1&#34;
        port =&gt; 4567
    }
}
filter {
}
output {
    stdout {
        codec =&gt; rubydebug
    }
}
</code></pre></td></tr></table></div></div><p>然后运行命令<code>logstash -f ../config/test.conf -r</code>来启动Logstash。由于我们这里通过<code>-r</code>来启用了热加载功能，所以可以在运行中直接修改配置并生效，比如修改input里的port。热加载成功后会看到如下字眼：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>Reloading pipeline {&#34;pipeline.id&#34;=&gt;:main}
</code></pre></td></tr></table></div></div><h3 id=使用了socket-appender的log4j2项目demo>使用了Socket Appender的Log4j2项目demo</h3><p>接着准备一个使用了Log4j2的项目demo，如下是一个测试类<code>Test.java</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=kn>import</span> <span class=nn>org.apache.logging.log4j.LogManager</span><span class=o>;</span>
<span class=kn>import</span> <span class=nn>org.apache.logging.log4j.Logger</span><span class=o>;</span>

<span class=kd>public</span> <span class=kd>class</span> <span class=nc>Test</span> <span class=o>{</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Logger</span> <span class=n>LOGGER</span> <span class=o>=</span> <span class=n>LogManager</span><span class=o>.</span><span class=na>getLogger</span><span class=o>(</span><span class=s>&#34;elk.test&#34;</span><span class=o>);</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=kd>final</span> <span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>LOGGER</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;Hello world!&#34;</span><span class=o>);</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table></div></div><p>这里使用的是2.11.1版本的Log4j2，Maven依赖如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>&lt;dependency&gt;
	&lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;
	&lt;artifactId&gt;log4j-core&lt;/artifactId&gt;
	&lt;version&gt;2.11.1&lt;/version&gt;
&lt;/dependency&gt;
</code></pre></td></tr></table></div></div><p>接着是配置Log4j2的配置文件<code>log4j2.xml</code>，如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;
&lt;configuration xmlns:xi=&#34;http://www.w3.org/2001/XInclude&#34; monitorInterval=&#34;30&#34;&gt;

    &lt;Properties&gt;
        &lt;Property name=&#34;LOG_PATTERN&#34;&gt;{&#34;logger&#34;: &#34;%logger&#34;, &#34;level&#34;: &#34;%level&#34;, &#34;msg&#34;: &#34;%message&#34;}%n&lt;/Property&gt;
    &lt;/Properties&gt;

	&lt;Appenders&gt;
        &lt;Console name=&#34;stdout&#34; target=&#34;SYSTEM_OUT&#34;&gt;
            &lt;PatternLayout pattern=&#34;${LOG_PATTERN}&#34; /&gt;
        &lt;/Console&gt;

        &lt;Socket name=&#34;logstash-tcp&#34; host=&#34;127.0.0.1&#34; port=&#34;4567&#34; protocol=&#34;TCP&#34;&gt;
            &lt;PatternLayout pattern=&#34;${LOG_PATTERN}&#34;/&gt;
        &lt;/Socket&gt;
	&lt;/Appenders&gt;

	&lt;Loggers&gt;
		&lt;Logger name=&#34;elk.test&#34; level=&#34;info&#34; additivity=&#34;false&#34;&gt;
            &lt;AppenderRef ref=&#34;stdout&#34; /&gt;
            &lt;AppenderRef ref=&#34;logstash-tcp&#34; /&gt;
		&lt;/Logger&gt;
		&lt;Root level=&#34;error&#34;&gt;
			&lt;AppenderRef ref=&#34;stdout&#34; /&gt;
		&lt;/Root&gt;
	&lt;/Loggers&gt;

&lt;/configuration&gt;
</code></pre></td></tr></table></div></div><p>从配置文件中可以看到，这里使用的是Socket Appender来将日志打印的信息发送到Logstash。</p><p><strong>注意了，Socket的Appender必须要配置到下面的Logger才能将日志输出到Logstash里！</strong></p><p>另外这里的host是部署了Logstash服务端的地址，并且端口号要和你在Logstash里配置的一致才行。</p><p>运行该项目demo，可以看到Logstash的控制台收集到了数据，如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>{
          &#34;host&#34; =&gt; &#34;127.0.0.1&#34;,
       &#34;message&#34; =&gt; &#34;{\&#34;logger\&#34;: \&#34;elk.test\&#34;, \&#34;level\&#34;: \&#34;INFO\&#34;, \&#34;msg\&#34;: \&#34;Hello world!\&#34;}\r&#34;,
    &#34;@timestamp&#34; =&gt; 2019-05-09T16:20:35.940Z,
      &#34;@version&#34; =&gt; &#34;1&#34;,
          &#34;port&#34; =&gt; 49781
}
</code></pre></td></tr></table></div></div><h3 id=注意>注意</h3><p>这里由于使用的是Socket方式来连接Logstash的服务端，如果在连接期间，Logstash的服务停止了或者断掉了，就算接下来重启了Logstash，项目工程也无法自动重新连接上Logstash，除非重启项目工程。</p><p>在生产环境中，Logstash自然是有可能半路出问题重启的，所以不能使用这种Socket方式来传输日志。</p><p>可以使用gelf的方式来传输日志到Logstash，用例如下所示。</p><h2 id=logstash--log4j2的快速搭建用例其二>Logstash + Log4j2的快速搭建用例其二</h2><h3 id=配置gelf插件并启动logstash>配置gelf插件并启动Logstash</h3><p>修改之前创建的Logstash的配置文件<code>test.config</code>，内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>input {
    gelf {
        host =&gt; &#34;127.0.0.1&#34;
        port =&gt; 4567
		use_tcp =&gt; true
    }
}
filter {
}
output {
    stdout {
        codec =&gt; rubydebug
    }
}
</code></pre></td></tr></table></div></div><p>运行命令<code>logstash -f ../config/test.conf -r</code>启动Logstash。</p><h3 id=在log4j2项目中使用gelf-appender>在Log4j2项目中使用Gelf Appender</h3><p>将之前的项目工程里的log4j2.xml的Socket Appender改为使用Gelf Appender，如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-xml data-lang=xml><span class=cp>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
<span class=nt>&lt;configuration</span> <span class=na>xmlns:xi=</span><span class=s>&#34;http://www.w3.org/2001/XInclude&#34;</span> <span class=na>monitorInterval=</span><span class=s>&#34;30&#34;</span><span class=nt>&gt;</span>

    <span class=nt>&lt;Properties&gt;</span>
        <span class=nt>&lt;Property</span> <span class=na>name=</span><span class=s>&#34;LOG_PATTERN&#34;</span><span class=nt>&gt;</span>{&#34;logger&#34;: &#34;%logger&#34;, &#34;level&#34;: &#34;%level&#34;, &#34;msg&#34;: &#34;%message&#34;}%n<span class=nt>&lt;/Property&gt;</span>
    <span class=nt>&lt;/Properties&gt;</span>

	<span class=nt>&lt;Appenders&gt;</span>
        <span class=nt>&lt;Console</span> <span class=na>name=</span><span class=s>&#34;stdout&#34;</span> <span class=na>target=</span><span class=s>&#34;SYSTEM_OUT&#34;</span><span class=nt>&gt;</span>
            <span class=nt>&lt;PatternLayout</span> <span class=na>pattern=</span><span class=s>&#34;${LOG_PATTERN}&#34;</span> <span class=nt>/&gt;</span>
        <span class=nt>&lt;/Console&gt;</span>

        <span class=nt>&lt;Gelf</span> <span class=na>name=</span><span class=s>&#34;logstash-gelf&#34;</span> <span class=na>host=</span><span class=s>&#34;tcp:localhost&#34;</span> <span class=na>port=</span><span class=s>&#34;4567&#34;</span> <span class=na>version=</span><span class=s>&#34;1.1&#34;</span> <span class=na>ignoreExceptions=</span><span class=s>&#34;true&#34;</span>
             <span class=na>extractStackTrace=</span><span class=s>&#34;true&#34;</span> <span class=na>filterStackTrace=</span><span class=s>&#34;false&#34;</span><span class=nt>&gt;</span>
            <span class=nt>&lt;Field</span> <span class=na>name=</span><span class=s>&#34;timestamp&#34;</span> <span class=na>pattern=</span><span class=s>&#34;%d{yyyy-MM-dd&#39;T&#39;HH:mm:ss.SSSZ}&#34;</span> <span class=nt>/&gt;</span>
            <span class=nt>&lt;Field</span> <span class=na>name=</span><span class=s>&#34;level&#34;</span> <span class=na>pattern=</span><span class=s>&#34;%level&#34;</span> <span class=nt>/&gt;</span>
            <span class=nt>&lt;Field</span> <span class=na>name=</span><span class=s>&#34;simpleClassName&#34;</span> <span class=na>pattern=</span><span class=s>&#34;%C{1}&#34;</span> <span class=nt>/&gt;</span>
            <span class=nt>&lt;Field</span> <span class=na>name=</span><span class=s>&#34;className&#34;</span> <span class=na>pattern=</span><span class=s>&#34;%C&#34;</span> <span class=nt>/&gt;</span>
            <span class=nt>&lt;Field</span> <span class=na>name=</span><span class=s>&#34;server&#34;</span> <span class=na>pattern=</span><span class=s>&#34;%host&#34;</span> <span class=nt>/&gt;</span>
        <span class=nt>&lt;/Gelf&gt;</span>
	<span class=nt>&lt;/Appenders&gt;</span>

	<span class=nt>&lt;Loggers&gt;</span>
		<span class=nt>&lt;Logger</span> <span class=na>name=</span><span class=s>&#34;elk.test&#34;</span> <span class=na>level=</span><span class=s>&#34;info&#34;</span> <span class=na>additivity=</span><span class=s>&#34;false&#34;</span><span class=nt>&gt;</span>
            <span class=nt>&lt;AppenderRef</span> <span class=na>ref=</span><span class=s>&#34;stdout&#34;</span> <span class=nt>/&gt;</span>
            <span class=nt>&lt;AppenderRef</span> <span class=na>ref=</span><span class=s>&#34;logstash-gelf&#34;</span> <span class=nt>/&gt;</span>
		<span class=nt>&lt;/Logger&gt;</span>
		<span class=nt>&lt;Root</span> <span class=na>level=</span><span class=s>&#34;error&#34;</span><span class=nt>&gt;</span>
			<span class=nt>&lt;AppenderRef</span> <span class=na>ref=</span><span class=s>&#34;stdout&#34;</span> <span class=nt>/&gt;</span>
		<span class=nt>&lt;/Root&gt;</span>
	<span class=nt>&lt;/Loggers&gt;</span>

<span class=nt>&lt;/configuration&gt;</span>
</code></pre></td></tr></table></div></div><p>另外，这个Gelf Appender需要导入另一个依赖，如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>&lt;dependency&gt;
    &lt;groupId&gt;biz.paluch.logging&lt;/groupId&gt;
    &lt;artifactId&gt;logstash-gelf&lt;/artifactId&gt;
    &lt;version&gt;1.11.1&lt;/version&gt;
&lt;/dependency&gt;
</code></pre></td></tr></table></div></div><p>接着运行项目工程，可以看到Logstash的控制台已经把收集到的日志打印出来了：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>{
            &#34;message&#34; =&gt; &#34;Hello world!&#34;,
         &#34;@timestamp&#34; =&gt; 2019-05-10T14:09:43.267Z,
          &#34;className&#34; =&gt; &#34;lewky.cn.Test&#34;,
        &#34;source_host&#34; =&gt; &#34;127.0.0.1&#34;,
          &#34;timestamp&#34; =&gt; &#34;2019-05-10T22:09:43.211+0800&#34;,
    &#34;simpleClassName&#34; =&gt; &#34;Test&#34;,
           &#34;facility&#34; =&gt; &#34;logstash-gelf&#34;,
              &#34;level&#34; =&gt; &#34;INFO&#34;,
               &#34;host&#34; =&gt; &#34;DESKTOP-S7HJJKD&#34;,
           &#34;@version&#34; =&gt; &#34;1&#34;,
             &#34;server&#34; =&gt; &#34;DESKTOP-S7HJJKD&#34;
}
</code></pre></td></tr></table></div></div><h2 id=elk--log4j2快速搭建用例>ELK + Log4j2快速搭建用例</h2><p>接下来就可以把Logstash收集到的日志输出到Elasticsearch，并通过Kibana显示到界面上。</p><h3 id=logstash配置elasticsearch插件>Logstash配置Elasticsearch插件</h3><p>修改配置文件如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>input {
    gelf {
        host =&gt; &#34;127.0.0.1&#34;
        port =&gt; 4567
        use_tcp =&gt; true
    }
}
filter {
}
output {
    stdout {
        codec =&gt; rubydebug
    }
    elasticsearch {
        hosts =&gt; [&#34;127.0.0.1:9200&#34;]
		document_id =&gt; &#34;%{docId}&#34;
        index =&gt; &#34;%{indexName}&#34;
    }
}
</code></pre></td></tr></table></div></div><p>output里添加了elasticsearch插件：</p><ol><li>hosts里配置Elasticsearch server的地址</li><li>document_id是index到ES时使用的索引id</li><li>index是index到ES是使用的索引名字</li></ol><h3 id=修改log4j2xml和项目代码>修改log4j2.xml和项目代码</h3><p>在项目的log4j2.xml里的Gelf Appender加上两个个新的Field：<code>indexName</code>和<code>docId</code>，如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>&lt;Gelf name=&#34;logstash-gelf&#34; host=&#34;tcp:localhost&#34; port=&#34;4567&#34; version=&#34;1.1&#34; ignoreExceptions=&#34;true&#34;
     extractStackTrace=&#34;true&#34; filterStackTrace=&#34;false&#34;&gt;
    &lt;Field name=&#34;timestamp&#34; pattern=&#34;%d{yyyy-MM-dd&#39;T&#39;HH:mm:ss.SSSZ}&#34; /&gt;
    &lt;Field name=&#34;level&#34; pattern=&#34;%level&#34; /&gt;
    &lt;Field name=&#34;simpleClassName&#34; pattern=&#34;%C{1}&#34; /&gt;
    &lt;Field name=&#34;className&#34; pattern=&#34;%C&#34; /&gt;
    &lt;Field name=&#34;server&#34; pattern=&#34;%host&#34; /&gt;

    &lt;Field name=&#34;indexName&#34; mdc=&#34;indexName&#34; /&gt;
    &lt;Field name=&#34;docId&#34; mdc=&#34;docId&#34; /&gt;
&lt;/Gelf&gt;
</code></pre></td></tr></table></div></div><p>这里添加的两个新的Field对应于上边Logstash配置文件里的两个变量，然后这里用到了<code>mdc</code>，这个是Log4j2里的ThreadContext的东西，有兴趣可以去了解下Log4j2里的MDC和NDC。</p><p>接着修改测试类的代码，如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Test</span> <span class=o>{</span>
    <span class=kd>public</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>Logger</span> <span class=n>LOGGER</span> <span class=o>=</span> <span class=n>LogManager</span><span class=o>.</span><span class=na>getLogger</span><span class=o>(</span><span class=s>&#34;elk.test&#34;</span><span class=o>);</span>

    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=kd>final</span> <span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>ThreadContext</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=s>&#34;docId&#34;</span><span class=o>,</span> <span class=s>&#34;1&#34;</span><span class=o>);</span>
        <span class=n>ThreadContext</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=s>&#34;indexName&#34;</span><span class=o>,</span> <span class=s>&#34;test&#34;</span><span class=o>);</span>

        <span class=n>LOGGER</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;Hello world!&#34;</span><span class=o>);</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table></div></div><p>接着依次启动ELK三个软件，然后运行项目，可以发现Logstash控制台里收集到了日志信息：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>{
    &#34;simpleClassName&#34; =&gt; &#34;Test&#34;,
             &#34;server&#34; =&gt; &#34;DESKTOP-S7HJJKD&#34;,
            &#34;message&#34; =&gt; &#34;Hello world!&#34;,
           &#34;@version&#34; =&gt; &#34;1&#34;,
        &#34;source_host&#34; =&gt; &#34;127.0.0.1&#34;,
          &#34;indexName&#34; =&gt; &#34;test&#34;,
              &#34;level&#34; =&gt; &#34;INFO&#34;,
         &#34;@timestamp&#34; =&gt; 2019-05-11T16:40:14.996Z,
           &#34;facility&#34; =&gt; &#34;logstash-gelf&#34;,
          &#34;className&#34; =&gt; &#34;lewky.cn.Test&#34;,
          &#34;timestamp&#34; =&gt; &#34;2019-05-12T00:40:14.877+0800&#34;,
              &#34;docId&#34; =&gt; 1,
               &#34;host&#34; =&gt; &#34;DESKTOP-S7HJJKD&#34;
}
</code></pre></td></tr></table></div></div><p>而在我们的IDE控制台（我用的是Eclipse）里也可以看到输出了信息：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>{&#34;logger&#34;: &#34;elk.test&#34;, &#34;level&#34;: &#34;INFO&#34;, &#34;msg&#34;: &#34;Hello world!&#34;}
</code></pre></td></tr></table></div></div><h3 id=配置kibana查看elasticsearch的index数据>配置Kibana查看Elasticsearch的index数据</h3><p>接下来就是最后一步了，通过Kibana来查看我们刚刚index到Elasticsearch里的数据。</p><p>启动了Kibana后，在浏览器访问<code>localhost:5601</code>，进入界面后，操作如下：</p><ol><li>Management -> Index Patterns</li><li>输入index的名字，我们这里填的是<code>test</code>；然后点击<code>Next step</code></li><li>在<code>Time Filter field name</code>下方的下拉框里选择<code>timestamp</code>作为我们的一个排序字段，默认是desc，即递减排序</li><li>最后点击<code>Create index pattern</code></li></ol><p>现在已经配置好了Index pattern，我们就可以直接在左侧菜单栏里的Discover去查看对应的index里的数据了。如果不出意外，现在在Discover里已经看到刚刚被我们index进去的日志信息了。</p><p>默认只会显示<code>Time</code>和<code>_source</code>两个字段的数据，<code>Time</code>就是排序字段，它的值和之前我们选择的那个<code>timestamp</code>一样。<code>_source</code>里则是所有字段的数据总和。</p><p>可以根据需要，在显示字段的左侧把任意的字段<code>add</code>到右侧以显示出来。当你添加了新的字段之后，<code>_source</code>字段会自动消失。</p><p>这就是最简单的一个ELK快速搭建例子，有兴趣的可以接着看后续的文章以了解更多和ELK相关的问题或知识。</p><h2 id=参考链接>参考链接</h2><ul><li><a href=https://segmentfault.com/a/1190000016192543 target=_blank rel="noopener noreffer">ELK入门01—Elasticsearch安装</a></li><li><a href=https://segmentfault.com/a/1190000016192394 target=_blank rel="noopener noreffer">ELK入门02—Logstash+Log4j2+ES</a></li><li><a href=https://segmentfault.com/a/1190000010138070 target=_blank rel="noopener noreffer">log4j2 + logstash</a></li><li><a href=https://elasticsearch.cn/question/3271 target=_blank rel="noopener noreffer">想问下ELK，不同版本都支持哪些jdk，在哪里查看。</a></li><li><a href=https://blog.csdn.net/qq_32292967/article/details/78622647 target=_blank rel="noopener noreffer">logstash配置之自动重载配置文件</a></li><li><a href=https://segmentfault.com/a/1190000015715238 target=_blank rel="noopener noreffer">ET001 不可不掌握的 Logstash 使用技巧</a></li></ul><div class="details admonition warning open"><div class="details-summary admonition-title"><i class="icon fas fa-exclamation-triangle fa-fwwarning"></i>警告<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>本文最后更新于 <span class=timeago datetime=2019-05-11T21:14:33 title="May 11, 2019">May 11, 2019</span>，文中内容可能已过时，请谨慎使用。</div></div></div><div class=post-reward><input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>赞赏支持</label><div class=qr-code><label class=qr-code-image for=reward><img class=image src=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/common/wechat.png>
<span>微信打赏</span></label>
<label class=qr-code-image for=reward><img class=image src=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/common/alipay.png>
<span>支付宝打赏</span></label></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2019-05-11</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/posts/65db1615.html/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://lewky.cn/posts/65db1615.html/ data-title="ELK系列(1) - Elasticsearch + Logstash + Kibana + Log4j2快速入门与搭建用例" data-hashtags=ELK系列,Elasticsearch,Logstash,Kibana><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://lewky.cn/posts/65db1615.html/ data-hashtag=ELK系列><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=https://lewky.cn/posts/65db1615.html/ data-title="ELK系列(1) - Elasticsearch + Logstash + Kibana + Log4j2快速入门与搭建用例"><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://lewky.cn/posts/65db1615.html/ data-title="ELK系列(1) - Elasticsearch + Logstash + Kibana + Log4j2快速入门与搭建用例"><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://lewky.cn/posts/65db1615.html/ data-title="ELK系列(1) - Elasticsearch + Logstash + Kibana + Log4j2快速入门与搭建用例"><i class="fab fa-weibo fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/elk%E7%B3%BB%E5%88%97/>ELK系列</a>,&nbsp;<a href=/tags/elasticsearch/>Elasticsearch</a>,&nbsp;<a href=/tags/logstash/>Logstash</a>,&nbsp;<a href=/tags/kibana/>Kibana</a></section><section><span><a href=javascript:void(0); onclick=window.history.back();>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/a34ffc44.html/ class=prev rel=prev title="Java - 一道关于整型和字符类型相加的题目"><i class="fas fa-angle-left fa-fw"></i>Java - 一道关于整型和字符类型相加的题目</a>
<a href=/posts/c85bbf4e.html/ class=next rel=next title="ELK系列(2) - Kibana怎么修改日期格式Date format">ELK系列(2) - Kibana怎么修改日期格式Date format<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=waline></div><script src=https://cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js></script><script>new Waline({el:'#waline',meta:["nick","mail","link"],requiredMeta:["nick","mail"],login:"force",placeholder:"为防恶意灌水攻击，评论前需注册并登录，望见谅~",serverURL:"https://comment.lewky.cn/",avatarCDN:"https://sdn.geekzu.org/avatar/",pageSize:20,avatar:"retro",lang:"zh-CN",visitor:true,highlight:true,emoji:['https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/weibo','https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/qq','https:\/\/cdn.jsdelivr.net\/gh\/lewky\/lewky.github.io@master/images/emoji/aru','https:\/\/cdn.jsdelivr.net\/gh\/lewky\/lewky.github.io@master/images/emoji/bilibili_2233','https:\/\/cdn.jsdelivr.net\/gh\/lewky\/lewky.github.io@master/images/emoji/bilibili_tv_gif','https:\/\/cdn.jsdelivr.net\/gh\/lewky\/lewky.github.io@master/images/emoji/滑稽','https:\/\/cdn.jsdelivr.net\/gh\/lewky\/lewky.github.io@master/images/emoji/default'],});</script></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><span id=run-time></span>|
<a href=http://rssblog.vercel.app/ target=_blank rel=noopener title=RSSBlog><i class="fas fa-fw fa-inbox"></i>&nbsp;RSSBlog</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2018 - 2021</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>雨临Lewis</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp><a target=_blank href=http://www.beian.miit.gov.cn/ style=font-weight:700>粤ICP备19103822</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><div class=sidebar_wo><div id=leimu><img src=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/b2t/leimuA.png alt=雷姆 onmouseover="this.src='https:\/\/cdn.jsdelivr.net\/gh\/lewky\/lewky.github.io@master/images/b2t/leimuB.png'" onmouseout="this.src='https:\/\/cdn.jsdelivr.net\/gh\/lewky\/lewky.github.io@master/images/b2t/leimuA.png'" title=回到顶部></div><div class=sidebar_wo id=lamu><img src=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/b2t/lamuA.png alt=雷姆 onmouseover="this.src='https:\/\/cdn.jsdelivr.net\/gh\/lewky\/lewky.github.io@master/images/b2t/lamuB.png'" onmouseout="this.src='https:\/\/cdn.jsdelivr.net\/gh\/lewky\/lewky.github.io@master/images/b2t/lamuA.png'" title=回到底部></div></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":30},"comment":{},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true}};</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/jquery@2.1.3/dist/jquery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/jquery-backstretch@2.1.18/jquery.backstretch.min.js></script><script>$(function(){$(".site-avatar-plug-bilibili").attr("src","https:\/\/cdn.jsdelivr.net\/gh\/lewky\/lewky.github.io@master/images/avatar-plug/bilibili_"+(~~(128*Math.random())+1)+".png");});var avatar_plug=0;var avatar_click=1;jQuery(document).ready(function($){var frequency=1;var plug_count=128;$("div.home-avatar a").click(function(e){if(avatar_click%frequency===0){avatar_plug++;$(".site-avatar-plug-bilibili").attr("src","https:\/\/cdn.jsdelivr.net\/gh\/lewky\/lewky.github.io@master/images/avatar-plug/bilibili_"+avatar_plug+".png");}
if(avatar_plug===plug_count){avatar_plug=0;}
$("div.home-avatar a").attr("alt","再点击"+(frequency-avatar_click%frequency)+"次头像试试看~~");avatar_click++;});});</script><script>var $cdnPrefix="https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master";</script><script type=text/javascript src=/js/custom.js></script><script>var _hmt=_hmt||[];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?6f278ed0fdb01edb3b1e7398379e5432";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script></body></html>