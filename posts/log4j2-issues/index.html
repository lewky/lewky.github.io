<!doctype html><html lang><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Log4j、Log4j2问题汇总 - Yulin Lewis' Blog</title><meta name=keywords content="雨临Lewis,Java,hugo,hexo,博客"><meta name=Description content="不想当写手的码农不是好咸鱼_(xз」∠)_"><meta property="og:title" content="Log4j、Log4j2问题汇总"><meta property="og:description" content="isDebugEnabled()的作用
查看公司项目的代码，发现在打印日志的时候会先进行一次判断，如下：


1
2
3


if (LOGGER.isDebugEnabled()) {
    LOGGER.debug(&#34;Search parameters: &#34; + searchParams);
}


"><meta property="og:type" content="article"><meta property="og:url" content="https://lewky233.top/posts/log4j2-issues/"><meta property="og:image" content="https://lewky233.top/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-08-07T23:23:54+08:00"><meta property="article:modified_time" content="2022-02-27T23:23:54+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://lewky233.top/logo.png"><meta name=twitter:title content="Log4j、Log4j2问题汇总"><meta name=twitter:description content="isDebugEnabled()的作用
查看公司项目的代码，发现在打印日志的时候会先进行一次判断，如下：


1
2
3


if (LOGGER.isDebugEnabled()) {
    LOGGER.debug(&#34;Search parameters: &#34; + searchParams);
}


"><meta name=application-name content="雨临Lewis的博客"><meta name=apple-mobile-web-app-title content="雨临Lewis的博客"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://lewky233.top/posts/log4j2-issues/><link rel=prev href=https://lewky233.top/posts/idea-issues/><link rel=next href=https://lewky233.top/posts/ireport-issues/><link rel=stylesheet href=https://unpkg.com/normalize.css@8.0.1/normalize.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://unpkg.com/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://unpkg.com/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Log4j、Log4j2问题汇总","inLanguage":"","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/lewky233.top\/posts\/log4j2-issues\/"},"genre":"posts","keywords":"Log4j, Log4j2, 工作记录","wordcount":8152,"url":"https:\/\/lewky233.top\/posts\/log4j2-issues\/","datePublished":"2021-08-07T23:23:54+08:00","dateModified":"2022-02-27T23:23:54+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"雨临Lewis","logo":"https:\/\/lewky233.top\/images\/avatar.jpg"},"author":{"@type":"Person","name":"雨临Lewis"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><a href=https://github.com/lewky class=github-corner target=_blank title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="3.5rem" height="3.5rem" viewBox="0 0 250 250" style="fill:#70b7fd;color:#fff;position:absolute;top:0;border:0;left:0;transform:scale(-1,1)" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div class=header-title><a href=/ title="Yulin Lewis' Blog"><span class=header-title-pre><i class='fas fa-fw fa-atom'></i></span>雨临Lewis</a></div><div class=menu><div class=menu-inner><div class=dropdown><a href=/posts/ class="menu-item menu-more dropbtn" title=点击查看所有文章><i class='fas fa-fw fa-archive'></i> 归档</a><div class="menu-more-content dropdown-content"><a href=/categories/ title><i class='fas fa-fw fa-th'></i> 分类 </a><a href=/tags/ title><i class='fas fa-fw fa-tag'></i> 标签 </a><a href=/about/ title><i class='fas fa-fw fa-at'></i> 关于</a></div></div><a class=menu-item href=/friends/ title=欢迎申请友链><i class='fas fa-fw fa-link'></i> 友链</a><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn" title=一些有意思的东东~><i class='fas fa-fw fa-fan fa-spin'></i> 趣味</a><div class="menu-more-content dropdown-content"><a href=/funny/high/ title="前方高能♂ 小心外放！" target=_blank rel=noopener><i class='fas fa-fw fa-dizzy'></i> 燥起来！ </a><a href=/funny/mikutap/ title=初音未来音乐游戏 target=_blank rel=noopener><i class='fas fa-fw fa-music'></i> 在线打碟 </a><a href=/funny/catch-the-cat/ title=逮住那只猫!><i class='fas fa-fw fa-cat'></i> 抓住猫咪</a></div></div><div class=dropdown><a href=/ class="menu-item menu-more dropbtn" title=回到首页><i class='fas fa-fw fa-atom'></i> 站点</a><div class="menu-more-content dropdown-content"><a href=/bbs/ title=来留言吧~><i class='fas fa-fw fa-comment'></i> 公告留言 </a><a href=https://seo.chinaz.com title target=_blank rel=noopener><i class='fas fa-fw fa-chart-line'></i> SEO查询 </a><a href=https://www.ping.cn/http/lewky233.top title target=_blank rel=noopener><i class='fas fa-fw fa-bezier-curve'></i> 网站测速 </a><a href=/posts/e62c38c4.html/ title><i class='fas fa-fw fa-cog fa-spin'></i> 建站日志</a></div></div><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn" title><i class='fas fa-fw fa-book'></i> 文档</a><div class="menu-more-content dropdown-content"><a href=https://gohugo.io/documentation/ title target=_blank rel=noopener><i class='fas fa-fw fa-star'></i> Hugo文档 </a><a href=https://javanote.doc.lewky233.top/ title=尚在完善中~ target=_blank rel=noopener><i class='fab fa-fw fa-java'></i> Java 笔记</a></div></div><a class=menu-item href=/search/ title=渲染搜索结果需要等待几秒钟~><i class='fas fa-fw fa-search'></i> 搜索
</a><span class="menu-item delimiter"></span>
<a href=https://travellings.link target=_blank class=menu-item rel=noopener title=开往-友链接力><i class='fas fa-fw fa-subway'></i></a>
<a href=https://rssblog.vercel.app/ class=menu-item target=_blank rel=noopener title=RSSBlog><i class='fas fa-fw fa-inbox'></i></a>
<a href=https://github.com/lewky class=menu-item target=_blank rel=noopener title=GitHub><i class='fab fa-fw fa-github'></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Yulin Lewis' Blog"><span class=header-title-pre><i class='fas fa-fw fa-atom'></i></span>雨临Lewis</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=dropdown><a href=/posts/ class="menu-item menu-more dropbtn" title=点击查看所有文章><i class='fas fa-fw fa-archive'></i> 归档</a><div class="menu-more-content dropdown-content"><a href=/categories/ title><i class='fas fa-fw fa-th'></i> 分类 </a><a href=/tags/ title><i class='fas fa-fw fa-tag'></i> 标签 </a><a href=/about/ title><i class='fas fa-fw fa-at'></i> 关于</a></div></div><a class=menu-item href=/friends/ title=欢迎申请友链><i class='fas fa-fw fa-link'></i> 友链</a><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn" title=一些有意思的东东~><i class='fas fa-fw fa-fan fa-spin'></i> 趣味</a><div class="menu-more-content dropdown-content"><a href=/funny/high/ title="前方高能♂ 小心外放！" target=_blank rel=noopener><i class='fas fa-fw fa-dizzy'></i> 燥起来！ </a><a href=/funny/mikutap/ title=初音未来音乐游戏 target=_blank rel=noopener><i class='fas fa-fw fa-music'></i> 在线打碟 </a><a href=/funny/catch-the-cat/ title=逮住那只猫!><i class='fas fa-fw fa-cat'></i> 抓住猫咪</a></div></div><div class=dropdown><a href=/ class="menu-item menu-more dropbtn" title=回到首页><i class='fas fa-fw fa-atom'></i> 站点</a><div class="menu-more-content dropdown-content"><a href=/bbs/ title=来留言吧~><i class='fas fa-fw fa-comment'></i> 公告留言 </a><a href=https://seo.chinaz.com title target=_blank rel=noopener><i class='fas fa-fw fa-chart-line'></i> SEO查询 </a><a href=https://www.ping.cn/http/lewky233.top title target=_blank rel=noopener><i class='fas fa-fw fa-bezier-curve'></i> 网站测速 </a><a href=/posts/e62c38c4.html/ title><i class='fas fa-fw fa-cog fa-spin'></i> 建站日志</a></div></div><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn" title><i class='fas fa-fw fa-book'></i> 文档</a><div class="menu-more-content dropdown-content"><a href=https://gohugo.io/documentation/ title target=_blank rel=noopener><i class='fas fa-fw fa-star'></i> Hugo文档 </a><a href=https://javanote.doc.lewky233.top/ title=尚在完善中~ target=_blank rel=noopener><i class='fab fa-fw fa-java'></i> Java 笔记</a></div></div><a class=menu-item href=/search/ title=渲染搜索结果需要等待几秒钟~><i class='fas fa-fw fa-search'></i> 搜索</a>
<a href=https://travellings.link target=_blank class=menu-item rel=noopener title=开往-友链接力><i class='fas fa-fw fa-subway'></i></a>
<a href=https://rssblog.vercel.app/ class=menu-item target=_blank rel=noopener title=RSSBlog><i class='fas fa-fw fa-inbox'></i></a>
<a href=https://github.com/lewky class=menu-item target=_blank rel=noopener title=GitHub><i class='fab fa-fw fa-github'></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">Log4j、Log4j2问题汇总</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>雨临Lewis</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/%E6%97%A5%E5%BF%97%E6%A1%86%E6%9E%B6/><i class="far fa-folder fa-fw"></i>日志框架</a></span></div><div class=post-meta-line><i class="far fa-calendar fa-fw"></i>&nbsp;<time datetime=2021-08-07>2021-08-07</time>&nbsp;<i class="far fa-calendar-plus fa-fw"></i>&nbsp;<time datetime=2022-02-27>2022-02-27</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 8152 字
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 17 分钟&nbsp;<span id=/posts/log4j2-issues/ class=leancloud_visitors data-flag-title=Log4j、Log4j2问题汇总>
<i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
</span>&nbsp;
<a href=#comments id=post-meta-vcount title=查看评论><i class="fas fa-comment fa-fw"></i>&nbsp;<span id=/posts/log4j2-issues/ class=waline-comment-count></span>&nbsp;条评论</a></div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ol><li><a href=#isdebugenabled的作用><code>isDebugEnabled()</code>的作用</a></li><li><a href=#使用占位符来打印日志>使用<code>{}</code>占位符来打印日志</a></li><li><a href=#神奇的堆栈溢出问题stackoverflowerror>神奇的堆栈溢出问题StackOverflowError</a></li><li><a href=#nosuchmethoderror-comlmaxdisruptordsldisruptor><code>NoSuchMethodError: com.lmax.disruptor.dsl.Disruptor</code></a></li><li><a href=#patternlayout的格式化参数>PatternLayout的格式化参数</a></li><li><a href=#启用热部署>启用热部署</a></li><li><a href=#在脚本中指定配置文件路径>在脚本中指定配置文件路径</a></li><li><a href=#使用xinclude来引入参数文件>使用XInclude来引入参数文件</a></li><li><a href=#ndc和mdc功能>NDC和MDC功能</a></li><li><a href=#illegalstateexception-no-factory-method-found-for-class><code>IllegalStateException: No factory method found for class</code></a><ol><li><a href=#解决方案一>解决方案一</a></li><li><a href=#解决方案二>解决方案二</a></li><li><a href=#解决方案三>解决方案三</a></li></ol></li><li><a href=#logj4-1x怎么使用异步日志>Logj4 1.x怎么使用异步日志</a></li><li><a href=#回滚策略>回滚策略</a></li><li><a href=#defaultrolloverstrategy无效超出上限的日志没有被删除>DefaultRolloverStrategy无效，超出上限的日志没有被删除</a></li><li><a href=#路由日志routingappender>路由日志RoutingAppender</a></li><li><a href=#log4j升级到log4j2>Log4j升级到Log4j2</a></li><li><a href=#springboot项目使用log4j2>SpringBoot项目使用Log4j2</a></li><li><a href=#参考链接>参考链接</a></li></ol></nav></div></div><div class=content id=content><h2 id=isdebugenabled的作用><code>isDebugEnabled()</code>的作用</h2><p>查看公司项目的代码，发现在打印日志的时候会先进行一次判断，如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=k>if</span> <span class=o>(</span><span class=n>LOGGER</span><span class=o>.</span><span class=na>isDebugEnabled</span><span class=o>())</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=n>LOGGER</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;Search parameters: &#34;</span> <span class=o>+</span> <span class=n>searchParams</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>我们使用的是Log4j框架，框架自身提供了类似的许多api，比如<code>isErrorEnabled()</code>，<code>isInfoEnabled()</code>等，每个Level对有对应的一个判断Level是否启用的api，实际上这些api都是调用的另一个api：<code>isEnabled</code>。</p><p>在打印日志之前先进行Level的判断，是因为在执行打印语句时，首先会先将要打印的字符串信息作为参数传递给被调用的方法。如下代码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>LOGGER</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;Search parameters: &#34;</span> <span class=o>+</span> <span class=n>searchParams</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>首先会执行字符串拼接的操作，会涉及到对象的toString()方法以及StringBuilder的创建，接着把拼接后的字符串传递给debug语句，这时候才会去判断打印日志的级别，来决定是否将这个字符串输入到对应的日志文件里。假如最终该语句并不会把字符串打印出来，那么这个拼接字符串的过程就属于毫无意义的操作，会增加系统性能的损耗。</p><p>因此，在一些必要的地方，我们会先进行一次日志Level的判断，来避免不必要的性能损耗。</p><h2 id=使用占位符来打印日志>使用<code>{}</code>占位符来打印日志</h2><p>Log4j在升级到Log4j2后提供了新的打印日志的方式：允许使用<code>{}</code>占位符来打印日志，如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>LOGGER</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;Search parameters: {}&#34;</span><span class=o>,</span> <span class=n>searchParams</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>通过占位符来打印日志有个好处，那就是不需要自己去预先判断日志的级别，其底层已经帮我们去实现这个步骤了。此外，使用占位符来打印日志，对于需要拼接大量变量的场景时，该方式也会更加地直观与优雅。如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>LOGGER</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;Current item id is {}, size is {}, color is {}, pattern is {}.&#34;</span><span class=o>,</span> <span class=n>id</span><span class=o>,</span> <span class=n>size</span><span class=o>,</span> <span class=n>color</span><span class=o>,</span> <span class=n>pattern</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p><strong>注意：在Log4j2中，这种占位符打印的方式，最多只能支持到9个变量参数。</strong></p><p>除了Log4j2，其它的日志框架同样支持占位符的写法，比如<code>logback</code>等。</p><p><strong>虽然使用<code>{}</code>占位符来打印日志很方便，但是却有可能引发堆栈溢出的问题，可参考下文。</strong></p><h2 id=神奇的堆栈溢出问题stackoverflowerror>神奇的堆栈溢出问题StackOverflowError</h2><p>自从把公司的系统从Log4j升级到Log4j2后，就总是时不时发生堆栈溢出的问题：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>StackOverflowError</span><span class=o>:</span> <span class=kc>null</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>ClassLoader</span><span class=o>.</span><span class=na>findLoadedClass</span><span class=o>(</span><span class=n>ClassLoader</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>1033</span><span class=o>)</span> <span class=o>~[?:</span><span class=mf>1.8.0_66</span><span class=o>]</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>org</span><span class=o>.</span><span class=na>eclipse</span><span class=o>.</span><span class=na>jetty</span><span class=o>.</span><span class=na>webapp</span><span class=o>.</span><span class=na>WebAppClassLoader</span><span class=o>.</span><span class=na>loadClass</span><span class=o>(</span><span class=n>WebAppClassLoader</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>410</span><span class=o>)</span> <span class=o>~[?:?]</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>org</span><span class=o>.</span><span class=na>eclipse</span><span class=o>.</span><span class=na>jetty</span><span class=o>.</span><span class=na>webapp</span><span class=o>.</span><span class=na>WebAppClassLoader</span><span class=o>.</span><span class=na>loadClass</span><span class=o>(</span><span class=n>WebAppClassLoader</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>403</span><span class=o>)</span> <span class=o>~[?:?]</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>ibatis</span><span class=o>.</span><span class=na>plugin</span><span class=o>.</span><span class=na>Plugin</span><span class=o>.</span><span class=na>invoke</span><span class=o>(</span><span class=n>Plugin</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>65</span><span class=o>)</span> <span class=o>~[</span><span class=n>cbx</span><span class=o>-</span><span class=n>mybatis</span><span class=o>-</span><span class=mf>3.3.0</span><span class=o>.</span><span class=na>jar</span><span class=o>:</span><span class=mf>3.3.0</span><span class=o>]</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>com</span><span class=o>.</span><span class=na>sun</span><span class=o>.</span><span class=na>proxy</span><span class=o>.</span><span class=na>$Proxy62</span><span class=o>.</span><span class=na>query</span><span class=o>(</span><span class=n>Unknown</span> <span class=n>Source</span><span class=o>)</span> <span class=o>~[?:?]</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>ibatis</span><span class=o>.</span><span class=na>session</span><span class=o>.</span><span class=na>defaults</span><span class=o>.</span><span class=na>DefaultSqlSession</span><span class=o>.</span><span class=na>selectList</span><span class=o>(</span><span class=n>DefaultSqlSession</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>120</span><span class=o>)</span> <span class=o>~[</span><span class=n>cbx</span><span class=o>-</span><span class=n>mybatis</span><span class=o>-</span><span class=mf>3.3.0</span><span class=o>.</span><span class=na>jar</span><span class=o>:</span><span class=mf>3.3.0</span><span class=o>]</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>ibatis</span><span class=o>.</span><span class=na>session</span><span class=o>.</span><span class=na>defaults</span><span class=o>.</span><span class=na>DefaultSqlSession</span><span class=o>.</span><span class=na>selectList</span><span class=o>(</span><span class=n>DefaultSqlSession</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>113</span><span class=o>)</span> <span class=o>~[</span><span class=n>cbx</span><span class=o>-</span><span class=n>mybatis</span><span class=o>-</span><span class=mf>3.3.0</span><span class=o>.</span><span class=na>jar</span><span class=o>:</span><span class=mf>3.3.0</span><span class=o>]</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>ibatis</span><span class=o>.</span><span class=na>binding</span><span class=o>.</span><span class=na>MapperMethod</span><span class=o>.</span><span class=na>executeForMany</span><span class=o>(</span><span class=n>MapperMethod</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>122</span><span class=o>)</span> <span class=o>~[</span><span class=n>cbx</span><span class=o>-</span><span class=n>mybatis</span><span class=o>-</span><span class=mf>3.3.0</span><span class=o>.</span><span class=na>jar</span><span class=o>:</span><span class=mf>3.3.0</span><span class=o>]</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>ibatis</span><span class=o>.</span><span class=na>binding</span><span class=o>.</span><span class=na>MapperMethod</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=n>MapperMethod</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>64</span><span class=o>)</span> <span class=o>~[</span><span class=n>cbx</span><span class=o>-</span><span class=n>mybatis</span><span class=o>-</span><span class=mf>3.3.0</span><span class=o>.</span><span class=na>jar</span><span class=o>:</span><span class=mf>3.3.0</span><span class=o>]</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>ibatis</span><span class=o>.</span><span class=na>binding</span><span class=o>.</span><span class=na>MapperProxy</span><span class=o>.</span><span class=na>invoke</span><span class=o>(</span><span class=n>MapperProxy</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>53</span><span class=o>)</span> <span class=o>~[</span><span class=n>cbx</span><span class=o>-</span><span class=n>mybatis</span><span class=o>-</span><span class=mf>3.3.0</span><span class=o>.</span><span class=na>jar</span><span class=o>:</span><span class=mf>3.3.0</span><span class=o>]</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>com</span><span class=o>.</span><span class=na>sun</span><span class=o>.</span><span class=na>proxy</span><span class=o>.</span><span class=na>$Proxy68</span><span class=o>.</span><span class=na>findEntitesByCriterion</span><span class=o>(</span><span class=n>Unknown</span> <span class=n>Source</span><span class=o>)</span> <span class=o>~[?:?]</span>
</span></span><span class=line><span class=cl>	<span class=err>···</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>logging</span><span class=o>.</span><span class=na>log4j</span><span class=o>.</span><span class=na>message</span><span class=o>.</span><span class=na>ParameterFormatter</span><span class=o>.</span><span class=na>appendMap</span><span class=o>(</span><span class=n>ParameterFormatter</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>562</span><span class=o>)</span> <span class=o>~[</span><span class=n>log4j</span><span class=o>-</span><span class=n>api</span><span class=o>-</span><span class=mf>2.11.2</span><span class=o>.</span><span class=na>jar</span><span class=o>:</span><span class=mf>2.11.2</span><span class=o>]</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>logging</span><span class=o>.</span><span class=na>log4j</span><span class=o>.</span><span class=na>message</span><span class=o>.</span><span class=na>ParameterFormatter</span><span class=o>.</span><span class=na>appendPotentiallyRecursiveValue</span><span class=o>(</span><span class=n>ParameterFormatter</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>498</span><span class=o>)</span> <span class=o>~[</span><span class=n>log4j</span><span class=o>-</span><span class=n>api</span><span class=o>-</span><span class=mf>2.11.2</span><span class=o>.</span><span class=na>jar</span><span class=o>:</span><span class=mf>2.11.2</span><span class=o>]</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>logging</span><span class=o>.</span><span class=na>log4j</span><span class=o>.</span><span class=na>message</span><span class=o>.</span><span class=na>ParameterFormatter</span><span class=o>.</span><span class=na>recursiveDeepToString</span><span class=o>(</span><span class=n>ParameterFormatter</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>456</span><span class=o>)</span> <span class=o>~[</span><span class=n>log4j</span><span class=o>-</span><span class=n>api</span><span class=o>-</span><span class=mf>2.11.2</span><span class=o>.</span><span class=na>jar</span><span class=o>:</span><span class=mf>2.11.2</span><span class=o>]</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>logging</span><span class=o>.</span><span class=na>log4j</span><span class=o>.</span><span class=na>message</span><span class=o>.</span><span class=na>ParameterFormatter</span><span class=o>.</span><span class=na>appendMap</span><span class=o>(</span><span class=n>ParameterFormatter</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>573</span><span class=o>)</span> <span class=o>~[</span><span class=n>log4j</span><span class=o>-</span><span class=n>api</span><span class=o>-</span><span class=mf>2.11.2</span><span class=o>.</span><span class=na>jar</span><span class=o>:</span><span class=mf>2.11.2</span><span class=o>]</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>logging</span><span class=o>.</span><span class=na>log4j</span><span class=o>.</span><span class=na>message</span><span class=o>.</span><span class=na>ParameterFormatter</span><span class=o>.</span><span class=na>appendPotentiallyRecursiveValue</span><span class=o>(</span><span class=n>ParameterFormatter</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>498</span><span class=o>)</span> <span class=o>~[</span><span class=n>log4j</span><span class=o>-</span><span class=n>api</span><span class=o>-</span><span class=mf>2.11.2</span><span class=o>.</span><span class=na>jar</span><span class=o>:</span><span class=mf>2.11.2</span><span class=o>]</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>logging</span><span class=o>.</span><span class=na>log4j</span><span class=o>.</span><span class=na>message</span><span class=o>.</span><span class=na>ParameterFormatter</span><span class=o>.</span><span class=na>recursiveDeepToString</span><span class=o>(</span><span class=n>ParameterFormatter</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>456</span><span class=o>)</span> <span class=o>~[</span><span class=n>log4j</span><span class=o>-</span><span class=n>api</span><span class=o>-</span><span class=mf>2.11.2</span><span class=o>.</span><span class=na>jar</span><span class=o>:</span><span class=mf>2.11.2</span><span class=o>]</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>logging</span><span class=o>.</span><span class=na>log4j</span><span class=o>.</span><span class=na>message</span><span class=o>.</span><span class=na>ParameterFormatter</span><span class=o>.</span><span class=na>appendMap</span><span class=o>(</span><span class=n>ParameterFormatter</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>573</span><span class=o>)</span> <span class=o>~[</span><span class=n>log4j</span><span class=o>-</span><span class=n>api</span><span class=o>-</span><span class=mf>2.11.2</span><span class=o>.</span><span class=na>jar</span><span class=o>:</span><span class=mf>2.11.2</span><span class=o>]</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>logging</span><span class=o>.</span><span class=na>log4j</span><span class=o>.</span><span class=na>message</span><span class=o>.</span><span class=na>ParameterFormatter</span><span class=o>.</span><span class=na>appendPotentiallyRecursiveValue</span><span class=o>(</span><span class=n>ParameterFormatter</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>498</span><span class=o>)</span> <span class=o>~[</span><span class=n>log4j</span><span class=o>-</span><span class=n>api</span><span class=o>-</span><span class=mf>2.11.2</span><span class=o>.</span><span class=na>jar</span><span class=o>:</span><span class=mf>2.11.2</span><span class=o>]</span>
</span></span><span class=line><span class=cl>	<span class=err>···</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看到，这个StackOverflowError是由于无限递归调用了<code>ParameterFormatter#recursiveDeepToString()</code>导致的，这个ParameterFormatter是Log4j2里用来支持占位符打印日志的一个API，用法如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>LOGGER</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;Current item id is {}, size is {}, color is {}, pattern is {}.&#34;</span><span class=o>,</span> <span class=n>id</span><span class=o>,</span> <span class=n>size</span><span class=o>,</span> <span class=n>color</span><span class=o>,</span> <span class=n>pattern</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>这行代码是在升级到Log4j2后才改用占位符来打印的，原本的代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>LOGGER</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;Current item id is &#34;</span> <span class=o>+</span> <span class=n>id</span> <span class=o>+</span> <span class=s>&#34;, size is &#34;</span> <span class=o>+</span> <span class=n>size</span> <span class=o>+</span> <span class=s>&#34;, color is &#34;</span> <span class=o>+</span> <span class=n>color</span> <span class=o>+</span> <span class=s>&#34;, pattern is &#34;</span> <span class=o>+</span> <span class=n>pattern</span> <span class=o>+</span> <span class=s>&#34;.&#34;</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>当使用这种带多个参数的占位符语法去打印日志时，Log4j2就会调用<code>ParameterFormatter#recursiveDeepToString()</code>来格式化参数，并最终替换掉对应位置的占位符。</p><p>可能是占位符打印日志的API设计问题，当被用于格式化的参数是一个复杂的对象时，比如POJO之类的，即上述例子中的<code>size</code>、<code>color</code>、<code>pattern</code>，就有可能由于重写了<code>toString()</code>方法，或者懒加载等原因而触发StackOverflowError。</p><p>这个堆栈溢出并不会立刻抛出并结束，而是会在项目运行中卡死页面无响应十几分钟！经过测试，重新改回原本的写法便可避免该异常。网上也找不到类似的案例，只能将原因归结于Log4j2框架的<code>ParameterFormatter#recursiveDeepToString()</code>的bug了。</p><p>在使用占位符打印日志时，<strong>要注意参数的类型</strong>，最好只使用简单的一些字符串来作为参数，<strong>尽量避免直接将一个复杂的对象作为参数</strong>，否则有可能引发预料之外的堆栈溢出问题。</p><h2 id=nosuchmethoderror-comlmaxdisruptordsldisruptor><code>NoSuchMethodError: com.lmax.disruptor.dsl.Disruptor</code></h2><p>项目使用了Log4j2，由于使用了全局异步打印日志的方式，还需要引入disruptor的依赖：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>org.apache.logging.log4j<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>log4j-core<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>2.11.1<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span><span class=line><span class=cl><span class=c>&lt;!-- log4j2 AsyncLogger need disruptor--&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>com.lmax<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>disruptor<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>3.2.0<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>在项目启动类通过代码来启用全局异步打印日志(需要在第一次使用到log4j2的logger之前)：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// use asyncLogger for log4j2 framework
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>System</span><span class=o>.</span><span class=na>setProperty</span><span class=o>(</span><span class=s>&#34;Log4jContextSelector&#34;</span><span class=o>,</span> <span class=s>&#34;org.apache.logging.log4j.core.async.AsyncLoggerContextSelector&#34;</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>然而在启动项目后报错如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>java.lang.NoSuchMethodError: com.lmax.disruptor.dsl.Disruptor.&lt;init&gt;(Lcom/lmax/disruptor/EventFactory;ILjava/util/concurrent/ThreadFactory;Lcom/lmax/disruptor/dsl/ProducerType;Lcom/lmax/disruptor/WaitStrategy;)V
</span></span><span class=line><span class=cl>        at org.apache.logging.log4j.core.async.AsyncLoggerDisruptor.start(AsyncLoggerDisruptor.java:97)
</span></span><span class=line><span class=cl>        at org.apache.logging.log4j.core.async.AsyncLoggerContext.start(AsyncLoggerContext.java:75)
</span></span><span class=line><span class=cl>	at .......
</span></span></code></pre></td></tr></table></div></div><p>该问题是因为Disruptor的版本较低导致，将版本改用较新版本的即可：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;groupId&gt;</span>com.lmax<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;artifactId&gt;</span>disruptor<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;version&gt;</span>3.4.2<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=patternlayout的格式化参数>PatternLayout的格式化参数</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Log4J</span><span class=err>采用类似</span><span class=n>C</span><span class=err>语言中的</span><span class=n>printf</span><span class=err>函数的打印格式格式化日志信息，打印参数如下：</span>
</span></span><span class=line><span class=cl><span class=mi>1</span><span class=err>）</span><span class=o>%</span><span class=n>t</span> <span class=err>用来输出生成该日志事件的线程的名称</span>
</span></span><span class=line><span class=cl><span class=mi>2</span><span class=err>）</span><span class=o>%</span><span class=n>p</span> <span class=err>用于输出日志事件的优先级，即</span><span class=n>DEBUG</span><span class=err>，</span><span class=n>INFO</span><span class=err>，</span><span class=n>WARN</span><span class=err>，</span><span class=n>ERROR</span><span class=err>，</span><span class=n>FATAL</span>
</span></span><span class=line><span class=cl><span class=mi>3</span><span class=err>）</span><span class=o>%</span><span class=n>r</span> <span class=err>用于输出从</span><span class=n>layout</span><span class=err>（布局）的构建到日志事件创建所经过的毫秒数</span>
</span></span><span class=line><span class=cl><span class=mi>4</span><span class=err>）</span><span class=o>%</span><span class=n>c</span> <span class=err>用于输出日志事件的</span><span class=n>category</span><span class=err>（类别），通常就是所在类的全名</span>
</span></span><span class=line><span class=cl><span class=mi>5</span><span class=err>）</span><span class=o>%</span><span class=n>F</span> <span class=err>用于输出被发出日志记录请求，其中的文件名</span>
</span></span><span class=line><span class=cl><span class=mi>6</span><span class=err>）</span><span class=o>%</span><span class=n>d</span> <span class=err>用于输出日志时间点的日期或时间，默认格式为</span><span class=n>ISO8601</span><span class=err>，也可以在其后指定格式，比如：</span><span class=o>%</span><span class=n>d</span><span class=o>{</span><span class=n>yyyy</span><span class=o>-</span><span class=n>MM</span><span class=o>-</span><span class=n>dd</span> <span class=n>HH</span><span class=o>:</span><span class=n>mm</span><span class=o>:</span><span class=n>ss</span><span class=o>,</span><span class=n>SSS</span><span class=o>}</span>
</span></span><span class=line><span class=cl><span class=mi>7</span><span class=err>）</span><span class=o>%</span><span class=n>L</span> <span class=err>用于输出日志事件的发生位置，即在代码中的行数。</span>
</span></span><span class=line><span class=cl><span class=mi>8</span><span class=err>）</span><span class=o>%</span><span class=n>l</span> <span class=err>用于输出日志事件的发生位置，包括类目名、发生的线程，以及在代码中的行数。</span>
</span></span><span class=line><span class=cl><span class=mi>9</span><span class=err>）</span><span class=o>%%</span> <span class=err>用于输出％标志，</span><span class=o>%</span><span class=err>即为转义标志</span>
</span></span><span class=line><span class=cl><span class=mi>10</span><span class=err>）</span><span class=o>%</span><span class=n>M</span> <span class=err>用于输出打印该条日志的方法名</span>
</span></span><span class=line><span class=cl><span class=mi>11</span><span class=err>）</span><span class=o>%</span><span class=n>m</span> <span class=err>用于输出代码中指定的消息</span>
</span></span><span class=line><span class=cl><span class=mi>12</span><span class=err>）</span><span class=o>%</span><span class=n>n</span> <span class=err>用于输出一个回车换行符，</span><span class=n>Windows</span><span class=err>平台为“</span><span class=n>rn</span><span class=err>”，</span><span class=n>Unix</span><span class=err>平台为“</span><span class=n>n</span><span class=err>”</span>
</span></span></code></pre></td></tr></table></div></div><p>输出的日志信息可能长短不一，可以通过格式修饰符来对齐。
格式修饰符：可以控制输出字段的最小字段宽度、最大字段宽度、字段对齐格式，如下所示：</p><table><thead><tr><th style=text-align:center>格式修饰符</th><th style=text-align:center>对齐方式</th><th style=text-align:center>最小宽度</th><th style=text-align:center>最大宽度</th><th style=text-align:center>备注（对%c来使用格式修饰符，所以改变的是类别名称）</th></tr></thead><tbody><tr><td style=text-align:center>%-20c</td><td style=text-align:center>左对齐</td><td style=text-align:center>20</td><td style=text-align:center>none</td><td style=text-align:center>用空格右垫，如果类别名称少于20个字符长</td></tr><tr><td style=text-align:center>%20c</td><td style=text-align:center>右对齐</td><td style=text-align:center>20</td><td style=text-align:center>none</td><td style=text-align:center>用空格左垫，如果类别名称少于20个字符长</td></tr><tr><td style=text-align:center>%.30c</td><td style=text-align:center>左对齐</td><td style=text-align:center>none</td><td style=text-align:center>30</td><td style=text-align:center>从开始截断，如果类别名称超过30个字符长</td></tr><tr><td style=text-align:center>%-20.30c</td><td style=text-align:center>左对齐</td><td style=text-align:center>20</td><td style=text-align:center>30</td><td style=text-align:center>用空格右侧垫，如果类别名称短于20个字符。但是，如果类别名称长度超过30个字符，那么从开始截断。</td></tr><tr><td style=text-align:center>%20.30c</td><td style=text-align:center>右对齐</td><td style=text-align:center>20</td><td style=text-align:center>30</td><td style=text-align:center>用空格左侧垫，如果类别名称短于20个字符。但是，如果类别名称长度超过30个字符，那么从开始截断。</td></tr></tbody></table><h2 id=启用热部署>启用热部署</h2><p>在<code>configuration</code>标签里可以通过设置<code>monitorInterval</code>属性来配置热部署功能，即扫描当前配置文件的间隔时间。单位为秒，不配置则默认值为0；官方文档提及如果配置了值，则会有个最小值5。</p><p>具体细节可以参考这篇文章，里面有源码分析：<a href=https://lewky.cn/posts/2c65baa3.html/ target=_blank rel="noopener noreffer">Log4j和Log4j2怎么动态加载配置文件</a></p><p>下面是一个简要的demo：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;configuration</span> <span class=na>xmlns:xi=</span><span class=s>&#34;http://www.w3.org/2001/XInclude&#34;</span> <span class=na>monitorInterval=</span><span class=s>&#34;30&#34;</span> <span class=na>status=</span><span class=s>&#34;error&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    ....
</span></span><span class=line><span class=cl><span class=nt>&lt;/configuration&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p><code>configuration</code>标签里还有个<code>status</code>属性，用于设置log4j2自身内部的信息输出，可以不设置，当设置成trace时，你会看到log4j2内部各种详细输出。这里设置成error后则只能看到log4j2自身error级以上级别的日志信息。</p><h2 id=在脚本中指定配置文件路径>在脚本中指定配置文件路径</h2><p>通常项目会通过bat或者shell脚本来运行，而配置文件又存放在其他路径，需要在脚本中另外指定配置文件的路径。</p><p>Log4j的配置文件路径参数为<code>-Dlog4j.configuration</code>，在用java命令执行项目时加入改参数即可：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>java</span> <span class=n>com</span><span class=o>.</span><span class=na>test</span><span class=o>.</span><span class=na>Test</span> <span class=o>-</span><span class=n>Dlog4j</span><span class=o>.</span><span class=na>configuration</span><span class=o>=</span><span class=n>config</span><span class=o>/</span><span class=n>log4j</span><span class=o>.</span><span class=na>xml</span>
</span></span></code></pre></td></tr></table></div></div><p>Log4j2的配置文件路径参数为<code>-Dlog4j.configurationFile</code>，如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>java</span> <span class=n>com</span><span class=o>.</span><span class=na>test</span><span class=o>.</span><span class=na>Test</span> <span class=o>-</span><span class=n>Dlog4j</span><span class=o>.</span><span class=na>configurationFile</span><span class=o>=</span><span class=n>config</span><span class=o>/</span><span class=n>log4j2</span><span class=o>.</span><span class=na>xml</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=使用xinclude来引入参数文件>使用XInclude来引入参数文件</h2><p>Log4j2的配置文件可以设置一些参数变量，方便下文使用：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;configuration</span> <span class=na>monitorInterval=</span><span class=s>&#34;30&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Properties&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;Property</span> <span class=na>name=</span><span class=s>&#34;logstash.host&#34;</span><span class=nt>&gt;</span>udp:localhost<span class=nt>&lt;/Property&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;Property</span> <span class=na>name=</span><span class=s>&#34;logstash.port&#34;</span><span class=nt>&gt;</span>4567<span class=nt>&lt;/Property&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/Properties&gt;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Appenders&gt;</span>
</span></span><span class=line><span class=cl>		<span class=c>&lt;!-- This appender is used for indexing CommandLog into Elasticsearch by ELK. --&gt;</span>
</span></span><span class=line><span class=cl>	    <span class=nt>&lt;Gelf</span> <span class=na>name=</span><span class=s>&#34;logstash-gelf&#34;</span> <span class=na>host=</span><span class=s>&#34;${logstash.host}&#34;</span> <span class=na>port=</span><span class=s>&#34;${logstash.port}&#34;</span> <span class=na>version=</span><span class=s>&#34;1.1&#34;</span> <span class=na>ignoreExceptions=</span><span class=s>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>             <span class=na>extractStackTrace=</span><span class=s>&#34;true&#34;</span> <span class=na>filterStackTrace=</span><span class=s>&#34;false&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/Gelf&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/Appenders&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;Loggers&gt;</span>
</span></span><span class=line><span class=cl>	    <span class=nt>&lt;Logger</span> <span class=na>name=</span><span class=s>&#34;elk&#34;</span> <span class=na>level=</span><span class=s>&#34;info&#34;</span> <span class=na>additivity=</span><span class=s>&#34;false&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;AppenderRef</span> <span class=na>ref=</span><span class=s>&#34;logstash-gelf&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/Logger&gt;</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=nt>&lt;Root</span> <span class=na>level=</span><span class=s>&#34;error&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>			<span class=nt>&lt;AppenderRef</span> <span class=na>ref=</span><span class=s>&#34;logfile&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>		<span class=nt>&lt;/Root&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/Loggers&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&lt;/configuration&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>有时候这个参数，不只是某个项目的配置文件使用，可能多个项目之间都是共享同样的变量值，这时候可以通过将公共的参数变量定义到一个单独的文件中，然后通过<code>XInclude</code>来引入参数文件：</p><p>首先定义一个单独的参数文件，假如命名为<code>log4j-xinclude-properties.xml</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&lt;Properties&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Property</span> <span class=na>name=</span><span class=s>&#34;logstash.host&#34;</span><span class=nt>&gt;</span>udp:localhost<span class=nt>&lt;/Property&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Property</span> <span class=na>name=</span><span class=s>&#34;logstash.port&#34;</span><span class=nt>&gt;</span>4567<span class=nt>&lt;/Property&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/Properties&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>然后在原本的配置文件<code>log4j2.xml</code>中引入<code>XInclude</code>，<strong>注意需要在文件头里引入该标签</strong>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=cp>&lt;?xml version=&#34;1.0&#34; encoding=&#34;UTF-8&#34;?&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;configuration</span> <span class=na>xmlns:xi=</span><span class=s>&#34;http://www.w3.org/2001/XInclude&#34;</span> <span class=na>monitorInterval=</span><span class=s>&#34;30&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;xi:include</span> <span class=na>href=</span><span class=s>&#34;log4j-xinclude-properties.xml&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Appenders&gt;</span>
</span></span><span class=line><span class=cl>		<span class=c>&lt;!-- This appender is used for indexing CommandLog into Elasticsearch by ELK. --&gt;</span>
</span></span><span class=line><span class=cl>	    <span class=nt>&lt;Gelf</span> <span class=na>name=</span><span class=s>&#34;logstash-gelf&#34;</span> <span class=na>host=</span><span class=s>&#34;${logstash.host}&#34;</span> <span class=na>port=</span><span class=s>&#34;${logstash.port}&#34;</span> <span class=na>version=</span><span class=s>&#34;1.1&#34;</span> <span class=na>ignoreExceptions=</span><span class=s>&#34;true&#34;</span>
</span></span><span class=line><span class=cl>             <span class=na>extractStackTrace=</span><span class=s>&#34;true&#34;</span> <span class=na>filterStackTrace=</span><span class=s>&#34;false&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/Gelf&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/Appenders&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;Loggers&gt;</span>
</span></span><span class=line><span class=cl>	    <span class=nt>&lt;Logger</span> <span class=na>name=</span><span class=s>&#34;elk&#34;</span> <span class=na>level=</span><span class=s>&#34;info&#34;</span> <span class=na>additivity=</span><span class=s>&#34;false&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;AppenderRef</span> <span class=na>ref=</span><span class=s>&#34;logstash-gelf&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/Logger&gt;</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=nt>&lt;Root</span> <span class=na>level=</span><span class=s>&#34;error&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>			<span class=nt>&lt;AppenderRef</span> <span class=na>ref=</span><span class=s>&#34;logfile&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>		<span class=nt>&lt;/Root&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/Loggers&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nt>&lt;/configuration&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>当然，<code>XInclude</code>不只是可以引入其他文件的Properties节点，实际上也可以引入公共的Appenders或者Loggers节点，注意它只能引入这种一级节点，且一级节点是不能重复定义的，也就是说如果引入了一个Properties节点，那么原本的配置文件中就不能定义该节点了，否则会冲突或者报错。</p><p>此外，配置中的变量占位符<code>${key}</code>可以用<code>${key:-defaultValue}</code>的形式来设置默认值：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>${logstash.host:-udp:localhost}
</span></span><span class=line><span class=cl>${logstash.port:-4567}
</span></span></code></pre></td></tr></table></div></div><h2 id=ndc和mdc功能>NDC和MDC功能</h2><p>NDC（Nested Diagnostic Context）和MDC（Mapped Diagnostic Context）是Log4j提供的一个线程共享的变量容器，NDC对应Stack，MDC对应Map，可以将变量存入其中，然后在打印日志时通过PatternLayout来将变量值打印出来，比如打印当前用户的用户id等。</p><p>从功能来看，其实跟Java提供的ThreadLocal差不多。NDC和MDC都是线程独立的，子线程会从父线程拷贝上下文。用法很简单：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// NDC
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mf>1.</span><span class=err>开始调用</span>
</span></span><span class=line><span class=cl><span class=n>NDC</span><span class=o>.</span><span class=na>push</span><span class=o>(</span><span class=n>message</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=mf>2.</span><span class=err>删除栈顶消息</span>
</span></span><span class=line><span class=cl><span class=n>NDC</span><span class=o>.</span><span class=na>pop</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=mf>3.</span><span class=err>清除全部的消息，必须在线程退出前显示的调用，否则会导致内存溢出。</span>
</span></span><span class=line><span class=cl><span class=n>NDC</span><span class=o>.</span><span class=na>remove</span><span class=o>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=mf>4.</span><span class=err>输出模板，注意是小写的</span><span class=o>[%</span><span class=n>x</span><span class=o>]</span>
</span></span><span class=line><span class=cl><span class=n>log4j</span><span class=o>.</span><span class=na>appender</span><span class=o>.</span><span class=na>stdout</span><span class=o>.</span><span class=na>layout</span><span class=o>.</span><span class=na>ConversionPattern</span><span class=o>=[%</span><span class=n>d</span><span class=o>{</span><span class=n>yyyy</span><span class=o>-</span><span class=n>MM</span><span class=o>-</span><span class=n>dd</span> <span class=n>HH</span><span class=o>:</span><span class=n>mm</span><span class=o>:</span><span class=n>ssS</span><span class=o>}]</span> <span class=o>[%</span><span class=n>x</span><span class=o>]</span> <span class=o>:</span> <span class=o>%</span><span class=n>m</span><span class=o>%</span><span class=n>n</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// MDC
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mf>1.</span><span class=err>保存信息到上下文</span>
</span></span><span class=line><span class=cl><span class=n>MDC</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=n>key</span><span class=o>,</span> <span class=n>value</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=mf>2.</span><span class=err>从上下文获取设置的信息</span>
</span></span><span class=line><span class=cl><span class=n>MDC</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=mf>3.</span><span class=err>清楚上下文中指定的</span><span class=n>key</span><span class=err>的信息</span>
</span></span><span class=line><span class=cl><span class=n>MDC</span><span class=o>.</span><span class=na>remove</span><span class=o>(</span><span class=n>key</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=mf>4.</span><span class=err>清除所有</span>
</span></span><span class=line><span class=cl><span class=n>clear</span><span class=o>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=mf>5.</span><span class=err>输出模板，注意是大写</span><span class=o>[%</span><span class=n>X</span><span class=o>{</span><span class=n>key</span><span class=o>}]</span>
</span></span><span class=line><span class=cl><span class=n>log4j</span><span class=o>.</span><span class=na>appender</span><span class=o>.</span><span class=na>consoleAppender</span><span class=o>.</span><span class=na>layout</span><span class=o>.</span><span class=na>ConversionPattern</span> <span class=o>=</span> <span class=o>%-</span><span class=mi>4</span><span class=n>r</span> <span class=o>[%</span><span class=n>t</span><span class=o>]</span> <span class=o>%</span><span class=mi>5</span><span class=n>p</span> <span class=o>%</span><span class=n>c</span> <span class=o>%</span><span class=n>x</span> <span class=o>-</span> <span class=o>%</span><span class=n>m</span> <span class=o>-</span> <span class=o>%</span><span class=n>X</span><span class=o>{</span><span class=n>key</span><span class=o>}%</span><span class=n>n</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// PatternLayout
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=o>%</span><span class=n>X</span> <span class=err>输出</span><span class=n>Map</span><span class=err>中全部数据</span>
</span></span><span class=line><span class=cl><span class=o>%</span><span class=n>X</span><span class=o>{</span><span class=n>key</span><span class=o>}</span> <span class=err>指定输出</span><span class=n>Map</span><span class=err>中的</span><span class=n>key</span><span class=err>的值</span>
</span></span><span class=line><span class=cl><span class=o>%</span><span class=n>x</span> <span class=err>输出</span><span class=n>Stack</span><span class=err>中的全部内容</span>
</span></span></code></pre></td></tr></table></div></div><p>而到了Log4j2中，将MDC和NDC合并到了一个新的类<code>ThreadContext</code>中，不过API和PatternLayout还是和NDC、MDC的用法一样。去查看底层源码，会发现内置了一个Stack和Map：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>final</span> <span class=kd>class</span> <span class=nc>ThreadContext</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>ThreadContextMap</span> <span class=n>contextMap</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>ThreadContextStack</span> <span class=n>contextStack</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=illegalstateexception-no-factory-method-found-for-class><code>IllegalStateException: No factory method found for class</code></h2><p>在使用Log4j2时，虽然可以正确读取配置文件并生成log文件，但偶然发现控制台打印了异常信息：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=mi>2018</span><span class=o>-</span><span class=mi>12</span><span class=o>-</span><span class=mi>31</span> <span class=mi>17</span><span class=o>:</span><span class=mi>28</span><span class=o>:</span><span class=mi>14</span><span class=o>,</span><span class=mi>282</span> <span class=n>Log4j2</span><span class=o>-</span><span class=n>TF</span><span class=o>-</span><span class=mi>19</span><span class=o>-</span><span class=n>ConfiguratonFileWatcher</span><span class=o>-</span><span class=mi>6</span> <span class=n>ERROR</span> <span class=n>Unable</span> <span class=n>to</span> <span class=n>invoke</span> <span class=n>factory</span> <span class=n>method</span> <span class=n>in</span> <span class=kd>class</span> <span class=nc>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>logging</span><span class=o>.</span><span class=na>log4j</span><span class=o>.</span><span class=na>core</span><span class=o>.</span><span class=na>appender</span><span class=o>.</span><span class=na>RollingFileAppender</span> <span class=k>for</span> <span class=n>element</span> <span class=n>RollingFile</span><span class=o>:</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>IllegalStateException</span><span class=o>:</span> <span class=n>No</span> <span class=n>factory</span> <span class=n>method</span> <span class=n>found</span> <span class=k>for</span> <span class=kd>class</span> <span class=nc>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>logging</span><span class=o>.</span><span class=na>log4j</span><span class=o>.</span><span class=na>core</span><span class=o>.</span><span class=na>appender</span><span class=o>.</span><span class=na>RollingFileAppender</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>IllegalStateException</span><span class=o>:</span> <span class=n>No</span> <span class=n>factory</span> <span class=n>method</span> <span class=n>found</span> <span class=k>for</span> <span class=kd>class</span> <span class=nc>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>logging</span><span class=o>.</span><span class=na>log4j</span><span class=o>.</span><span class=na>core</span><span class=o>.</span><span class=na>appender</span><span class=o>.</span><span class=na>RollingFileAppender</span>
</span></span><span class=line><span class=cl>        <span class=n>at</span> <span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>logging</span><span class=o>.</span><span class=na>log4j</span><span class=o>.</span><span class=na>core</span><span class=o>.</span><span class=na>config</span><span class=o>.</span><span class=na>plugins</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>PluginBuilder</span><span class=o>.</span><span class=na>findFactoryMethod</span><span class=o>(</span><span class=n>PluginBuilder</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>235</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=n>at</span> <span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>logging</span><span class=o>.</span><span class=na>log4j</span><span class=o>.</span><span class=na>core</span><span class=o>.</span><span class=na>config</span><span class=o>.</span><span class=na>plugins</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>PluginBuilder</span><span class=o>.</span><span class=na>build</span><span class=o>(</span><span class=n>PluginBuilder</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>135</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=n>at</span> <span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>logging</span><span class=o>.</span><span class=na>log4j</span><span class=o>.</span><span class=na>core</span><span class=o>.</span><span class=na>config</span><span class=o>.</span><span class=na>AbstractConfiguration</span><span class=o>.</span><span class=na>createPluginObject</span><span class=o>(</span><span class=n>AbstractConfiguration</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>959</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=n>at</span> <span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>logging</span><span class=o>.</span><span class=na>log4j</span><span class=o>.</span><span class=na>core</span><span class=o>.</span><span class=na>config</span><span class=o>.</span><span class=na>AbstractConfiguration</span><span class=o>.</span><span class=na>createConfiguration</span><span class=o>(</span><span class=n>AbstractConfiguration</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>899</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=n>at</span> <span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>logging</span><span class=o>.</span><span class=na>log4j</span><span class=o>.</span><span class=na>core</span><span class=o>.</span><span class=na>config</span><span class=o>.</span><span class=na>AbstractConfiguration</span><span class=o>.</span><span class=na>createConfiguration</span><span class=o>(</span><span class=n>AbstractConfiguration</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>891</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=n>at</span> <span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>logging</span><span class=o>.</span><span class=na>log4j</span><span class=o>.</span><span class=na>core</span><span class=o>.</span><span class=na>config</span><span class=o>.</span><span class=na>AbstractConfiguration</span><span class=o>.</span><span class=na>doConfigure</span><span class=o>(</span><span class=n>AbstractConfiguration</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>514</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=n>at</span> <span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>logging</span><span class=o>.</span><span class=na>log4j</span><span class=o>.</span><span class=na>core</span><span class=o>.</span><span class=na>config</span><span class=o>.</span><span class=na>AbstractConfiguration</span><span class=o>.</span><span class=na>initialize</span><span class=o>(</span><span class=n>AbstractConfiguration</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>238</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=n>at</span> <span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>logging</span><span class=o>.</span><span class=na>log4j</span><span class=o>.</span><span class=na>core</span><span class=o>.</span><span class=na>config</span><span class=o>.</span><span class=na>AbstractConfiguration</span><span class=o>.</span><span class=na>start</span><span class=o>(</span><span class=n>AbstractConfiguration</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>250</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=n>at</span> <span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>logging</span><span class=o>.</span><span class=na>log4j</span><span class=o>.</span><span class=na>core</span><span class=o>.</span><span class=na>LoggerContext</span><span class=o>.</span><span class=na>setConfiguration</span><span class=o>(</span><span class=n>LoggerContext</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>547</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=n>at</span> <span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>logging</span><span class=o>.</span><span class=na>log4j</span><span class=o>.</span><span class=na>core</span><span class=o>.</span><span class=na>LoggerContext</span><span class=o>.</span><span class=na>onChange</span><span class=o>(</span><span class=n>LoggerContext</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>670</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=n>at</span> <span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>logging</span><span class=o>.</span><span class=na>log4j</span><span class=o>.</span><span class=na>core</span><span class=o>.</span><span class=na>config</span><span class=o>.</span><span class=na>ConfiguratonFileWatcher$ReconfigurationRunnable</span><span class=o>.</span><span class=na>run</span><span class=o>(</span><span class=n>ConfiguratonFileWatcher</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>68</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>Thread</span><span class=o>.</span><span class=na>run</span><span class=o>(</span><span class=n>Thread</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>748</span><span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>将控制台的所有信息都复制出来，仔细查找，又发现了相关的异常信息：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=mi>2018</span><span class=o>-</span><span class=mi>12</span><span class=o>-</span><span class=mi>31</span> <span class=mi>17</span><span class=o>:</span><span class=mi>28</span><span class=o>:</span><span class=mi>14</span><span class=o>,</span><span class=mi>241</span> <span class=n>Log4j2</span><span class=o>-</span><span class=n>TF</span><span class=o>-</span><span class=mi>19</span><span class=o>-</span><span class=n>ConfiguratonFileWatcher</span><span class=o>-</span><span class=mi>6</span> <span class=n>ERROR</span> <span class=n>Unable</span> <span class=n>to</span> <span class=n>create</span> <span class=n>file</span> <span class=n>logs</span><span class=o>/</span><span class=n>$</span><span class=o>{</span><span class=n>ctx</span><span class=o>:</span><span class=n>domainId</span><span class=o>}/</span><span class=n>CNTCore</span><span class=o>.</span><span class=na>log</span> <span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>IOException</span><span class=o>:</span> <span class=n>The</span> <span class=n>filename</span><span class=o>,</span> <span class=n>directory</span> <span class=n>name</span><span class=o>,</span> <span class=n>or</span> <span class=n>volume</span> <span class=n>label</span> <span class=n>syntax</span> <span class=n>is</span> <span class=n>incorrect</span>
</span></span><span class=line><span class=cl>        <span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>WinNTFileSystem</span><span class=o>.</span><span class=na>canonicalize0</span><span class=o>(</span><span class=n>Native</span> <span class=n>Method</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>WinNTFileSystem</span><span class=o>.</span><span class=na>canonicalize</span><span class=o>(</span><span class=n>WinNTFileSystem</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>428</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>File</span><span class=o>.</span><span class=na>getCanonicalPath</span><span class=o>(</span><span class=n>File</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>618</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=o>....</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=mi>2018</span><span class=o>-</span><span class=mi>12</span><span class=o>-</span><span class=mi>31</span> <span class=mi>17</span><span class=o>:</span><span class=mi>28</span><span class=o>:</span><span class=mi>14</span><span class=o>,</span><span class=mi>280</span> <span class=n>Log4j2</span><span class=o>-</span><span class=n>TF</span><span class=o>-</span><span class=mi>19</span><span class=o>-</span><span class=n>ConfiguratonFileWatcher</span><span class=o>-</span><span class=mi>6</span> <span class=n>ERROR</span> <span class=n>Could</span> <span class=n>not</span> <span class=n>create</span> <span class=n>plugin</span> <span class=n>of</span> <span class=n>type</span> <span class=kd>class</span> <span class=nc>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>logging</span><span class=o>.</span><span class=na>log4j</span><span class=o>.</span><span class=na>core</span><span class=o>.</span><span class=na>appender</span><span class=o>.</span><span class=na>RollingFileAppender</span> <span class=k>for</span> <span class=n>element</span> <span class=n>RollingFile</span><span class=o>:</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>IllegalStateException</span><span class=o>:</span> <span class=n>ManagerFactory</span> <span class=o>[...]</span> <span class=n>unable</span> <span class=n>to</span> <span class=n>create</span> <span class=n>manager</span> <span class=k>for</span> <span class=o>[</span><span class=n>logs</span><span class=o>/</span><span class=n>$</span><span class=o>{</span><span class=n>ctx</span><span class=o>:</span><span class=n>domainId</span><span class=o>}/</span><span class=n>CNTCore</span><span class=o>.</span><span class=na>log</span><span class=o>]</span> <span class=n>with</span> <span class=n>data</span> <span class=o>[...]</span> <span class=n>java</span><span class=o>.</span><span class=na>lang</span><span class=o>.</span><span class=na>IllegalStateException</span><span class=o>:</span> <span class=n>ManagerFactory</span> <span class=o>[...]</span> <span class=n>unable</span> <span class=n>to</span> <span class=n>create</span> <span class=n>manager</span> <span class=k>for</span> <span class=o>[</span><span class=n>logs</span><span class=o>/</span><span class=n>$</span><span class=o>{</span><span class=n>ctx</span><span class=o>:</span><span class=n>domainId</span><span class=o>}/</span><span class=n>CNTCore</span><span class=o>.</span><span class=na>log</span><span class=o>]</span> <span class=n>with</span> <span class=n>data</span> <span class=o>[...]</span>
</span></span><span class=line><span class=cl>        <span class=n>at</span> <span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>logging</span><span class=o>.</span><span class=na>log4j</span><span class=o>.</span><span class=na>core</span><span class=o>.</span><span class=na>appender</span><span class=o>.</span><span class=na>AbstractManager</span><span class=o>.</span><span class=na>getManager</span><span class=o>(</span><span class=n>AbstractManager</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>115</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=n>at</span> <span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>logging</span><span class=o>.</span><span class=na>log4j</span><span class=o>.</span><span class=na>core</span><span class=o>.</span><span class=na>appender</span><span class=o>.</span><span class=na>OutputStreamManager</span><span class=o>.</span><span class=na>getManager</span><span class=o>(</span><span class=n>OutputStreamManager</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>114</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=n>at</span> <span class=n>org</span><span class=o>.</span><span class=na>apache</span><span class=o>.</span><span class=na>logging</span><span class=o>.</span><span class=na>log4j</span><span class=o>.</span><span class=na>core</span><span class=o>.</span><span class=na>appender</span><span class=o>.</span><span class=na>rolling</span><span class=o>.</span><span class=na>RollingFileManager</span><span class=o>.</span><span class=na>getFileManager</span><span class=o>(</span><span class=n>RollingFileManager</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>188</span><span class=o>)</span>
</span></span><span class=line><span class=cl>        <span class=n>at</span> <span class=o>....</span>
</span></span></code></pre></td></tr></table></div></div><p>看起来是因为配置文件里的RollingFile使用到了<code>${ctx:domainId}</code>导致了这个问题。百度了下，发现了Log4j2的jira issue：<a href=https://issues.apache.org/jira/browse/LOG4J2-1967 target=_blank rel="noopener noreffer">Unable to invoke factory method in class class org.apache.logging.log4j.core.appender.RollingFileAppender for element RollingFile</a></p><p>该问题和我遇到的一样，而在jira里有comment如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>Question: Does system property logfile have a value?
</span></span></code></pre></td></tr></table></div></div><p>结合项目的配置文件log4j2.xml:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;RollingFile</span> <span class=na>name=</span><span class=s>&#34;logfile&#34;</span> <span class=na>immediateFlush=</span><span class=s>&#34;true&#34;</span> <span class=na>fileName=</span><span class=s>&#34;logs/${ctx:domainId}/CNTCore.log&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>filePattern=</span><span class=s>&#34;logs/${ctx:domainId}/CNTCore.log.%d{yyyy-MM-dd-a}.gz&#34;</span> <span class=na>append=</span><span class=s>&#34;true&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;PatternLayout&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;pattern&gt;</span>%d %t %p %X{TracingMsg} %c - %m%n<span class=nt>&lt;/pattern&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/PatternLayout&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Policies&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;TimeBasedTriggeringPolicy</span> <span class=na>modulate=</span><span class=s>&#34;true&#34;</span> <span class=na>interval=</span><span class=s>&#34;1&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/Policies&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/RollingFile&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>可以看出，这个异常是由于RollingFile使用到了<code>${ctx:domainId}</code>，而该变量值是null，导致无法创建对应的RollingFile文件到磁盘。但是这个domainId是通过ThreadContext把值put进去的，不可能是null，从最终的效果来看，这个变量其实也是拿到了值的，因为对应的日志文件已经存在于磁盘上了。</p><p>既然如此，为什么还会出现这个异常呢？通过观察控制台可以发现，每过一段时间就会出现一次该异常。从异常中可以看到<code>ConfiguratonFileWatcher</code>，好像有些明白为什么了。</p><p>ConfiguratonFileWatcher是用来扫描配置文件是否被改动过的，在配置文件中设置的扫描间隔是30s：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;configuration</span> <span class=na>monitorInterval=</span><span class=s>&#34;30&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    ....
</span></span><span class=line><span class=cl><span class=nt>&lt;/configuration&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>由于扫描文件时另外起一个线程去扫描的，而<code>${ctx:domainId}</code>的值是存放于ThreadContext中的，ThreadContext是线程安全的，同一个key对应的value在不同线程中是不一定相同的。而对于新启动的线程来说，并没有将domainId的值存放进去，于是新线程在扫描配置文件的RollingFile时，自然是无法获取到<code>${ctx:domainId}</code>的值，故而每隔一段时间就会报上边的异常。</p><h3 id=解决方案一>解决方案一</h3><p>既然问题是因为扫描配置文件是否改动造成的，那么只要将动态加载的功能关闭就行了，如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;configuration</span> <span class=na>monitorInterval=</span><span class=s>&#34;0&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    ....
</span></span><span class=line><span class=cl><span class=nt>&lt;/configuration&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=解决方案二>解决方案二</h3><p>如果希望不关闭动态加载配置文件的功能，可以将domainId的值存放到System.properties里：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>System</span><span class=o>.</span><span class=na>setProperty</span><span class=o>(</span><span class=s>&#34;domainId&#34;</span><span class=o>,</span> <span class=s>&#34;xxx&#34;</span><span class=o>);</span>
</span></span></code></pre></td></tr></table></div></div><p>然后通过<code>${sys:xxx}</code>的方式来获取该properties的值：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;RollingFile</span> <span class=na>name=</span><span class=s>&#34;logfile&#34;</span> <span class=na>immediateFlush=</span><span class=s>&#34;true&#34;</span> <span class=na>fileName=</span><span class=s>&#34;logs/${sys:domainId}/CNTCore.log&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>filePattern=</span><span class=s>&#34;logs/${sys:domainId}/CNTCore.log.%d{yyyy-MM-dd-a}.gz&#34;</span> <span class=na>append=</span><span class=s>&#34;true&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;PatternLayout&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;pattern&gt;</span>%d %t %p %X{TracingMsg} %c - %m%n<span class=nt>&lt;/pattern&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/PatternLayout&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Policies&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;TimeBasedTriggeringPolicy</span> <span class=na>modulate=</span><span class=s>&#34;true&#34;</span> <span class=na>interval=</span><span class=s>&#34;1&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/Policies&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/RollingFile&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>在log4j2中关于这些变量取值有以下这些种类：</p><table><thead><tr><th>Prefix</th><th>Context</th></tr></thead><tbody><tr><td>bundle</td><td>Resource bundle. The format is ${bundle:BundleName:BundleKey}. The bundle name follows package naming conventions, for example: ${bundle:com.domain.Messages:MyKey}.</td></tr><tr><td>ctx</td><td>Thread Context Map (MDC)</td></tr><tr><td>date</td><td>Inserts the current date and/or time using the specified format</td></tr><tr><td>env</td><td>System environment variables. The formats are ${env:ENV_NAME} and ${env:ENV_NAME:-default_value}.</td></tr><tr><td>jndi</td><td>A value set in the default JNDI Context.</td></tr><tr><td>jvmrunargs</td><td>A JVM input argument accessed through JMX, but not a main argument; see RuntimeMXBean.getInputArguments(). Not available on Android.</td></tr><tr><td>log4j</td><td>Log4j configuration properties. The expressions ${log4j:configLocation} and ${log4j:configParentLocation} respectively provide the absolute path to the log4j configuration file and its parent folder.</td></tr><tr><td>main</td><td>A value set with MapLookup.setMainArguments(String[])</td></tr><tr><td>map</td><td>A value from a MapMessage</td></tr><tr><td>sd</td><td>A value from a StructuredDataMessage. The key &ldquo;id&rdquo; will return the name of the StructuredDataId without the enterprise number. The key &ldquo;type&rdquo; will return the message type. Other keys will retrieve individual elements from the Map.</td></tr><tr><td>sys</td><td>System properties. The formats are ${sys:some.property} and ${sys:some.property:-default_value}.</td></tr></tbody></table><h3 id=解决方案三>解决方案三</h3><p>不要在RollingFile的fileName和filePattern属性里使用到<code>${ctx:domainId}</code>等NDC和MDC的写法，这样会导致在log4j2异步扫描重加载配置文件的时候报错。</p><p>可以使用另一种Appender来实现这种把日志分别打印到不同文件的效果，那就是<a href=http://lewky.cn/posts/log4j2-issues/#%e8%b7%af%e7%94%b1%e6%97%a5%e5%bf%97routingappender target=_blank rel="noopener noreffer">路由日志<code>RoutingAppender</code></a>。有兴趣的可以去了解下这个，还是挺有意思的。</p><h2 id=logj4-1x怎么使用异步日志>Logj4 1.x怎么使用异步日志</h2><p>异步日志是Log4j2引入的新特性，但可以通过导入一个桥接包<code>log4j-1.2-api-2.6.jar</code>，这样就可以用旧版本的Log4j 1.x的API来调用Log4j2的实现。</p><p>当然更推荐的做法是，直接升级Log4j到2.x版本。</p><h2 id=回滚策略>回滚策略</h2><p><code>RollingFile</code>标签里可以配置回滚策略<code>Policies</code>，有两种类型：一种是基于体积回滚日志，一种是基于日期。可以同时配置多个回滚策略：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;RollingFile</span> <span class=na>name=</span><span class=s>&#34;cntCorelog&#34;</span> <span class=na>immediateFlush=</span><span class=s>&#34;true&#34;</span> <span class=na>fileName=</span><span class=s>&#34;logs/CNTCore.log&#34;</span> <span class=na>filePattern=</span><span class=s>&#34;logs/%d{yyyy/MM/dd}/CNTCore.log.%d{yyyy-MM-dd-HH}-%i.gz&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>append=</span><span class=s>&#34;true&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;PatternLayout&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;pattern&gt;</span>%d{yyyy-MM-dd HH:mm:ss.SSS}:%p %t %X{TracingMsg} %c - %m%n<span class=nt>&lt;/pattern&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/PatternLayout&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Policies&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;SizeBasedTriggeringPolicy</span> <span class=na>size=</span><span class=s>&#34;100MB&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;TimeBasedTriggeringPolicy</span> <span class=na>modulate=</span><span class=s>&#34;true&#34;</span> <span class=na>interval=</span><span class=s>&#34;1&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/Policies&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;DefaultRolloverStrategy</span> <span class=na>max=</span><span class=s>&#34;30&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/RollingFile&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p><code>TimeBasedTriggeringPolicy</code>标签的<code>interval</code>表示回滚间隔，<code>1</code>表示每经过一个单位的最小时间粒度就回滚一次。<code>modulate</code>表示回滚的时间点是否校准为零点整。</p><p>回滚日志的最小时间粒度由<code>filePattern</code>决定，比如<code>%d{yyyy-MM-dd-HH}</code>表示最小时间粒度为小时，以最后一个符号为准。</p><h2 id=defaultrolloverstrategy无效超出上限的日志没有被删除>DefaultRolloverStrategy无效，超出上限的日志没有被删除</h2><p>默认的<code>DefaultRolloverStrategy</code>的<code>max</code>默认值是7，如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;DefaultRolloverStrategy</span> <span class=na>max=</span><span class=s>&#34;7&#34;</span><span class=nt>/&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>这里的<code>max</code>属性并非指日志的保留上限，而是指<code>filePattern</code>的计数器<code>%i</code>的最大值，<strong><code>max</code>属性必须和这个计数器<code>%i</code>搭配使用才有效果</strong>，此外<code>filePattern</code>的最小时间粒度为分钟。如下：</p><p><code>RollingFile</code>会自动按照<code>filePattern</code>的最小时间粒度进行日志的切割回滚。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;RollingFile</span> <span class=na>name=</span><span class=s>&#34;cntCorelog&#34;</span> <span class=na>immediateFlush=</span><span class=s>&#34;true&#34;</span> <span class=na>fileName=</span><span class=s>&#34;logs/CNTCore.log&#34;</span> <span class=na>filePattern=</span><span class=s>&#34;logs/%d{yyyy/MM/dd}/CNTCore.log.%d{yyyy-MM-dd-HH}-%i.gz&#34;</span>
</span></span><span class=line><span class=cl>    <span class=na>append=</span><span class=s>&#34;true&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;PatternLayout&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;pattern&gt;</span>%d{yyyy-MM-dd HH:mm:ss.SSS}:%p %t %X{TracingMsg} %c - %m%n<span class=nt>&lt;/pattern&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/PatternLayout&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Policies&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;TimeBasedTriggeringPolicy</span> <span class=na>modulate=</span><span class=s>&#34;true&#34;</span> <span class=na>interval=</span><span class=s>&#34;1&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/Policies&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;DefaultRolloverStrategy</span> <span class=na>max=</span><span class=s>&#34;30&#34;</span><span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/RollingFile&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p>上述配置的回滚日志会存放到名字为日期格式的子目录里，因此<code>max</code>统计的是子目录里的数量。如果需要统计所有的子目录里的日志数量，则需要对<code>DefaultRolloverStrategy</code>进行特殊配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;DefaultRolloverStrategy</span> <span class=na>max=</span><span class=s>&#34;30&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Delete</span> <span class=na>basePath=</span><span class=s>&#34;logs/%d{yyyy/MM/dd}/&#34;</span> <span class=na>maxDepth=</span><span class=s>&#34;2&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;IfFileName</span> <span class=na>glob=</span><span class=s>&#34;*.gz&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>        <span class=c>&lt;!--7天--&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;IfLastModified</span> <span class=na>age=</span><span class=s>&#34;168H&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/Delete&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/DefaultRolloverStrategy&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p><code>Delete</code>标签内决定了删除过期文件的规则：</p><ul><li><code>IfLastModified</code>的<code>age</code>的时间粒度要和filePattern的一致，此外<code>age</code>填写的数字最好大于2，否则可能造成删除的时候<code>IfLastModified</code>的<code>age</code>的时间粒度要和filePattern的一致，此外<code>age</code>填写的数字最好大于2，否则可能造成删除的时候, 最近的文件还处于被占用状态,导致删除不成功。</li><li><code>maxDepth</code>是递归统计的目录深度，<code>basePath</code>是需要处理的目录，<code>maxDepth="1"</code>表示当前目录，即<code>basePath</code>。</li></ul><h2 id=路由日志routingappender>路由日志RoutingAppender</h2><p>如果想要将日志文件生成到指定的目录里，这个目录是动态的，由程序来控制具体的值，比如说，对于不同的用户，可以将这些用户专属的日志存放到各自的目录里进行分类，方便后续跟踪。</p><p>这种时候，就需要使用到路由日志RoutingAppender，如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;Appenders&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;Routing</span> <span class=na>name=</span><span class=s>&#34;domainAppender&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;Routes</span> <span class=na>pattern=</span><span class=s>&#34;$${ctx:domainId}&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c>&lt;!-- This route is chosen if ThreadContext has no value for key domainId. --&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;Route</span> <span class=na>key=</span><span class=s>&#34;$${ctx:domainId}&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;AppenderRef</span> <span class=na>ref=</span><span class=s>&#34;&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;/Route&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c>&lt;!-- This route is chosen if ThreadContext has value &#39;/&#39; for key domainId. --&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;Route</span> <span class=na>key=</span><span class=s>&#34;/&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;AppenderRef</span> <span class=na>ref=</span><span class=s>&#34;&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;/Route&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=c>&lt;!-- This route is chosen if ThreadContext has value(besides &#39;/&#39;) for key domainId. --&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;Route&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;RollingFile</span> <span class=na>name=</span><span class=s>&#34;${ctx:domainId}-cntCorelog&#34;</span> <span class=na>immediateFlush=</span><span class=s>&#34;true&#34;</span> <span class=na>fileName=</span><span class=s>&#34;logs/${ctx:domainId}/CNTCore.log&#34;</span>
</span></span><span class=line><span class=cl>                     <span class=na>filePattern=</span><span class=s>&#34;logs/${ctx:domainId}/CNTCore.log.%d{yyyy-MM-dd-a}.gz&#34;</span> <span class=na>append=</span><span class=s>&#34;true&#34;</span><span class=nt>&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&lt;PatternLayout&gt;</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&lt;pattern&gt;</span>%d %t %p %X{TracingMsg} %c - %m%n<span class=nt>&lt;/pattern&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&lt;/PatternLayout&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&lt;Policies&gt;</span>
</span></span><span class=line><span class=cl>                        <span class=nt>&lt;TimeBasedTriggeringPolicy</span> <span class=na>modulate=</span><span class=s>&#34;true&#34;</span> <span class=na>interval=</span><span class=s>&#34;1&#34;</span> <span class=nt>/&gt;</span>
</span></span><span class=line><span class=cl>                    <span class=nt>&lt;/Policies&gt;</span>
</span></span><span class=line><span class=cl>                <span class=nt>&lt;/RollingFile&gt;</span>
</span></span><span class=line><span class=cl>            <span class=nt>&lt;/Route&gt;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=nt>&lt;/Routes&gt;</span>
</span></span><span class=line><span class=cl>    <span class=nt>&lt;/Routing&gt;</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl><span class=nt>&lt;/Appenders&gt;</span>
</span></span></code></pre></td></tr></table></div></div><p><code>$${}</code>这里的两个<code>$$</code>是对<code>$</code>进行了转义，这里表示动态计算占位符<code>${}</code>的值。如果是<code>${}</code>占位符，只会计算第一次然后替换为对应的值，而<code>$${}</code>每一次都会计算值。换句话说，<code>${}</code>只能生效一次，后续就算改变了变量值也无效。</p><p>而<code>$${ctx:domainId}</code>指的是存放于MDC中的一个变量<code>domainId</code>的值，在上述配置中不同用户的<code>domainId</code>是不一样的，这样就可以实现对不同用户的日志进行归类。</p><h2 id=log4j升级到log4j2>Log4j升级到Log4j2</h2><p>由于公司老项目的日志管理十分混乱，大部分地方使用自定制的打印类工具来打印，小部分地方用的slf4j+log4j。Log4j在高并发场景下，也会有引发线程阻塞的情况。</p><p>为了便于管理，以及提高日志打印的性能，决定将日志从Log4j升级到Log4j2。并且统一使用slf4j+log4j2的方式来打印日志，关于slf4j等日志门面，可以看这篇文章：<a href=https://lewky.cn/posts/log-framework/ target=_blank rel="noopener noreffer">日志框架与门面模式</a></p><p>首先是移除低版本的Log4j日志依赖：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;exclusions&gt;  
</span></span><span class=line><span class=cl>    &lt;exclusion&gt;  
</span></span><span class=line><span class=cl>        &lt;groupId&gt;org.slf4j&lt;/groupId&gt;  
</span></span><span class=line><span class=cl>        &lt;artifactId&gt;slf4j-log4j12&lt;/artifactId&gt;  
</span></span><span class=line><span class=cl>    &lt;/exclusion&gt;  
</span></span><span class=line><span class=cl>    &lt;exclusion&gt;  
</span></span><span class=line><span class=cl>        &lt;groupId&gt;log4j&lt;/groupId&gt;  
</span></span><span class=line><span class=cl>        &lt;artifactId&gt;log4j&lt;/artifactId&gt;  
</span></span><span class=line><span class=cl>    &lt;/exclusion&gt;  
</span></span><span class=line><span class=cl>&lt;/exclusions&gt;
</span></span></code></pre></td></tr></table></div></div><p>然后是添加Log4j2的依赖：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;dependency&gt;
</span></span><span class=line><span class=cl>    &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;
</span></span><span class=line><span class=cl>    &lt;artifactId&gt;log4j-core&lt;/artifactId&gt;
</span></span><span class=line><span class=cl>    &lt;version&gt;2.11.2&lt;/version&gt;
</span></span><span class=line><span class=cl>&lt;/dependency&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;!-- web工程需要包含log4j-web，非web工程不需要 --&gt;
</span></span><span class=line><span class=cl>&lt;!-- 用来释放日志资源（关闭数据库连接，关闭文件等） --&gt;
</span></span><span class=line><span class=cl>&lt;dependency&gt;
</span></span><span class=line><span class=cl>    &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;
</span></span><span class=line><span class=cl>    &lt;artifactId&gt;log4j-web&lt;/artifactId&gt;
</span></span><span class=line><span class=cl>    &lt;version&gt;2.11.2&lt;/version&gt;
</span></span><span class=line><span class=cl>&lt;/dependency&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;!-- log4j2的异步日志AsyncLogger需要disruptor--&gt;
</span></span><span class=line><span class=cl>&lt;dependency&gt;
</span></span><span class=line><span class=cl>    &lt;groupId&gt;com.lmax&lt;/groupId&gt;
</span></span><span class=line><span class=cl>    &lt;artifactId&gt;disruptor&lt;/artifactId&gt;
</span></span><span class=line><span class=cl>    &lt;version&gt;3.4.2&lt;/version&gt;
</span></span><span class=line><span class=cl>&lt;/dependency&gt;
</span></span></code></pre></td></tr></table></div></div><p>关于log4j-web这个jar包，可以看看这个问答：<a href=https://segmentfault.com/q/1010000017777508 target=_blank rel="noopener noreffer">web项目中log4j2的log4j-web包如果不添加，会影响哪些日志输出？</a></p><p>接着是添加slf4j的依赖：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;dependency&gt;
</span></span><span class=line><span class=cl>    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
</span></span><span class=line><span class=cl>    &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;
</span></span><span class=line><span class=cl>    &lt;version&gt;1.7.13&lt;/version&gt;
</span></span><span class=line><span class=cl>&lt;/dependency&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;!-- 桥接slf4j和log4j2 --&gt;
</span></span><span class=line><span class=cl>&lt;dependency&gt;
</span></span><span class=line><span class=cl>    &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;
</span></span><span class=line><span class=cl>    &lt;artifactId&gt;log4j-slf4j-impl&lt;/artifactId&gt;
</span></span><span class=line><span class=cl>    &lt;version&gt;2.11.2&lt;/version&gt;
</span></span><span class=line><span class=cl>&lt;/dependency&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;!-- 下面的桥接包都是为了兼容第三方库的日志打印 --&gt;
</span></span><span class=line><span class=cl>&lt;!-- 将jcl桥接为slf4j --&gt;
</span></span><span class=line><span class=cl>&lt;dependency&gt;
</span></span><span class=line><span class=cl>    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
</span></span><span class=line><span class=cl>    &lt;artifactId&gt;jcl-over-slf4j&lt;/artifactId&gt;
</span></span><span class=line><span class=cl>    &lt;version&gt;1.7.13&lt;/version&gt;
</span></span><span class=line><span class=cl>&lt;/dependency&gt;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>&lt;!-- 将log4j桥接为slf4j --&gt;
</span></span><span class=line><span class=cl>&lt;dependency&gt;
</span></span><span class=line><span class=cl>    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
</span></span><span class=line><span class=cl>    &lt;artifactId&gt;log4j-over-slf4j&lt;/artifactId&gt;
</span></span><span class=line><span class=cl>    &lt;version&gt;1.7.13&lt;/version&gt;
</span></span><span class=line><span class=cl>&lt;/dependency&gt;
</span></span></code></pre></td></tr></table></div></div><p>最后是改变日志的配置文件，将<code>log4j.properties</code>替换成<code>log4j2.xml</code>。</p><p>下面是Log4j官方网站的迁移文档说明：</p><p><a href=https://logging.apache.org/log4j/2.x/manual/migration.html target=_blank rel="noopener noreffer">Migrating from Log4j 1.x</a></p><h2 id=springboot项目使用log4j2>SpringBoot项目使用Log4j2</h2><p>SpringBoot项目默认使用commons-logging + Logback，可以用下面的方式改为使用Log4j2：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>&lt;!-- use log4j2 instead of logback --&gt;
</span></span><span class=line><span class=cl>&lt;dependency&gt;
</span></span><span class=line><span class=cl>    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
</span></span><span class=line><span class=cl>    &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;
</span></span><span class=line><span class=cl>    &lt;exclusions&gt;
</span></span><span class=line><span class=cl>        &lt;exclusion&gt;
</span></span><span class=line><span class=cl>            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
</span></span><span class=line><span class=cl>            &lt;artifactId&gt;spring-boot-starter-logging&lt;/artifactId&gt;
</span></span><span class=line><span class=cl>        &lt;/exclusion&gt;
</span></span><span class=line><span class=cl>    &lt;/exclusions&gt;
</span></span><span class=line><span class=cl>&lt;/dependency&gt;
</span></span><span class=line><span class=cl>&lt;dependency&gt;
</span></span><span class=line><span class=cl>    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
</span></span><span class=line><span class=cl>    &lt;artifactId&gt;spring-boot-starter-log4j2&lt;/artifactId&gt;
</span></span><span class=line><span class=cl>&lt;/dependency&gt;
</span></span></code></pre></td></tr></table></div></div><h2 id=参考链接>参考链接</h2><ul><li><a href=https://blog.csdn.net/neosmith/article/details/50100061 target=_blank rel="noopener noreffer">Java日志框架中真的需要判断log.isDebugEnabled()吗？</a></li><li><a href=https://issues.apache.org/jira/browse/LOG4J2-1967 target=_blank rel="noopener noreffer">Unable to invoke factory method in class class org.apache.logging.log4j.core.appender.RollingFileAppender for element RollingFile</a></li><li><a href=http://logging.apache.org/log4j/2.x/manual/configuration.html target=_blank rel="noopener noreffer">Property Substitution</a></li><li><a href=https://stackoverflow.com/questions/37525996/can-i-run-my-log-asynchronously-using-log4j-1-x-with-log4j-properties-file# target=_blank rel="noopener noreffer">Can i run my log asynchronously using log4j 1.x with log4j.properties file?</a></li><li><a href=https://www.cnblogs.com/yeyang/p/7944899.html target=_blank rel="noopener noreffer">Log4j2中RollingFile的文件滚动更新机制</a></li><li><a href=https://www.jianshu.com/p/ee075bfc7dff target=_blank rel="noopener noreffer">log4j2定期生成和删除过期日志文件的配置</a></li><li><a href=https://www.cnblogs.com/bugzeroman/p/12858116.html target=_blank rel="noopener noreffer">Log4j2进阶使用(按大小时间备份日志)</a></li><li><a href=https://www.cnblogs.com/godtrue/p/6442347.html target=_blank rel="noopener noreffer">log4j（二）——如何控制日志信息的输出？</a></li><li><a href=https://www.cnblogs.com/yudar/p/5113655.html target=_blank rel="noopener noreffer">Log4j2配置文件详解</a></li><li><a href=https://stackoverflow.com/questions/25694782/log4j2-file-inclusion-include-and-included-similar-to-logback/30478905#30478905 target=_blank rel="noopener noreffer">Log4j2 File Inclusion : <include>and <included>similar to Logback</a></li><li><a href=https://zhuanlan.zhihu.com/p/89594636 target=_blank rel="noopener noreffer">Java日志Log4j或者Logback的NDC和MDC功能</a></li><li><a href=https://www.cnblogs.com/hafiz/p/6160298.html#autoid-2-0-0 target=_blank rel="noopener noreffer">使用Slf4j集成Log4j2构建项目日志系统的完美解决方案</a></li></ul><div class="details admonition warning open"><div class="details-summary admonition-title"><i class="icon fas fa-exclamation-triangle fa-fwwarning"></i>警告<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>本文最后更新于 <span class=timeago datetime=2022-02-27T23:23:54 title="February 27, 2022">February 27, 2022</span>，文中内容可能已过时，请谨慎使用。</div></div></div><div class=post-reward><input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>赞赏支持</label><div class=qr-code><label class=qr-code-image for=reward><img class=image src=https://lewky233.top/images/reward/wechat.png>
<span>微信打赏</span></label>
<label class=qr-code-image for=reward><img class=image src=https://lewky233.top/images/reward/alipay.png>
<span>支付宝打赏</span></label></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2022-02-27</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/posts/log4j2-issues/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://lewky233.top/posts/log4j2-issues/ data-title=Log4j、Log4j2问题汇总 data-hashtags=Log4j,Log4j2,工作记录><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://lewky233.top/posts/log4j2-issues/ data-hashtag=Log4j><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=https://lewky233.top/posts/log4j2-issues/ data-title=Log4j、Log4j2问题汇总><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://lewky233.top/posts/log4j2-issues/ data-title=Log4j、Log4j2问题汇总><i data-svg-src=https://unpkg.com/simple-icons@2.14.0/icons/line.svg></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://lewky233.top/posts/log4j2-issues/ data-title=Log4j、Log4j2问题汇总><i class="fab fa-weibo fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/log4j/>Log4j</a>,&nbsp;<a href=/tags/log4j2/>Log4j2</a>,&nbsp;<a href=/tags/%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/>工作记录</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/idea-issues/ class=prev rel=prev title=IDEA问题汇总><i class="fas fa-angle-left fa-fw"></i>IDEA问题汇总</a>
<a href=/posts/ireport-issues/ class=next rel=next title=iReport问题汇总>iReport问题汇总<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=waline></div><script src=/js/Waline.min.js></script>
<script>new Waline({el:"#waline",meta:["nick","mail","link"],requiredMeta:["nick","mail"],login:"force",placeholder:"为防恶意灌水攻击，评论前需注册并登录，望见谅~",serverURL:"https://comment.lewky233.top/",avatarCDN:"https://cravatar.cn/avatar/",pageSize:20,avatar:"retro",lang:"zh-CN",visitor:!0,highlight:!0,uploadImage:!1,emoji:["https://lewky233.top/images/emoji/嘉然今天吃什么","https://lewky233.top/images/emoji/大航海嘉然","https://lewky233.top/images/emoji/向晚大魔王","https://lewky233.top/images/emoji/贝拉kira","https://lewky233.top/images/emoji/珈乐Carol","https://lewky233.top/images/emoji/乃琳Queen","https://lewky233.top/images/emoji/EveOneCat","https://lewky233.top/images/emoji/weibo","https://lewky233.top/images/emoji/滑稽","https://lewky233.top/images/emoji/default"]})</script></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><span id=run-time></span>|
<a href=http://rssblog.vercel.app/ target=_blank rel=noopener title=RSSBlog><i class='fas fa-fw fa-inbox'></i>&nbsp;RSSBlog</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2018 - 2023</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>雨临Lewis</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp><a target=_blank href=http://www.beian.miit.gov.cn/ style=font-weight:700>粤ICP备19103822</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><div class=sidebar_wo><div id=leimu><img src=https://lewky233.top/images/b2t/leimuA.png alt=雷姆 onmouseover='this.src="https://lewky233.top/images/b2t/leimuB.png"' onmouseout='this.src="https://lewky233.top/images/b2t/leimuA.png"' title=回到顶部></div><div class=sidebar_wo id=lamu><img src=https://lewky233.top/images/b2t/lamuA.png alt=雷姆 onmouseover='this.src="https://lewky233.top/images/b2t/lamuB.png"' onmouseout='this.src="https://lewky233.top/images/b2t/lamuA.png"' title=回到底部></div></div><link rel=stylesheet href=https://unpkg.com/lightgallery.js@1.2.0/dist/css/lightgallery.min.css><script type=text/javascript src=https://unpkg.com/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://unpkg.com/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://unpkg.com/lightgallery.js@1.2.0/dist/js/lightgallery.min.js></script><script type=text/javascript src=https://unpkg.com/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js></script><script type=text/javascript src=https://unpkg.com/lg-zoom.js@1.2.0/dist/lg-zoom.min.js></script><script type=text/javascript src=https://unpkg.com/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://unpkg.com/sharer.js@0.4.0/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:30},comment:{},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript src=https://unpkg.com/jquery@2.1.3/dist/jquery.min.js></script><script type=text/javascript src=https://unpkg.com/jquery-backstretch@2.1.18/jquery.backstretch.min.js></script><script>var $cdnPrefix="https://lewky233.top"</script>
<script type=text/javascript src=/js/custom.js></script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?6f278ed0fdb01edb3b1e7398379e5432",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script></body></html>