<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>PostgreSQL - DML操作汇总 - Yulin Lewis' Blog</title><meta name=keywords content="雨临Lewis,Java,hugo,hexo,博客"><meta name=Description content="不想当写手的码农不是好咸鱼_(xз」∠)_"><meta property="og:title" content="PostgreSQL - DML操作汇总"><meta property="og:description" content="匿名函数
DO关键字
pl/pgsql即Procedural Language/ Postgres SQL(过程化sql语言)，是Postgresql数据库对sql语句的扩展，可以在pl/pgsql代码块内定义多条sql语句，每条语句以分号结束，代码块由begin开始，end结束，代码块的最后一个end可以不加分号。"><meta property="og:type" content="article"><meta property="og:url" content="https://lewky.cn/posts/postgresql-dml/"><meta property="og:image" content="https://lewky.cn/logo.png"><meta property="article:published_time" content="2021-12-07T23:43:17+08:00"><meta property="article:modified_time" content="2022-03-19T23:43:17+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://lewky.cn/logo.png"><meta name=twitter:title content="PostgreSQL - DML操作汇总"><meta name=twitter:description content="匿名函数
DO关键字
pl/pgsql即Procedural Language/ Postgres SQL(过程化sql语言)，是Postgresql数据库对sql语句的扩展，可以在pl/pgsql代码块内定义多条sql语句，每条语句以分号结束，代码块由begin开始，end结束，代码块的最后一个end可以不加分号。"><meta name=application-name content="雨临Lewis的博客"><meta name=apple-mobile-web-app-title content="雨临Lewis的博客"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://lewky.cn/posts/postgresql-dml/><link rel=prev href=https://lewky.cn/posts/navicat/><link rel=next href=https://lewky.cn/posts/windows-netstat/><link rel=stylesheet href=https://unpkg.com/normalize.css@8.0.1/normalize.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://unpkg.com/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://unpkg.com/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"PostgreSQL - DML操作汇总","inLanguage":"","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/lewky.cn\/posts\/postgresql-dml\/"},"genre":"posts","keywords":"工作记录","wordcount":2015,"url":"https:\/\/lewky.cn\/posts\/postgresql-dml\/","datePublished":"2021-12-07T23:43:17+08:00","dateModified":"2022-03-19T23:43:17+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"雨临Lewis","logo":"https:\/\/lewky.cn\/images\/avatar.jpg"},"author":{"@type":"Person","name":"雨临Lewis"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><a href=https://github.com/lewky class=github-corner target=_blank title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="3.5rem" height="3.5rem" viewBox="0 0 250 250" style="fill:#70b7fd;color:#fff;position:absolute;top:0;border:0;left:0;transform:scale(-1,1)" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div class=header-title><a href=/ title="Yulin Lewis' Blog"><span class=header-title-pre><i class="fas fa-fw fa-atom"></i></span>雨临Lewis</a></div><div class=menu><div class=menu-inner><div class=dropdown><a href=/posts/ class="menu-item menu-more dropbtn" title=点击查看所有文章><i class="fas fa-fw fa-archive"></i>归档</a><div class="menu-more-content dropdown-content"><a href=/categories/><i class="fas fa-fw fa-th"></i>分类 </a><a href=/tags/><i class="fas fa-fw fa-tag"></i>标签 </a><a href=/about/><i class="fas fa-fw fa-at"></i>关于</a></div></div><a class=menu-item href=/friends/ title=欢迎申请友链><i class="fas fa-fw fa-link"></i>友链</a><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn" title=一些有意思的东东~><i class="fas fa-fw fa-fan fa-spin"></i>趣味</a><div class="menu-more-content dropdown-content"><a href=/funny/high/ title="前方高能♂ 小心外放！" target=_blank rel=noopener><i class="fas fa-fw fa-dizzy"></i>燥起来！ </a><a href=/funny/mikutap/ title=初音未来音乐游戏 target=_blank rel=noopener><i class="fas fa-fw fa-music"></i>在线打碟 </a><a href=/funny/catch-the-cat/ title=逮住那只猫!><i class="fas fa-fw fa-cat"></i>抓住猫咪</a></div></div><div class=dropdown><a href=/ class="menu-item menu-more dropbtn" title=回到首页><i class="fas fa-fw fa-atom"></i>站点</a><div class="menu-more-content dropdown-content"><a href=/bbs/ title=来留言吧~><i class="fas fa-fw fa-comment"></i>公告留言 </a><a href=https://seo.chinaz.com target=_blank rel=noopener><i class="fas fa-fw fa-chart-line"></i>SEO查询 </a><a href=https://www.ping.cn/http/lewky.cn target=_blank rel=noopener><i class="fas fa-fw fa-bezier-curve"></i>网站测速 </a><a href=/posts/e62c38c4.html/><i class="fas fa-fw fa-cog fa-spin"></i>建站日志</a></div></div><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn"><i class="fas fa-fw fa-book"></i>文档</a><div class="menu-more-content dropdown-content"><a href=https://gohugo.io/documentation/ target=_blank rel=noopener><i class="fas fa-fw fa-star"></i>Hugo文档 </a><a href=https://javanote.doc.lewky.cn/ title=尚在完善中~ target=_blank rel=noopener><i class="fab fa-fw fa-java"></i>Java 笔记</a></div></div><a class=menu-item href=/search/ title=渲染搜索结果需要等待几秒钟~><i class="fas fa-fw fa-search"></i>搜索
</a><span class="menu-item delimiter"></span><a href=https://travellings.link target=_blank class=menu-item rel=noopener title=开往-友链接力><i class="fas fa-fw fa-subway"></i></a><a href=https://rssblog.vercel.app/ class=menu-item target=_blank rel=noopener title=RSSBlog><i class="fas fa-fw fa-inbox"></i></a><a href=https://github.com/lewky class=menu-item target=_blank rel=noopener title=GitHub><i class="fab fa-fw fa-github"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Yulin Lewis' Blog"><span class=header-title-pre><i class="fas fa-fw fa-atom"></i></span>雨临Lewis</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=dropdown><a href=/posts/ class="menu-item menu-more dropbtn" title=点击查看所有文章><i class="fas fa-fw fa-archive"></i>归档</a><div class="menu-more-content dropdown-content"><a href=/categories/><i class="fas fa-fw fa-th"></i>分类 </a><a href=/tags/><i class="fas fa-fw fa-tag"></i>标签 </a><a href=/about/><i class="fas fa-fw fa-at"></i>关于</a></div></div><a class=menu-item href=/friends/ title=欢迎申请友链><i class="fas fa-fw fa-link"></i>友链</a><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn" title=一些有意思的东东~><i class="fas fa-fw fa-fan fa-spin"></i>趣味</a><div class="menu-more-content dropdown-content"><a href=/funny/high/ title="前方高能♂ 小心外放！" target=_blank rel=noopener><i class="fas fa-fw fa-dizzy"></i>燥起来！ </a><a href=/funny/mikutap/ title=初音未来音乐游戏 target=_blank rel=noopener><i class="fas fa-fw fa-music"></i>在线打碟 </a><a href=/funny/catch-the-cat/ title=逮住那只猫!><i class="fas fa-fw fa-cat"></i>抓住猫咪</a></div></div><div class=dropdown><a href=/ class="menu-item menu-more dropbtn" title=回到首页><i class="fas fa-fw fa-atom"></i>站点</a><div class="menu-more-content dropdown-content"><a href=/bbs/ title=来留言吧~><i class="fas fa-fw fa-comment"></i>公告留言 </a><a href=https://seo.chinaz.com target=_blank rel=noopener><i class="fas fa-fw fa-chart-line"></i>SEO查询 </a><a href=https://www.ping.cn/http/lewky.cn target=_blank rel=noopener><i class="fas fa-fw fa-bezier-curve"></i>网站测速 </a><a href=/posts/e62c38c4.html/><i class="fas fa-fw fa-cog fa-spin"></i>建站日志</a></div></div><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn"><i class="fas fa-fw fa-book"></i>文档</a><div class="menu-more-content dropdown-content"><a href=https://gohugo.io/documentation/ target=_blank rel=noopener><i class="fas fa-fw fa-star"></i>Hugo文档 </a><a href=https://javanote.doc.lewky.cn/ title=尚在完善中~ target=_blank rel=noopener><i class="fab fa-fw fa-java"></i>Java 笔记</a></div></div><a class=menu-item href=/search/ title=渲染搜索结果需要等待几秒钟~><i class="fas fa-fw fa-search"></i>搜索</a>
<a href=https://travellings.link target=_blank class=menu-item rel=noopener title=开往-友链接力><i class="fas fa-fw fa-subway"></i></a><a href=https://rssblog.vercel.app/ class=menu-item target=_blank rel=noopener title=RSSBlog><i class="fas fa-fw fa-inbox"></i></a><a href=https://github.com/lewky class=menu-item target=_blank rel=noopener title=GitHub><i class="fab fa-fw fa-github"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">PostgreSQL - DML操作汇总</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>雨临Lewis</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/postgresql/><i class="far fa-folder fa-fw"></i>PostgreSQL</a></span></div><div class=post-meta-line><i class="far fa-calendar fa-fw"></i>&nbsp;<time datetime=2021-12-07>2021-12-07</time>&nbsp;<i class="far fa-calendar-plus fa-fw"></i>&nbsp;<time datetime=2022-03-19>2022-03-19</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 2015 字
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 5 分钟&nbsp;<span id=/posts/postgresql-dml/ class=leancloud_visitors data-flag-title="PostgreSQL - DML操作汇总">
<i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
</span>&nbsp;
<a href=#comments id=post-meta-vcount title=查看评论><i class="fas fa-comment fa-fw"></i>&nbsp;<span id=/posts/postgresql-dml/ class=waline-comment-count></span>&nbsp;条评论</a></div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ol><li><a href=#匿名函数>匿名函数</a><ol><li><a href=#do关键字>DO关键字</a></li><li><a href=#code>code</a></li><li><a href=#lang_name>lang_name</a></li><li><a href=#一个例子>一个例子</a></li></ol></li><li><a href=#遍历数据变量赋值>遍历数据，变量赋值</a></li><li><a href=#插入其他表的数据>插入其他表的数据</a></li><li><a href=#修改多个列的值>修改多个列的值</a></li><li><a href=#update语句怎么关联其他表>update语句怎么关联其他表</a><ol><li><a href=#postgresql中正确的多表关联update写法>PostgreSQL中正确的多表关联update写法</a></li></ol></li><li><a href=#参考链接>参考链接</a></li></ol></nav></div></div><div class=content id=content><h2 id=匿名函数>匿名函数</h2><h3 id=do关键字>DO关键字</h3><p>pl/pgsql即Procedural Language/ Postgres SQL(过程化sql语言)，是Postgresql数据库对sql语句的扩展，可以在pl/pgsql代码块内定义多条sql语句，每条语句以分号结束，代码块由begin开始，end结束，代码块的最后一个end可以不加分号。</p><p>DO关键字用来执行一段匿名代码块，即在在程序语言过程中一次性执行的匿名函数。代码块可以看做是一段没有参数、没有返回值的函数体。其格式如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sql data-lang=sql><span class=k>DO</span> <span class=p>[</span><span class=k>LANGUAGE</span> <span class=n>lang_name</span><span class=p>]</span> <span class=n>code</span><span class=p>;</span>
</code></pre></td></tr></table></div></div><h3 id=code>code</h3><p>code block代码块实际上为一个字符串，可以用"美元符引用”<code>$$</code>书写字符串常量，<code>$$</code>中间可以包含标签名，可以自由命名，但是不能以数字开头，可以命名为<code>$$，$_$，$a$，$a1$...</code>，该标签名必须成对出现，且大小写敏感。</p><p>用DECLARE声明变量(如果不需要声明变量可以不写declare)，用BEGIN和END包括需要执行的代码/sql语句，每个语句末尾需要加上分号，BEGIN不加分号，代码块最后一个END后可以省略分号；其格式如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sql data-lang=sql><span class=k>DO</span> <span class=err>$</span><span class=n>body$</span>
<span class=k>BEGIN</span>
  <span class=k>update</span> <span class=n>student</span> <span class=k>set</span> <span class=n>name</span> <span class=o>=</span> <span class=s1>&#39;张小明&#39;</span> <span class=k>where</span> <span class=n>id</span> <span class=o>=</span> <span class=mi>10010</span><span class=p>;</span>
<span class=k>END</span>
<span class=err>$</span><span class=n>body$</span><span class=p>;</span>
</code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sql data-lang=sql><span class=k>DO</span> <span class=err>$</span><span class=n>body$</span>
<span class=k>DECLARE</span>
  <span class=n>NEW_NAME</span> <span class=nb>varchar</span><span class=p>(</span><span class=mi>100</span><span class=p>);</span>
<span class=k>BEGIN</span>
  <span class=n>NEW_NAME</span><span class=p>:</span><span class=o>=</span><span class=s1>&#39;张&#39;</span><span class=o>||</span><span class=s1>&#39;小明&#39;</span><span class=p>;</span>
  <span class=k>update</span> <span class=n>student</span> <span class=k>set</span> <span class=n>name</span> <span class=o>=</span> <span class=n>NEW_NAME</span> <span class=k>where</span> <span class=n>id</span> <span class=o>=</span> <span class=mi>10010</span><span class=p>;</span>
<span class=k>END</span>
<span class=err>$</span><span class=n>body$</span><span class=p>;</span>
</code></pre></td></tr></table></div></div><h3 id=lang_name>lang_name</h3><p>用来解析code的程序语言的名字，如果缺省，默认为plpgsql，lang_name可以写在code前，也可以写在code后，即</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sql data-lang=sql><span class=k>DO</span> <span class=n>code</span><span class=p>;</span>
</code></pre></td></tr></table></div></div><p>等效于下边的</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sql data-lang=sql><span class=k>DO</span> <span class=k>LANGUAGE</span> <span class=n>PLPGSQL</span> <span class=n>code</span><span class=p>;</span>
</code></pre></td></tr></table></div></div><p>或者</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sql data-lang=sql><span class=k>DO</span> <span class=n>code</span> <span class=k>LANGUAGE</span> <span class=n>PLPGSQL</span><span class=p>;</span>
</code></pre></td></tr></table></div></div><p>这里的code指的是代码块，也就是上边说的内容格式。</p><h3 id=一个例子>一个例子</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sql data-lang=sql><span class=k>DO</span> <span class=err>$</span><span class=n>body$</span>
<span class=k>DECLARE</span>
  <span class=n>SIZES_VALUE</span> <span class=nb>varchar</span><span class=p>(</span><span class=mi>1000</span><span class=p>);</span>
  <span class=n>MEASUREMENT_TEMPLATE</span> <span class=n>RECORD</span><span class=p>;</span>

<span class=k>BEGIN</span>
  <span class=k>FOR</span> <span class=n>MEASUREMENT_TEMPLATE</span> <span class=k>IN</span> <span class=p>(</span><span class=k>SELECT</span> <span class=n>ID</span> <span class=k>FROM</span> <span class=n>CNT_MEASUREMENT_TEMPLATE</span> <span class=k>WHERE</span> <span class=n>DOMAIN_ID</span> <span class=k>IN</span> <span class=p>(</span><span class=s1>&#39;/&#39;</span><span class=p>,</span><span class=s1>&#39;RD1&#39;</span><span class=p>,</span><span class=s1>&#39;RD2&#39;</span><span class=p>)</span> <span class=k>AND</span> <span class=n>IS_LATEST</span> <span class=o>=</span> <span class=k>TRUE</span> <span class=k>AND</span> <span class=p>(</span><span class=n>SIZES</span> <span class=k>IS</span> <span class=k>NULL</span> <span class=k>OR</span> <span class=n>SIZES</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span><span class=p>))</span>
    <span class=n>LOOP</span>
      <span class=c1>-------- split sizes value from CNT_MEASUREMENT_TEMPLATE_SIZE order by seq_no --------
</span><span class=c1></span>      <span class=n>SIZES_VALUE</span> <span class=o>=</span> <span class=p>(</span><span class=k>SELECT</span> <span class=n>ARRAY_TO_STRING</span><span class=p>(</span><span class=nb>ARRAY</span><span class=p>(</span><span class=k>SELECT</span> <span class=n>ALT_LABEL</span><span class=o>||</span><span class=k>CASE</span> <span class=k>WHEN</span> <span class=n>COALESCE</span><span class=p>(</span><span class=n>LABEL</span><span class=p>,</span><span class=s1>&#39;&#39;</span><span class=p>)</span> <span class=o>=</span> <span class=s1>&#39;&#39;</span> <span class=k>THEN</span> <span class=s1>&#39;&#39;</span> <span class=k>ELSE</span> <span class=s1>&#39;(&#39;</span><span class=o>||</span><span class=n>LABEL</span><span class=o>||</span><span class=s1>&#39;)&#39;</span> <span class=k>END</span> <span class=k>FROM</span> <span class=n>CNT_MEASUREMENT_TEMPLATE_SIZE</span> 
      	<span class=k>WHERE</span> <span class=n>PARENT_ID</span> <span class=o>=</span> <span class=n>MEASUREMENT_TEMPLATE</span><span class=p>.</span><span class=n>ID</span> <span class=k>ORDER</span> <span class=k>BY</span> <span class=n>SEQ_NO</span><span class=p>),</span><span class=s1>&#39;, &#39;</span><span class=p>));</span>

      <span class=c1>-------- set sizes value for cnt_measurement_template whose sizes value is null or &#39;&#39; --------
</span><span class=c1></span>	  <span class=k>UPDATE</span> <span class=n>CNT_MEASUREMENT_TEMPLATE</span> <span class=k>SET</span> <span class=n>SIZES</span> <span class=o>=</span> <span class=n>SIZES_VALUE</span> <span class=k>WHERE</span> <span class=n>ID</span> <span class=o>=</span> <span class=n>MEASUREMENT_TEMPLATE</span><span class=p>.</span><span class=n>ID</span><span class=p>;</span>
	  
    <span class=k>END</span> <span class=n>LOOP</span><span class=p>;</span>
<span class=k>END</span><span class=p>;</span>
<span class=err>$</span><span class=n>body$</span> <span class=k>LANGUAGE</span> <span class=n>PLPGSQL</span><span class=p>;</span>
</code></pre></td></tr></table></div></div><h2 id=遍历数据变量赋值>遍历数据，变量赋值</h2><p>遍历操作以及变量赋值操作需要在匿名函数脚本中使用，且匿名函数在执行时必须显示开启事务。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sql data-lang=sql><span class=k>begin</span><span class=p>;</span>

<span class=k>DO</span> <span class=err>$</span><span class=n>body$</span>
<span class=k>declare</span>
<span class=n>targetId</span> <span class=n>bpchar</span><span class=p>(</span><span class=mi>32</span><span class=p>);</span>
<span class=n>update_sr</span> <span class=n>RECORD</span><span class=p>;</span>
<span class=k>begin</span>

    <span class=c1>--遍历表中符合条件的数据
</span><span class=c1></span>	<span class=k>for</span> <span class=n>update_sr</span> <span class=k>in</span> <span class=p>(</span>
        <span class=k>select</span> <span class=n>temp</span><span class=p>.</span><span class=o>*</span> <span class=k>from</span> <span class=n>tab_test</span> <span class=n>temp</span>
        <span class=k>inner</span> <span class=k>join</span> <span class=n>tab_student</span> <span class=n>sr</span> <span class=k>on</span> <span class=n>sr</span><span class=p>.</span><span class=n>id</span> <span class=o>=</span> <span class=n>temp</span><span class=p>.</span><span class=n>id</span>
        <span class=k>where</span> <span class=n>sr</span><span class=p>.</span><span class=n>is_latest</span> <span class=k>is</span> <span class=k>true</span>
	<span class=p>)</span>
	<span class=n>loop</span>

        <span class=k>select</span> <span class=k>max</span><span class=p>(</span><span class=n>id</span><span class=p>)</span> <span class=k>into</span> <span class=n>targetId</span> <span class=k>from</span> <span class=n>tab_student</span> <span class=k>where</span> <span class=n>ref_no</span> <span class=o>=</span> <span class=n>update_sr</span><span class=p>.</span><span class=n>ref_no</span><span class=p>;</span>

        <span class=k>if</span> <span class=n>targetId</span> <span class=k>is</span> <span class=k>not</span> <span class=k>null</span> <span class=k>then</span>
        
            <span class=c1>--操作数据等
</span><span class=c1></span>        
        <span class=k>end</span> <span class=k>if</span><span class=p>;</span>
        
    <span class=k>end</span> <span class=n>loop</span><span class=p>;</span>
<span class=k>END</span><span class=p>;</span>
<span class=err>$</span><span class=n>body$</span> <span class=k>LANGUAGE</span> <span class=n>PLPGSQL</span><span class=p>;</span>

<span class=k>commit</span><span class=p>;</span>
</code></pre></td></tr></table></div></div><p>上面的脚本中使用了<code>for loop</code>来遍历数据，需要注意的是，在遍历时会将数据缓存起来，如果在遍历时改变了被遍历的数据，是不会影响到被缓存的数据的。如果此时需要使用到被更改的值，只能通过赋值给临时变量来获取到被更改的值。</p><p>在变量赋值时，可以用<code>select max(xx) into</code>的写法。使用<code>max()</code>的目的是，如果select不到数据则会返回null，避免在变量赋值时出错。</p><h2 id=插入其他表的数据>插入其他表的数据</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sql data-lang=sql><span class=k>INSERT</span> <span class=k>INTO</span> <span class=n>tab_test</span>
<span class=p>(</span><span class=n>id</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>ref_no</span><span class=p>,</span> <span class=k>version</span><span class=p>)</span>
<span class=k>select</span> <span class=n>id</span><span class=p>,</span> <span class=n>name</span><span class=p>,</span> <span class=n>ref_no</span><span class=p>,</span> <span class=k>version</span>
<span class=k>from</span> <span class=n>tab_student</span><span class=p>;</span>
</code></pre></td></tr></table></div></div><p>使用<code>insert into ... select from ...</code>来插入其他表的数据，也可以是同一个表，但此时需要起表别名来区分数据。且这种写法，需要两个表都存在才行。</p><h2 id=修改多个列的值>修改多个列的值</h2><p>在修改的列数量较少时，可以用下面的写法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sql data-lang=sql><span class=k>update</span> <span class=n>tab_test</span> <span class=k>set</span> <span class=n>name</span> <span class=o>=</span> <span class=s1>&#39;new name&#39;</span><span class=p>,</span> <span class=n>ref_no</span> <span class=o>=</span> <span class=s1>&#39;new ref_no&#39;</span> <span class=k>where</span> <span class=n>id</span> <span class=o>=</span> <span class=s1>&#39;1&#39;</span><span class=p>;</span>
</code></pre></td></tr></table></div></div><p>如果列非常多时，比如同时改几十上百个，可以用下面的写法简单点：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sql data-lang=sql><span class=k>update</span> <span class=n>tab_test</span> <span class=k>set</span> <span class=p>(</span><span class=n>name</span><span class=p>,</span> <span class=n>ref_no</span><span class=p>,</span> <span class=k>version</span><span class=p>)</span>
<span class=o>=</span> <span class=p>(</span><span class=s1>&#39;new name&#39;</span><span class=p>,</span> <span class=s1>&#39;new ref_no&#39;</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
<span class=k>where</span> <span class=n>id</span> <span class=o>=</span> <span class=s1>&#39;1&#39;</span><span class=p>;</span>
</code></pre></td></tr></table></div></div><h2 id=update语句怎么关联其他表>update语句怎么关联其他表</h2><p>PostgreSQL的update语句关联外表的写法与MySQL不同，不能直接通过join/outer join来关联其他表，就算使用update+join不会报错，join的那部分其实也不会有任何效果，如下所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sql data-lang=sql><span class=k>update</span> <span class=n>a</span>
<span class=k>set</span> <span class=n>value</span> <span class=o>=</span> <span class=s1>&#39;test&#39;</span>
<span class=k>from</span> <span class=n>a</span>
<span class=k>join</span> <span class=n>b</span> <span class=k>on</span> <span class=n>a</span><span class=p>.</span><span class=n>b_id</span> <span class=o>=</span> <span class=n>b</span><span class=p>.</span><span class=n>id</span>
<span class=k>join</span> <span class=k>c</span> <span class=k>on</span> <span class=n>b</span><span class=p>.</span><span class=n>c_id</span> <span class=o>=</span> <span class=k>c</span><span class=p>.</span><span class=n>id</span>
<span class=k>where</span>
<span class=n>a</span><span class=p>.</span><span class=k>key</span> <span class=o>=</span> <span class=s1>&#39;test&#39;</span>
<span class=k>and</span> <span class=k>c</span><span class=p>.</span><span class=n>value</span> <span class=o>=</span> <span class=s1>&#39;test&#39;</span><span class=p>;</span>
</code></pre></td></tr></table></div></div><p>上边的sql本意是a、b、c三表关联，当c的value是&rsquo;test&rsquo;且a的key也是&rsquo;test&rsquo;的时候，就将a的value也改为&rsquo;test&rsquo;。</p><p>但实际上这个sql有大问题，这里的join和where条件并没有意义，一旦update成功，你会发现，a表内的所有数据的value都被改成了<code>test</code>！！要么update 0条数据，要么全部update！至于是哪种结果，这要看where的条件，目前还不清楚为什么会这样。因为这种写法本身就是<strong>不对的</strong>！</p><h3 id=postgresql中正确的多表关联update写法>PostgreSQL中正确的多表关联update写法</h3><p>在update语句中不应该通过join来进行多表关联，而是要<strong>通过from来多表关联</strong>，如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sql data-lang=sql><span class=k>update</span> <span class=n>a</span>
<span class=k>set</span> <span class=n>value</span> <span class=o>=</span> <span class=s1>&#39;test&#39;</span>
<span class=k>from</span> <span class=n>b</span><span class=p>,</span><span class=k>c</span>
<span class=k>where</span>
<span class=n>a</span><span class=p>.</span><span class=n>b_id</span> <span class=o>=</span> <span class=n>b</span><span class=p>.</span><span class=n>id</span>
<span class=k>and</span> <span class=n>b</span><span class=p>.</span><span class=n>c_id</span> <span class=o>=</span> <span class=k>c</span><span class=p>.</span><span class=n>id</span>
<span class=k>and</span> <span class=n>a</span><span class=p>.</span><span class=k>key</span> <span class=o>=</span> <span class=s1>&#39;test&#39;</span>
<span class=k>and</span> <span class=k>c</span><span class=p>.</span><span class=n>value</span> <span class=o>=</span> <span class=s1>&#39;test&#39;</span><span class=p>;</span>
</code></pre></td></tr></table></div></div><p>通过from来多表关联，而关联条件则是放到了where中，这样就可以达到我们想要的效果了。另外补充一句，对于<code>set xxx = 'xxx'</code>这个update的部分，是不可以在column字段前加上表前缀的，比如下边的写法就是有语法错误的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sql data-lang=sql><span class=k>update</span> <span class=n>a</span>
<span class=k>set</span> <span class=n>a</span><span class=p>.</span><span class=n>value</span> <span class=o>=</span> <span class=s1>&#39;test&#39;</span><span class=p>;</span>
</code></pre></td></tr></table></div></div><p>此外，update语句也可以连接自身的表，只要起了表别名将二者区分开来就行。</p><h2 id=参考链接>参考链接</h2><ul><li><a href=https://www.cnblogs.com/wangzhen3798/p/7630597.html target=_blank rel="noopener noreffer">PostgreSQL数据库PL/PGSQL学习使用</a></li><li><a href=https://www.2cto.com/database/201505/399624.html target=_blank rel="noopener noreffer">PostgreSQL中的DO-有条件的创建函数</a></li><li><a href=https://www.e-learn.cn/content/wangluowenzhang/36970 target=_blank rel="noopener noreffer">How to do an update + join in PostgreSQL?</a></li></ul><div class="details admonition warning open"><div class="details-summary admonition-title"><i class="icon fas fa-exclamation-triangle fa-fwwarning"></i>警告<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>本文最后更新于 <span class=timeago datetime=2022-03-19T23:43:17 title="March 19, 2022">March 19, 2022</span>，文中内容可能已过时，请谨慎使用。</div></div></div><div class=post-reward><input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>赞赏支持</label><div class=qr-code><label class=qr-code-image for=reward><img class=image src=https://lewky.cn/images/reward/wechat.png>
<span>微信打赏</span></label>
<label class=qr-code-image for=reward><img class=image src=https://lewky.cn/images/reward/alipay.png>
<span>支付宝打赏</span></label></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2022-03-19</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/posts/postgresql-dml/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://lewky.cn/posts/postgresql-dml/ data-title="PostgreSQL - DML操作汇总" data-hashtags=工作记录><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://lewky.cn/posts/postgresql-dml/ data-hashtag=工作记录><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=https://lewky.cn/posts/postgresql-dml/ data-title="PostgreSQL - DML操作汇总"><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://lewky.cn/posts/postgresql-dml/ data-title="PostgreSQL - DML操作汇总"><i data-svg-src=https://unpkg.com/simple-icons@2.14.0/icons/line.svg></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://lewky.cn/posts/postgresql-dml/ data-title="PostgreSQL - DML操作汇总"><i class="fab fa-weibo fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/>工作记录</a></section><section><span><a href=javascript:void(0); onclick=window.history.back();>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/navicat/ class=prev rel=prev title=Navicat使用汇总><i class="fas fa-angle-left fa-fw"></i>Navicat使用汇总</a>
<a href=/posts/windows-netstat/ class=next rel=next title=Windows查询被占用的端口>Windows查询被占用的端口<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=waline></div><script src=/js/Waline.min.js></script><script>new Waline({el:'#waline',meta:["nick","mail","link"],requiredMeta:["nick","mail"],login:"force",placeholder:"为防恶意灌水攻击，评论前需注册并登录，望见谅~",serverURL:"https://comment.lewky.cn/",avatarCDN:"https://cdn.sep.cc/avatar/",pageSize:20,avatar:"retro",lang:"zh-CN",visitor:true,highlight:true,uploadImage:false,emoji:['https:\/\/lewky.cn/images/emoji/嘉然今天吃什么','https:\/\/lewky.cn/images/emoji/大航海嘉然','https:\/\/lewky.cn/images/emoji/向晚大魔王','https:\/\/lewky.cn/images/emoji/贝拉kira','https:\/\/lewky.cn/images/emoji/珈乐Carol','https:\/\/lewky.cn/images/emoji/乃琳Queen','https:\/\/lewky.cn/images/emoji/EveOneCat','https:\/\/lewky.cn/images/emoji/weibo','https:\/\/lewky.cn/images/emoji/滑稽','https:\/\/lewky.cn/images/emoji/default']});</script></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><span id=run-time></span>|
<a href=http://rssblog.vercel.app/ target=_blank rel=noopener title=RSSBlog><i class="fas fa-fw fa-inbox"></i>&nbsp;RSSBlog</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2018 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>雨临Lewis</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp><a target=_blank href=http://www.beian.miit.gov.cn/ style=font-weight:700>粤ICP备19103822</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><div class=sidebar_wo><div id=leimu><img src=https://lewky.cn/images/b2t/leimuA.png alt=雷姆 onmouseover="this.src='https:\/\/lewky.cn/images/b2t/leimuB.png'" onmouseout="this.src='https:\/\/lewky.cn/images/b2t/leimuA.png'" title=回到顶部></div><div class=sidebar_wo id=lamu><img src=https://lewky.cn/images/b2t/lamuA.png alt=雷姆 onmouseover="this.src='https:\/\/lewky.cn/images/b2t/lamuB.png'" onmouseout="this.src='https:\/\/lewky.cn/images/b2t/lamuA.png'" title=回到底部></div></div><link rel=stylesheet href=https://unpkg.com/lightgallery.js@1.2.0/dist/css/lightgallery.min.css><script type=text/javascript src=https://unpkg.com/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://unpkg.com/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://unpkg.com/lightgallery.js@1.2.0/dist/js/lightgallery.min.js></script><script type=text/javascript src=https://unpkg.com/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js></script><script type=text/javascript src=https://unpkg.com/lg-zoom.js@1.2.0/dist/lg-zoom.min.js></script><script type=text/javascript src=https://unpkg.com/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://unpkg.com/sharer.js@0.4.0/sharer.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":30},"comment":{},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true}};</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript src=https://unpkg.com/jquery@2.1.3/dist/jquery.min.js></script><script type=text/javascript src=https://unpkg.com/jquery-backstretch@2.1.18/jquery.backstretch.min.js></script><script>var $cdnPrefix="https://lewky.cn";</script><script type=text/javascript src=/js/custom.js></script><script>var _hmt=_hmt||[];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?6f278ed0fdb01edb3b1e7398379e5432";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script></body></html>