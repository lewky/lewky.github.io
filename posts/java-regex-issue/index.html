<!doctype html><html lang><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>由Java正则表达式的灾难性回溯引发的高CPU异常：java.util.regex.Pattern$Loop.match - Yulin Lewis' Blog</title><meta name=keywords content="雨临Lewis,Java,hugo,hexo,博客"><meta name=Description content="不想当写手的码农不是好咸鱼_(xз」∠)_"><meta property="og:title" content="由Java正则表达式的灾难性回溯引发的高CPU异常：java.util.regex.Pattern$Loop.match"><meta property="og:description" content="问题与分析
某天领导report了一个问题：线上的CPU自从上一个版本迭代后就一直处于居高不下的状况，领导看着这段时间的曲线图判断是有两条线程在不停的死循环。
接到任务后去查看了AWS的CloudWatch，发现线上CPU确实一直居高不下，使用率基本是之前的两倍；另外发现线程使用率以比之前频繁很多。后来公司的大佬拿到dump后经过分析发现，是由正则表达式造成的CPU持续高使用率的问题。"><meta property="og:type" content="article"><meta property="og:url" content="https://lewky233.top/posts/java-regex-issue/"><meta property="og:image" content="https://lewky233.top/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-10-09T20:11:45+08:00"><meta property="article:modified_time" content="2022-11-14T20:11:45+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://lewky233.top/logo.png"><meta name=twitter:title content="由Java正则表达式的灾难性回溯引发的高CPU异常：java.util.regex.Pattern$Loop.match"><meta name=twitter:description content="问题与分析
某天领导report了一个问题：线上的CPU自从上一个版本迭代后就一直处于居高不下的状况，领导看着这段时间的曲线图判断是有两条线程在不停的死循环。
接到任务后去查看了AWS的CloudWatch，发现线上CPU确实一直居高不下，使用率基本是之前的两倍；另外发现线程使用率以比之前频繁很多。后来公司的大佬拿到dump后经过分析发现，是由正则表达式造成的CPU持续高使用率的问题。"><meta name=application-name content="雨临Lewis的博客"><meta name=apple-mobile-web-app-title content="雨临Lewis的博客"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://lewky233.top/posts/java-regex-issue/><link rel=prev href=https://lewky233.top/posts/1411dcba.html/><link rel=next href=https://lewky233.top/posts/sql-issues/><link rel=stylesheet href=https://unpkg.com/normalize.css@8.0.1/normalize.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://unpkg.com/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://unpkg.com/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"由Java正则表达式的灾难性回溯引发的高CPU异常：java.util.regex.Pattern$Loop.match","inLanguage":"","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/lewky233.top\/posts\/java-regex-issue\/"},"genre":"posts","keywords":"Java, 正则表达式, 工作记录","wordcount":4515,"url":"https:\/\/lewky233.top\/posts\/java-regex-issue\/","datePublished":"2019-10-09T20:11:45+08:00","dateModified":"2022-11-14T20:11:45+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"雨临Lewis","logo":"https:\/\/lewky233.top\/images\/avatar.jpg"},"author":{"@type":"Person","name":"雨临Lewis"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><a href=https://github.com/lewky class=github-corner target=_blank title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="3.5rem" height="3.5rem" viewBox="0 0 250 250" style="fill:#70b7fd;color:#fff;position:absolute;top:0;border:0;left:0;transform:scale(-1,1)" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div class=header-title><a href=/ title="Yulin Lewis' Blog"><span class=header-title-pre><i class='fas fa-fw fa-atom'></i></span>雨临Lewis</a></div><div class=menu><div class=menu-inner><div class=dropdown><a href=/posts/ class="menu-item menu-more dropbtn" title=点击查看所有文章><i class='fas fa-fw fa-archive'></i> 归档</a><div class="menu-more-content dropdown-content"><a href=/categories/ title><i class='fas fa-fw fa-th'></i> 分类 </a><a href=/tags/ title><i class='fas fa-fw fa-tag'></i> 标签 </a><a href=/about/ title><i class='fas fa-fw fa-at'></i> 关于</a></div></div><a class=menu-item href=/friends/ title=欢迎申请友链><i class='fas fa-fw fa-link'></i> 友链</a><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn" title=一些有意思的东东~><i class='fas fa-fw fa-fan fa-spin'></i> 趣味</a><div class="menu-more-content dropdown-content"><a href=/funny/high/ title="前方高能♂ 小心外放！" target=_blank rel=noopener><i class='fas fa-fw fa-dizzy'></i> 燥起来！ </a><a href=/funny/mikutap/ title=初音未来音乐游戏 target=_blank rel=noopener><i class='fas fa-fw fa-music'></i> 在线打碟 </a><a href=/funny/catch-the-cat/ title=逮住那只猫!><i class='fas fa-fw fa-cat'></i> 抓住猫咪</a></div></div><div class=dropdown><a href=/ class="menu-item menu-more dropbtn" title=回到首页><i class='fas fa-fw fa-atom'></i> 站点</a><div class="menu-more-content dropdown-content"><a href=/bbs/ title=来留言吧~><i class='fas fa-fw fa-comment'></i> 公告留言 </a><a href=https://seo.chinaz.com title target=_blank rel=noopener><i class='fas fa-fw fa-chart-line'></i> SEO查询 </a><a href=https://www.ping.cn/http/lewky233.top title target=_blank rel=noopener><i class='fas fa-fw fa-bezier-curve'></i> 网站测速 </a><a href=/posts/e62c38c4.html/ title><i class='fas fa-fw fa-cog fa-spin'></i> 建站日志</a></div></div><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn" title><i class='fas fa-fw fa-book'></i> 文档</a><div class="menu-more-content dropdown-content"><a href=https://gohugo.io/documentation/ title target=_blank rel=noopener><i class='fas fa-fw fa-star'></i> Hugo文档 </a><a href=https://javanote.doc.lewky233.top/ title=尚在完善中~ target=_blank rel=noopener><i class='fab fa-fw fa-java'></i> Java 笔记</a></div></div><a class=menu-item href=/search/ title=渲染搜索结果需要等待几秒钟~><i class='fas fa-fw fa-search'></i> 搜索
</a><span class="menu-item delimiter"></span>
<a href=https://travellings.link target=_blank class=menu-item rel=noopener title=开往-友链接力><i class='fas fa-fw fa-subway'></i></a>
<a href=https://rssblog.vercel.app/ class=menu-item target=_blank rel=noopener title=RSSBlog><i class='fas fa-fw fa-inbox'></i></a>
<a href=https://github.com/lewky class=menu-item target=_blank rel=noopener title=GitHub><i class='fab fa-fw fa-github'></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Yulin Lewis' Blog"><span class=header-title-pre><i class='fas fa-fw fa-atom'></i></span>雨临Lewis</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=dropdown><a href=/posts/ class="menu-item menu-more dropbtn" title=点击查看所有文章><i class='fas fa-fw fa-archive'></i> 归档</a><div class="menu-more-content dropdown-content"><a href=/categories/ title><i class='fas fa-fw fa-th'></i> 分类 </a><a href=/tags/ title><i class='fas fa-fw fa-tag'></i> 标签 </a><a href=/about/ title><i class='fas fa-fw fa-at'></i> 关于</a></div></div><a class=menu-item href=/friends/ title=欢迎申请友链><i class='fas fa-fw fa-link'></i> 友链</a><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn" title=一些有意思的东东~><i class='fas fa-fw fa-fan fa-spin'></i> 趣味</a><div class="menu-more-content dropdown-content"><a href=/funny/high/ title="前方高能♂ 小心外放！" target=_blank rel=noopener><i class='fas fa-fw fa-dizzy'></i> 燥起来！ </a><a href=/funny/mikutap/ title=初音未来音乐游戏 target=_blank rel=noopener><i class='fas fa-fw fa-music'></i> 在线打碟 </a><a href=/funny/catch-the-cat/ title=逮住那只猫!><i class='fas fa-fw fa-cat'></i> 抓住猫咪</a></div></div><div class=dropdown><a href=/ class="menu-item menu-more dropbtn" title=回到首页><i class='fas fa-fw fa-atom'></i> 站点</a><div class="menu-more-content dropdown-content"><a href=/bbs/ title=来留言吧~><i class='fas fa-fw fa-comment'></i> 公告留言 </a><a href=https://seo.chinaz.com title target=_blank rel=noopener><i class='fas fa-fw fa-chart-line'></i> SEO查询 </a><a href=https://www.ping.cn/http/lewky233.top title target=_blank rel=noopener><i class='fas fa-fw fa-bezier-curve'></i> 网站测速 </a><a href=/posts/e62c38c4.html/ title><i class='fas fa-fw fa-cog fa-spin'></i> 建站日志</a></div></div><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn" title><i class='fas fa-fw fa-book'></i> 文档</a><div class="menu-more-content dropdown-content"><a href=https://gohugo.io/documentation/ title target=_blank rel=noopener><i class='fas fa-fw fa-star'></i> Hugo文档 </a><a href=https://javanote.doc.lewky233.top/ title=尚在完善中~ target=_blank rel=noopener><i class='fab fa-fw fa-java'></i> Java 笔记</a></div></div><a class=menu-item href=/search/ title=渲染搜索结果需要等待几秒钟~><i class='fas fa-fw fa-search'></i> 搜索</a>
<a href=https://travellings.link target=_blank class=menu-item rel=noopener title=开往-友链接力><i class='fas fa-fw fa-subway'></i></a>
<a href=https://rssblog.vercel.app/ class=menu-item target=_blank rel=noopener title=RSSBlog><i class='fas fa-fw fa-inbox'></i></a>
<a href=https://github.com/lewky class=menu-item target=_blank rel=noopener title=GitHub><i class='fab fa-fw fa-github'></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">由Java正则表达式的灾难性回溯引发的高CPU异常：java.util.regex.Pattern$Loop.match</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>雨临Lewis</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/><i class="far fa-folder fa-fw"></i>工作记录</a></span></div><div class=post-meta-line><i class="far fa-calendar fa-fw"></i>&nbsp;<time datetime=2019-10-09>2019-10-09</time>&nbsp;<i class="far fa-calendar-plus fa-fw"></i>&nbsp;<time datetime=2022-11-14>2022-11-14</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 4515 字
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 10 分钟&nbsp;<span id=/posts/java-regex-issue/ class=leancloud_visitors data-flag-title=由Java正则表达式的灾难性回溯引发的高CPU异常：java.util.regex.Pattern$Loop.match>
<i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
</span>&nbsp;
<a href=#comments id=post-meta-vcount title=查看评论><i class="fas fa-comment fa-fw"></i>&nbsp;<span id=/posts/java-regex-issue/ class=waline-comment-count></span>&nbsp;条评论</a></div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ol><li><a href=#问题与分析>问题与分析</a></li><li><a href=#引擎与回溯>引擎与回溯</a></li><li><a href=#具体案例与解决方案>具体案例与解决方案</a></li><li><a href=#排查高cpu使用率的方法>排查高CPU使用率的方法</a></li><li><a href=#参考链接>参考链接</a></li></ol></nav></div></div><div class=content id=content><h2 id=问题与分析>问题与分析</h2><p>某天领导report了一个问题：线上的CPU自从上一个版本迭代后就一直处于居高不下的状况，领导看着这段时间的曲线图判断是有两条线程在不停的死循环。</p><p>接到任务后去查看了AWS的CloudWatch，发现线上CPU确实一直居高不下，使用率基本是之前的两倍；另外发现线程使用率以比之前频繁很多。后来公司的大佬拿到dump后经过分析发现，是由正则表达式造成的CPU持续高使用率的问题。</p><p>堆栈信息如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$Loop</span><span class=o>.</span><span class=na>match</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4787</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$GroupTail</span><span class=o>.</span><span class=na>match</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4719</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$Curly</span><span class=o>.</span><span class=na>match0</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4281</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$Curly</span><span class=o>.</span><span class=na>match</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4236</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$Curly</span><span class=o>.</span><span class=na>match0</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4274</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$Curly</span><span class=o>.</span><span class=na>match</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4236</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$GroupCurly</span><span class=o>.</span><span class=na>match0</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4487</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$GroupCurly</span><span class=o>.</span><span class=na>match</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4407</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$Curly</span><span class=o>.</span><span class=na>match0</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4274</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$Curly</span><span class=o>.</span><span class=na>match</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4236</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$GroupHead</span><span class=o>.</span><span class=na>match</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4660</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$Loop</span><span class=o>.</span><span class=na>match</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4787</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$GroupTail</span><span class=o>.</span><span class=na>match</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4719</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$Curly</span><span class=o>.</span><span class=na>match0</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4281</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$Curly</span><span class=o>.</span><span class=na>match</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4236</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$Curly</span><span class=o>.</span><span class=na>match0</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4274</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$Curly</span><span class=o>.</span><span class=na>match</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4236</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$GroupCurly</span><span class=o>.</span><span class=na>match0</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4487</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$GroupCurly</span><span class=o>.</span><span class=na>match</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4407</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$Curly</span><span class=o>.</span><span class=na>match0</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4274</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$Curly</span><span class=o>.</span><span class=na>match</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4236</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$GroupHead</span><span class=o>.</span><span class=na>match</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4660</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$Loop</span><span class=o>.</span><span class=na>match</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4787</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$GroupTail</span><span class=o>.</span><span class=na>match</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4719</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$Curly</span><span class=o>.</span><span class=na>match0</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4274</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$Curly</span><span class=o>.</span><span class=na>match</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4236</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$Curly</span><span class=o>.</span><span class=na>match0</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4274</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$Curly</span><span class=o>.</span><span class=na>match</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4236</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$GroupCurly</span><span class=o>.</span><span class=na>match0</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4487</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$GroupCurly</span><span class=o>.</span><span class=na>match</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4407</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$Curly</span><span class=o>.</span><span class=na>match0</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4274</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$Curly</span><span class=o>.</span><span class=na>match</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4236</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$GroupHead</span><span class=o>.</span><span class=na>match</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4660</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$Loop</span><span class=o>.</span><span class=na>matchInit</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4803</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$Prolog</span><span class=o>.</span><span class=na>match</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4743</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$GroupCurly</span><span class=o>.</span><span class=na>match0</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4487</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$GroupCurly</span><span class=o>.</span><span class=na>match</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4407</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$GroupTail</span><span class=o>.</span><span class=na>match</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4719</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$BranchConn</span><span class=o>.</span><span class=na>match</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4570</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$BmpCharProperty</span><span class=o>.</span><span class=na>match</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>3800</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$Branch</span><span class=o>.</span><span class=na>match</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4606</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$GroupHead</span><span class=o>.</span><span class=na>match</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>4660</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Pattern$Start</span><span class=o>.</span><span class=na>match</span><span class=o>(</span><span class=n>Pattern</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>3463</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Matcher</span><span class=o>.</span><span class=na>search</span><span class=o>(</span><span class=n>Matcher</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>1248</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>regex</span><span class=o>.</span><span class=na>Matcher</span><span class=o>.</span><span class=na>find</span><span class=o>(</span><span class=n>Matcher</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>637</span><span class=o>)</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>com</span><span class=o>.</span><span class=na>core</span><span class=o>.</span><span class=na>cbx</span><span class=o>.</span><span class=na>mybatis</span><span class=o>.</span><span class=na>plugin</span><span class=o>.</span><span class=na>sql</span><span class=o>.</span><span class=na>TableAliasParseInjector</span><span class=o>.</span><span class=na>getTableAlias</span><span class=o>(</span><span class=n>TableAliasParseInjector</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>48</span><span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>还是第一次知道正则表达式也会引发这种问题，网上查了下资料，原来有不少人也遇到同样的问题。而这个问题，是由正则表达式的灾难性回溯（Catastrophic Backtracking），或者说回溯陷阱造成的。</p><p>另外，可以发现在jdk的JIRA里也有人提出了这个issue，不过目前依然还没有解决这个bug，下面是官方的issue链接：<a href=https://bugs.openjdk.java.net/browse/JDK-6882582 target=_blank rel="noopener noreffer">StackOverflowError in java.util.regex.Pattern</a></p><h2 id=引擎与回溯>引擎与回溯</h2><p>这里引用下一位老哥的原文，简单介绍下正则表达式的引擎和回溯机制。</p><blockquote><p>正则引擎主要可以分为基本不同的两大类：一种是DFA（确定型有穷自动机），另一种是NFA（不确定型有穷自动机）。简单来讲，NFA 对应的是正则表达式主导的匹配，而 DFA 对应的是文本主导的匹配。</p><p>DFA从匹配文本入手，从左到右，每个字符不会匹配两次，它的时间复杂度是多项式的，所以通常情况下，它的速度更快，但支持的特性很少，不支持捕获组、各种引用等等；而NFA则是从正则表达式入手，不断读入字符，尝试是否匹配当前正则，不匹配则吐出字符重新尝试，通常它的速度比较慢，最优时间复杂度为多项式的，最差情况为指数级的。但NFA支持更多的特性，因而绝大多数编程场景下（包括java，js），我们面对的是NFA。</p></blockquote><p>Java的正则表达式引擎用的是NFA算法，在根据正则表达式来匹配文本时，拥有回溯机制。在遇到以下字符时就有可能发生回溯：</p><ol><li><code>?</code></li><li><code>+</code></li><li><code>*</code></li><li><code>{min, max}</code></li></ol><p>以上四种默认是贪婪模式去匹配文本，也就是说，会尽可能多地去匹配更多的字符。在这个匹配的过程中，必然会一次次地匹配文本，一直到匹配不上时，才会回溯一次，重新用正则表达式的下一个字符去匹配回溯之前匹配不上的文本。</p><p>这里说的比较抽象，有兴趣的可以自行搜索下正则表达式的回溯以及贪婪模式、懒惰模式（也叫勉强模式）和独占模式（也叫侵占模式），下面附上一篇图文并茂的文章：<a href=https://blog.csdn.net/weixin_42516949/article/details/80858913 target=_blank rel="noopener noreffer">正则表达式三种模式：贪婪模式、懒惰模式、独占模式</a></p><p>总之，简单地说，由于正则表达式的回溯，如果我们的正则表达式写得不够好，并且被匹配的字符串文本又非常长，就有可能大量触发回溯，导致CPU飙升，甚至是堆栈溢出。这也就是所谓的灾难性回溯，或者说回溯陷阱。</p><p>这里还是拿上面文章里的例子来举例：为了校验马来西亚的商店名字，写了如下一条正则表达式：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=o>^([</span><span class=n>A</span><span class=o>-</span><span class=n>Za</span><span class=o>-</span><span class=n>z0</span><span class=o>-</span><span class=mf>9.</span><span class=n>_</span><span class=o>()&amp;</span><span class=err>&#39;\\</span><span class=o>-</span> <span class=o>]|[</span><span class=n>aA</span><span class=err>àÀảẢãÃáÁạẠăĂằẰẳẲẵẴắẮặẶâÂầẦẩẨẫẪấẤậẬ</span><span class=n>bBcCdD</span><span class=err>đĐ</span><span class=n>eE</span><span class=err>èÈẻẺẽẼéÉẹẸêÊềỀểỂễỄếẾệỆ</span><span class=n>fFgGhHiI</span><span class=err>ìÌỉỈĩĨíÍịỊ</span><span class=n>jJkKlLmMnNoO</span><span class=err>òÒỏỎõÕóÓọỌôÔồỒổỔỗỖốỐộỘơƠờỜởỞỡỠớỚợỢ</span><span class=n>pPqQrRsStTuU</span><span class=err>ùÙủỦũŨúÚụỤưƯừỪửỬữỮứỨựỰ</span><span class=n>vVwWxXyY</span><span class=err>ỳỲỷỶỹỸýÝỵỴ</span><span class=n>zZ</span><span class=o>])+</span><span class=n>$</span>
</span></span></code></pre></td></tr></table></div></div><p>这就是一个很简单的<code>^()+$</code>结构，由于校验允许使用英文字母大小写、数字、越南文和一些特殊字符如“&”，“-”，“_”等，于是直接把这些字符都塞到<code>[]</code>里，然后为了方便观看把越南文特地抽出来塞到另一个<code>[]</code>里，最后把这两个<code>[]</code>用<code>|</code>拼接起来。</p><p>看上去非常简单的结构，但却会在线上时不时引发CPU过高的问题，可以用下面的测试类简单跑一下看看：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.regex.Matcher</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>java.util.regex.Pattern</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Test</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>REGEX_TABLE_ALIAS</span> <span class=o>=</span> <span class=s>&#34;^([A-Za-z0-9._()&amp;&#39;\\- ]|[aAàÀảẢãÃáÁạẠăĂằẰẳẲẵẴắẮặẶâÂầẦẩẨẫẪấẤậẬbBcCdDđĐeEèÈẻẺẽẼéÉẹẸêÊềỀểỂễỄếẾệỆfFgGhHiIìÌỉỈĩĨíÍịỊjJkKlLmMnNoOòÒỏỎõÕóÓọỌôÔồỒổỔỗỖốỐộỘơƠờỜởỞỡỠớỚợỢpPqQrRsStTuUùÙủỦũŨúÚụỤưƯừỪửỬữỮứỨựỰvVwWxXyYỳỲỷỶỹỸýÝỵỴzZ])+$&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=kd>final</span> <span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>String</span> <span class=n>string</span> <span class=o>=</span> <span class=s>&#34;aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa!&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>Pattern</span> <span class=n>pattern</span> <span class=o>=</span> <span class=n>Pattern</span><span class=o>.</span><span class=na>compile</span><span class=o>(</span><span class=n>REGEX_TABLE_ALIAS</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>Matcher</span> <span class=n>matcher</span> <span class=o>=</span> <span class=n>pattern</span><span class=o>.</span><span class=na>matcher</span><span class=o>(</span><span class=n>string</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=kt>boolean</span> <span class=n>result</span> <span class=o>=</span> <span class=n>matcher</span><span class=o>.</span><span class=na>find</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>System</span><span class=o>.</span><span class=na>out</span><span class=o>.</span><span class=na>println</span><span class=o>(</span><span class=n>result</span><span class=o>);</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><p>你会发现，当在校验这个<code>aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa!</code>字符串时，竟然无法立刻打印出校验结果，需要等待相当长的一段时间。如果把这个字符串改成这个，<code>!aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa</code>，就可以秒出结果。</p><p>这两个字符串是一样长，区别仅仅是<code>!</code>在首位和末位而已，但在校验时花费的时间却完全不同，原因是<code>!</code>是非法字符，但在末位时，会触发大量回溯，如果这个字符串文本有数百位，上千位，就很有可能会发生堆栈溢出。</p><p>原文作者的解决方法是把原来的正则表达式改为独占模式，也就是在<code>+</code>后加上<code>+</code>，将<code>^()+$</code>结构变成<code>^()++$</code>结构。这种做法我认为其实不太好，独占模式也是会尽可能地匹配更多的字符，但是却不会发生回溯，如果正则表达式写得不好，就可能会校验漏。</p><p>其实有个更好的改法，就是单纯把原来的表达式里的两个<code>[]</code>合并成一个<code>[]</code>，如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=o>^([</span><span class=n>A</span><span class=o>-</span><span class=n>Za</span><span class=o>-</span><span class=n>z0</span><span class=o>-</span><span class=mf>9.</span><span class=n>_</span><span class=o>()&amp;</span><span class=err>&#39;\\</span><span class=o>-</span> <span class=n>aA</span><span class=err>àÀảẢãÃáÁạẠăĂằẰẳẲẵẴắẮặẶâÂầẦẩẨẫẪấẤậẬ</span><span class=n>bBcCdD</span><span class=err>đĐ</span><span class=n>eE</span><span class=err>èÈẻẺẽẼéÉẹẸêÊềỀểỂễỄếẾệỆ</span><span class=n>fFgGhHiI</span><span class=err>ìÌỉỈĩĨíÍịỊ</span><span class=n>jJkKlLmMnNoO</span><span class=err>òÒỏỎõÕóÓọỌôÔồỒổỔỗỖốỐộỘơƠờỜởỞỡỠớỚợỢ</span><span class=n>pPqQrRsStTuU</span><span class=err>ùÙủỦũŨúÚụỤưƯừỪửỬữỮứỨựỰ</span><span class=n>vVwWxXyY</span><span class=err>ỳỲỷỶỹỸýÝỵỴ</span><span class=n>zZ</span><span class=o>])+</span><span class=n>$</span>
</span></span></code></pre></td></tr></table></div></div><p>这时候再去跑上面的测试类，你会发现在校验上面的两个字符串文本时，都可以秒出校验结果。原因是新的表达式减少了回溯的机会，相当于把Java里连续多个if语句给合并成一个了，这样就减少了分支，自然就降低了灾难性回溯的可能性。</p><h2 id=具体案例与解决方案>具体案例与解决方案</h2><p>上面是其他人遇到的案例，这里说下博主遇到的case以及最终的解决方案。在系统中我们用的是自己魔改过的mybatis，其中有个正则表达式是用来获取sql中的表别名的，如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=o>(</span><span class=n>FROM</span><span class=o>|</span><span class=n>JOIN</span><span class=o>|,)(</span><span class=err>\\</span><span class=n>s</span><span class=o>)+([</span><span class=n>A</span><span class=o>-</span><span class=n>Z0</span><span class=o>-</span><span class=mi>9_</span><span class=o>]+(</span><span class=err>\\</span><span class=n>s</span><span class=o>)+[</span><span class=n>A</span><span class=o>-</span><span class=n>Z0</span><span class=o>-</span><span class=mi>9_</span><span class=o>]+(,|</span> <span class=o>)*)+(</span><span class=err>\\</span><span class=n>s</span><span class=o>)+(</span><span class=n>JOIN</span><span class=o>|</span><span class=n>WHERE</span><span class=o>|</span><span class=n>INNER</span><span class=o>|</span><span class=n>LEFT</span><span class=o>|</span><span class=n>OUTER</span><span class=o>|</span><span class=n>ON</span><span class=o>|</span><span class=n>ORDER</span><span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>这个本来一直都没有问题，直到前段时间系统迭代后，有客户在页面上搜索了一段比较长的字符串。这个搜索的操作其实就是向db发出一条sql，用来模糊查询若干个字段是否含有用户搜索的这段字符串。然后在组装这条sql的时候，会使用到上述的正则表达式来获取表别名，具体组装逻辑这里就不说了。最后组装成的sql比较长，大概一万多个字符（已经简化过了）。之所以这么长，是因为我们会拿用户输入的字符串去挨个模糊查询数据表里的很多个字符类型的列，也就是说，会有大量的<code>like '%xxxx%'</code>的部分。</p><p>当这条很长的sql被上述的正则表达式匹配时，就会发生灾难性回溯，导致系统长时间假死。这里就不贴出来具体的sql了，就简单分析下上述正则表达式存在什么问题。</p><p>表达式分成了三块部分，第一部分是<code>(FROM|JOIN|,)(\\s)+</code>，第二部分是<code>([A-Z0-9_]+(\\s)+[A-Z0-9_]+(,| )*)+</code>，第三部分是<code>(JOIN|WHERE|INNER|LEFT|OUTER|ON|ORDER)</code>。这个很好理解，就是简单匹配下表别名，比如：<code>from Table_A a, Table_B b where ...</code>。</p><p>可以发现，表达式的第一部分和第二部分都有<code>,</code>，而第二部分的末尾使用了<code>+</code>限定必须至少匹配一次，导致当sql过长时并存在大量逗号空格时，会触发大量回溯。为了避免这种情况，应当尽量把第二部分末尾的<code>+</code>去掉，如果可能的话，可以转换成<code>*</code>。</p><p>最终的修改方案是分为了两部分：
第一部分是简化sql，因为原本是直接拿组装后的sql去匹配，其实sql里大量的<code>like '%xxxx%'</code>部分毫无意义，因为目的只是拿到表别名而已。所以在匹配之前，把这些模糊匹配的部分直接去掉了。</p><p>第二部分是修改正则表达式，测试时直接拿简化前的sql去匹配，如果不会发生灾难性回溯就算过关了。最终修改后的样子如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=o>(</span><span class=n>FROM</span><span class=o>|</span><span class=n>JOIN</span><span class=o>)(</span><span class=err>\\</span><span class=n>s</span><span class=o>)+([</span><span class=n>A</span><span class=o>-</span><span class=n>Z0</span><span class=o>-</span><span class=mi>9_</span><span class=o>]+(</span><span class=err>\\</span><span class=n>s</span><span class=o>)+[</span><span class=n>A</span><span class=o>-</span><span class=n>Z0</span><span class=o>-</span><span class=mi>9_</span><span class=o>]+((</span><span class=err>\\</span><span class=n>s</span><span class=o>)*(,|</span><span class=n>JOIN</span><span class=o>)(</span><span class=err>\\</span><span class=n>s</span><span class=o>)*[</span><span class=n>A</span><span class=o>-</span><span class=n>Z0</span><span class=o>-</span><span class=mi>9_</span><span class=o>]+(</span><span class=err>\\</span><span class=n>s</span><span class=o>)+[</span><span class=n>A</span><span class=o>-</span><span class=n>Z0</span><span class=o>-</span><span class=mi>9_</span><span class=o>]+)*)(</span><span class=err>\\</span><span class=n>s</span><span class=o>)+(</span><span class=n>JOIN</span><span class=o>|</span><span class=n>WHERE</span><span class=o>|</span><span class=n>INNER</span><span class=o>|</span><span class=n>LEFT</span><span class=o>|</span><span class=n>OUTER</span><span class=o>|</span><span class=n>ON</span><span class=o>|</span><span class=n>ORDER</span><span class=o>)</span>
</span></span></code></pre></td></tr></table></div></div><p>这里推荐个在线检查正则表达式匹配字符串文本的网站，可以用来发现是否会触发灾难性回溯：<a href=https://regex101.com/ target=_blank rel="noopener noreffer">Online regex tester and debugger: PHP, PCRE, Python, Golang and JavaScript</a>
关于这个网站的用法可以看看这篇文章的末尾部分：<a href=https://juejin.im/post/5b287ea6f265da596d04a324 target=_blank rel="noopener noreffer">一个正则表达式引发的血案，让线上CPU100%异常！</a></p><h2 id=排查高cpu使用率的方法>排查高CPU使用率的方法</h2><ol><li>使用<code>top</code>命令查找在大量占用CPU的进程的PID</li><li>使用<code>ps -mp pid -o THREAD,tid,time</code>定位到大量占用CPU的线程TID；也可以用这个命令直接排序下，更方便找到大量占用CPU的线程：<code>ps -mp pid -o THREAD,tid,time|uniq -c|sort -nr</code></li><li>将上述找到的线程TID转换成十六进制：<code>printf “%x\n” TID</code>，比如原本的线程TID是28802，可以用上面的命令转成十六进制数7082</li><li>使用PID以及刚刚转成十六进制的TID来打印出该线程的堆栈信息：<code>jstack PID|grep TID -A 100</code>。也可以把完整的堆栈信息输入到一个log文件里，有两种方法：<ol><li>方法一是用<code>kill -3 PID > threadDump.log 2>&amp;1</code>，这种方法不适用于JDK1.6以上的版本</li><li>方法二是用<code>jstack -l PID > threadDump.log 2>&amp;1</code></li></ol></li><li>接下来就是分析堆栈信息，定位到问题代码的位置了。</li></ol><p>下面简单介绍下上述命令的几个关键参数的含义：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bat data-lang=bat><span class=line><span class=cl>ps命令：
</span></span><span class=line><span class=cl>-m 显示所有的执行者。
</span></span><span class=line><span class=cl>-p 指定进程的PID，并列出该进程的状况。
</span></span><span class=line><span class=cl>-o 用户自定义输出格式。
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>uniq命令：
</span></span><span class=line><span class=cl>-c 检查文件是否已经按照顺序排序，排序过为真
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>sort命令：
</span></span><span class=line><span class=cl>-n 按照数值大小进行排序
</span></span><span class=line><span class=cl>-r 以相反的顺序进行排序，即降序排序，从大排到小
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>jstack命令：
</span></span><span class=line><span class=cl>-l long listing. Prints additional information about locks，会打印出额外的锁信息，可以在发生死锁时用来观察锁持有情况
</span></span><span class=line><span class=cl>-m to print both java and native frames (mixed mode),不仅会输出Java堆栈信息，还会输出C/C++堆栈信息（比如Native方法）
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>kill命令：
</span></span><span class=line><span class=cl>-signal 指定发送的信号类型，比如：
</span></span><span class=line><span class=cl>-3是打印进程的线程信息，并不会终止进程；
</span></span><span class=line><span class=cl>-9是强制杀死进程，一般用于立即杀死无响应或者卡死的进程；
</span></span><span class=line><span class=cl>-15是柔和地终止进程，一般会在终止之前保存数据、关闭连接，需要经过一段时间后才会完全退出进程，效果等同于-TERM
</span></span></code></pre></td></tr></table></div></div><h2 id=参考链接>参考链接</h2><ul><li><a href=https://juejin.im/post/5b287ea6f265da596d04a324 target=_blank rel="noopener noreffer">一个正则表达式引发的血案，让线上CPU100%异常！</a></li><li><a href=https://www.cnblogs.com/jackablack/p/10751914.html target=_blank rel="noopener noreffer">正则表达式的失控——回溯循环</a></li><li><a href=https://blog.csdn.net/lapush/article/details/92720184 target=_blank rel="noopener noreffer">正则表达式：java.util.regex.Pattern matcher 循环导致高CPU</a></li><li><a href=https://blog.csdn.net/weixin_42516949/article/details/80858913 target=_blank rel="noopener noreffer">正则表达式三种模式：贪婪模式、懒惰模式、独占模式</a></li><li><a href=https://bugs.openjdk.java.net/browse/JDK-6882582 target=_blank rel="noopener noreffer">StackOverflowError in java.util.regex.Pattern</a></li><li><a href=https://blog.csdn.net/New_Objectc/article/details/50817893 target=_blank rel="noopener noreffer">linux系统中,kill -3查看java进程状态无效的解决方法</a></li><li><a href=https://www.cnblogs.com/jilodream/p/5107785.html target=_blank rel="noopener noreffer">Win下，通过Jstack截取Java进程中的堆栈信息</a></li><li><a href=https://www.cnblogs.com/jiqing9006/p/10036676.html target=_blank rel="noopener noreffer">linux ps 命令参数详解</a></li><li><a href=https://zhidao.baidu.com/question/560969810.html target=_blank rel="noopener noreffer">Linux下面ps -o是什么意思</a></li><li><a href=https://blog.csdn.net/u010486679/article/details/78415666 target=_blank rel="noopener noreffer">kill与kill -9的区别</a></li><li><a href=https://www.jianshu.com/p/77ca821e7151 target=_blank rel="noopener noreffer">使用 kill 命令杀死 java进程，你用对了吗？</a></li><li><a href=https://www.iteye.com/blog/langgufu-2277147 target=_blank rel="noopener noreffer">sort、uniq命令对文本进行排序、单一和重复操作</a></li></ul><div class="details admonition warning open"><div class="details-summary admonition-title"><i class="icon fas fa-exclamation-triangle fa-fwwarning"></i>警告<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>本文最后更新于 <span class=timeago datetime=2022-11-14T20:11:45 title="November 14, 2022">November 14, 2022</span>，文中内容可能已过时，请谨慎使用。</div></div></div><div class=post-reward><input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>赞赏支持</label><div class=qr-code><label class=qr-code-image for=reward><img class=image src=https://lewky233.top/images/reward/wechat.png>
<span>微信打赏</span></label>
<label class=qr-code-image for=reward><img class=image src=https://lewky233.top/images/reward/alipay.png>
<span>支付宝打赏</span></label></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2022-11-14</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/posts/java-regex-issue/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://lewky233.top/posts/java-regex-issue/ data-title=由Java正则表达式的灾难性回溯引发的高CPU异常：java.util.regex.Pattern$Loop.match data-hashtags=Java,正则表达式,工作记录><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://lewky233.top/posts/java-regex-issue/ data-hashtag=Java><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=https://lewky233.top/posts/java-regex-issue/ data-title=由Java正则表达式的灾难性回溯引发的高CPU异常：java.util.regex.Pattern$Loop.match><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://lewky233.top/posts/java-regex-issue/ data-title=由Java正则表达式的灾难性回溯引发的高CPU异常：java.util.regex.Pattern$Loop.match><i data-svg-src=https://unpkg.com/simple-icons@2.14.0/icons/line.svg></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://lewky233.top/posts/java-regex-issue/ data-title=由Java正则表达式的灾难性回溯引发的高CPU异常：java.util.regex.Pattern$Loop.match><i class="fab fa-weibo fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/java/>Java</a>,&nbsp;<a href=/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/>正则表达式</a>,&nbsp;<a href=/tags/%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/>工作记录</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/1411dcba.html/ class=prev rel=prev title="Jetty - Unable to compile class for JSP"><i class="fas fa-angle-left fa-fw"></i>Jetty - Unable to compile class for JSP</a>
<a href=/posts/sql-issues/ class=next rel=next title="SQL - where条件里的!=会过滤值为null的数据">SQL - where条件里的!=会过滤值为null的数据<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=waline></div><script src=/js/Waline.min.js></script>
<script>new Waline({el:"#waline",meta:["nick","mail","link"],requiredMeta:["nick","mail"],login:"force",placeholder:"为防恶意灌水攻击，评论前需注册并登录，望见谅~",serverURL:"https://comment.lewky233.top/",avatarCDN:"https://cravatar.cn/avatar/",pageSize:20,avatar:"retro",lang:"zh-CN",visitor:!0,highlight:!0,uploadImage:!1,emoji:["https://lewky233.top/images/emoji/嘉然今天吃什么","https://lewky233.top/images/emoji/大航海嘉然","https://lewky233.top/images/emoji/向晚大魔王","https://lewky233.top/images/emoji/贝拉kira","https://lewky233.top/images/emoji/珈乐Carol","https://lewky233.top/images/emoji/乃琳Queen","https://lewky233.top/images/emoji/EveOneCat","https://lewky233.top/images/emoji/weibo","https://lewky233.top/images/emoji/滑稽","https://lewky233.top/images/emoji/default"]})</script></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><span id=run-time></span>|
<a href=http://rssblog.vercel.app/ target=_blank rel=noopener title=RSSBlog><i class='fas fa-fw fa-inbox'></i>&nbsp;RSSBlog</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2018 - 2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>雨临Lewis</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp><a target=_blank href=http://www.beian.miit.gov.cn/ style=font-weight:700>粤ICP备19103822</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><div class=sidebar_wo><div id=leimu><img src=https://lewky233.top/images/b2t/leimuA.png alt=雷姆 onmouseover='this.src="https://lewky233.top/images/b2t/leimuB.png"' onmouseout='this.src="https://lewky233.top/images/b2t/leimuA.png"' title=回到顶部></div><div class=sidebar_wo id=lamu><img src=https://lewky233.top/images/b2t/lamuA.png alt=雷姆 onmouseover='this.src="https://lewky233.top/images/b2t/lamuB.png"' onmouseout='this.src="https://lewky233.top/images/b2t/lamuA.png"' title=回到底部></div></div><link rel=stylesheet href=https://unpkg.com/lightgallery.js@1.2.0/dist/css/lightgallery.min.css><script type=text/javascript src=https://unpkg.com/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://unpkg.com/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://unpkg.com/lightgallery.js@1.2.0/dist/js/lightgallery.min.js></script><script type=text/javascript src=https://unpkg.com/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js></script><script type=text/javascript src=https://unpkg.com/lg-zoom.js@1.2.0/dist/lg-zoom.min.js></script><script type=text/javascript src=https://unpkg.com/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://unpkg.com/sharer.js@0.4.0/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:30},comment:{},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript src=https://unpkg.com/jquery@2.1.3/dist/jquery.min.js></script><script type=text/javascript src=https://unpkg.com/jquery-backstretch@2.1.18/jquery.backstretch.min.js></script><script>var $cdnPrefix="https://lewky233.top"</script>
<script type=text/javascript src=/js/custom.js></script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?6f278ed0fdb01edb3b1e7398379e5432",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script></body></html>