<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>ELK系列(3) - Logstash问题汇总 - Yulin Lewis' Blog</title><meta name=keywords content="雨临Lewis,Java,hugo,hexo,博客"><meta name=Description content="不想当写手的码农不是好咸鱼_(xз」∠)_"><meta property="og:title" content="ELK系列(3) - Logstash问题汇总"><meta property="og:description" content="启动参数
启动Logstash时可以指定一些参数：


1
2
3
4
5


-w # 指定线程,默认是cpu核数 
-f # 指定配置文件
-r # 启用热加载，可以在运行期间修改配置文件并生效
-t # 测试配置文件是否正常
-b # 执行filter模块之前最大能积累的日志，数值越大性能越好，同时越占内存"><meta property="og:type" content="article"><meta property="og:url" content="https://lewky.cn/posts/elk-3/"><meta property="og:image" content="https://lewky.cn/logo.png"><meta property="article:published_time" content="2019-05-12T18:24:07+08:00"><meta property="article:modified_time" content="2022-03-19T18:24:07+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://lewky.cn/logo.png"><meta name=twitter:title content="ELK系列(3) - Logstash问题汇总"><meta name=twitter:description content="启动参数
启动Logstash时可以指定一些参数：


1
2
3
4
5


-w # 指定线程,默认是cpu核数 
-f # 指定配置文件
-r # 启用热加载，可以在运行期间修改配置文件并生效
-t # 测试配置文件是否正常
-b # 执行filter模块之前最大能积累的日志，数值越大性能越好，同时越占内存"><meta name=application-name content="雨临Lewis的博客"><meta name=apple-mobile-web-app-title content="雨临Lewis的博客"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://lewky.cn/posts/elk-3/><link rel=prev href=https://lewky.cn/posts/elk-2/><link rel=next href=https://lewky.cn/posts/d5221ccd.html/><link rel=stylesheet href=https://unpkg.com/normalize.css@8.0.1/normalize.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://unpkg.com/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://unpkg.com/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"ELK系列(3) - Logstash问题汇总","inLanguage":"","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/lewky.cn\/posts\/elk-3\/"},"genre":"posts","keywords":"Logstash, 工作记录","wordcount":2188,"url":"https:\/\/lewky.cn\/posts\/elk-3\/","datePublished":"2019-05-12T18:24:07+08:00","dateModified":"2022-03-19T18:24:07+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"雨临Lewis","logo":"https:\/\/lewky.cn\/images\/avatar.jpg"},"author":{"@type":"Person","name":"雨临Lewis"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><a href=https://github.com/lewky class=github-corner target=_blank title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="3.5rem" height="3.5rem" viewBox="0 0 250 250" style="fill:#70b7fd;color:#fff;position:absolute;top:0;border:0;left:0;transform:scale(-1,1)" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div class=header-title><a href=/ title="Yulin Lewis' Blog"><span class=header-title-pre><i class="fas fa-fw fa-atom"></i></span>雨临Lewis</a></div><div class=menu><div class=menu-inner><div class=dropdown><a href=/posts/ class="menu-item menu-more dropbtn" title=点击查看所有文章><i class="fas fa-fw fa-archive"></i>归档</a><div class="menu-more-content dropdown-content"><a href=/categories/><i class="fas fa-fw fa-th"></i>分类 </a><a href=/tags/><i class="fas fa-fw fa-tag"></i>标签 </a><a href=/donation/ title=感谢打赏，老板大气~><i class="fas fa-fw fa-donate"></i>打赏 </a><a href=/about/><i class="fas fa-fw fa-at"></i>关于</a></div></div><a class=menu-item href=/friends/ title=欢迎申请友链><i class="fas fa-fw fa-link"></i>友链</a><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn" title=一些有意思的东东~><i class="fas fa-fw fa-fan fa-spin"></i>趣味</a><div class="menu-more-content dropdown-content"><a href=/funny/high/ title="前方高能♂ 小心外放！" target=_blank rel=noopener><i class="fas fa-fw fa-dizzy"></i>燥起来！ </a><a href=/funny/mikutap/ title=初音未来音乐游戏 target=_blank rel=noopener><i class="fas fa-fw fa-music"></i>在线打碟 </a><a href=/funny/catch-the-cat/ title=逮住那只猫!><i class="fas fa-fw fa-cat"></i>抓住猫咪</a></div></div><div class=dropdown><a href=/ class="menu-item menu-more dropbtn" title=回到首页><i class="fas fa-fw fa-atom"></i>站点</a><div class="menu-more-content dropdown-content"><a href=/bbs/ title=来留言吧~><i class="fas fa-fw fa-comment"></i>公告留言 </a><a href=https://seo.chinaz.com target=_blank rel=noopener><i class="fas fa-fw fa-chart-line"></i>SEO查询 </a><a href=https://www.ping.cn/http/lewky.cn target=_blank rel=noopener><i class="fas fa-fw fa-bezier-curve"></i>网站测速 </a><a href=/posts/e62c38c4.html/><i class="fas fa-fw fa-cog fa-spin"></i>建站日志</a></div></div><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn"><i class="fas fa-fw fa-book"></i>文档</a><div class="menu-more-content dropdown-content"><a href=https://gohugo.io/documentation/ target=_blank rel=noopener><i class="fas fa-fw fa-star"></i>Hugo文档 </a><a href=https://javanote.doc.lewky.cn/ title=尚在完善中~ target=_blank rel=noopener><i class="fab fa-fw fa-java"></i>Java 笔记</a></div></div><a class=menu-item href=/search/ title=渲染搜索结果需要等待几秒钟~><i class="fas fa-fw fa-search"></i>搜索
</a><span class="menu-item delimiter"></span><a href=https://travellings.link target=_blank class=menu-item rel=noopener title=开往-友链接力><i class="fas fa-fw fa-subway"></i></a><a href=https://rssblog.vercel.app/ class=menu-item target=_blank rel=noopener title=RSSBlog><i class="fas fa-fw fa-inbox"></i></a><a href=https://github.com/lewky class=menu-item target=_blank rel=noopener title=GitHub><i class="fab fa-fw fa-github"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Yulin Lewis' Blog"><span class=header-title-pre><i class="fas fa-fw fa-atom"></i></span>雨临Lewis</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=dropdown><a href=/posts/ class="menu-item menu-more dropbtn" title=点击查看所有文章><i class="fas fa-fw fa-archive"></i>归档</a><div class="menu-more-content dropdown-content"><a href=/categories/><i class="fas fa-fw fa-th"></i>分类 </a><a href=/tags/><i class="fas fa-fw fa-tag"></i>标签 </a><a href=/donation/ title=感谢打赏，老板大气~><i class="fas fa-fw fa-donate"></i>打赏 </a><a href=/about/><i class="fas fa-fw fa-at"></i>关于</a></div></div><a class=menu-item href=/friends/ title=欢迎申请友链><i class="fas fa-fw fa-link"></i>友链</a><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn" title=一些有意思的东东~><i class="fas fa-fw fa-fan fa-spin"></i>趣味</a><div class="menu-more-content dropdown-content"><a href=/funny/high/ title="前方高能♂ 小心外放！" target=_blank rel=noopener><i class="fas fa-fw fa-dizzy"></i>燥起来！ </a><a href=/funny/mikutap/ title=初音未来音乐游戏 target=_blank rel=noopener><i class="fas fa-fw fa-music"></i>在线打碟 </a><a href=/funny/catch-the-cat/ title=逮住那只猫!><i class="fas fa-fw fa-cat"></i>抓住猫咪</a></div></div><div class=dropdown><a href=/ class="menu-item menu-more dropbtn" title=回到首页><i class="fas fa-fw fa-atom"></i>站点</a><div class="menu-more-content dropdown-content"><a href=/bbs/ title=来留言吧~><i class="fas fa-fw fa-comment"></i>公告留言 </a><a href=https://seo.chinaz.com target=_blank rel=noopener><i class="fas fa-fw fa-chart-line"></i>SEO查询 </a><a href=https://www.ping.cn/http/lewky.cn target=_blank rel=noopener><i class="fas fa-fw fa-bezier-curve"></i>网站测速 </a><a href=/posts/e62c38c4.html/><i class="fas fa-fw fa-cog fa-spin"></i>建站日志</a></div></div><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn"><i class="fas fa-fw fa-book"></i>文档</a><div class="menu-more-content dropdown-content"><a href=https://gohugo.io/documentation/ target=_blank rel=noopener><i class="fas fa-fw fa-star"></i>Hugo文档 </a><a href=https://javanote.doc.lewky.cn/ title=尚在完善中~ target=_blank rel=noopener><i class="fab fa-fw fa-java"></i>Java 笔记</a></div></div><a class=menu-item href=/search/ title=渲染搜索结果需要等待几秒钟~><i class="fas fa-fw fa-search"></i>搜索</a>
<a href=https://travellings.link target=_blank class=menu-item rel=noopener title=开往-友链接力><i class="fas fa-fw fa-subway"></i></a><a href=https://rssblog.vercel.app/ class=menu-item target=_blank rel=noopener title=RSSBlog><i class="fas fa-fw fa-inbox"></i></a><a href=https://github.com/lewky class=menu-item target=_blank rel=noopener title=GitHub><i class="fab fa-fw fa-github"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">ELK系列(3) - Logstash问题汇总</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>雨临Lewis</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/elk/><i class="far fa-folder fa-fw"></i>ELK</a></span></div><div class=post-meta-line><i class="far fa-calendar fa-fw"></i>&nbsp;<time datetime=2019-05-12>2019-05-12</time>&nbsp;<i class="far fa-calendar-plus fa-fw"></i>&nbsp;<time datetime=2022-03-19>2022-03-19</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 2188 字
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 5 分钟&nbsp;<span id=/posts/elk-3/ class=leancloud_visitors data-flag-title="ELK系列(3) - Logstash问题汇总">
<i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
</span>&nbsp;
<a href=#comments id=post-meta-vcount title=查看评论><i class="fas fa-comment fa-fw"></i>&nbsp;<span id=/posts/elk-3/ class=waline-comment-count></span>&nbsp;条评论</a></div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ol><li><a href=#启动参数>启动参数</a></li><li><a href=#关闭logstash>关闭Logstash</a></li><li><a href=#启动关闭脚本>启动、关闭脚本</a></li><li><a href=#分割字符串并添加新的字段到elasticsearch>分割字符串并添加新的字段到Elasticsearch</a><ol><li><a href=#方案一使用mutate插件>方案一：使用mutate插件</a></li><li><a href=#方案二使用ruby插件>方案二：使用ruby插件</a></li></ol></li><li><a href=#block-in-multi_receive_encoded>block in multi_receive_encoded</a></li><li><a href=#参考链接>参考链接</a></li></ol></nav></div></div><div class=content id=content><h2 id=启动参数>启动参数</h2><p>启动Logstash时可以指定一些参数：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>-w # 指定线程,默认是cpu核数 
-f # 指定配置文件
-r # 启用热加载，可以在运行期间修改配置文件并生效
-t # 测试配置文件是否正常
-b # 执行filter模块之前最大能积累的日志，数值越大性能越好，同时越占内存
</code></pre></td></tr></table></div></div><h2 id=关闭logstash>关闭Logstash</h2><p>如果将Logstash作为服务启动的，通过以下方式之一关闭：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>// systemd
systemctl stop logstash

// upstart
initctl stop logstash

// sysv
/etc/init.d/logstash stop
</code></pre></td></tr></table></div></div><p>如果是在POSIX系统的控制台中直接运行Logstash则这样关闭：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>kill -TERM {logstash_pid}
</code></pre></td></tr></table></div></div><p>或者在控制台中输入<code>Ctrl-C</code>。</p><h2 id=启动关闭脚本>启动、关闭脚本</h2><p>下面是一个Logstash启动、关闭的ansible脚本，里面有几个环境变量（logstash_home，logstash_bin_folder，logstash_config）需要替换成对应的值才能作为一个完整的shell文件执行：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span><span class=lnt>76
</span><span class=lnt>77
</span><span class=lnt>78
</span><span class=lnt>79
</span><span class=lnt>80
</span><span class=lnt>81
</span><span class=lnt>82
</span><span class=lnt>83
</span><span class=lnt>84
</span><span class=lnt>85
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-shell data-lang=shell><span class=cp>#!/bin/sh
</span><span class=cp></span>
<span class=c1>#LOGSTASH_USAGE is the message if this script is called without any options</span>
<span class=nv>LOGSTASH_USAGE</span><span class=o>=</span><span class=s2>&#34;Usage: </span><span class=nv>$0</span><span class=s2> {start|stop|status|restart}&#34;</span>

<span class=c1>#SHUTDOWN_WAIT is wait time in seconds for java proccess to stop</span>
<span class=nv>SHUTDOWN_WAIT</span><span class=o>=</span><span class=m>20</span>

<span class=c1>#------ private functions</span>
logstash_pid<span class=o>()</span> <span class=o>{</span>
  <span class=nb>echo</span> <span class=sb>`</span>ps -fe <span class=p>|</span> grep <span class=o>{{</span> logstash_home <span class=o>}}</span> <span class=p>|</span> grep -v grep <span class=p>|</span> grep -v <span class=nv>$0</span> <span class=p>|</span> tr -s <span class=s2>&#34; &#34;</span><span class=p>|</span>cut -d<span class=s2>&#34; &#34;</span> -f2<span class=sb>`</span>
<span class=o>}</span>

start<span class=o>()</span> <span class=o>{</span>
  <span class=nv>pid</span><span class=o>=</span><span class=k>$(</span>logstash_pid<span class=k>)</span>
  <span class=k>if</span> <span class=o>[</span> -n <span class=s2>&#34;</span><span class=nv>$pid</span><span class=s2>&#34;</span> <span class=o>]</span>
  <span class=k>then</span>
    <span class=nb>echo</span> -e <span class=s2>&#34;Logstash is already running (pid: </span><span class=nv>$pid</span><span class=s2>)&#34;</span>
  <span class=k>else</span>
    <span class=c1># Start Logstash</span>
    <span class=nb>echo</span> -e <span class=s2>&#34;Starting Logstash&#34;</span>
    nohup sh <span class=o>{{</span> logstash_bin_folder <span class=o>}}</span>/logstash -f <span class=o>{{</span> logstash_config <span class=o>}}</span> <span class=p>&amp;</span>
  <span class=k>fi</span>
  <span class=k>return</span> <span class=m>0</span>
<span class=o>}</span>

status<span class=o>(){</span>
  <span class=nv>pid</span><span class=o>=</span><span class=k>$(</span>logstash_pid<span class=k>)</span>
  <span class=k>if</span> <span class=o>[</span> -n <span class=s2>&#34;</span><span class=nv>$pid</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span> <span class=nb>echo</span> -e <span class=s2>&#34;Logstash is running with pid: </span><span class=nv>$pid</span><span class=s2>&#34;</span>
  <span class=k>else</span> <span class=nb>echo</span> -e <span class=s2>&#34;Logstash is not running&#34;</span>
  <span class=k>fi</span>
<span class=o>}</span>

stop<span class=o>()</span> <span class=o>{</span>
  <span class=nv>pid</span><span class=o>=</span><span class=k>$(</span>logstash_pid<span class=k>)</span>
  <span class=k>if</span> <span class=o>[</span> -n <span class=s2>&#34;</span><span class=nv>$pid</span><span class=s2>&#34;</span> <span class=o>]</span>
  <span class=k>then</span>
    <span class=nb>echo</span> -e <span class=s2>&#34;Stoping Logstash [</span><span class=nv>$pid</span><span class=s2>]&#34;</span>
    <span class=nb>kill</span> -TERM <span class=nv>$pid</span>

    <span class=nb>let</span> <span class=nv>kwait</span><span class=o>=</span><span class=nv>$SHUTDOWN_WAIT</span>
    <span class=nv>count</span><span class=o>=</span>0<span class=p>;</span>
    <span class=k>until</span> <span class=o>[</span> <span class=sb>`</span>ps -p <span class=nv>$pid</span> <span class=p>|</span> grep -c <span class=nv>$pid</span><span class=sb>`</span> <span class=o>=</span> <span class=s1>&#39;0&#39;</span> <span class=o>]</span> <span class=o>||</span> <span class=o>[</span> <span class=nv>$count</span> -gt <span class=nv>$kwait</span> <span class=o>]</span>
    <span class=k>do</span>
      <span class=nb>echo</span> -n -e <span class=s2>&#34;\nwaiting for processes to exit&#34;</span><span class=p>;</span>
      sleep <span class=m>1</span>
      <span class=nb>let</span> <span class=nv>count</span><span class=o>=</span><span class=nv>$count</span>+1<span class=p>;</span>
    <span class=k>done</span>

    <span class=k>if</span> <span class=o>[</span> <span class=nv>$count</span> -gt <span class=nv>$kwait</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
      <span class=nb>echo</span> -n -e <span class=s2>&#34;\nkilling processes which didn&#39;t stop after </span><span class=nv>$SHUTDOWN_WAIT</span><span class=s2> seconds&#34;</span>
      <span class=nb>kill</span> -9 <span class=nv>$pid</span>
    <span class=k>fi</span>
  <span class=k>else</span>
    <span class=nb>echo</span> -e <span class=s2>&#34;Logstash is not running&#34;</span>
  <span class=k>fi</span>

  <span class=k>return</span> <span class=m>0</span>
<span class=o>}</span>

<span class=c1>#----- main program</span>
<span class=k>case</span> <span class=nv>$1</span> in
  start<span class=o>)</span>
    start
  <span class=p>;;</span>

  stop<span class=o>)</span>
    stop
  <span class=p>;;</span>

  restart<span class=o>)</span>
    stop
    start
  <span class=p>;;</span>

  status<span class=o>)</span>
    status
  <span class=p>;;</span>

  *<span class=o>)</span>
    <span class=nb>echo</span> -e <span class=nv>$LOGSTASH_USAGE</span>
  <span class=p>;;</span>
<span class=k>esac</span>

<span class=nb>exit</span> <span class=m>0</span>
</code></pre></td></tr></table></div></div><h2 id=分割字符串并添加新的字段到elasticsearch>分割字符串并添加新的字段到Elasticsearch</h2><p>有时需要对收集到的日志等信息进行分割，并且将分割后的字符作为新的字段index到Elasticsearch里。假定需求如下：</p><p>Logstash收集到的日志字段<code>message</code>的值是由多个字段拼接而成的，分隔符是<code>;,;</code>，如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>{
    &#34;message&#34;: &#34;key_1=value_1;,;key_2=value_2&#34;
}
</code></pre></td></tr></table></div></div><p>现在想要将<code>message</code>的值拆分成2个新的字段：key_1、key_2，并且将它们index到ES里，可以借助Logstash的filter的插件来完成；这里提供两种解决方案。</p><h3 id=方案一使用mutate插件>方案一：使用mutate插件</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>filter {
    mutate {
        split =&gt; [&#34;message&#34;,&#34;;,;&#34;]
    }

    if [message][0] {
        mutate {                
            add_field =&gt;   {
                &#34;temp1&#34; =&gt; &#34;%{[message][0]}&#34;
            }
        }
    }
    
    if [message][1] {
        mutate {                
            add_field =&gt;   {
                &#34;temp2&#34; =&gt; &#34;%{[message][1]}&#34;
            }
        }
    }   

    if [temp1][1] {
        mutate {
            split =&gt; [&#34;temp1&#34;,&#34;=&#34;]
            add_field =&gt;   {
                &#34;%{[temp1][0]}&#34; =&gt; &#34;%{[temp1][1]}&#34;
            }
        }
    }
    
    if [temp2][1] {
        mutate {
            split =&gt; [&#34;temp2&#34;,&#34;=&#34;]
            add_field =&gt;   {
                &#34;%{[temp2][0]}&#34; =&gt; &#34;%{[temp2][1]}&#34;
            }
            remove_field =&gt; [ &#34;temp1&#34;, &#34;temp2&#34;, &#34;message&#34; ]
        }
    }
}
</code></pre></td></tr></table></div></div><p>在filter里可以通过<code>if [varA]</code>来判断一个变量varA是否为空或null，如果需要取反则是<code>if ![varA]</code>。</p><p>从上面代码可以看出，这种做法很麻烦，也不利于日后的维护。每当<code>message</code>里被拼接的字段的数量增加时，就必须同步改动这里的filter逻辑，而且添加的代码量也是呈线性递增的。</p><p>此外，这里使用的诸如<code>temp1</code>等临时变量，可以用<code>[@metadata][temp1]</code>的写法来作为临时变量，这样就不需要去手动remove掉了。</p><h3 id=方案二使用ruby插件>方案二：使用ruby插件</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-fallback data-lang=fallback>filter {
	ruby {
		code =&gt; &#34;
			array1 = event.get(&#39;message&#39;).split(&#39;;,;&#39;)
			array1.each do |temp1|
				if temp1.nil? then
					next
				end
				array2 = temp1.split(&#39;=&#39;)
				key = array2[0]
				value = array2[1]
				if key.nil? then
					next
				end
				event.set(key, value)
			end
		&#34;
		remove_field =&gt; [ &#34;message&#34; ]
	}
}
</code></pre></td></tr></table></div></div><p>ruby插件可以允许你使用ruby的语法来完成各种复杂的逻辑，使用这种方案可以完美解决方案一中的不足之处，便于日后的维护。</p><h2 id=block-in-multi_receive_encoded>block in multi_receive_encoded</h2><p>测试坏境中Logstash总是会down掉，查看了下日志文件，发现报错如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-json data-lang=json><span class=p>[</span><span class=mi>2019-06-28</span><span class=err>T</span><span class=mi>07</span><span class=err>:</span><span class=mi>56</span><span class=err>:</span><span class=mi>13</span><span class=p>,</span><span class=mi>148</span><span class=p>][</span><span class=err>FATAL</span><span class=p>][</span><span class=err>logstash.runner</span>          <span class=p>]</span> <span class=err>An</span> <span class=err>unexpected</span> <span class=err>error</span> <span class=err>occurred!</span>
<span class=p>{</span>
	<span class=err>:</span> <span class=err>error=&gt;#&lt;Errno:</span> <span class=err>:</span> <span class=err>EPIPE:</span> <span class=err>Brokenpipe-&lt;STDOUT&gt;&gt;,</span>
	<span class=err>:</span> <span class=err>backtrace=&gt;[</span><span class=nt>&#34;org/jruby/RubyIO.java:1457:in `write&#39;&#34;</span><span class=p>,</span>
	<span class=nt>&#34;org/jruby/RubyIO.java:1428:in `write&#39;&#34;</span><span class=p>,</span>
	<span class=nt>&#34;/home/cbx6/software/logstash-6.6.1/vendor/bundle/jruby/2.3.0/gems/logstash-output-stdout-3.1.4/lib/logstash/outputs/stdout.rb:43:in `block in multi_receive_encoded&#39;&#34;</span><span class=p>,</span>
	<span class=nt>&#34;org/jruby/RubyArray.java:1734:in `each&#39;&#34;</span><span class=p>,</span>
	<span class=nt>&#34;/home/cbx6/software/logstash-6.6.1/vendor/bundle/jruby/2.3.0/gems/logstash-output-stdout-3.1.4/lib/logstash/outputs/stdout.rb:42:in `multi_receive_encoded&#39;&#34;</span><span class=p>,</span>
	<span class=nt>&#34;/home/cbx6/software/logstash-6.6.1/logstash-core/lib/logstash/outputs/base.rb:87:in `multi_receive&#39;&#34;</span><span class=p>,</span>
	<span class=nt>&#34;org/logstash/config/ir/compiler/OutputStrategyExt.java:114:in `multi_receive&#39;&#34;</span><span class=p>,</span>
	<span class=nt>&#34;org/logstash/config/ir/compiler/AbstractOutputDelegatorExt.java:97:in `multi_receive&#39;&#34;</span><span class=p>,</span>
	<span class=nt>&#34;/home/cbx6/software/logstash-6.6.1/logstash-core/lib/logstash/pipeline.rb:390:in `block in output_batch&#39;&#34;</span><span class=p>,</span>
	<span class=nt>&#34;org/jruby/RubyHash.java:1343:in `each&#39;&#34;</span><span class=p>,</span>
	<span class=nt>&#34;/home/cbx6/software/logstash-6.6.1/logstash-core/lib/logstash/pipeline.rb:389:in `output_batch&#39;&#34;</span><span class=p>,</span>
	<span class=nt>&#34;/home/cbx6/software/logstash-6.6.1/logstash-core/lib/logstash/pipeline.rb:341:in `worker_loop&#39;&#34;</span><span class=p>,</span>
	<span class=nt>&#34;/home/cbx6/software/logstash-6.6.1/logstash-core/lib/logstash/pipeline.rb:304:in `block in start_workers&#39;&#34;</span><span class=err>]</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div><p>从堆栈信息里可以看到关键字眼：<code>block in multi_receive_encoded</code>，<code>block in output_batch</code>；另外，还可以发现这些错误信息都是由<code>logstash-output-stdout-3.1.4</code>这个插件引发的。</p><p>简单分析来看，应该是由于测试环境下同一时间内太多message要经由<code>logstash-output-stdout</code>输出到控制台造成的某种未知的并发问题。下面是对应的Logstash的output的配置：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-xml data-lang=xml>output {
    stdout {
        codec =&gt; rubydebug
    }
    elasticsearch {
        hosts =&gt; [&#34;{{ cbx_logstash_es_server }}&#34;]
        index =&gt; &#34;%{indexName}&#34;
        action =&gt; &#34;index&#34;
    }
}
</code></pre></td></tr></table></div></div><p>根据配置，并结合堆栈信息来分析，可以认为是Logstash的stdout插件在高并发状态下使用<code>rubydebug</code>进行编解码时抛出了异常。</p><p>其实这里的stdout插件是不必要的，之前只是在本地测试使用到的。而在测试环境下，并发量远非本地测试能比，此外将大量的message输出到console上也会对性能产生影响。可以说，这种配置等同于在Java代码中频繁使用<code>System.out.print()</code>语句来输出信息，应该去除掉，最终output的配置如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-xml data-lang=xml>output {
    elasticsearch {
        hosts =&gt; [&#34;{{ cbx_logstash_es_server }}&#34;]
        index =&gt; &#34;%{indexName}&#34;
        action =&gt; &#34;index&#34;
    }
}
</code></pre></td></tr></table></div></div><p>将stdout插件的配置去除后，在之后的一段时间里，测试环境的Logstash不再发生异常退出，证实该issue确实是由<code>stdout</code>的<code>codec</code>所引发的。注意，不要在正式环境使用该插件来输出信息到控制台，有可能会引发类似的并发异常问题或者性能问题。</p><h2 id=参考链接>参考链接</h2><ul><li><a href=https://blog.csdn.net/mvpboss1004/article/details/78069877 target=_blank rel="noopener noreffer">Logstash事件字段遍历</a></li><li><a href=https://yq.aliyun.com/articles/154341 target=_blank rel="noopener noreffer">Logstash详解之——filter模块</a></li><li><a href=https://elasticsearch.cn/article/6192 target=_blank rel="noopener noreffer">logstash filter如何判断字段是够为空或者null</a></li><li><a href=https://www.elastic.co/guide/en/logstash/6.6/shutdown.html target=_blank rel="noopener noreffer">Shutting Down Logstash</a></li></ul><div class=post-reward><input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>赞赏支持</label><div class=qr-code><label class=qr-code-image for=reward><img class=image src=/images/common/wechat.png>
<span>微信打赏</span></label>
<label class=qr-code-image for=reward><img class=image src=/images/common/alipay.png>
<span>支付宝打赏</span></label></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2022-03-19</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/posts/elk-3/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://lewky.cn/posts/elk-3/ data-title="ELK系列(3) - Logstash问题汇总" data-hashtags=Logstash,工作记录><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://lewky.cn/posts/elk-3/ data-hashtag=Logstash><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=https://lewky.cn/posts/elk-3/ data-title="ELK系列(3) - Logstash问题汇总"><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://lewky.cn/posts/elk-3/ data-title="ELK系列(3) - Logstash问题汇总"><i data-svg-src=https://unpkg.com/simple-icons@2.14.0/icons/line.svg></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://lewky.cn/posts/elk-3/ data-title="ELK系列(3) - Logstash问题汇总"><i class="fab fa-weibo fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/logstash/>Logstash</a>,&nbsp;<a href=/tags/%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/>工作记录</a></section><section><span><a href=javascript:void(0); onclick=window.history.back();>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/elk-2/ class=prev rel=prev title="ELK系列(2) - Kibana问题汇总"><i class="fas fa-angle-left fa-fw"></i>ELK系列(2) - Kibana问题汇总</a>
<a href=/posts/d5221ccd.html/ class=next rel=next title="Linux - /bin/sh^M: bad interpreter: No such file or directory">Linux - /bin/sh^M: bad interpreter: No such file or directory<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=waline></div><script src=/js/Waline.min.js></script><script>new Waline({el:'#waline',meta:["nick","mail","link"],requiredMeta:["nick","mail"],login:"force",placeholder:"为防恶意灌水攻击，评论前需注册并登录，望见谅~",serverURL:"https://comment.lewky.cn/",avatarCDN:"https://sdn.geekzu.org/avatar/",pageSize:20,avatar:"retro",lang:"zh-CN",visitor:true,highlight:true,uploadImage:false,emoji:['/images/emoji/嘉然今天吃什么','/images/emoji/大航海嘉然','/images/emoji/向晚大魔王','/images/emoji/贝拉kira','/images/emoji/珈乐Carol','/images/emoji/乃琳Queen','/images/emoji/EveOneCat','/images/emoji/weibo','/images/emoji/滑稽','/images/emoji/default']});</script></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><span id=run-time></span>|
<a href=http://rssblog.vercel.app/ target=_blank rel=noopener title=RSSBlog><i class="fas fa-fw fa-inbox"></i>&nbsp;RSSBlog</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2018 - 2022</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>雨临Lewis</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp><a target=_blank href=http://www.beian.miit.gov.cn/ style=font-weight:700>粤ICP备19103822</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><div class=sidebar_wo><div id=leimu><img src=/images/b2t/leimuA.png alt=雷姆 onmouseover="this.src='/images/b2t/leimuB.png'" onmouseout="this.src='/images/b2t/leimuA.png'" title=回到顶部></div><div class=sidebar_wo id=lamu><img src=/images/b2t/lamuA.png alt=雷姆 onmouseover="this.src='/images/b2t/lamuB.png'" onmouseout="this.src='/images/b2t/lamuA.png'" title=回到底部></div></div><link rel=stylesheet href=https://unpkg.com/lightgallery.js@1.2.0/dist/css/lightgallery.min.css><script type=text/javascript src=https://unpkg.com/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://unpkg.com/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://unpkg.com/lightgallery.js@1.2.0/dist/js/lightgallery.min.js></script><script type=text/javascript src=https://unpkg.com/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js></script><script type=text/javascript src=https://unpkg.com/lg-zoom.js@1.2.0/dist/lg-zoom.min.js></script><script type=text/javascript src=https://unpkg.com/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://unpkg.com/sharer.js@0.4.0/sharer.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":30},"comment":{},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true}};</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript src=https://unpkg.com/jquery@2.1.3/dist/jquery.min.js></script><script type=text/javascript src=https://unpkg.com/jquery-backstretch@2.1.18/jquery.backstretch.min.js></script><script>var $cdnPrefix="";</script><script type=text/javascript src=/js/custom.js></script><script>var _hmt=_hmt||[];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?6f278ed0fdb01edb3b1e7398379e5432";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script></body></html>