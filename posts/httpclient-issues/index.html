<!doctype html><html lang><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>HttpClient问题汇总 - Yulin Lewis' Blog</title><meta name=keywords content="雨临Lewis,Java,hugo,hexo,博客"><meta name=Description content="不想当写手的码农不是好咸鱼_(xз」∠)_"><meta property="og:title" content="HttpClient问题汇总"><meta property="og:description" content="HttpURLConnection设置host请求头无效
由于业务需要在调用第三方SDK时需要设置host请求头为对方的域名，在测试时发现代码设置后依然无法生效。查找资料后发现是从JDK6的6u23版本开始就对HTTP的部分请求头做了限制，如下："><meta property="og:type" content="article"><meta property="og:url" content="https://lewky.cn/posts/httpclient-issues/"><meta property="og:image" content="https://lewky.cn/logo.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-20T23:13:22+08:00"><meta property="article:modified_time" content="2024-12-26T13:13:22+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://lewky.cn/logo.png"><meta name=twitter:title content="HttpClient问题汇总"><meta name=twitter:description content="HttpURLConnection设置host请求头无效
由于业务需要在调用第三方SDK时需要设置host请求头为对方的域名，在测试时发现代码设置后依然无法生效。查找资料后发现是从JDK6的6u23版本开始就对HTTP的部分请求头做了限制，如下："><meta name=application-name content="雨临Lewis的博客"><meta name=apple-mobile-web-app-title content="雨临Lewis的博客"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5916478302479037" crossorigin=anonymous></script>
<link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://lewky.cn/posts/httpclient-issues/><link rel=prev href=https://lewky.cn/posts/oculus-quests/><link rel=next href=https://lewky.cn/posts/smartgit-issues/><link rel=stylesheet href=https://unpkg.com/normalize.css@8.0.1/normalize.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://unpkg.com/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://unpkg.com/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"HttpClient问题汇总","inLanguage":"","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/lewky.cn\/posts\/httpclient-issues\/"},"genre":"posts","keywords":"JavaWeb","wordcount":4540,"url":"https:\/\/lewky.cn\/posts\/httpclient-issues\/","datePublished":"2022-11-20T23:13:22+08:00","dateModified":"2024-12-26T13:13:22+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"雨临Lewis","logo":"https:\/\/lewky.cn\/images\/avatar.jpg"},"author":{"@type":"Person","name":"雨临Lewis"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><a href=https://github.com/lewky class=github-corner target=_blank title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="3.5rem" height="3.5rem" viewBox="0 0 250 250" style="fill:#70b7fd;color:#fff;position:absolute;top:0;border:0;left:0;transform:scale(-1,1)" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div class=header-title><a href=/ title="Yulin Lewis' Blog"><span class=header-title-pre><i class='fas fa-fw fa-atom'></i></span>雨临Lewis</a></div><div class=menu><div class=menu-inner><div class=dropdown><a href=/posts/ class="menu-item menu-more dropbtn" title=点击查看所有文章><i class='fas fa-fw fa-archive'></i> 归档</a><div class="menu-more-content dropdown-content"><a href=/categories/ title><i class='fas fa-fw fa-th'></i> 分类 </a><a href=/tags/ title><i class='fas fa-fw fa-tag'></i> 标签 </a><a href=/hot/ title=文章热度Top15><i class='fas fa-fw fa-fire'></i> 热度 </a><a href=/donation/ title=感谢打赏，老板大气~><i class='fas fa-fw fa-donate'></i> 打赏 </a><a href=/posts/d65a1577.html/ title=密码是123><i class='fas fa-fw fa-pen-nib'></i> 随笔 </a><a href=/about/ title><i class='fas fa-fw fa-at'></i> 关于</a></div></div><a class=menu-item href=/friends/ title=欢迎申请友链><i class='fas fa-fw fa-link'></i> 友链</a><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn" title=一些有意思的东东~><i class='fas fa-fw fa-fan fa-spin'></i> 趣味</a><div class="menu-more-content dropdown-content"><a href=/funny/high/ title="前方高能♂ 小心外放！" target=_blank rel=noopener><i class='fas fa-fw fa-dizzy'></i> 燥起来！ </a><a href=/funny/mikutap/ title=初音未来音乐游戏 target=_blank rel=noopener><i class='fas fa-fw fa-music'></i> 在线打碟 </a><a href=/funny/catch-the-cat/ title=逮住那只猫!><i class='fas fa-fw fa-cat'></i> 抓住猫咪</a></div></div><div class=dropdown><a href=/ class="menu-item menu-more dropbtn" title=回到首页><i class='fas fa-fw fa-atom'></i> 站点</a><div class="menu-more-content dropdown-content"><a href=/bbs/ title=来留言吧~><i class='fas fa-fw fa-comment'></i> 公告留言 </a><a href=https://seo.chinaz.com title target=_blank rel=noopener><i class='fas fa-fw fa-chart-line'></i> SEO查询 </a><a href=https://www.ping.cn/http/lewky.cn title target=_blank rel=noopener><i class='fas fa-fw fa-bezier-curve'></i> 网站测速 </a><a href=/posts/e62c38c4.html/ title><i class='fas fa-fw fa-cog fa-spin'></i> 建站日志</a></div></div><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn" title><i class='fas fa-fw fa-book'></i> 文档</a><div class="menu-more-content dropdown-content"><a href=https://gohugo.io/documentation/ title target=_blank rel=noopener><i class='fas fa-fw fa-star'></i> Hugo文档 </a><a href=https://javanote.doc.lewky.cn/ title=尚在完善中~ target=_blank rel=noopener><i class='fab fa-fw fa-java'></i> Java 笔记</a></div></div><a class=menu-item href=/search/ title=渲染搜索结果需要等待几秒钟~><i class='fas fa-fw fa-search'></i> 搜索
</a><span class="menu-item delimiter"></span>
<a href=https://www.travellings.cn/go.html target=_blank class=menu-item rel=noopener title=开往-友链接力><i class='fas fa-fw fa-subway'></i></a>
<a href=https://rssblog.vercel.app/ class=menu-item target=_blank rel=noopener title=RSSBlog><i class='fas fa-fw fa-inbox'></i></a>
<a href=https://github.com/lewky class=menu-item target=_blank rel=noopener title=GitHub><i class='fab fa-fw fa-github'></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Yulin Lewis' Blog"><span class=header-title-pre><i class='fas fa-fw fa-atom'></i></span>雨临Lewis</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=dropdown><a href=/posts/ class="menu-item menu-more dropbtn" title=点击查看所有文章><i class='fas fa-fw fa-archive'></i> 归档</a><div class="menu-more-content dropdown-content"><a href=/categories/ title><i class='fas fa-fw fa-th'></i> 分类 </a><a href=/tags/ title><i class='fas fa-fw fa-tag'></i> 标签 </a><a href=/hot/ title=文章热度Top15><i class='fas fa-fw fa-fire'></i> 热度 </a><a href=/donation/ title=感谢打赏，老板大气~><i class='fas fa-fw fa-donate'></i> 打赏 </a><a href=/posts/d65a1577.html/ title=密码是123><i class='fas fa-fw fa-pen-nib'></i> 随笔 </a><a href=/about/ title><i class='fas fa-fw fa-at'></i> 关于</a></div></div><a class=menu-item href=/friends/ title=欢迎申请友链><i class='fas fa-fw fa-link'></i> 友链</a><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn" title=一些有意思的东东~><i class='fas fa-fw fa-fan fa-spin'></i> 趣味</a><div class="menu-more-content dropdown-content"><a href=/funny/high/ title="前方高能♂ 小心外放！" target=_blank rel=noopener><i class='fas fa-fw fa-dizzy'></i> 燥起来！ </a><a href=/funny/mikutap/ title=初音未来音乐游戏 target=_blank rel=noopener><i class='fas fa-fw fa-music'></i> 在线打碟 </a><a href=/funny/catch-the-cat/ title=逮住那只猫!><i class='fas fa-fw fa-cat'></i> 抓住猫咪</a></div></div><div class=dropdown><a href=/ class="menu-item menu-more dropbtn" title=回到首页><i class='fas fa-fw fa-atom'></i> 站点</a><div class="menu-more-content dropdown-content"><a href=/bbs/ title=来留言吧~><i class='fas fa-fw fa-comment'></i> 公告留言 </a><a href=https://seo.chinaz.com title target=_blank rel=noopener><i class='fas fa-fw fa-chart-line'></i> SEO查询 </a><a href=https://www.ping.cn/http/lewky.cn title target=_blank rel=noopener><i class='fas fa-fw fa-bezier-curve'></i> 网站测速 </a><a href=/posts/e62c38c4.html/ title><i class='fas fa-fw fa-cog fa-spin'></i> 建站日志</a></div></div><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn" title><i class='fas fa-fw fa-book'></i> 文档</a><div class="menu-more-content dropdown-content"><a href=https://gohugo.io/documentation/ title target=_blank rel=noopener><i class='fas fa-fw fa-star'></i> Hugo文档 </a><a href=https://javanote.doc.lewky.cn/ title=尚在完善中~ target=_blank rel=noopener><i class='fab fa-fw fa-java'></i> Java 笔记</a></div></div><a class=menu-item href=/search/ title=渲染搜索结果需要等待几秒钟~><i class='fas fa-fw fa-search'></i> 搜索</a>
<a href=https://www.travellings.cn/go.html target=_blank class=menu-item rel=noopener title=开往-友链接力><i class='fas fa-fw fa-subway'></i></a>
<a href=https://rssblog.vercel.app/ class=menu-item target=_blank rel=noopener title=RSSBlog><i class='fas fa-fw fa-inbox'></i></a>
<a href=https://github.com/lewky class=menu-item target=_blank rel=noopener title=GitHub><i class='fab fa-fw fa-github'></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">HttpClient问题汇总</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>雨临Lewis</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/%E5%B7%A5%E4%BD%9C%E8%AE%B0%E5%BD%95/><i class="far fa-folder fa-fw"></i>工作记录</a></span></div><div class=post-meta-line><i class="far fa-calendar fa-fw"></i>&nbsp;<time datetime=2022-11-20>2022-11-20</time>&nbsp;<i class="far fa-calendar-plus fa-fw"></i>&nbsp;<time datetime=2024-12-26>2024-12-26</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 4540 字
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 10 分钟&nbsp;<span id=/posts/httpclient-issues/ class=leancloud_visitors data-flag-title=HttpClient问题汇总>
<i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
</span>&nbsp;
<a href=#comments id=post-meta-vcount title=查看评论><i class="fas fa-comment fa-fw"></i>&nbsp;<span id=/posts/httpclient-issues/ class=waline-comment-count></span>&nbsp;条评论</a></div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ol><li><a href=#httpurlconnection设置host请求头无效>HttpURLConnection设置host请求头无效</a></li><li><a href=#lengthtag111-too-big>lengthTag=111, too big</a></li><li><a href=#https单向认证和双向认证>HTTPS单向认证和双向认证</a></li><li><a href=#jdk自带的keytool工具生成证书>JDK自带的keytool工具生成证书</a></li><li><a href=#java实现https双向认证>Java实现HTTPS双向认证</a></li><li><a href=#httpclient提交表单数据>HttpClient提交表单数据</a></li><li><a href=#the-request-was-rejected-because-no-multipart-boundary-was-found>the request was rejected because no multipart boundary was found</a></li><li><a href=#httpclient发送文件请求>HttpClient发送文件请求</a></li><li><a href=#连接超时的3个参数>连接超时的3个参数</a></li><li><a href=#参考链接>参考链接</a></li></ol></nav></div></div><div class=content id=content><h2 id=httpurlconnection设置host请求头无效>HttpURLConnection设置host请求头无效</h2><p>由于业务需要在调用第三方SDK时需要设置host请求头为对方的域名，在测试时发现代码设置后依然无法生效。查找资料后发现是从JDK6的6u23版本开始就对HTTP的部分请求头做了限制，如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span><span class=o>[]</span> <span class=n>restrictedHeaders</span> <span class=o>=</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=cm>/* Restricted by XMLHttpRequest2 */</span>
</span></span><span class=line><span class=cl>    <span class=c1>//&#34;Accept-Charset&#34;,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//&#34;Accept-Encoding&#34;,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=s>&#34;Access-Control-Request-Headers&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;Access-Control-Request-Method&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;Connection&#34;</span><span class=o>,</span> <span class=cm>/* close is allowed */</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;Content-Length&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>//&#34;Cookie&#34;,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//&#34;Cookie2&#34;,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=s>&#34;Content-Transfer-Encoding&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>//&#34;Date&#34;,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=s>&#34;Expect&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;Host&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;Keep-Alive&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;Origin&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>// &#34;Referer&#34;, 
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>// &#34;TE&#34;,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=s>&#34;Trailer&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;Transfer-Encoding&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=s>&#34;Upgrade&#34;</span><span class=o>,</span>
</span></span><span class=line><span class=cl>    <span class=c1>//&#34;User-Agent&#34;,
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=s>&#34;Via&#34;</span>
</span></span><span class=line><span class=cl>    <span class=o>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>allowRestrictedHeaders</span> <span class=o>=</span> <span class=o>((</span><span class=n>Boolean</span><span class=o>)</span><span class=n>java</span><span class=o>.</span><span class=na>security</span><span class=o>.</span><span class=na>AccessController</span><span class=o>.</span><span class=na>doPrivileged</span><span class=o>(</span>
</span></span><span class=line><span class=cl>        <span class=k>new</span> <span class=n>sun</span><span class=o>.</span><span class=na>security</span><span class=o>.</span><span class=na>action</span><span class=o>.</span><span class=na>GetBooleanAction</span><span class=o>(</span>
</span></span><span class=line><span class=cl>            <span class=s>&#34;sun.net.http.allowRestrictedHeaders&#34;</span><span class=o>))).</span><span class=na>booleanValue</span><span class=o>();</span>
</span></span></code></pre></td></tr></table></div></div><p>可以通过设置JVM启动参数<code>-Dsun.net.http.allowRestrictedHeaders=true</code>，或者在启动类里加上代码<code>System.setProperty("sun.net.http.allowRestrictedHeaders", "true")</code>来解决这个问题。</p><p>实际上在发送HTTP请求时如果URL是用的域名，就已经将host请求头设置为该域名了，当然也可以手动设置成其他域名。</p><p>有时候项目部署在内网，无法直接发送请求到对方域名，而是发送到代理IP上，而对方又对请求域名进行了检测和限制，此时就只能用上述方式来解除限制并在代码中设置host请求头了。如果条件允许，也可以用设置代理IP的方式来实现同样的效果，这样做的好处是不需要设置JVM启动参数。</p><p>这两种方式可以用curl来举例模拟，如下是智信钉钉新版服务端的登陆接口：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>// 智信钉钉接口域名是api.dingtalk.com，在公司内网的代理地址是20.1.1.123:80
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// 第一种方式，使用host属性，URL里用的是代理IP
</span></span><span class=line><span class=cl>curl -H &#34;Content-Type:application/json&#34; -H &#34;host:api.dingtalk.com&#34; -X POST -d &#39;{&#34;appKey&#34;:&#34;xxx&#34;,&#34;appSecret&#34;:&#34;xxx&#34;}&#39; &#34;https://20.1.1.123/v1.0/oauth2/accessToken&#34;
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// 第二种方式，使用proxy代理IP，URL里用的是域名
</span></span><span class=line><span class=cl>curl --proxy &#34;20.1.1.123:80&#34; -H &#34;Content-Type:application/json&#34; -X POST -d &#39;{&#34;appKey&#34;:&#34;xxx&#34;,&#34;appSecret&#34;:&#34;xxx&#34;}&#39; &#34;https://api.dingtalk.com/v1.0/oauth2/accessToken&#34;
</span></span></code></pre></td></tr></table></div></div><p>如果既不想设置host请求头，项目部署在内网并开通了代理，可以让运维那边设置网络策略为TCP转发（这一步其实可以不用做，只是如果服务端是HTTPS双向认证时会出问题），然后修改项目所在机器的hosts文件，这样就不需要设置JVM启动参数和设置host请求头了。</p><h2 id=lengthtag111-too-big>lengthTag=111, too big</h2><p>SpringBoot项目读取HTTPS证书文件时报错如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Caused</span> <span class=n>by</span><span class=o>:</span> <span class=n>java</span><span class=o>.</span><span class=na>io</span><span class=o>.</span><span class=na>IOException</span><span class=o>:</span> <span class=n>DerInputStream</span><span class=o>.</span><span class=na>getLength</span><span class=o>():</span> <span class=n>lengthTag</span><span class=o>=</span><span class=mi>111</span><span class=o>,</span> <span class=n>too</span> <span class=n>big</span><span class=o>.</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>sun</span><span class=o>.</span><span class=na>security</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>DerInputStream</span><span class=o>.</span><span class=na>getLength</span><span class=o>(</span><span class=n>DerInputStream</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>599</span><span class=o>)</span> <span class=o>~[</span><span class=n>na</span><span class=o>:</span><span class=mf>1.8.0_181</span><span class=o>]</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>sun</span><span class=o>.</span><span class=na>security</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>DerValue</span><span class=o>.</span><span class=na>init</span><span class=o>(</span><span class=n>DerValue</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>391</span><span class=o>)</span> <span class=o>~[</span><span class=n>na</span><span class=o>:</span><span class=mf>1.8.0_181</span><span class=o>]</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>sun</span><span class=o>.</span><span class=na>security</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>DerValue</span><span class=o>.&lt;</span><span class=n>init</span><span class=o>&gt;(</span><span class=n>DerValue</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>332</span><span class=o>)</span> <span class=o>~[</span><span class=n>na</span><span class=o>:</span><span class=mf>1.8.0_181</span><span class=o>]</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>sun</span><span class=o>.</span><span class=na>security</span><span class=o>.</span><span class=na>util</span><span class=o>.</span><span class=na>DerValue</span><span class=o>.&lt;</span><span class=n>init</span><span class=o>&gt;(</span><span class=n>DerValue</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>345</span><span class=o>)</span> <span class=o>~[</span><span class=n>na</span><span class=o>:</span><span class=mf>1.8.0_181</span><span class=o>]</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>sun</span><span class=o>.</span><span class=na>security</span><span class=o>.</span><span class=na>pkcs12</span><span class=o>.</span><span class=na>PKCS12KeyStore</span><span class=o>.</span><span class=na>engineLoad</span><span class=o>(</span><span class=n>PKCS12KeyStore</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>1938</span><span class=o>)</span> <span class=o>~[</span><span class=n>na</span><span class=o>:</span><span class=mf>1.8.0_181</span><span class=o>]</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>java</span><span class=o>.</span><span class=na>security</span><span class=o>.</span><span class=na>KeyStore</span><span class=o>.</span><span class=na>load</span><span class=o>(</span><span class=n>KeyStore</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>1445</span><span class=o>)</span> <span class=o>~[</span><span class=n>na</span><span class=o>:</span><span class=mf>1.8.0_181</span><span class=o>]</span>
</span></span><span class=line><span class=cl>	<span class=n>at</span> <span class=n>org</span><span class=o>.</span><span class=na>springframework</span><span class=o>.</span><span class=na>boot</span><span class=o>.</span><span class=na>web</span><span class=o>.</span><span class=na>embedded</span><span class=o>.</span><span class=na>netty</span><span class=o>.</span><span class=na>SslServerCustomizer</span><span class=o>.</span><span class=na>loadStore</span><span class=o>(</span><span class=n>SslServerCustomizer</span><span class=o>.</span><span class=na>java</span><span class=o>:</span><span class=mi>173</span><span class=o>)</span> <span class=o>~[</span><span class=n>spring</span><span class=o>-</span><span class=n>boot</span><span class=o>-</span><span class=mf>2.4.1</span><span class=o>.</span><span class=na>jar</span><span class=o>:</span><span class=mf>2.4.1</span><span class=o>]</span>
</span></span><span class=line><span class=cl>	<span class=o>...</span> <span class=mi>21</span> <span class=n>common</span> <span class=n>frames</span> <span class=n>omitted</span>
</span></span></code></pre></td></tr></table></div></div><p>报错是因为maven在打包项目时将resource目录下的证书文件重新编译了一次（这个可以对比编译前后的文件大小即可看出来），导致程序运行时读取证书文件失败。</p><p>可以在<code>pom.xml</code>中通过插件排除指定的文件来解决这个问题：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;build&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;finalName&gt;</span>test<span class=nt>&lt;/finalName&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;plugins&gt;</span>
</span></span><span class=line><span class=cl>		<span class=nt>&lt;plugin&gt;</span>
</span></span><span class=line><span class=cl>			<span class=nt>&lt;groupId&gt;</span>org.apache.maven.plugins<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>			<span class=nt>&lt;artifactId&gt;</span>maven-resources-plugin<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>			<span class=nt>&lt;configuration&gt;</span>
</span></span><span class=line><span class=cl>				<span class=nt>&lt;nonFilteredFileExtensions&gt;</span>
</span></span><span class=line><span class=cl>					<span class=nt>&lt;nonFilteredFileExtension&gt;</span>jks<span class=nt>&lt;/nonFilteredFileExtension&gt;</span>
</span></span><span class=line><span class=cl>					<span class=nt>&lt;nonFilteredFileExtension&gt;</span>p12<span class=nt>&lt;/nonFilteredFileExtension&gt;</span>
</span></span><span class=line><span class=cl>					<span class=nt>&lt;nonFilteredFileExtension&gt;</span>cer<span class=nt>&lt;/nonFilteredFileExtension&gt;</span>
</span></span><span class=line><span class=cl>					<span class=nt>&lt;nonFilteredFileExtension&gt;</span>crt<span class=nt>&lt;/nonFilteredFileExtension&gt;</span>
</span></span><span class=line><span class=cl>					<span class=nt>&lt;nonFilteredFileExtension&gt;</span>pem<span class=nt>&lt;/nonFilteredFileExtension&gt;</span>
</span></span><span class=line><span class=cl>					<span class=nt>&lt;nonFilteredFileExtension&gt;</span>pfx<span class=nt>&lt;/nonFilteredFileExtension&gt;</span>
</span></span><span class=line><span class=cl>				<span class=nt>&lt;/nonFilteredFileExtensions&gt;</span>
</span></span><span class=line><span class=cl>			<span class=nt>&lt;/configuration&gt;</span>
</span></span><span class=line><span class=cl>		<span class=nt>&lt;/plugin&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;/plugins&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/build&gt;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=https单向认证和双向认证>HTTPS单向认证和双向认证</h2><p>HTTP是明文传输，默认端口为80。</p><p>HTTPS是SSL / TLS + HTTP，默认端口为443，可进行加密传输和身份认证，因此涉及到两类文件：密钥和信任证书。SSL协议使用的加解密方式很像数字信封。</p><p>TLS可以说是SSL的升级版，但二者不可共用。TLS的版本号与SSL不同，TLS的版本1.0使用的版本号是SSLv3.1。</p><p>单向认证是只有客户端验证服务端的身份，客户端发起连接时服务端需要发送自己的数字证书给客户端验证。双向认证是客户端和服务端都需要互相验证对方的身份。单向认证的方式比较简单且常见，但安全性较低。</p><p>更具体的可以看看这篇文章：<a href=https://www.wangan.com/wenda/9707 target=_blank rel="noopener noreffer">SSL 和 TLS 之间的主要区别是什么？</a></p><h2 id=jdk自带的keytool工具生成证书>JDK自带的keytool工具生成证书</h2><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-cmd data-lang=cmd><span class=line><span class=cl>// 生成keystore文件，生成的证书文件是Java专用的JKS格式
</span></span><span class=line><span class=cl>keytool -genkey -alias tomcat -keyalg RSA
</span></span><span class=line><span class=cl>// 生成一个别名为tomcat的自签名证书，证书文件名为test，证书实体信息为<span class=s2>&#34;CN=Liu, OU=TestOU, O=TestO, L=sde, ST=GD, C=CN&#34;</span>，密钥密码和密钥库密码为123456，有效期为180天
</span></span><span class=line><span class=cl>keytool -genkey -alias tomcat -keyalg RSA -dname <span class=s2>&#34;CN=Liu, OU=TestOU, O=TestO, L=sde, ST=GD, C=CN&#34;</span> -keystore test -keypass 123456 -storepass 123456 -validity 180
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// 把JKS格式转为行业标准格式PKCS12，参数和生成keystore类似，根据src和dest区分
</span></span><span class=line><span class=cl>keytool -importkeystore -srckeystore test -destkeystore test1 -deststoretype pkcs12 -srcalias tomcat -destalias tomcat -srckeypass 123456 -srcstorepass 123456 -destkeypass 123456 -deststorepass 123456
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// 列出详细信息
</span></span><span class=line><span class=cl>keytool -list -v -keystore .keystore
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// 导出cer信任证书
</span></span><span class=line><span class=cl>keytool -export -alias tomcat -file test.cer -keystore .keystore -storepass 123456 -rfc
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// 查看证书信息
</span></span><span class=line><span class=cl>keytool -printcert -file test.cer
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>// jdk自带的证书库文件：`<span class=nv>%JAVA_HOME%</span>/jre/lib/security/cacerts`
</span></span><span class=line><span class=cl>keytool -list -v -keystore <span class=s2>&#34;</span><span class=nv>%JAVA_HOME%</span><span class=s2>/jre/lib/security/cacerts&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=java实现https双向认证>Java实现HTTPS双向认证</h2><p>JDK通过KeyStore对象来存储密钥文件和信任证书，但两个文件由不同的管理器类分开管理：KeyManagerFactory、TrustManagerFactory</p><p>KeyManagerFactory负责装载密钥文件，加解密通讯数据；TrustManagerFactory负责装载信任证书，进行身份验证。</p><p>如果对于安全性要求不是很高，直接使用忽略认证SSL来发送https请求也是可以的，但是不建议在生产环境这样做。</p><p>pom依赖：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-xml data-lang=xml><span class=line><span class=cl><span class=nt>&lt;dependency&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;groupId&gt;</span>org.apache.httpcomponents<span class=nt>&lt;/groupId&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;artifactId&gt;</span>httpmime<span class=nt>&lt;/artifactId&gt;</span>
</span></span><span class=line><span class=cl>	<span class=nt>&lt;version&gt;</span>4.3<span class=nt>&lt;/version&gt;</span>
</span></span><span class=line><span class=cl><span class=nt>&lt;/dependency&gt;</span>
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span><span class=lnt>121
</span><span class=lnt>122
</span><span class=lnt>123
</span><span class=lnt>124
</span><span class=lnt>125
</span><span class=lnt>126
</span><span class=lnt>127
</span><span class=lnt>128
</span><span class=lnt>129
</span><span class=lnt>130
</span><span class=lnt>131
</span><span class=lnt>132
</span><span class=lnt>133
</span><span class=lnt>134
</span><span class=lnt>135
</span><span class=lnt>136
</span><span class=lnt>137
</span><span class=lnt>138
</span><span class=lnt>139
</span><span class=lnt>140
</span><span class=lnt>141
</span><span class=lnt>142
</span><span class=lnt>143
</span><span class=lnt>144
</span><span class=lnt>145
</span><span class=lnt>146
</span><span class=lnt>147
</span><span class=lnt>148
</span><span class=lnt>149
</span><span class=lnt>150
</span><span class=lnt>151
</span><span class=lnt>152
</span><span class=lnt>153
</span><span class=lnt>154
</span><span class=lnt>155
</span><span class=lnt>156
</span><span class=lnt>157
</span><span class=lnt>158
</span><span class=lnt>159
</span><span class=lnt>160
</span><span class=lnt>161
</span><span class=lnt>162
</span><span class=lnt>163
</span><span class=lnt>164
</span><span class=lnt>165
</span><span class=lnt>166
</span><span class=lnt>167
</span><span class=lnt>168
</span><span class=lnt>169
</span><span class=lnt>170
</span><span class=lnt>171
</span><span class=lnt>172
</span><span class=lnt>173
</span><span class=lnt>174
</span><span class=lnt>175
</span><span class=lnt>176
</span><span class=lnt>177
</span><span class=lnt>178
</span><span class=lnt>179
</span><span class=lnt>180
</span><span class=lnt>181
</span><span class=lnt>182
</span><span class=lnt>183
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 设置协议http和https对应的处理socket链接工厂的对象
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>RegistryBuilder</span><span class=o>&lt;</span><span class=n>ConnectionSocketFactory</span><span class=o>&gt;</span> <span class=n>builder</span> <span class=o>=</span> <span class=n>RegistryBuilder</span><span class=o>.&lt;</span><span class=n>ConnectionSocketFactory</span><span class=o>&gt;</span><span class=n>create</span><span class=o>()</span>
</span></span><span class=line><span class=cl>                <span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=s>&#34;http&#34;</span><span class=o>,</span> <span class=n>PlainConnectionSocketFactory</span><span class=o>.</span><span class=na>getSocketFactory</span><span class=o>());</span>
</span></span><span class=line><span class=cl>        <span class=n>Registry</span><span class=o>&lt;</span><span class=n>ConnectionSocketFactory</span><span class=o>&gt;</span> <span class=n>registry</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// HTTPS是否忽略SSL认证
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>boolean</span> <span class=n>ignoreSSL</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 是否信任所有信任证书，相当于跳过客户端验证服务端证书
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>boolean</span> <span class=n>trustAllCerts</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 是否使用代理
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kt>boolean</span> <span class=n>useProxy</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=o>(!</span><span class=n>ignoreSSL</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 密钥和信任证书被存储在一个密钥库文件中（也可能存储在两个不同的密钥库文件中），需要用密钥库口令才能读取密钥库文件
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=c1>// 密钥本身还有一个口令保护着，因此这里涉及到两个口令：密钥口令和密钥库口令
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>            <span class=c1>// 信任证书相关
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>String</span> <span class=n>trustStoreType</span> <span class=o>=</span> <span class=s>&#34;&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>trustStoreFile</span> <span class=o>=</span> <span class=s>&#34;&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>trustStorePass</span> <span class=o>=</span> <span class=s>&#34;&#34;</span><span class=o>;</span> <span class=c1>// 存储信任证书的密钥库口令，jetty里将该密钥库称为信任库
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>            <span class=c1>// 密钥文件相关
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>String</span> <span class=n>keyStoreType</span> <span class=o>=</span> <span class=s>&#34;&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>keyStoreFile</span> <span class=o>=</span> <span class=s>&#34;&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>keyStorePass</span> <span class=o>=</span> <span class=s>&#34;&#34;</span><span class=o>;</span>   <span class=c1>// 存储密钥的密钥库口令
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>String</span> <span class=n>keyPass</span> <span class=o>=</span> <span class=s>&#34;&#34;</span><span class=o>;</span>        <span class=c1>// 密钥口令
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>            <span class=n>SSLContext</span> <span class=n>sslContext</span> <span class=o>=</span> <span class=n>custom</span><span class=o>(</span><span class=n>trustStoreType</span><span class=o>,</span> <span class=n>trustStoreFile</span><span class=o>,</span> <span class=n>trustStorePass</span><span class=o>,</span> <span class=n>keyStoreType</span><span class=o>,</span> <span class=n>keyStoreFile</span><span class=o>,</span> <span class=n>keyStorePass</span><span class=o>,</span> <span class=n>keyPass</span><span class=o>,</span> <span class=n>trustAllCerts</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>registry</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=s>&#34;https&#34;</span><span class=o>,</span> <span class=k>new</span> <span class=n>SSLConnectionSocketFactory</span><span class=o>(</span><span class=n>sslContext</span><span class=o>))</span>
</span></span><span class=line><span class=cl>                    <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 完全忽略SSL认证，既不加载密钥，也不加载信任证书
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>registry</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>register</span><span class=o>(</span><span class=s>&#34;https&#34;</span><span class=o>,</span> <span class=k>new</span> <span class=n>SSLConnectionSocketFactory</span><span class=o>(</span><span class=n>createIgnoreVerifySSL</span><span class=o>(),</span> <span class=n>SSLConnectionSocketFactory</span><span class=o>.</span><span class=na>ALLOW_ALL_HOSTNAME_VERIFIER</span><span class=o>))</span>
</span></span><span class=line><span class=cl>                    <span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>PoolingHttpClientConnectionManager</span> <span class=n>cm</span> <span class=o>=</span> <span class=k>new</span> <span class=n>PoolingHttpClientConnectionManager</span><span class=o>(</span><span class=n>registry</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 这两个值设置一样大不太合适，PreRoute指的是针对某个url的最大并发数
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>cm</span><span class=o>.</span><span class=na>setMaxTotal</span><span class=o>(</span><span class=mi>2000</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>cm</span><span class=o>.</span><span class=na>setDefaultMaxPerRoute</span><span class=o>(</span><span class=mi>500</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>RequestConfig</span> <span class=n>requestConfig</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span><span class=o>(</span><span class=n>useProxy</span><span class=o>){</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>proxyIP</span> <span class=o>=</span> <span class=s>&#34;&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>proxyPort</span> <span class=o>=</span> <span class=s>&#34;&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=n>HttpHost</span> <span class=n>pr</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HttpHost</span><span class=o>(</span><span class=n>proxyIP</span><span class=o>,</span><span class=n>Integer</span><span class=o>.</span><span class=na>parseInt</span><span class=o>(</span><span class=n>proxyPort</span><span class=o>));</span>
</span></span><span class=line><span class=cl>            <span class=n>requestConfig</span> <span class=o>=</span> <span class=n>RequestConfig</span><span class=o>.</span><span class=na>custom</span><span class=o>().</span><span class=na>setConnectTimeout</span><span class=o>(</span><span class=mi>30000</span><span class=o>).</span><span class=na>setSocketTimeout</span><span class=o>(</span><span class=mi>30000</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                    <span class=o>.</span><span class=na>setConnectionRequestTimeout</span><span class=o>(</span><span class=mi>30000</span><span class=o>).</span><span class=na>setProxy</span><span class=o>(</span><span class=n>pr</span><span class=o>).</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span><span class=k>else</span><span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>requestConfig</span> <span class=o>=</span> <span class=n>RequestConfig</span><span class=o>.</span><span class=na>custom</span><span class=o>().</span><span class=na>setConnectTimeout</span><span class=o>(</span><span class=mi>30000</span><span class=o>).</span><span class=na>setSocketTimeout</span><span class=o>(</span><span class=mi>30000</span><span class=o>)</span>
</span></span><span class=line><span class=cl>                    <span class=o>.</span><span class=na>setConnectionRequestTimeout</span><span class=o>(</span><span class=mi>30000</span><span class=o>).</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=n>HttpClient</span> <span class=n>httpClient</span> <span class=o>=</span> <span class=n>HttpClients</span><span class=o>.</span><span class=na>custom</span><span class=o>().</span><span class=na>setConnectionManager</span><span class=o>(</span><span class=n>cm</span><span class=o>).</span><span class=na>setDefaultRequestConfig</span><span class=o>(</span><span class=n>requestConfig</span><span class=o>).</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>uri</span> <span class=o>=</span> <span class=s>&#34;http://localhost:55555&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>charset</span> <span class=o>=</span> <span class=s>&#34;UTF-8&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>HttpPost</span> <span class=n>post</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HttpPost</span><span class=o>(</span><span class=n>uri</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 设置请求头
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>post</span><span class=o>.</span><span class=na>setHeader</span><span class=o>(</span><span class=s>&#34;key1&#34;</span><span class=o>,</span> <span class=s>&#34;value1&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>post</span><span class=o>.</span><span class=na>setHeader</span><span class=o>(</span><span class=s>&#34;key2&#34;</span><span class=o>,</span> <span class=s>&#34;value2&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 设置支持cookie
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>HttpContext</span> <span class=n>localContext</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BasicHttpContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>BasicCookieStore</span> <span class=n>cookieStore</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BasicCookieStore</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Cookie</span> <span class=n>cookie</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BasicClientCookie</span><span class=o>(</span><span class=s>&#34;name&#34;</span><span class=o>,</span> <span class=s>&#34;value&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>cookieStore</span><span class=o>.</span><span class=na>addCookie</span><span class=o>(</span><span class=n>cookie</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>localContext</span><span class=o>.</span><span class=na>setAttribute</span><span class=o>(</span><span class=n>HttpClientContext</span><span class=o>.</span><span class=na>COOKIE_STORE</span><span class=o>,</span> <span class=n>cookieStore</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 设置body
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=kd>final</span> <span class=n>BasicHttpEntity</span> <span class=n>entity</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BasicHttpEntity</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>entity</span><span class=o>.</span><span class=na>setChunked</span><span class=o>(</span><span class=kc>false</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=kt>byte</span><span class=o>[]</span> <span class=n>content</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>content</span> <span class=o>=</span> <span class=s>&#34;POST body content.&#34;</span><span class=o>.</span><span class=na>getBytes</span><span class=o>(</span><span class=n>charset</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>UnsupportedEncodingException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>entity</span><span class=o>.</span><span class=na>setContentEncoding</span><span class=o>(</span><span class=n>charset</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>entity</span><span class=o>.</span><span class=na>setContentLength</span><span class=o>(</span><span class=n>content</span><span class=o>.</span><span class=na>length</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>entity</span><span class=o>.</span><span class=na>setContent</span><span class=o>(</span><span class=k>new</span> <span class=n>ByteArrayInputStream</span><span class=o>(</span><span class=n>content</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=n>post</span><span class=o>.</span><span class=na>setEntity</span><span class=o>(</span><span class=n>entity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=c1>// 发送请求
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>HttpResponse</span> <span class=n>httpResponse</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>httpResponse</span> <span class=o>=</span> <span class=n>httpClient</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=n>post</span><span class=o>,</span> <span class=n>localContext</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>SSLContext</span> <span class=nf>custom</span><span class=o>(</span><span class=n>String</span> <span class=n>trustStoreType</span><span class=o>,</span> <span class=n>String</span> <span class=n>trustStoreFile</span><span class=o>,</span> <span class=n>String</span> <span class=n>trustStorePass</span><span class=o>,</span> <span class=n>String</span> <span class=n>keyStoreType</span><span class=o>,</span> <span class=n>String</span> <span class=n>keyStoreFile</span><span class=o>,</span> <span class=n>String</span> <span class=n>keyStorePass</span><span class=o>,</span> <span class=n>String</span> <span class=n>keyPass</span><span class=o>,</span> <span class=kt>boolean</span> <span class=n>trustAll</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>SSLContext</span> <span class=n>ctx</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>ByteArrayInputStream</span> <span class=n>trustInputStream</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>ByteArrayInputStream</span> <span class=n>keyInputStream</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>KeyStore</span> <span class=n>trustStore</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>KeyStore</span> <span class=n>keyStore</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>TrustManager</span><span class=o>[]</span> <span class=n>trustManagers</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=c1>// 密钥文件，通常格式为pfx、p12或jks（jks是java专用的格式）
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>keyStore</span> <span class=o>=</span> <span class=n>KeyStore</span><span class=o>.</span><span class=na>getInstance</span><span class=o>(</span><span class=n>StringUtils</span><span class=o>.</span><span class=na>isNotBlank</span><span class=o>(</span><span class=n>keyStoreType</span><span class=o>)</span> <span class=o>?</span> <span class=n>keyStoreType</span> <span class=o>:</span> <span class=s>&#34;PKCS12&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>keyInputStream</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteArrayInputStream</span><span class=o>(</span><span class=n>Base64</span><span class=o>.</span><span class=na>getDecoder</span><span class=o>().</span><span class=na>decode</span><span class=o>(</span><span class=n>keyStoreFile</span><span class=o>));</span>
</span></span><span class=line><span class=cl>            <span class=n>keyStore</span><span class=o>.</span><span class=na>load</span><span class=o>(</span><span class=n>keyInputStream</span><span class=o>,</span> <span class=n>keyStorePass</span><span class=o>.</span><span class=na>toCharArray</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>KeyManagerFactory</span> <span class=n>kmf</span> <span class=o>=</span> <span class=n>KeyManagerFactory</span><span class=o>.</span><span class=na>getInstance</span><span class=o>(</span><span class=n>KeyManagerFactory</span><span class=o>.</span><span class=na>getDefaultAlgorithm</span><span class=o>());</span>
</span></span><span class=line><span class=cl>            <span class=n>kmf</span><span class=o>.</span><span class=na>init</span><span class=o>(</span><span class=n>keyStore</span><span class=o>,</span> <span class=n>keyPass</span><span class=o>.</span><span class=na>toCharArray</span><span class=o>());</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=o>(</span><span class=n>trustAll</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 信任所有信任证书
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>TrustManager</span><span class=o>[]</span> <span class=n>trustAllCerts</span> <span class=o>=</span> <span class=k>new</span> <span class=n>TrustManager</span><span class=o>[]</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>new</span> <span class=n>X509TrustManager</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                            <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>checkClientTrusted</span><span class=o>(</span><span class=n>X509Certificate</span><span class=o>[]</span> <span class=n>x509Certificates</span><span class=o>,</span> <span class=n>String</span> <span class=n>s</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>CertificateException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                <span class=c1>// don&#39;t check
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                            <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                            <span class=kd>public</span> <span class=kt>void</span> <span class=nf>checkServerTrusted</span><span class=o>(</span><span class=n>X509Certificate</span><span class=o>[]</span> <span class=n>x509Certificates</span><span class=o>,</span> <span class=n>String</span> <span class=n>s</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>CertificateException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                <span class=c1>// don&#39;t check
</span></span></span><span class=line><span class=cl><span class=c1></span>                            <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                            <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                            <span class=kd>public</span> <span class=n>X509Certificate</span><span class=o>[]</span> <span class=nf>getAcceptedIssuers</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                                <span class=k>return</span> <span class=k>new</span> <span class=n>X509Certificate</span><span class=o>[]{};</span>
</span></span><span class=line><span class=cl>                            <span class=o>}</span>
</span></span><span class=line><span class=cl>                        <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>trustManagers</span> <span class=o>=</span> <span class=n>trustAllCerts</span><span class=o>;</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=c1>// 信任证书，通常格式为crt、cer
</span></span></span><span class=line><span class=cl><span class=c1></span>                <span class=n>trustStore</span> <span class=o>=</span> <span class=n>KeyStore</span><span class=o>.</span><span class=na>getInstance</span><span class=o>(</span><span class=n>StringUtils</span><span class=o>.</span><span class=na>isNotBlank</span><span class=o>(</span><span class=n>trustStoreType</span><span class=o>)</span> <span class=o>?</span> <span class=n>trustStoreType</span> <span class=o>:</span> <span class=n>KeyStore</span><span class=o>.</span><span class=na>getDefaultType</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                <span class=n>trustInputStream</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ByteArrayInputStream</span><span class=o>(</span><span class=n>Base64</span><span class=o>.</span><span class=na>getDecoder</span><span class=o>().</span><span class=na>decode</span><span class=o>(</span><span class=n>trustStoreFile</span><span class=o>));</span>
</span></span><span class=line><span class=cl>                <span class=n>trustStore</span><span class=o>.</span><span class=na>load</span><span class=o>(</span><span class=n>trustInputStream</span><span class=o>,</span> <span class=n>trustStorePass</span><span class=o>.</span><span class=na>toCharArray</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                <span class=n>TrustManagerFactory</span> <span class=n>tmf</span> <span class=o>=</span> <span class=n>TrustManagerFactory</span><span class=o>.</span><span class=na>getInstance</span><span class=o>(</span><span class=n>TrustManagerFactory</span><span class=o>.</span><span class=na>getDefaultAlgorithm</span><span class=o>());</span>
</span></span><span class=line><span class=cl>                <span class=n>tmf</span><span class=o>.</span><span class=na>init</span><span class=o>(</span><span class=n>trustStore</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>trustManagers</span> <span class=o>=</span> <span class=n>tmf</span><span class=o>.</span><span class=na>getTrustManagers</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=o>}</span>
</span></span><span class=line><span class=cl>            <span class=c1>// TLS可以视为SSL升级版，TLSv1.0版本号记为SSLv3.1
</span></span></span><span class=line><span class=cl><span class=c1></span>            <span class=n>ctx</span> <span class=o>=</span> <span class=n>SSLContext</span><span class=o>.</span><span class=na>getInstance</span><span class=o>(</span><span class=s>&#34;TLS&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>ctx</span><span class=o>.</span><span class=na>init</span><span class=o>(</span><span class=n>kmf</span><span class=o>.</span><span class=na>getKeyManagers</span><span class=o>(),</span> <span class=n>trustManagers</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>log</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=s>&#34;当前HTTPS协议装载SSL证书失败！&#34;</span><span class=o>,</span> <span class=n>e</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>IOUtils</span><span class=o>.</span><span class=na>closeQuietly</span><span class=o>(</span><span class=n>trustInputStream</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>IOUtils</span><span class=o>.</span><span class=na>closeQuietly</span><span class=o>(</span><span class=n>keyInputStream</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ctx</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=n>SSLContext</span> <span class=nf>createIgnoreVerifySSL</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>SSLContext</span> <span class=n>ctx</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 信任所有信任证书
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>TrustManager</span><span class=o>[]</span> <span class=n>trustAllCerts</span> <span class=o>=</span> <span class=k>new</span> <span class=n>TrustManager</span><span class=o>[]</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                <span class=k>new</span> <span class=n>X509TrustManager</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>checkClientTrusted</span><span class=o>(</span><span class=n>X509Certificate</span><span class=o>[]</span> <span class=n>x509Certificates</span><span class=o>,</span> <span class=n>String</span> <span class=n>s</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>CertificateException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// don&#39;t check
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>checkServerTrusted</span><span class=o>(</span><span class=n>X509Certificate</span><span class=o>[]</span> <span class=n>x509Certificates</span><span class=o>,</span> <span class=n>String</span> <span class=n>s</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>CertificateException</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// don&#39;t check
</span></span></span><span class=line><span class=cl><span class=c1></span>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                    <span class=nd>@Override</span>
</span></span><span class=line><span class=cl>                    <span class=kd>public</span> <span class=n>X509Certificate</span><span class=o>[]</span> <span class=nf>getAcceptedIssuers</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>                        <span class=k>return</span> <span class=k>new</span> <span class=n>X509Certificate</span><span class=o>[]{};</span>
</span></span><span class=line><span class=cl>                    <span class=o>}</span>
</span></span><span class=line><span class=cl>                <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=o>};</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>ctx</span> <span class=o>=</span> <span class=n>SSLContext</span><span class=o>.</span><span class=na>getInstance</span><span class=o>(</span><span class=s>&#34;SSL&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>ctx</span><span class=o>.</span><span class=na>init</span><span class=o>(</span><span class=kc>null</span><span class=o>,</span> <span class=n>trustAllCerts</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>NoSuchAlgorithmException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>KeyManagementException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>ctx</span><span class=o>;</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=httpclient提交表单数据>HttpClient提交表单数据</h2><p>通过<code>application/x-www-form-urlencoded</code>提交页面form表单数据，键值对会被自动url编码，并通过<code>&</code>拼接起来。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>String</span> <span class=n>uri</span> <span class=o>=</span> <span class=s>&#34;http://localhost:55555&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=n>String</span> <span class=n>charset</span> <span class=o>=</span> <span class=s>&#34;UTF-8&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=kd>final</span> <span class=n>HttpPost</span> <span class=n>post</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HttpPost</span><span class=o>(</span><span class=n>uri</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 设置请求头
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>post</span><span class=o>.</span><span class=na>setHeader</span><span class=o>(</span><span class=s>&#34;key1&#34;</span><span class=o>,</span> <span class=s>&#34;value1&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>post</span><span class=o>.</span><span class=na>setHeader</span><span class=o>(</span><span class=s>&#34;key2&#34;</span><span class=o>,</span> <span class=s>&#34;value2&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 设置支持cookie
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>HttpContext</span> <span class=n>localContext</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BasicHttpContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>BasicCookieStore</span> <span class=n>cookieStore</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BasicCookieStore</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>Cookie</span> <span class=n>cookie</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BasicClientCookie</span><span class=o>(</span><span class=s>&#34;name&#34;</span><span class=o>,</span> <span class=s>&#34;value&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>cookieStore</span><span class=o>.</span><span class=na>addCookie</span><span class=o>(</span><span class=n>cookie</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=n>localContext</span><span class=o>.</span><span class=na>setAttribute</span><span class=o>(</span><span class=n>HttpClientContext</span><span class=o>.</span><span class=na>COOKIE_STORE</span><span class=o>,</span> <span class=n>cookieStore</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 获取URL参数
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>List</span><span class=o>&lt;</span><span class=n>NameValuePair</span><span class=o>&gt;</span> <span class=n>pairs</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ArrayList</span><span class=o>&lt;</span><span class=n>NameValuePair</span><span class=o>&gt;();</span>
</span></span><span class=line><span class=cl><span class=n>pairs</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=k>new</span> <span class=n>BasicNameValuePair</span><span class=o>(</span><span class=s>&#34;key1&#34;</span><span class=o>,</span> <span class=s>&#34;value1&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=n>pairs</span><span class=o>.</span><span class=na>add</span><span class=o>(</span><span class=k>new</span> <span class=n>BasicNameValuePair</span><span class=o>(</span><span class=s>&#34;key2&#34;</span><span class=o>,</span> <span class=s>&#34;value2&#34;</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=n>UrlEncodedFormEntity</span> <span class=n>entity</span> <span class=o>=</span> <span class=k>new</span> <span class=n>UrlEncodedFormEntity</span><span class=o>(</span><span class=n>pairs</span><span class=o>,</span> <span class=n>Charset</span><span class=o>.</span><span class=na>forName</span><span class=o>(</span><span class=n>charset</span><span class=o>));</span>
</span></span><span class=line><span class=cl><span class=n>post</span><span class=o>.</span><span class=na>setEntity</span><span class=o>(</span><span class=n>entity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// 发送请求
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>HttpClient</span> <span class=n>httpClient</span> <span class=o>=</span> <span class=n>HttpClients</span><span class=o>.</span><span class=na>createDefault</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=n>HttpResponse</span> <span class=n>httpResponse</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl><span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>	<span class=n>httpResponse</span> <span class=o>=</span> <span class=n>httpClient</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=n>post</span><span class=o>,</span> <span class=n>localContext</span><span class=o>);</span>
</span></span><span class=line><span class=cl><span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>	<span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=the-request-was-rejected-because-no-multipart-boundary-was-found>the request was rejected because no multipart boundary was found</h2><p>通过<code>multipart/form-data</code>提交表单数据时，需要用到boundary来分割文件和请求参数，如果只需要提交文件，用HttpClient时不需要设置Header，底层会自动生成boundary。</p><p>如果需要同时提交文件和请求参数，需要手动设置Header和boundary，否则会报错<code>the request was rejected because no multipart boundary was found</code>，设置方法可以参考下文。</p><h2 id=httpclient发送文件请求>HttpClient发送文件请求</h2><p>通过<code>multipart/form-data</code>上传文件，文件和请求参数需要用boundary来分割。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kd>public</span> <span class=kd>class</span> <span class=nc>Test</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=kt>char</span><span class=o>[]</span> <span class=n>MULTIPART_CHARS</span> <span class=o>=</span> <span class=s>&#34;-_1234567890abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#34;</span><span class=o>.</span><span class=na>toCharArray</span><span class=o>();</span>
</span></span><span class=line><span class=cl>	
</span></span><span class=line><span class=cl>    <span class=kd>public</span> <span class=kd>static</span> <span class=kt>void</span> <span class=nf>main</span><span class=o>(</span><span class=n>String</span><span class=o>[]</span> <span class=n>args</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>uri</span> <span class=o>=</span> <span class=s>&#34;http://localhost:55555&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>String</span> <span class=n>charset</span> <span class=o>=</span> <span class=s>&#34;UTF-8&#34;</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=kd>final</span> <span class=n>HttpPost</span> <span class=n>post</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HttpPost</span><span class=o>(</span><span class=n>uri</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>        <span class=c1>// 设置请求头
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>post</span><span class=o>.</span><span class=na>setHeader</span><span class=o>(</span><span class=s>&#34;key1&#34;</span><span class=o>,</span> <span class=s>&#34;value1&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>post</span><span class=o>.</span><span class=na>setHeader</span><span class=o>(</span><span class=s>&#34;key2&#34;</span><span class=o>,</span> <span class=s>&#34;value2&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>        <span class=c1>// 设置支持cookie
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>HttpContext</span> <span class=n>localContext</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BasicHttpContext</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>BasicCookieStore</span> <span class=n>cookieStore</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BasicCookieStore</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Cookie</span> <span class=n>cookie</span> <span class=o>=</span> <span class=k>new</span> <span class=n>BasicClientCookie</span><span class=o>(</span><span class=s>&#34;name&#34;</span><span class=o>,</span> <span class=s>&#34;value&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>cookieStore</span><span class=o>.</span><span class=na>addCookie</span><span class=o>(</span><span class=n>cookie</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>localContext</span><span class=o>.</span><span class=na>setAttribute</span><span class=o>(</span><span class=n>HttpClientContext</span><span class=o>.</span><span class=na>COOKIE_STORE</span><span class=o>,</span> <span class=n>cookieStore</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>        <span class=c1>// 设置boundary，用于分割文件和请求参数
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>String</span> <span class=n>boundary</span> <span class=o>=</span> <span class=n>generateBoundary</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>post</span><span class=o>.</span><span class=na>setHeader</span><span class=o>(</span><span class=s>&#34;Content-type&#34;</span><span class=o>,</span> <span class=s>&#34;multipart/form-data; boundary=&#34;</span> <span class=o>+</span> <span class=n>boundary</span> <span class=o>+</span> <span class=s>&#34;; charset=utf-8&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>MultipartEntityBuilder</span> <span class=n>builder</span> <span class=o>=</span> <span class=n>MultipartEntityBuilder</span><span class=o>.</span><span class=na>create</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>builder</span><span class=o>.</span><span class=na>setMode</span><span class=o>(</span><span class=n>HttpMultipartMode</span><span class=o>.</span><span class=na>BROWSER_COMPATIBLE</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>builder</span><span class=o>.</span><span class=na>setCharset</span><span class=o>(</span><span class=n>Charset</span><span class=o>.</span><span class=na>forName</span><span class=o>(</span><span class=n>charset</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=n>builder</span><span class=o>.</span><span class=na>setBoundary</span><span class=o>(</span><span class=n>boundary</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 添加请求参数
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ContentType</span> <span class=n>textContentType</span> <span class=o>=</span> <span class=n>ContentType</span><span class=o>.</span><span class=na>create</span><span class=o>(</span><span class=s>&#34;application/x-www-form-urlencoded&#34;</span><span class=o>,</span> <span class=n>Charset</span><span class=o>.</span><span class=na>forName</span><span class=o>(</span><span class=n>charset</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=n>builder</span><span class=o>.</span><span class=na>addTextBody</span><span class=o>(</span><span class=s>&#34;key1&#34;</span><span class=o>,</span> <span class=s>&#34;value1&#34;</span><span class=o>,</span> <span class=n>textContentType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=n>builder</span><span class=o>.</span><span class=na>addTextBody</span><span class=o>(</span><span class=s>&#34;key2&#34;</span><span class=o>,</span> <span class=s>&#34;value2&#34;</span><span class=o>,</span> <span class=n>textContentType</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=c1>// 添加文件
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>ContentType</span> <span class=n>fileContentType</span> <span class=o>=</span> <span class=n>ContentType</span><span class=o>.</span><span class=na>create</span><span class=o>(</span><span class=s>&#34;multipart/form-data&#34;</span><span class=o>,</span> <span class=n>Charset</span><span class=o>.</span><span class=na>forName</span><span class=o>(</span><span class=n>charset</span><span class=o>));</span>
</span></span><span class=line><span class=cl>        <span class=n>InputStream</span> <span class=n>inputStream</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=n>File</span> <span class=n>file</span> <span class=o>=</span> <span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=s>&#34;C:\\Users\\WB2027\\Downloads\\123.txt&#34;</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>inputStream</span> <span class=o>=</span> <span class=k>new</span> <span class=n>FileInputStream</span><span class=o>(</span><span class=n>file</span><span class=o>);</span>
</span></span><span class=line><span class=cl>            <span class=n>String</span> <span class=n>fileName</span> <span class=o>=</span> <span class=n>file</span><span class=o>.</span><span class=na>getName</span><span class=o>();</span>
</span></span><span class=line><span class=cl>            <span class=n>builder</span><span class=o>.</span><span class=na>addBinaryBody</span><span class=o>(</span><span class=s>&#34;file&#34;</span><span class=o>,</span> <span class=n>inputStream</span><span class=o>,</span> <span class=n>fileContentType</span><span class=o>,</span> <span class=n>fileName</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>        <span class=n>HttpEntity</span> <span class=n>entity</span> <span class=o>=</span> <span class=n>builder</span><span class=o>.</span><span class=na>build</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>post</span><span class=o>.</span><span class=na>setEntity</span><span class=o>(</span><span class=n>entity</span><span class=o>);</span>
</span></span><span class=line><span class=cl>		
</span></span><span class=line><span class=cl>		<span class=c1>// 发送请求
</span></span></span><span class=line><span class=cl><span class=c1></span>        <span class=n>HttpClient</span> <span class=n>httpClient</span> <span class=o>=</span> <span class=n>HttpClients</span><span class=o>.</span><span class=na>createDefault</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>HttpResponse</span> <span class=n>httpResponse</span> <span class=o>=</span> <span class=kc>null</span><span class=o>;</span>
</span></span><span class=line><span class=cl>        <span class=k>try</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>httpResponse</span> <span class=o>=</span> <span class=n>httpClient</span><span class=o>.</span><span class=na>execute</span><span class=o>(</span><span class=n>post</span><span class=o>,</span> <span class=n>localContext</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>IOException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>e</span><span class=o>.</span><span class=na>printStackTrace</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>IOUtils</span><span class=o>.</span><span class=na>closeQuietly</span><span class=o>(</span><span class=n>inputStream</span><span class=o>);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// 拷贝自Apache MultipartEntityBuilder
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=kd>private</span> <span class=kd>static</span> <span class=n>String</span> <span class=nf>generateBoundary</span><span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>        <span class=n>StringBuilder</span> <span class=n>buffer</span> <span class=o>=</span> <span class=k>new</span> <span class=n>StringBuilder</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=n>Random</span> <span class=n>rand</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Random</span><span class=o>();</span>
</span></span><span class=line><span class=cl>        <span class=kt>int</span> <span class=n>count</span> <span class=o>=</span> <span class=n>rand</span><span class=o>.</span><span class=na>nextInt</span><span class=o>(</span><span class=mi>11</span><span class=o>)</span> <span class=o>+</span> <span class=mi>30</span><span class=o>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>for</span><span class=o>(</span><span class=kt>int</span> <span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=o>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>count</span><span class=o>;</span> <span class=o>++</span><span class=n>i</span><span class=o>)</span> <span class=o>{</span>
</span></span><span class=line><span class=cl>            <span class=n>buffer</span><span class=o>.</span><span class=na>append</span><span class=o>(</span><span class=n>MULTIPART_CHARS</span><span class=o>[</span><span class=n>rand</span><span class=o>.</span><span class=na>nextInt</span><span class=o>(</span><span class=n>MULTIPART_CHARS</span><span class=o>.</span><span class=na>length</span><span class=o>)]);</span>
</span></span><span class=line><span class=cl>        <span class=o>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>buffer</span><span class=o>.</span><span class=na>toString</span><span class=o>();</span>
</span></span><span class=line><span class=cl>    <span class=o>}</span>
</span></span><span class=line><span class=cl><span class=o>}</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=连接超时的3个参数>连接超时的3个参数</h2><p>在使用HttpClient时会涉及到3个超时参数：ConnectTimeout、SocketTimeout、ConnectionRequestTimeout。</p><p>ConnectTimeout是建立数据库连接的超时时间，此时如果超时报错就是连接超时，意味着三次握手失败了。</p><p>SocketTimeout是数据读取超时，超过设定的时间则会连接断开，一般用这个参数来控制一次连接的最长时间，比如某笔重要交易服务端返回的数据量会很巨大，需要大量时间来返回和读取，那么就要给它设置一个比较大的值，避免读取到的响应不完整。</p><p>ConnectionRequestTimeout是从连接池中获取连接的超时时间，如果设置的连接池数量太少，而当前的TPS比较高，大量交易在排队等着从连接池获取连接，如果业务处理不过来则会报错连接池获取连接超时。这个参数不建议设置太高，3秒足矣，太高会影响整个交易的业务超时时间，对于上述的例子，正确做法是增加连接池里的连接数量。</p><h2 id=参考链接>参考链接</h2><ul><li><a href=http://t.zoukankan.com/skyaccross-p-2828986.html target=_blank rel="noopener noreffer">HttpURLConnection 设置Host 头部无效</a></li><li><a href=https://qa.1r1g.com/sf/ask/636789121/ target=_blank rel="noopener noreffer">如何在HttpURLConnection中覆盖http-header"Host"？</a></li><li><a href=https://blog.csdn.net/yaomingyang/article/details/112683829 target=_blank rel="noopener noreffer">springboot2.4开启HTTPS功能报DerInputStream.getLength(): lengthTag=111, too big异常</a></li><li><a href=https://blog.csdn.net/liuquan0071/article/details/50318405 target=_blank rel="noopener noreffer">JAVA SSL HTTPS 连接详解 生成证书</a></li><li><a href=https://blog.csdn.net/woliuqiangdong/article/details/121304907 target=_blank rel="noopener noreffer">Java，Web，https，读取网站申请SSL证书，JKS、PFX、CRT格式</a></li><li><a href=https://www.cnblogs.com/h-c-g/p/11002380.html target=_blank rel="noopener noreffer">post请求中的参数形式和form-data提交数据时取不到的问题</a></li><li><a href=https://blog.csdn.net/qianhuan_/article/details/103374292 target=_blank rel="noopener noreffer">httpclient 使用application/x-www-form-urlencoded提交</a></li></ul><div class=post-reward><input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>赞赏支持</label><div class=qr-code><label class=qr-code-image for=reward><img class=image src=https://lewky.cn/images/reward/wechat.png>
<span>微信打赏</span></label>
<label class=qr-code-image for=reward><img class=image src=https://lewky.cn/images/reward/alipay.png>
<span>支付宝打赏</span></label></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2024-12-26</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/posts/httpclient-issues/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://lewky.cn/posts/httpclient-issues/ data-title=HttpClient问题汇总 data-hashtags=JavaWeb><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://lewky.cn/posts/httpclient-issues/ data-hashtag=JavaWeb><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=https://lewky.cn/posts/httpclient-issues/ data-title=HttpClient问题汇总><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://lewky.cn/posts/httpclient-issues/ data-title=HttpClient问题汇总><i data-svg-src=https://unpkg.com/simple-icons@2.14.0/icons/line.svg></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://lewky.cn/posts/httpclient-issues/ data-title=HttpClient问题汇总><i class="fab fa-weibo fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/javaweb/>JavaWeb</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/oculus-quests/ class=prev rel=prev title="Oculus Quest2食用指南"><i class="fas fa-angle-left fa-fw"></i>Oculus Quest2食用指南</a>
<a href=/posts/smartgit-issues/ class=next rel=next title=SmartGit问题汇总>SmartGit问题汇总<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=waline></div><script src=/js/Waline.min.js></script>
<script>new Waline({el:"#waline",meta:["nick","mail","link"],requiredMeta:["nick","mail"],login:"force",placeholder:"为防恶意灌水攻击，评论前需注册并登录，望见谅~",serverURL:"https://comment.lewky.cn/",avatarCDN:"https://cravatar.cn/avatar/",pageSize:20,avatar:"retro",lang:"zh-CN",visitor:!0,highlight:!0,uploadImage:!1,emoji:["https://lewky.cn/images/emoji/嘉然今天吃什么","https://lewky.cn/images/emoji/大航海嘉然","https://lewky.cn/images/emoji/向晚大魔王","https://lewky.cn/images/emoji/贝拉kira","https://lewky.cn/images/emoji/珈乐Carol","https://lewky.cn/images/emoji/乃琳Queen","https://lewky.cn/images/emoji/EveOneCat","https://lewky.cn/images/emoji/weibo","https://lewky.cn/images/emoji/滑稽","https://lewky.cn/images/emoji/default"]})</script></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><span id=run-time></span>|
<a href=http://rssblog.vercel.app/ target=_blank rel=noopener title=RSSBlog><i class='fas fa-fw fa-inbox'></i>&nbsp;RSSBlog</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2018 - 2025</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>雨临Lewis</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp><a target=_blank href=http://www.beian.miit.gov.cn/ style=font-weight:700>粤ICP备19103822</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i>
</a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><div class=sidebar_wo><div id=leimu><img src=https://lewky.cn/images/b2t/leimuA.png alt=雷姆 onmouseover='this.src="https://lewky.cn/images/b2t/leimuB.png"' onmouseout='this.src="https://lewky.cn/images/b2t/leimuA.png"' title=回到顶部></div><div class=sidebar_wo id=lamu><img src=https://lewky.cn/images/b2t/lamuA.png alt=雷姆 onmouseover='this.src="https://lewky.cn/images/b2t/lamuB.png"' onmouseout='this.src="https://lewky.cn/images/b2t/lamuA.png"' title=回到底部></div></div><link rel=stylesheet href=https://unpkg.com/lightgallery.js@1.2.0/dist/css/lightgallery.min.css><script type=text/javascript src=https://unpkg.com/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://unpkg.com/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://unpkg.com/lightgallery.js@1.2.0/dist/js/lightgallery.min.js></script><script type=text/javascript src=https://unpkg.com/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js></script><script type=text/javascript src=https://unpkg.com/lg-zoom.js@1.2.0/dist/lg-zoom.min.js></script><script type=text/javascript src=https://unpkg.com/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://unpkg.com/sharer.js@0.4.0/sharer.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"复制到剪贴板",maxShownLines:30},comment:{},lightGallery:{actualSize:!1,exThumbImage:"data-thumbnail",hideBarsDelay:2e3,selector:".lightgallery",speed:400,thumbContHeight:80,thumbWidth:80,thumbnail:!0}}</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript src=https://unpkg.com/jquery@2.1.3/dist/jquery.min.js></script><script type=text/javascript src=https://unpkg.com/jquery-backstretch@2.1.18/jquery.backstretch.min.js></script><script>var $cdnPrefix="https://lewky.cn"</script>
<script type=text/javascript src=/js/custom.js></script><script>var _hmt=_hmt||[];(function(){var e,t=document.createElement("script");t.src="https://hm.baidu.com/hm.js?6f278ed0fdb01edb3b1e7398379e5432",e=document.getElementsByTagName("script")[0],e.parentNode.insertBefore(t,e)})()</script></body></html>