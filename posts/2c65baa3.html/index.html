<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Log4j和Log4j2怎么动态加载配置文件 - Yulin Lewis' Blog</title><meta name=keywords content="雨临Lewis,Java,hugo,hexo,博客"><meta name=Description content="不想当写手的码农不是好咸鱼_(xз」∠)_"><meta property="og:title" content="Log4j和Log4j2怎么动态加载配置文件"><meta property="og:description" content="应用场景与问题
当项目在运行时，我们如果需要修改log4j 1.X或者log4j2的配置文件，一般来说我们是不能直接将项目停止运行再来修改文件重新部署的。于是就有这样一个问题：如何在不停止当前项目的运行的情况下，让系统能够自动地监控配置文件的修改状况，从而实现动态加载配置文件的功能？而log4j 1.X和log4j2的差别略大，各自应该怎么实现这个功能？"><meta property="og:type" content="article"><meta property="og:url" content="https://lewky.cn/posts/2c65baa3.html/"><meta property="og:image" content="https://lewky.cn/logo.png"><meta property="article:published_time" content="2018-12-28T00:34:44+08:00"><meta property="article:modified_time" content="2018-12-28T00:34:44+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://lewky.cn/logo.png"><meta name=twitter:title content="Log4j和Log4j2怎么动态加载配置文件"><meta name=twitter:description content="应用场景与问题
当项目在运行时，我们如果需要修改log4j 1.X或者log4j2的配置文件，一般来说我们是不能直接将项目停止运行再来修改文件重新部署的。于是就有这样一个问题：如何在不停止当前项目的运行的情况下，让系统能够自动地监控配置文件的修改状况，从而实现动态加载配置文件的功能？而log4j 1.X和log4j2的差别略大，各自应该怎么实现这个功能？"><meta name=application-name content="雨临Lewis的博客"><meta name=apple-mobile-web-app-title content="雨临Lewis的博客"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://lewky.cn/posts/2c65baa3.html/><link rel=prev href=https://lewky.cn/posts/f53d27da.html/><link rel=next href=https://lewky.cn/posts/55fa957a.html/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Log4j和Log4j2怎么动态加载配置文件","inLanguage":"","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/lewky.cn\/posts\/2c65baa3.html\/"},"genre":"posts","keywords":"Log4j, Log4j2","wordcount":3430,"url":"https:\/\/lewky.cn\/posts\/2c65baa3.html\/","datePublished":"2018-12-28T00:34:44+08:00","dateModified":"2018-12-28T00:34:44+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"雨临Lewis","logo":"https:\/\/lewky.cn\/images\/avatar.jpg"},"author":{"@type":"Person","name":"雨临Lewis"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><a href=https://github.com/lewky class=github-corner target=_blank title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="3.5rem" height="3.5rem" viewBox="0 0 250 250" style="fill:#70b7fd;color:#fff;position:absolute;top:0;border:0;left:0;transform:scale(-1,1)" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div class=header-title><a href=/ title="Yulin Lewis' Blog"><span class=header-title-pre><i class="fas fa-fw fa-atom"></i></span>雨临Lewis</a></div><div class=menu><div class=menu-inner><div class=dropdown><a href=/posts/ class="menu-item menu-more dropbtn" title=点击查看所有文章><i class="fas fa-fw fa-archive"></i>归档</a><div class="menu-more-content dropdown-content"><a href=/categories/><i class="fas fa-fw fa-th"></i>分类 </a><a href=/tags/><i class="fas fa-fw fa-tag"></i>标签 </a><a href=/hot/ title=文章热度Top15><i class="fas fa-fw fa-fire"></i>热度 </a><a href=/donation/ title=感谢打赏，老板大气~><i class="fas fa-fw fa-donate"></i>打赏 </a><a href=/about/><i class="fas fa-fw fa-at"></i>关于</a></div></div><a class=menu-item href=/friends/ title=欢迎申请友链><i class="fas fa-fw fa-link"></i>友链</a><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn" title=一些有意思的东东~><i class="fas fa-fw fa-fan fa-spin"></i>趣味</a><div class="menu-more-content dropdown-content"><a href=/funny/high/ title="前方高能♂ 小心外放！" target=_blank rel=noopener><i class="fas fa-fw fa-dizzy"></i>燥起来！ </a><a href=/funny/mikutap/ title=初音未来音乐游戏 target=_blank rel=noopener><i class="fas fa-fw fa-music"></i>在线打碟 </a><a href=/funny/catch-the-cat/ title=逮住那只猫!><i class="fas fa-fw fa-cat"></i>抓住猫咪</a></div></div><div class=dropdown><a href=/ class="menu-item menu-more dropbtn" title=回到首页><i class="fas fa-fw fa-atom"></i>站点</a><div class="menu-more-content dropdown-content"><a href=/bbs/ title=来留言吧~><i class="fas fa-fw fa-comment"></i>公告留言 </a><a href=https://seo.chinaz.com target=_blank rel=noopener><i class="fas fa-fw fa-chart-line"></i>SEO查询 </a><a href=https://www.ping.cn/http/lewky.cn target=_blank rel=noopener><i class="fas fa-fw fa-bezier-curve"></i>网站测速 </a><a href=/posts/e62c38c4.html/><i class="fas fa-fw fa-cog fa-spin"></i>建站日志</a></div></div><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn"><i class="fas fa-fw fa-book"></i>文档</a><div class="menu-more-content dropdown-content"><a href=https://gohugo.io/documentation/ target=_blank rel=noopener><i class="fas fa-fw fa-star"></i>Hugo文档 </a><a href=https://javanote.doc.lewky.cn/ title=尚在完善中~ target=_blank rel=noopener><i class="fab fa-fw fa-java"></i>Java 笔记</a></div></div><a class=menu-item href=/search/ title=渲染搜索结果需要等待几秒钟~><i class="fas fa-fw fa-search"></i>搜索
</a><span class="menu-item delimiter"></span><a href=https://travellings.link target=_blank class=menu-item rel=noopener title=开往-友链接力><i class="fas fa-fw fa-subway"></i></a><a href=https://rssblog.vercel.app/ class=menu-item target=_blank rel=noopener title=RSSBlog><i class="fas fa-fw fa-inbox"></i></a><a href=https://github.com/lewky class=menu-item target=_blank rel=noopener title=GitHub><i class="fab fa-fw fa-github"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Yulin Lewis' Blog"><span class=header-title-pre><i class="fas fa-fw fa-atom"></i></span>雨临Lewis</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=dropdown><a href=/posts/ class="menu-item menu-more dropbtn" title=点击查看所有文章><i class="fas fa-fw fa-archive"></i>归档</a><div class="menu-more-content dropdown-content"><a href=/categories/><i class="fas fa-fw fa-th"></i>分类 </a><a href=/tags/><i class="fas fa-fw fa-tag"></i>标签 </a><a href=/hot/ title=文章热度Top15><i class="fas fa-fw fa-fire"></i>热度 </a><a href=/donation/ title=感谢打赏，老板大气~><i class="fas fa-fw fa-donate"></i>打赏 </a><a href=/about/><i class="fas fa-fw fa-at"></i>关于</a></div></div><a class=menu-item href=/friends/ title=欢迎申请友链><i class="fas fa-fw fa-link"></i>友链</a><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn" title=一些有意思的东东~><i class="fas fa-fw fa-fan fa-spin"></i>趣味</a><div class="menu-more-content dropdown-content"><a href=/funny/high/ title="前方高能♂ 小心外放！" target=_blank rel=noopener><i class="fas fa-fw fa-dizzy"></i>燥起来！ </a><a href=/funny/mikutap/ title=初音未来音乐游戏 target=_blank rel=noopener><i class="fas fa-fw fa-music"></i>在线打碟 </a><a href=/funny/catch-the-cat/ title=逮住那只猫!><i class="fas fa-fw fa-cat"></i>抓住猫咪</a></div></div><div class=dropdown><a href=/ class="menu-item menu-more dropbtn" title=回到首页><i class="fas fa-fw fa-atom"></i>站点</a><div class="menu-more-content dropdown-content"><a href=/bbs/ title=来留言吧~><i class="fas fa-fw fa-comment"></i>公告留言 </a><a href=https://seo.chinaz.com target=_blank rel=noopener><i class="fas fa-fw fa-chart-line"></i>SEO查询 </a><a href=https://www.ping.cn/http/lewky.cn target=_blank rel=noopener><i class="fas fa-fw fa-bezier-curve"></i>网站测速 </a><a href=/posts/e62c38c4.html/><i class="fas fa-fw fa-cog fa-spin"></i>建站日志</a></div></div><div class=dropdown><a href=javascript:void(0); class="menu-item menu-more dropbtn"><i class="fas fa-fw fa-book"></i>文档</a><div class="menu-more-content dropdown-content"><a href=https://gohugo.io/documentation/ target=_blank rel=noopener><i class="fas fa-fw fa-star"></i>Hugo文档 </a><a href=https://javanote.doc.lewky.cn/ title=尚在完善中~ target=_blank rel=noopener><i class="fab fa-fw fa-java"></i>Java 笔记</a></div></div><a class=menu-item href=/search/ title=渲染搜索结果需要等待几秒钟~><i class="fas fa-fw fa-search"></i>搜索</a>
<a href=https://travellings.link target=_blank class=menu-item rel=noopener title=开往-友链接力><i class="fas fa-fw fa-subway"></i></a><a href=https://rssblog.vercel.app/ class=menu-item target=_blank rel=noopener title=RSSBlog><i class="fas fa-fw fa-inbox"></i></a><a href=https://github.com/lewky class=menu-item target=_blank rel=noopener title=GitHub><i class="fab fa-fw fa-github"></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>目录</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animated flipInX">Log4j和Log4j2怎么动态加载配置文件</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>雨临Lewis</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/%E6%97%A5%E5%BF%97%E6%A1%86%E6%9E%B6/><i class="far fa-folder fa-fw"></i>日志框架</a></span></div><div class=post-meta-line><i class="far fa-calendar fa-fw"></i>&nbsp;<time datetime=2018-12-28>2018-12-28</time>&nbsp;<i class="far fa-calendar-plus fa-fw"></i>&nbsp;<time datetime=2018-12-28>2018-12-28</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 3430 字
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 7 分钟&nbsp;<span id=/posts/2c65baa3.html/ class=leancloud_visitors data-flag-title=Log4j和Log4j2怎么动态加载配置文件>
<i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
</span>&nbsp;
<a href=#comments id=post-meta-vcount title=查看评论><i class="fas fa-comment fa-fw"></i>&nbsp;<span id=/posts/2c65baa3.html/ class=waline-comment-count></span>&nbsp;条评论</a></div></div><div class="details toc" id=toc-static kept><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fas fa-angle-right"></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ol><li><a href=#应用场景与问题>应用场景与问题</a></li><li><a href=#log4j-1x动态加载配置文件>log4j 1.X动态加载配置文件</a></li><li><a href=#log4j2动态加载配置文件>log4j2动态加载配置文件</a></li><li><a href=#log4j-1x动态加载配置文件的底层实现原理>Log4j 1.X动态加载配置文件的底层实现原理</a><ol><li><a href=#domconfiguratorconfigureandwatch源码解析>DOMConfigurator#configureAndWatch源码解析</a></li><li><a href=#总结>总结</a></li><li><a href=#propertyconfiguratorconfigureandwatch源码解析>PropertyConfigurator#configureAndWatch源码解析</a></li></ol></li><li><a href=#log4j2底层实现动态加载配置文件的简单解析>log4j2底层实现动态加载配置文件的简单解析</a></li><li><a href=#参考链接>参考链接</a></li></ol></nav></div></div><div class=content id=content><h2 id=应用场景与问题>应用场景与问题</h2><p>当项目在运行时，我们如果需要修改log4j 1.X或者log4j2的配置文件，一般来说我们是不能直接将项目停止运行再来修改文件重新部署的。于是就有这样一个问题：如何在不停止当前项目的运行的情况下，让系统能够自动地监控配置文件的修改状况，从而实现动态加载配置文件的功能？而log4j 1.X和log4j2的差别略大，各自应该怎么实现这个功能？</p><h2 id=log4j-1x动态加载配置文件>log4j 1.X动态加载配置文件</h2><p>log4j 1.X提供了动态加载配置文件的方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=n>DOMConfigurator</span><span class=o>.</span><span class=na>configureAndWatch</span><span class=o>()</span>
<span class=n>PropertyConfigurator</span><span class=o>.</span><span class=na>onfigureAndWatch</span><span class=o>()</span>
</code></pre></td></tr></table></div></div><p><code>DOMConfigurator</code>对应的是xml配置文件，<code>PropertyConfigurator</code>对应的是properties配置文件。这两个类都有<code>configureAndWatch</code>这个方法，该方法有个重载方法，如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=n>configureAndWatch</span><span class=o>(</span><span class=n>String</span> <span class=n>configFilename</span><span class=o>)</span>
<span class=n>configureAndWatch</span><span class=o>(</span><span class=n>String</span> <span class=n>configFilename</span><span class=o>,</span> <span class=kt>long</span> <span class=n>delay</span><span class=o>)</span>

</code></pre></td></tr></table></div></div><p><code>configureAndWatch</code>方法用来监控配置文件是否被改动，监控的时间间隔是<code>delay</code>参数来决定，如果不传入该参数则使用默认的时间间隔1分钟(60000L)。<code>configureAndWatch(String configFilename)</code>实际上还是调用的<code>configureAndWatch(String configFilename, long delay)</code>。</p><h2 id=log4j2动态加载配置文件>log4j2动态加载配置文件</h2><p>和log4j 1.X比起来，log4j2的动态加载配置很简单就能实现，不需要另外在代码中调用api，方法如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-xml data-lang=xml><span class=nt>&lt;configuration</span> <span class=na>monitorInterval=</span><span class=s>&#34;30&#34;</span><span class=nt>&gt;</span>
    ...
<span class=nt>&lt;/configuration&gt;</span>
</code></pre></td></tr></table></div></div><p>在log4j2.xml配置文件中的<code>configuration</code>节点添加<code>monitorInterval</code>的值，单位是秒，如果配置的值大于0，则会按照时间间隔来自动扫描配置文件是否被修改，并在修改后重新加载最新的配置文件。如果不配置该值，默认为0，即不扫描配置文件是否被修改。</p><h2 id=log4j-1x动态加载配置文件的底层实现原理>Log4j 1.X动态加载配置文件的底层实现原理</h2><h3 id=domconfiguratorconfigureandwatch源码解析>DOMConfigurator#configureAndWatch源码解析</h3><p>org.apache.log4j.xml.DOMConfigurator#configureAndWatch源码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=kd>static</span> <span class=kd>public</span> <span class=kt>void</span> <span class=nf>configureAndWatch</span><span class=o>(</span><span class=n>String</span> <span class=n>configFilename</span><span class=o>,</span> <span class=kt>long</span> <span class=n>delay</span><span class=o>)</span> <span class=o>{</span>
    <span class=n>XMLWatchdog</span> <span class=n>xdog</span> <span class=o>=</span> <span class=k>new</span> <span class=n>XMLWatchdog</span><span class=o>(</span><span class=n>configFilename</span><span class=o>);</span>
    <span class=n>xdog</span><span class=o>.</span><span class=na>setDelay</span><span class=o>(</span><span class=n>delay</span><span class=o>);</span>
    <span class=n>xdog</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
<span class=o>}</span>
</code></pre></td></tr></table></div></div><p>这里new了一个XMLWatchdog对象，接着设置了delay参数，最后调用了start()方法。
watchdog是看门狗、检查者的意思，XMLWatchdog继承了FileWatchdog这个类，在XMLWatchdog中仅仅重写了doOnChange方法：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kt>void</span> <span class=nf>doOnChange</span><span class=o>()</span> <span class=o>{</span>
    <span class=k>new</span> <span class=n>DOMConfigurator</span><span class=o>().</span><span class=na>doConfigure</span><span class=o>(</span><span class=n>filename</span><span class=o>,</span> <span class=n>LogManager</span><span class=o>.</span><span class=na>getLoggerRepository</span><span class=o>());</span>
<span class=o>}</span>
</code></pre></td></tr></table></div></div><p>从方法名就可以看出来，如果XMLWatchdog监控到配置文件被改动了，就会调用这个doOnChange方法，用来重新加载配置文件。那么它又是怎么知道配置文件被改动过了呢？接着看其父类FileWatchdog的源码：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span><span class=lnt>71
</span><span class=lnt>72
</span><span class=lnt>73
</span><span class=lnt>74
</span><span class=lnt>75
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=kd>public</span> <span class=kd>abstract</span> <span class=kd>class</span> <span class=nc>FileWatchdog</span> <span class=kd>extends</span> <span class=n>Thread</span> <span class=o>{</span>

  <span class=cm>/**
</span><span class=cm>     The default delay between every file modification check, set to 60
</span><span class=cm>     seconds.  */</span>
  <span class=kd>static</span> <span class=kd>final</span> <span class=kd>public</span> <span class=kt>long</span> <span class=n>DEFAULT_DELAY</span> <span class=o>=</span> <span class=n>60000</span><span class=o>;</span> 
  <span class=cm>/**
</span><span class=cm>     The name of the file to observe  for changes.
</span><span class=cm>   */</span>
  <span class=kd>protected</span> <span class=n>String</span> <span class=n>filename</span><span class=o>;</span>
  
  <span class=cm>/**
</span><span class=cm>     The delay to observe between every check. By default set {@link
</span><span class=cm>     #DEFAULT_DELAY}. */</span>
  <span class=kd>protected</span> <span class=kt>long</span> <span class=n>delay</span> <span class=o>=</span> <span class=n>DEFAULT_DELAY</span><span class=o>;</span> 
  
  <span class=n>File</span> <span class=n>file</span><span class=o>;</span>
  <span class=kt>long</span> <span class=n>lastModif</span> <span class=o>=</span> <span class=n>0</span><span class=o>;</span> 
  <span class=kt>boolean</span> <span class=n>warnedAlready</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
  <span class=kt>boolean</span> <span class=n>interrupted</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>

  <span class=kd>protected</span> <span class=nf>FileWatchdog</span><span class=o>(</span><span class=n>String</span> <span class=n>filename</span><span class=o>)</span> <span class=o>{</span>
    <span class=kd>super</span><span class=o>(</span><span class=s>&#34;FileWatchdog&#34;</span><span class=o>);</span>
    <span class=k>this</span><span class=o>.</span><span class=na>filename</span> <span class=o>=</span> <span class=n>filename</span><span class=o>;</span>
    <span class=n>file</span> <span class=o>=</span> <span class=k>new</span> <span class=n>File</span><span class=o>(</span><span class=n>filename</span><span class=o>);</span>
    <span class=n>setDaemon</span><span class=o>(</span><span class=kc>true</span><span class=o>);</span>
    <span class=n>checkAndConfigure</span><span class=o>();</span>
  <span class=o>}</span>

  <span class=cm>/**
</span><span class=cm>     Set the delay to observe between each check of the file changes.
</span><span class=cm>   */</span>
  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>setDelay</span><span class=o>(</span><span class=kt>long</span> <span class=n>delay</span><span class=o>)</span> <span class=o>{</span>
    <span class=k>this</span><span class=o>.</span><span class=na>delay</span> <span class=o>=</span> <span class=n>delay</span><span class=o>;</span>
  <span class=o>}</span>

  <span class=kd>abstract</span> <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>doOnChange</span><span class=o>();</span>

  <span class=kd>protected</span> <span class=kt>void</span> <span class=nf>checkAndConfigure</span><span class=o>()</span> <span class=o>{</span>
    <span class=kt>boolean</span> <span class=n>fileExists</span><span class=o>;</span>
    <span class=k>try</span> <span class=o>{</span>
      <span class=n>fileExists</span> <span class=o>=</span> <span class=n>file</span><span class=o>.</span><span class=na>exists</span><span class=o>();</span>
    <span class=o>}</span> <span class=k>catch</span><span class=o>(</span><span class=n>SecurityException</span>  <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
      <span class=n>LogLog</span><span class=o>.</span><span class=na>warn</span><span class=o>(</span><span class=s>&#34;Was not allowed to read check file existance, file:[&#34;</span><span class=o>+</span>
          <span class=n>filename</span><span class=o>+</span><span class=s>&#34;].&#34;</span><span class=o>);</span>
      <span class=n>interrupted</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span> <span class=c1>// there is no point in continuing
</span><span class=c1></span>      <span class=k>return</span><span class=o>;</span>
    <span class=o>}</span>

    <span class=k>if</span><span class=o>(</span><span class=n>fileExists</span><span class=o>)</span> <span class=o>{</span>
      <span class=kt>long</span> <span class=n>l</span> <span class=o>=</span> <span class=n>file</span><span class=o>.</span><span class=na>lastModified</span><span class=o>();</span> <span class=c1>// this can also throw a SecurityException
</span><span class=c1></span>      <span class=k>if</span><span class=o>(</span><span class=n>l</span> <span class=o>&gt;</span> <span class=n>lastModif</span><span class=o>)</span> <span class=o>{</span>           <span class=c1>// however, if we reached this point this
</span><span class=c1></span>    <span class=n>lastModif</span> <span class=o>=</span> <span class=n>l</span><span class=o>;</span>              <span class=c1>// is very unlikely.
</span><span class=c1></span>    <span class=n>doOnChange</span><span class=o>();</span>
    <span class=n>warnedAlready</span> <span class=o>=</span> <span class=kc>false</span><span class=o>;</span>
      <span class=o>}</span>
    <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
      <span class=k>if</span><span class=o>(!</span><span class=n>warnedAlready</span><span class=o>)</span> <span class=o>{</span>
    <span class=n>LogLog</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;[&#34;</span><span class=o>+</span><span class=n>filename</span><span class=o>+</span><span class=s>&#34;] does not exist.&#34;</span><span class=o>);</span>
    <span class=n>warnedAlready</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
      <span class=o>}</span>
    <span class=o>}</span>
  <span class=o>}</span>

  <span class=kd>public</span> <span class=kt>void</span> <span class=nf>run</span><span class=o>()</span> <span class=o>{</span>    
    <span class=k>while</span><span class=o>(!</span><span class=n>interrupted</span><span class=o>)</span> <span class=o>{</span>
      <span class=k>try</span> <span class=o>{</span>
        <span class=n>Thread</span><span class=o>.</span><span class=na>sleep</span><span class=o>(</span><span class=n>delay</span><span class=o>);</span>
      <span class=o>}</span> <span class=k>catch</span><span class=o>(</span><span class=n>InterruptedException</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
    <span class=c1>// no interruption expected
</span><span class=c1></span>      <span class=o>}</span>
      <span class=n>checkAndConfigure</span><span class=o>();</span>
    <span class=o>}</span>
  <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table></div></div><p>可以看到，FileWatchdog继承了Thread类，类里定义了几个成员变量，比如默认的监控时间间隔等。而在该类的构造方法中可以看到，首先该线程类将名字设定成<code>FileWatchdog</code>，接着根据传入的配置文件的路径new了一个File对象，然后该线程类又设置成了守护线程(daemon thread)，最后调用了<code>checkAndConfigure()</code>。</p><p>在<code>checkAndConfigure()</code>中，则是对new出来的配置文件File对象进行检查是否存在该文件，若不存在该文件则会设置成员变量的值，这样就不会去监控不存在的配置文件了。如果该配置文件存在，则通过<code>lastModified()</code>来获取文件的最后更新时间，和上次的更新时间作对比，如果比上次更新时间大则会调用<code>doOnChange()</code>来重新加载配置文件。</p><p>而在FileWatchdog的run方法中，则是在无限循环中先让线程睡眠设置好的监控时间间隔，然后调用<code>checkAndConfigure()</code>。</p><h3 id=总结>总结</h3><p>可以看出，在log4j 1.X的DOMConfigurator中，是通过创建一个守护线程来不停地扫描配置文件的最后更新时间，并和上次的更新时间进行对比，如果最后更新时间大于上次更新时间则会重新加载配置文件。</p><h3 id=propertyconfiguratorconfigureandwatch源码解析>PropertyConfigurator#configureAndWatch源码解析</h3><p>PropertyConfigurator的<code>configureAndWatch()</code>其实和DOMConfigurator差不多，区别是PropertyConfigurator在方法里new了一个PropertyWatchdog对象，PropertyWatchdog和XMLWatchdog一样继承了FileWatchdog，一样重写了doOnChange()方法。只是PropertyWatchdog是通过new PropertyConfigurator().doConfigure()来加载配置文件的。</p><p>从源码实现来看，无论是使用xml配置文件，还是使用properties配置文件，其动态加载配置文件的底层实现是基本一样的。可以通过解析配置文件的文件后缀来判断是xml还是properties文件，然后调用对应的方法即可，大概的思路如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=kt>boolean</span> <span class=n>flag</span> <span class=o>=</span> <span class=kc>true</span><span class=o>;</span>
<span class=kt>boolean</span> <span class=n>isXml</span> <span class=o>=</span> <span class=n>StringUtils</span><span class=o>.</span><span class=na>equalsIgnoreCase</span><span class=o>(</span><span class=s>&#34;xml&#34;</span><span class=o>,</span> <span class=n>StringUtils</span><span class=o>.</span><span class=na>substringAfterLast</span><span class=o>(</span><span class=n>filepath</span><span class=o>,</span> <span class=s>&#34;.&#34;</span><span class=o>));</span>
<span class=n>ling</span> <span class=n>delay</span> <span class=o>=</span> <span class=n>30000</span><span class=o>;</span>

<span class=k>if</span> <span class=o>(</span><span class=n>isXml</span><span class=o>)</span> <span class=o>{</span>
  <span class=k>if</span> <span class=o>(</span><span class=n>flag</span><span class=o>)</span> <span class=o>{</span>
    <span class=n>DOMConfigurator</span><span class=o>.</span><span class=na>configureAndWatch</span><span class=o>(</span><span class=n>filepath</span><span class=o>,</span> <span class=n>delay</span><span class=o>);</span>
  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
    <span class=n>DOMConfigurator</span><span class=o>.</span><span class=na>configure</span><span class=o>(</span><span class=n>filepath</span><span class=o>);</span>
  <span class=o>}</span>
<span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
  <span class=k>if</span> <span class=o>(</span><span class=n>flag</span><span class=o>)</span> <span class=o>{</span>
    <span class=n>PropertyConfigurator</span><span class=o>.</span><span class=na>configureAndWatch</span><span class=o>(</span><span class=n>filepath</span><span class=o>,</span> <span class=n>delay</span><span class=o>);</span>
  <span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
    <span class=n>PropertyConfigurator</span><span class=o>.</span><span class=na>configure</span><span class=o>(</span><span class=n>filepath</span><span class=o>);</span>
  <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table></div></div><h2 id=log4j2底层实现动态加载配置文件的简单解析>log4j2底层实现动态加载配置文件的简单解析</h2><p>虽然log4j2的动态加载配置很简单，但其底层实现比起log4j 1.X却要复杂很多，使用到了很多并发包下的类，具体也不是很了解，这里简单解释下流程。</p><p>对于log4j2.xml文件，对应的是<code>org.apache.logging.log4j.core.config.xml.XmlConfiguration</code>这个类。如果在log4j2.xml里配置了monitorInterval，在构建XmlConfiguration时会根据该值来走一段特定的逻辑：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=k>for</span> <span class=o>(</span><span class=kd>final</span> <span class=n>Map</span><span class=o>.</span><span class=na>Entry</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>String</span><span class=o>&gt;</span> <span class=n>entry</span> <span class=o>:</span> <span class=n>attrs</span><span class=o>.</span><span class=na>entrySet</span><span class=o>())</span> <span class=o>{</span>
    <span class=kd>final</span> <span class=n>String</span> <span class=n>key</span> <span class=o>=</span> <span class=n>entry</span><span class=o>.</span><span class=na>getKey</span><span class=o>();</span>
    <span class=kd>final</span> <span class=n>String</span> <span class=n>value</span> <span class=o>=</span> <span class=n>getStrSubstitutor</span><span class=o>().</span><span class=na>replace</span><span class=o>(</span><span class=n>entry</span><span class=o>.</span><span class=na>getValue</span><span class=o>());</span>
    <span class=k>if</span> <span class=o>(</span><span class=s>&#34;status&#34;</span><span class=o>.</span><span class=na>equalsIgnoreCase</span><span class=o>(</span><span class=n>key</span><span class=o>))</span> <span class=o>{</span>
        <span class=n>statusConfig</span><span class=o>.</span><span class=na>withStatus</span><span class=o>(</span><span class=n>value</span><span class=o>);</span>
    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=s>&#34;dest&#34;</span><span class=o>.</span><span class=na>equalsIgnoreCase</span><span class=o>(</span><span class=n>key</span><span class=o>))</span> <span class=o>{</span>
        <span class=n>statusConfig</span><span class=o>.</span><span class=na>withDestination</span><span class=o>(</span><span class=n>value</span><span class=o>);</span>
    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=s>&#34;shutdownHook&#34;</span><span class=o>.</span><span class=na>equalsIgnoreCase</span><span class=o>(</span><span class=n>key</span><span class=o>))</span> <span class=o>{</span>
        <span class=n>isShutdownHookEnabled</span> <span class=o>=</span> <span class=o>!</span><span class=s>&#34;disable&#34;</span><span class=o>.</span><span class=na>equalsIgnoreCase</span><span class=o>(</span><span class=n>value</span><span class=o>);</span>
    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=s>&#34;shutdownTimeout&#34;</span><span class=o>.</span><span class=na>equalsIgnoreCase</span><span class=o>(</span><span class=n>key</span><span class=o>))</span> <span class=o>{</span>
        <span class=n>shutdownTimeoutMillis</span> <span class=o>=</span> <span class=n>Long</span><span class=o>.</span><span class=na>parseLong</span><span class=o>(</span><span class=n>value</span><span class=o>);</span>
    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=s>&#34;verbose&#34;</span><span class=o>.</span><span class=na>equalsIgnoreCase</span><span class=o>(</span><span class=n>key</span><span class=o>))</span> <span class=o>{</span>
        <span class=n>statusConfig</span><span class=o>.</span><span class=na>withVerbosity</span><span class=o>(</span><span class=n>value</span><span class=o>);</span>
    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=s>&#34;packages&#34;</span><span class=o>.</span><span class=na>equalsIgnoreCase</span><span class=o>(</span><span class=n>key</span><span class=o>))</span> <span class=o>{</span>
        <span class=n>pluginPackages</span><span class=o>.</span><span class=na>addAll</span><span class=o>(</span><span class=n>Arrays</span><span class=o>.</span><span class=na>asList</span><span class=o>(</span><span class=n>value</span><span class=o>.</span><span class=na>split</span><span class=o>(</span><span class=n>Patterns</span><span class=o>.</span><span class=na>COMMA_SEPARATOR</span><span class=o>)));</span>
    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=s>&#34;name&#34;</span><span class=o>.</span><span class=na>equalsIgnoreCase</span><span class=o>(</span><span class=n>key</span><span class=o>))</span> <span class=o>{</span>
        <span class=n>setName</span><span class=o>(</span><span class=n>value</span><span class=o>);</span>
    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=s>&#34;strict&#34;</span><span class=o>.</span><span class=na>equalsIgnoreCase</span><span class=o>(</span><span class=n>key</span><span class=o>))</span> <span class=o>{</span>
        <span class=n>strict</span> <span class=o>=</span> <span class=n>Boolean</span><span class=o>.</span><span class=na>parseBoolean</span><span class=o>(</span><span class=n>value</span><span class=o>);</span>
    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=s>&#34;schema&#34;</span><span class=o>.</span><span class=na>equalsIgnoreCase</span><span class=o>(</span><span class=n>key</span><span class=o>))</span> <span class=o>{</span>
        <span class=n>schemaResource</span> <span class=o>=</span> <span class=n>value</span><span class=o>;</span>
    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=s>&#34;monitorInterval&#34;</span><span class=o>.</span><span class=na>equalsIgnoreCase</span><span class=o>(</span><span class=n>key</span><span class=o>))</span> <span class=o>{</span>
        <span class=kd>final</span> <span class=kt>int</span> <span class=n>intervalSeconds</span> <span class=o>=</span> <span class=n>Integer</span><span class=o>.</span><span class=na>parseInt</span><span class=o>(</span><span class=n>value</span><span class=o>);</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>intervalSeconds</span> <span class=o>&gt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
            <span class=n>getWatchManager</span><span class=o>().</span><span class=na>setIntervalSeconds</span><span class=o>(</span><span class=n>intervalSeconds</span><span class=o>);</span>
            <span class=k>if</span> <span class=o>(</span><span class=n>configFile</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
                <span class=kd>final</span> <span class=n>FileWatcher</span> <span class=n>watcher</span> <span class=o>=</span> <span class=k>new</span> <span class=n>ConfiguratonFileWatcher</span><span class=o>(</span><span class=k>this</span><span class=o>,</span> <span class=n>listeners</span><span class=o>);</span>
                <span class=n>getWatchManager</span><span class=o>().</span><span class=na>watchFile</span><span class=o>(</span><span class=n>configFile</span><span class=o>,</span> <span class=n>watcher</span><span class=o>);</span>
            <span class=o>}</span>
        <span class=o>}</span>
    <span class=o>}</span> <span class=k>else</span> <span class=k>if</span> <span class=o>(</span><span class=s>&#34;advertiser&#34;</span><span class=o>.</span><span class=na>equalsIgnoreCase</span><span class=o>(</span><span class=n>key</span><span class=o>))</span> <span class=o>{</span>
        <span class=n>createAdvertiser</span><span class=o>(</span><span class=n>value</span><span class=o>,</span> <span class=n>configSource</span><span class=o>,</span> <span class=n>buffer</span><span class=o>,</span> <span class=s>&#34;text/xml&#34;</span><span class=o>);</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table></div></div><p>可以看到，如果monitorInterval的值大于0，则会拿到WatchManager并设置扫描配置文件的时间间隔，如果配置文件存在，则会new一个ConfiguratonFileWatcher对象，并将配置文件和该对象一起传递给WatchManager的watchFile方法。这两个方法的底层实现很绕，比起log4j 1.X要复杂得多，不容易看懂。不过最终实现的效果还是一样的，依然会开启一个守护线程来监控配置文件是否被改动。</p><p>区别在于，log4j2使用线程池来启动线程，在<code>WatchManager#start()</code>里实现的：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>start</span><span class=o>()</span> <span class=o>{</span>
    <span class=kd>super</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
    <span class=k>if</span> <span class=o>(</span><span class=n>intervalSeconds</span> <span class=o>&gt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>future</span> <span class=o>=</span> <span class=n>scheduler</span><span class=o>.</span><span class=na>scheduleWithFixedDelay</span><span class=o>(</span><span class=k>new</span> <span class=n>WatchRunnable</span><span class=o>(),</span> <span class=n>intervalSeconds</span><span class=o>,</span> <span class=n>intervalSeconds</span><span class=o>,</span>
                <span class=n>TimeUnit</span><span class=o>.</span><span class=na>SECONDS</span><span class=o>);</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></td></tr></table></div></div><p>而该方法则是在启动配置文件时被调用的，<code>AbstractConfiguration#start()</code>：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java><span class=cm>/**
</span><span class=cm> * Start the configuration.
</span><span class=cm> */</span>
<span class=nd>@Override</span>
<span class=kd>public</span> <span class=kt>void</span> <span class=nf>start</span><span class=o>()</span> <span class=o>{</span>
    <span class=c1>// Preserve the prior behavior of initializing during start if not initialized.
</span><span class=c1></span>    <span class=k>if</span> <span class=o>(</span><span class=n>getState</span><span class=o>().</span><span class=na>equals</span><span class=o>(</span><span class=n>State</span><span class=o>.</span><span class=na>INITIALIZING</span><span class=o>))</span> <span class=o>{</span>
        <span class=n>initialize</span><span class=o>();</span>
    <span class=o>}</span>
    <span class=n>LOGGER</span><span class=o>.</span><span class=na>debug</span><span class=o>(</span><span class=s>&#34;Starting configuration {}&#34;</span><span class=o>,</span> <span class=k>this</span><span class=o>);</span>
    <span class=k>this</span><span class=o>.</span><span class=na>setStarting</span><span class=o>();</span>
    <span class=k>if</span> <span class=o>(</span><span class=n>watchManager</span><span class=o>.</span><span class=na>getIntervalSeconds</span><span class=o>()</span> <span class=o>&gt;</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
        <span class=n>watchManager</span><span class=o>.</span><span class=na>start</span><span class=o>();</span>
    <span class=o>}</span>
    <span class=o>...</span>
<span class=o>}</span>
</code></pre></td></tr></table></div></div><p>这里只是简单解析了下主要的流程，具体的实现细节目前还看不太懂，有兴趣的可以自己去看看log4j2的源码。另外我在官方文档里看到说<code>monitorInterval</code>的最小值是5，但是在源码里也没看到这个，我觉得只要配置值大于0应该就是可以的。有不对之处，欢迎指出。</p><p>这是官方原文：</p><blockquote><p>###Automatic Reconfiguration
When configured from a File, Log4j has the ability to automatically detect changes to the configuration file and reconfigure itself. If the monitorInterval attribute is specified on the configuration element and is set to a non-zero value then the file will be checked the next time a log event is evaluated and/or logged and the monitorInterval has elapsed since the last check. The example below shows how to configure the attribute so that the configuration file will be checked for changes only after at least 30 seconds have elapsed. The minimum interval is 5 seconds.</p></blockquote><h2 id=参考链接>参考链接</h2><ul><li><a href="https://www.oschina.net/translate/the-new-log4j-2-0?lang=chs&p=1" target=_blank rel="noopener noreffer">Log4j 2.0 的新特性</a></li><li><a href=http://logging.apache.org/log4j/2.x/manual/configuration.html#AutomaticConfiguration target=_blank rel="noopener noreffer">Log4j – Configuring Log4j 2 - Apache Log4j 2</a></li></ul><div class="details admonition warning open"><div class="details-summary admonition-title"><i class="icon fas fa-exclamation-triangle fa-fwwarning"></i>警告<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>本文最后更新于 <span class=timeago datetime=2018-12-28T00:34:44 title="December 28, 2018">December 28, 2018</span>，文中内容可能已过时，请谨慎使用。</div></div></div><div class=post-reward><input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>赞赏支持</label><div class=qr-code><label class=qr-code-image for=reward><img class=image src=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/common/wechat.png>
<span>微信打赏</span></label>
<label class=qr-code-image for=reward><img class=image src=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/common/alipay.png>
<span>支付宝打赏</span></label></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2018-12-28</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/posts/2c65baa3.html/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://lewky.cn/posts/2c65baa3.html/ data-title=Log4j和Log4j2怎么动态加载配置文件 data-hashtags=Log4j,Log4j2><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://lewky.cn/posts/2c65baa3.html/ data-hashtag=Log4j><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=https://lewky.cn/posts/2c65baa3.html/ data-title=Log4j和Log4j2怎么动态加载配置文件><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://lewky.cn/posts/2c65baa3.html/ data-title=Log4j和Log4j2怎么动态加载配置文件><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://lewky.cn/posts/2c65baa3.html/ data-title=Log4j和Log4j2怎么动态加载配置文件><i class="fab fa-weibo fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/log4j/>Log4j</a>,&nbsp;<a href=/tags/log4j2/>Log4j2</a></section><section><span><a href=javascript:void(0); onclick=window.history.back();>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/f53d27da.html/ class=prev rel=prev title=Log4j2中LevelRangeFilter的注意点><i class="fas fa-angle-left fa-fw"></i>Log4j2中LevelRangeFilter的注意点</a>
<a href=/posts/55fa957a.html/ class=next rel=next title="升级Log4j到Log4j2报错：cannot access org.apache.http.annotation.NotThreadSafe">升级Log4j到Log4j2报错：cannot access org.apache.http.annotation.NotThreadSafe<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=waline></div><script src=https://cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js></script><script>new Waline({el:'#waline',meta:["nick","mail","link"],requiredMeta:["nick","mail"],login:"force",placeholder:"为防恶意灌水攻击，评论前需注册并登录，望见谅~",serverURL:"https://comment.lewky.cn/",avatarCDN:"https://sdn.geekzu.org/avatar/",pageSize:20,avatar:"retro",lang:"zh-CN",visitor:true,highlight:true,uploadImage:false,emoji:['https:\/\/cdn.jsdelivr.net\/gh\/lewky\/lewky.github.io@master/images/emoji/嘉然今天吃什么','https:\/\/cdn.jsdelivr.net\/gh\/lewky\/lewky.github.io@master/images/emoji/向晚大魔王','https:\/\/cdn.jsdelivr.net\/gh\/lewky\/lewky.github.io@master/images/emoji/贝拉kira','https:\/\/cdn.jsdelivr.net\/gh\/lewky\/lewky.github.io@master/images/emoji/阿梓','https:\/\/cdn.jsdelivr.net\/gh\/lewky\/lewky.github.io@master/images/emoji/EveOneCat','https:\/\/cdn.jsdelivr.net\/gh\/lewky\/lewky.github.io@master/images/emoji/EveOneCat2','https://cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/weibo','https:\/\/cdn.jsdelivr.net\/gh\/lewky\/lewky.github.io@master/images/emoji/aru','https:\/\/cdn.jsdelivr.net\/gh\/lewky\/lewky.github.io@master/images/emoji/滑稽','https:\/\/cdn.jsdelivr.net\/gh\/lewky\/lewky.github.io@master/images/emoji/default'],});</script></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><span id=run-time></span>|
<a href=http://rssblog.vercel.app/ target=_blank rel=noopener title=RSSBlog><i class="fas fa-fw fa-inbox"></i>&nbsp;RSSBlog</a></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2018 - 2021</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>雨临Lewis</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp><a target=_blank href=http://www.beian.miit.gov.cn/ style=font-weight:700>粤ICP备19103822</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><div class=sidebar_wo><div id=leimu><img src=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/b2t/leimuA.png alt=雷姆 onmouseover="this.src='https:\/\/cdn.jsdelivr.net\/gh\/lewky\/lewky.github.io@master/images/b2t/leimuB.png'" onmouseout="this.src='https:\/\/cdn.jsdelivr.net\/gh\/lewky\/lewky.github.io@master/images/b2t/leimuA.png'" title=回到顶部></div><div class=sidebar_wo id=lamu><img src=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/b2t/lamuA.png alt=雷姆 onmouseover="this.src='https:\/\/cdn.jsdelivr.net\/gh\/lewky\/lewky.github.io@master/images/b2t/lamuB.png'" onmouseout="this.src='https:\/\/cdn.jsdelivr.net\/gh\/lewky\/lewky.github.io@master/images/b2t/lamuA.png'" title=回到底部></div></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":30},"comment":{},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true}};</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/jquery@2.1.3/dist/jquery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/jquery-backstretch@2.1.18/jquery.backstretch.min.js></script><script>$(function(){$(".site-avatar-plug-bilibili").attr("src","https:\/\/cdn.jsdelivr.net\/gh\/lewky\/lewky.github.io@master/images/avatar-plug/bilibili_"+(~~(134*Math.random())+1)+".png");});var avatar_plug=0;var avatar_click=1;jQuery(document).ready(function($){var frequency=1;var plug_count=134;$("div.home-avatar a").click(function(e){if(avatar_click%frequency===0){avatar_plug++;$(".site-avatar-plug-bilibili").attr("src","https:\/\/cdn.jsdelivr.net\/gh\/lewky\/lewky.github.io@master/images/avatar-plug/bilibili_"+avatar_plug+".png");}
if(avatar_plug===plug_count){avatar_plug=0;}
$("div.home-avatar a").attr("alt","再点击"+(frequency-avatar_click%frequency)+"次头像试试看~~");avatar_click++;});});</script><script>var $cdnPrefix="https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master";</script><script type=text/javascript src=/js/custom.js></script><script>var _hmt=_hmt||[];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?6f278ed0fdb01edb3b1e7398379e5432";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script></body></html>