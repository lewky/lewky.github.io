<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><meta http-equiv=x-ua-compatible content="IE=edge, chrome=1"><title>Java高并发秒杀API(四)之高并发优化 - Yulin Lewis' Blog</title><meta name=keywords content="雨临Lewis,Java,hugo,hexo,博客"><meta name=Description content="不想当写手的码农不是好咸鱼_(xз」∠)_"><meta property="og:title" content="Java高并发秒杀API(四)之高并发优化"><meta property="og:description" content="1. 高并发优化分析

关于并发

并发性上不去是因为当多个线程同时访问一行数据时，产生了事务，因此产生写锁，每当一个获取了事务的线程把锁释放，另一个排队线程才能拿到写锁，QPS(Query Per Second每秒查询率)和事务执行的时间有密切关系，事务执行时间越短，并发性越高，这也是要将费时的I/O操作移出事务的原因。"><meta property="og:type" content="article"><meta property="og:url" content="https://lewky.cn/posts/43941.html/"><meta property="og:image" content="https://lewky.cn/logo.png"><meta property="article:published_time" content="2017-10-06T17:07:54+08:00"><meta property="article:modified_time" content="2017-10-06T17:07:54+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://lewky.cn/logo.png"><meta name=twitter:title content="Java高并发秒杀API(四)之高并发优化"><meta name=twitter:description content="1. 高并发优化分析

关于并发

并发性上不去是因为当多个线程同时访问一行数据时，产生了事务，因此产生写锁，每当一个获取了事务的线程把锁释放，另一个排队线程才能拿到写锁，QPS(Query Per Second每秒查询率)和事务执行的时间有密切关系，事务执行时间越短，并发性越高，这也是要将费时的I/O操作移出事务的原因。"><meta name=application-name content="雨临Lewis的博客"><meta name=apple-mobile-web-app-title content="雨临Lewis的博客"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://lewky.cn/posts/43941.html/><link rel=prev href=https://lewky.cn/posts/33818.html/><link rel=next href=https://lewky.cn/posts/ppk-to-ssh-key.html/><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/normalize.css@8.0.1/normalize.min.css><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@3.7.2/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Java高并发秒杀API(四)之高并发优化","inLanguage":"","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/lewky.cn\/posts\/43941.html\/"},"genre":"posts","keywords":"项目笔记, SSM实战项目, 秒杀","wordcount":8286,"url":"https:\/\/lewky.cn\/posts\/43941.html\/","datePublished":"2017-10-06T17:07:54+08:00","dateModified":"2017-10-06T17:07:54+08:00","license":"This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher":{"@type":"Organization","name":"雨临Lewis","logo":"https:\/\/lewky.cn\/images\/avatar.jpg"},"author":{"@type":"Person","name":"雨临Lewis"},"description":""}</script></head><body header-desktop=fixed header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem('theme')?localStorage.getItem('theme')==='dark':('auto'==='auto'?window.matchMedia('(prefers-color-scheme: dark)').matches:'auto'==='dark'))&&document.body.setAttribute('theme','dark');</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><a href=https://github.com/lewky class=github-corner target=_blank title="Follow me on GitHub" aria-label="Follow me on GitHub"><svg width="3.5rem" height="3.5rem" viewBox="0 0 250 250" style="fill:#70b7fd;color:#fff;position:absolute;top:0;border:0;left:0;transform:scale(-1,1)" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div class=header-title><a href=/ title="Yulin Lewis' Blog"><span class=header-title-pre><i class="fas fa-fw fa-atom"></i></span>雨临Lewis</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/><i class="fas fa-fw fa-archive"></i>归档 </a><a class=menu-item href=/tags/><i class="fas fa-fw fa-tag"></i>标签 </a><a class=menu-item href=/categories/><i class="fas fa-fw fa-th"></i>分类 </a><a class=menu-item href=/about/><i class="fas fa-fw fa-at"></i>关于 </a><a class=menu-item href=/friends/><i class="fas fa-fw fa-fan fa-spin"></i>友链 </a><a class=menu-item href=/search/><i class="fas fa-fw fa-search"></i>搜索 </a><a href=javascript:void(0); class="menu-item language" title=更多><i class="fa fa-fw fa-angle-double-down"></i>更多
<select class=menu-more id=language-select-desktop onchange="location=this.value;">
<option class=placeholder>------</option><option value=/bbs/><i class="fas fa-fw fa-fan fa-spin"></i> BBS </option><option value=https://javanote.doc.lewky.cn/><i class="fas fa-fw fa-fan fa-spin"></i>JavaNote</option></select>
</a><span class="menu-item delimiter"></span><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题><i class="fas fa-adjust fa-fw"></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Yulin Lewis' Blog"><span class=header-title-pre><i class="fas fa-fw fa-atom"></i></span>雨临Lewis</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><a class=menu-item href=/posts/><i class="fas fa-fw fa-archive"></i>归档</a><a class=menu-item href=/tags/><i class="fas fa-fw fa-tag"></i>标签</a><a class=menu-item href=/categories/><i class="fas fa-fw fa-th"></i>分类</a><a class=menu-item href=/about/><i class="fas fa-fw fa-at"></i>关于</a><a class=menu-item href=/friends/><i class="fas fa-fw fa-fan fa-spin"></i>友链</a><a class=menu-item href=/search/><i class="fas fa-fw fa-search"></i>搜索</a><a href=javascript:void(0); class="menu-item theme-switch" title=切换主题>
<i class="fas fa-adjust fa-fw"></i></a><a href=javascript:void(0); class="menu-item language" title=更多><i class="fa fa-angle-double-down"></i>更多
<select class=menu-more id=language-select-desktop onchange="location=this.value;">
<option class=placeholder>------</option><option value=/bbs/><i class="fas fa-fw fa-fan fa-spin"></i> BBS </option><option value=https://javanote.doc.lewky.cn/><i class="fas fa-fw fa-fan fa-spin"></i>JavaNote</option></select></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><article class="page single"><h1 class="single-title animated flipInX">Java高并发秒杀API(四)之高并发优化</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw"></i>雨临Lewis</a></span>&nbsp;<span class=post-category>收录于 <a href=/categories/seckill/><i class="far fa-folder fa-fw"></i>seckill</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime=2017-10-06>2017-10-06</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;约 8286 字
<i class="far fa-clock fa-fw"></i>&nbsp;预计阅读 17 分钟&nbsp;<span id=/posts/43941.html/ class=leancloud_visitors data-flag-title=Java高并发秒杀API(四)之高并发优化>
<i class="far fa-eye fa-fw"></i>&nbsp;<span class=leancloud-visitors-count></span>&nbsp;次阅读
</span>&nbsp;
<a href=#comments id=post-meta-vcount title=查看评论><i class="fas fa-comment fa-fw"></i>&nbsp;<span id=/posts/43941.html/ class=waline-comment-count></span>&nbsp;条评论</a></div></div><div class=content id=content><h2 id=1-高并发优化分析><strong>1. 高并发优化分析</strong></h2><blockquote><p><strong>关于并发</strong></p></blockquote><p>并发性上不去是因为当多个线程同时访问一行数据时，产生了事务，因此产生写锁，每当一个获取了事务的线程把锁释放，另一个排队线程才能拿到写锁，QPS(Query Per Second每秒查询率)和事务执行的时间有密切关系，事务执行时间越短，并发性越高，这也是要将费时的I/O操作移出事务的原因。</p><blockquote><p><strong>在本项目中高并发发生在哪？</strong></p></blockquote><p><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e9%ab%98%e5%b9%b6%e5%8f%91%e5%8f%91%e7%94%9f%e7%9a%84%e5%9c%b0%e6%96%b9.jpg title=高并发发生的地方 data-thumbnail=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/高并发发生的地方.jpg data-sub-html="<h2> </h2><p>高并发发生的地方</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e9%ab%98%e5%b9%b6%e5%8f%91%e5%8f%91%e7%94%9f%e7%9a%84%e5%9c%b0%e6%96%b9.jpg data-srcset="https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e9%ab%98%e5%b9%b6%e5%8f%91%e5%8f%91%e7%94%9f%e7%9a%84%e5%9c%b0%e6%96%b9.jpg, https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e9%ab%98%e5%b9%b6%e5%8f%91%e5%8f%91%e7%94%9f%e7%9a%84%e5%9c%b0%e6%96%b9.jpg 1.5x, https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e9%ab%98%e5%b9%b6%e5%8f%91%e5%8f%91%e7%94%9f%e7%9a%84%e5%9c%b0%e6%96%b9.jpg 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/高并发发生的地方.jpg></a><figcaption class=image-caption>高并发发生的地方</figcaption></figure></p><p>在上图中，红色的部分就表示会发生高并发的地方，绿色部分表示对于高并发没有影响。</p><blockquote><p><strong>为什么需要单独获取系统时间？</strong></p></blockquote><p>这是为了我们的秒杀系统的优化做铺垫。比如在秒杀还未开始的时候，用户大量刷新秒杀商品详情页面是很正常的情况，这时候秒杀还未开始，大量的请求发送到服务器会造成不必要的负担。</p><p>我们将这个详情页放置到CDN中，这样用户在访问该页面时就不需要访问我们的服务器了，起到了降低服务器压力的作用。而CDN中存储的是静态化的详情页和一些静态资源（css，js等），这样我们就拿不到系统的时间来进行秒杀时段的控制，所以我们需要单独设计一个请求来获取我们服务器的系统时间。</p><p><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e8%af%a6%e6%83%85%e9%a1%b5.png title=详情页 data-thumbnail=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/详情页.png data-sub-html="<h2> </h2><p>详情页</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e8%af%a6%e6%83%85%e9%a1%b5.png data-srcset="https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e8%af%a6%e6%83%85%e9%a1%b5.png, https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e8%af%a6%e6%83%85%e9%a1%b5.png 1.5x, https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e8%af%a6%e6%83%85%e9%a1%b5.png 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/详情页.png></a><figcaption class=image-caption>详情页</figcaption></figure></p><blockquote><p><strong>CDN（Content Delivery Network）的理解</strong></p></blockquote><p><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/CDN.jpg title=CDN data-thumbnail=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/CDN.jpg data-sub-html="<h2> </h2><p>CDN</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/CDN.jpg data-srcset="https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/CDN.jpg, https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/CDN.jpg 1.5x, https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/CDN.jpg 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/CDN.jpg></a><figcaption class=image-caption>CDN</figcaption></figure></p><blockquote><p><strong>获取系统时间不需要优化</strong></p></blockquote><p>因为Java访问一次内存（Cacheline）大约10ns，1s=10亿ns，也就是如果不考虑GC，这个操作1s可以做1亿次。</p><blockquote><p><strong>秒杀地址接口分析</strong></p></blockquote><ul><li>无法使用CDN缓存，因为CDN适合请求对应的资源不变化的，比如静态资源、JavaScript；秒杀地址返回的数据是变化的，不适合放在CDN缓存；</li><li>适合服务端缓存：Redis等，1秒钟可以承受10万qps。多个Redis组成集群，可以到100w个qps. 所以后端缓存可以用业务系统控制。</li></ul><blockquote><p><strong>秒杀地址接口优化</strong></p></blockquote><p><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e7%a7%92%e6%9d%80%e5%9c%b0%e5%9d%80%e6%8e%a5%e5%8f%a3%e4%bc%98%e5%8c%96.jpg title=秒杀地址接口优化 data-thumbnail=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/秒杀地址接口优化.jpg data-sub-html="<h2> </h2><p>秒杀地址接口优化</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e7%a7%92%e6%9d%80%e5%9c%b0%e5%9d%80%e6%8e%a5%e5%8f%a3%e4%bc%98%e5%8c%96.jpg data-srcset="https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e7%a7%92%e6%9d%80%e5%9c%b0%e5%9d%80%e6%8e%a5%e5%8f%a3%e4%bc%98%e5%8c%96.jpg, https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e7%a7%92%e6%9d%80%e5%9c%b0%e5%9d%80%e6%8e%a5%e5%8f%a3%e4%bc%98%e5%8c%96.jpg 1.5x, https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e7%a7%92%e6%9d%80%e5%9c%b0%e5%9d%80%e6%8e%a5%e5%8f%a3%e4%bc%98%e5%8c%96.jpg 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/秒杀地址接口优化.jpg></a><figcaption class=image-caption>秒杀地址接口优化</figcaption></figure></p><blockquote><p><strong>秒杀操作优化分析</strong></p></blockquote><ul><li>无法使用cdn缓存</li><li>后端缓存困难： 库存问题</li><li>一行数据竞争：热点商品</li></ul><p>大部分写的操作和核心操作无法使用CDN，也不可能在缓存中减库存。你在Redis中减库存，那么用户也可能通过缓存来减库存，这样库存会不一致，所以要通过mysql的事务来保证一致性。</p><p>比如一个热点商品所有人都在抢，那么会在同一时间对数据表中的一行数据进行大量的update set操作。</p><p>行级锁在commit之后才释放，所以优化方向是减少行级锁的持有时间。</p><blockquote><p><strong>延迟问题很关键</strong></p></blockquote><ul><li>同城机房网络（0.5ms~2ms），最高并发性是1000qps。</li><li>Update后JVM -GC(垃圾回收机制)大约50ms，最高并发性是20qps。并发性越高，GC就越可能发生，虽然不一定每次都会发生，但一定会发生。</li><li>异地机房，比如北京到上海之间的网络延迟，进过计算大概13~20ms。</li></ul><p><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e7%bd%91%e7%bb%9c%e5%bb%b6%e8%bf%9f%e8%ae%a1%e7%ae%97.jpg title=网络延迟计算 data-thumbnail=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/网络延迟计算.jpg data-sub-html="<h2> </h2><p>网络延迟计算</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e7%bd%91%e7%bb%9c%e5%bb%b6%e8%bf%9f%e8%ae%a1%e7%ae%97.jpg data-srcset="https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e7%bd%91%e7%bb%9c%e5%bb%b6%e8%bf%9f%e8%ae%a1%e7%ae%97.jpg, https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e7%bd%91%e7%bb%9c%e5%bb%b6%e8%bf%9f%e8%ae%a1%e7%ae%97.jpg 1.5x, https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e7%bd%91%e7%bb%9c%e5%bb%b6%e8%bf%9f%e8%ae%a1%e7%ae%97.jpg 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/网络延迟计算.jpg></a><figcaption class=image-caption>网络延迟计算</figcaption></figure></p><blockquote><p><strong>如何判断update更新库存成功？</strong></p></blockquote><p>有两个条件：</p><ol><li>update自身没报错；</li><li>客户端确认update影响记录数</li></ol><p>优化思路：</p><ul><li>把客户端逻辑放到MySQL服务端，避免网络延迟和GC影响</li></ul><blockquote><p><strong>如何把客户端逻辑放到MySQL服务端</strong></p></blockquote><p>有两种方案：</p><ol><li>定制SQL方案，在每次update后都会自动提交，但需要修改MySQL源码，成本很高，不是大公司（BAT等）一般不会使用这种方法。</li><li>使用存储过程：整个事务在MySQL端完成，用存储过程写业务逻辑，服务端负责调用。</li></ol><p>接下来先分析第一种方案</p><p><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e7%a7%92%e6%9d%80%e6%96%b9%e6%a1%881.jpg title=秒杀方案1 data-thumbnail=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/秒杀方案1.jpg data-sub-html="<h2> </h2><p>秒杀方案1</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e7%a7%92%e6%9d%80%e6%96%b9%e6%a1%881.jpg data-srcset="https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e7%a7%92%e6%9d%80%e6%96%b9%e6%a1%881.jpg, https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e7%a7%92%e6%9d%80%e6%96%b9%e6%a1%881.jpg 1.5x, https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e7%a7%92%e6%9d%80%e6%96%b9%e6%a1%881.jpg 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/秒杀方案1.jpg></a><figcaption class=image-caption>秒杀方案1</figcaption></figure></p><p><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e7%a7%92%e6%9d%80%e6%96%b9%e6%a1%881%e6%88%90%e6%9c%ac%e5%88%86%e6%9e%90.jpg title=秒杀方案1成本分析 data-thumbnail=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/秒杀方案1成本分析.jpg data-sub-html="<h2> </h2><p>秒杀方案1成本分析</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e7%a7%92%e6%9d%80%e6%96%b9%e6%a1%881%e6%88%90%e6%9c%ac%e5%88%86%e6%9e%90.jpg data-srcset="https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e7%a7%92%e6%9d%80%e6%96%b9%e6%a1%881%e6%88%90%e6%9c%ac%e5%88%86%e6%9e%90.jpg, https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e7%a7%92%e6%9d%80%e6%96%b9%e6%a1%881%e6%88%90%e6%9c%ac%e5%88%86%e6%9e%90.jpg 1.5x, https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e7%a7%92%e6%9d%80%e6%96%b9%e6%a1%881%e6%88%90%e6%9c%ac%e5%88%86%e6%9e%90.jpg 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/秒杀方案1成本分析.jpg></a><figcaption class=image-caption>秒杀方案1成本分析</figcaption></figure></p><p>根据上图的成本分析，我们的秒杀系统采用第二种方案，即使用存储过程。</p><blockquote><p><strong>优化总结</strong></p></blockquote><ul><li>前端控制</li></ul><p>暴露接口，按钮防重复（点击一次按钮后就变成灰色，禁止重复点击按钮）</p><ul><li>动静态数据分离</li></ul><p>CDN缓存，后端缓存</p><ul><li>事务竞争优化</li></ul><p>减少事务行级锁的持有时间</p><h2 id=2-redis后端缓存优化编码><strong>2. Redis后端缓存优化编码</strong></h2><blockquote><p><strong>关于CDN的说明</strong></p></blockquote><p>由于不同公司提供的CDN的接口暴露不同，不同的公司租用的机房调用的API也不相同，所以慕课网的视频中并没有对CDN的使用过程进行讲解。</p><h3 id=21-下载安装redis><strong>2.1 下载安装Redis</strong></h3><p>前往官网下载安装Stable版本的Redis，安装后可以将安装目录添加到系统变量Path里以方便使用，我使用的是Windows系统的Redis，懒得去官网下载的可以<a href=http://download.csdn.net/download/lewky_liu/10011091 target=_blank rel="noopener noreffer">点这里下载</a>。</p><p>安装后，运行<code>redis-server.exe</code>启动服务器成功，接着运行<code>redis-cli.exe</code>启动客户端连接服务器成功，说明Redis已经安装成功了。</p><blockquote><p><strong>为什么使用Redis</strong></p></blockquote><p>Redis属于NoSQL，即非关系型数据库，它是key-value型数据库，是直接在内存中进行存取数据的，所以有着很高的性能。</p><p>利用Redis可以减轻MySQL服务器的压力，减少了跟数据库服务器的通信次数。秒杀的瓶颈就在于跟数据库服务器的通信速度（MySQL本身的主键查询非常快）</p><h3 id=22-在pomxml中配置redis客户端><strong>2.2 在pom.xml中配置Redis客户端</strong></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-xml data-lang=xml>	<span class=c>&lt;!--添加Redis依赖 --&gt;</span>
	<span class=nt>&lt;dependency&gt;</span>
		<span class=nt>&lt;groupId&gt;</span>redis.clients<span class=nt>&lt;/groupId&gt;</span>
		<span class=nt>&lt;artifactId&gt;</span>jedis<span class=nt>&lt;/artifactId&gt;</span>
		<span class=nt>&lt;version&gt;</span>2.7.3<span class=nt>&lt;/version&gt;</span>
	<span class=nt>&lt;/dependency&gt;</span>
</code></pre></td></tr></table></div></div><blockquote><p><strong>Jedis</strong></p></blockquote><p>Redis有很多客户端，我们的项目是用Java语言写的，自然选择对应Java语言的客户端，而官网最推荐我们的Java客户端是Jedis，在pom.xml里配置了Jedis依赖就可以使用它了，记得要先开启Redis的服务器，Jedis才能连接到服务器。</p><p>由于Jedis并没有实现内部序列化操作，而Java内置的序列化机制性能又不高，我们是一个秒杀系统，需要考虑高并发优化，在这里我们采用开源社区提供的更高性能的自定义序列化工具protostuff。</p><h3 id=23-在pomxml中配置protostuff依赖><strong>2.3 在pom.xml中配置protostuff依赖</strong></h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-xml data-lang=xml>	<span class=c>&lt;!--prostuff序列化依赖 --&gt;</span>
	<span class=nt>&lt;dependency&gt;</span>
		<span class=nt>&lt;groupId&gt;</span>com.dyuproject.protostuff<span class=nt>&lt;/groupId&gt;</span>
		<span class=nt>&lt;artifactId&gt;</span>protostuff-core<span class=nt>&lt;/artifactId&gt;</span>
		<span class=nt>&lt;version&gt;</span>1.0.8<span class=nt>&lt;/version&gt;</span>
	<span class=nt>&lt;/dependency&gt;</span>
	<span class=nt>&lt;dependency&gt;</span>
		<span class=nt>&lt;groupId&gt;</span>com.dyuproject.protostuff<span class=nt>&lt;/groupId&gt;</span>
		<span class=nt>&lt;artifactId&gt;</span>protostuff-runtime<span class=nt>&lt;/artifactId&gt;</span>
		<span class=nt>&lt;version&gt;</span>1.0.8<span class=nt>&lt;/version&gt;</span>
	<span class=nt>&lt;/dependency&gt;</span>
</code></pre></td></tr></table></div></div><blockquote><p><strong>关于序列化和反序列化</strong></p></blockquote><p>序列化是处理对象流的机制，就是将对象的内容进行流化，可以对流化后的对象进行读写操作，也可以将流化后的对象在网络间传输。反序列化就是将流化后的对象重新转化成原来的对象。</p><p>在Java中内置了序列化机制，通过<code>implements Serializable</code>来标识一个对象实现了序列化接口，不过其性能并不高。</p><h3 id=24-使用redis优化地址暴露接口><strong>2.4 使用Redis优化地址暴露接口</strong></h3><p>原本查询秒杀商品时是通过主键直接去数据库查询的，选择将数据缓存在Redis，在查询秒杀商品时先去Redis缓存中查询，以此降低数据库的压力。如果在缓存中查询不到数据再去数据库中查询，再将查询到的数据放入Redis缓存中，这样下次就可以直接去缓存中直接查询到。</p><p>以上属于数据访问层的逻辑（DAO层），所以我们需要在dao包下新建一个<code>cache</code>目录，在该目录下新建<code>RedisDao.java</code>，用来存取缓存。</p><blockquote><p><strong>RedisDao</strong></p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java>	<span class=kd>public</span> <span class=kd>class</span> <span class=nc>RedisDao</span> <span class=o>{</span>
		<span class=kd>private</span> <span class=kd>final</span> <span class=n>JedisPool</span> <span class=n>jedisPool</span><span class=o>;</span>
	
		<span class=kd>public</span> <span class=nf>RedisDao</span><span class=o>(</span><span class=n>String</span> <span class=n>ip</span><span class=o>,</span> <span class=kt>int</span> <span class=n>port</span><span class=o>)</span> <span class=o>{</span>
			<span class=n>jedisPool</span> <span class=o>=</span> <span class=k>new</span> <span class=n>JedisPool</span><span class=o>(</span><span class=n>ip</span><span class=o>,</span> <span class=n>port</span><span class=o>);</span>
		<span class=o>}</span>
	
		<span class=kd>private</span> <span class=n>RuntimeSchema</span><span class=o>&lt;</span><span class=n>Seckill</span><span class=o>&gt;</span> <span class=n>schema</span> <span class=o>=</span> <span class=n>RuntimeSchema</span><span class=o>.</span><span class=na>createFrom</span><span class=o>(</span><span class=n>Seckill</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
	
		<span class=kd>public</span> <span class=n>Seckill</span> <span class=nf>getSeckill</span><span class=o>(</span><span class=kt>long</span> <span class=n>seckillId</span><span class=o>)</span> <span class=o>{</span>
			<span class=c1>// redis操作逻辑
</span><span class=c1></span>			<span class=k>try</span> <span class=o>{</span>
				<span class=n>Jedis</span> <span class=n>jedis</span> <span class=o>=</span> <span class=n>jedisPool</span><span class=o>.</span><span class=na>getResource</span><span class=o>();</span>
				<span class=k>try</span> <span class=o>{</span>
					<span class=n>String</span> <span class=n>key</span> <span class=o>=</span> <span class=s>&#34;seckill:&#34;</span> <span class=o>+</span> <span class=n>seckillId</span><span class=o>;</span>
					<span class=c1>// 并没有实现哪部序列化操作
</span><span class=c1></span>					<span class=c1>// 采用自定义序列化
</span><span class=c1></span>					<span class=c1>// protostuff: pojo.
</span><span class=c1></span>					<span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span> <span class=o>=</span> <span class=n>jedis</span><span class=o>.</span><span class=na>get</span><span class=o>(</span><span class=n>key</span><span class=o>.</span><span class=na>getBytes</span><span class=o>());</span>
					<span class=c1>// 缓存重获取到
</span><span class=c1></span>					<span class=k>if</span> <span class=o>(</span><span class=n>bytes</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
						<span class=n>Seckill</span> <span class=n>seckill</span> <span class=o>=</span> <span class=n>schema</span><span class=o>.</span><span class=na>newMessage</span><span class=o>();</span>
						<span class=n>ProtostuffIOUtil</span><span class=o>.</span><span class=na>mergeFrom</span><span class=o>(</span><span class=n>bytes</span><span class=o>,</span> <span class=n>seckill</span><span class=o>,</span> <span class=n>schema</span><span class=o>);</span>
						<span class=c1>// seckill被反序列化
</span><span class=c1></span>	
						<span class=k>return</span> <span class=n>seckill</span><span class=o>;</span>
					<span class=o>}</span>
				<span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
					<span class=n>jedis</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
				<span class=o>}</span>
			<span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
	
			<span class=o>}</span>
			<span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
		<span class=o>}</span>
	
		<span class=kd>public</span> <span class=n>String</span> <span class=nf>putSeckill</span><span class=o>(</span><span class=n>Seckill</span> <span class=n>seckill</span><span class=o>)</span> <span class=o>{</span>
			<span class=k>try</span> <span class=o>{</span>
				<span class=n>Jedis</span> <span class=n>jedis</span> <span class=o>=</span> <span class=n>jedisPool</span><span class=o>.</span><span class=na>getResource</span><span class=o>();</span>
				<span class=k>try</span> <span class=o>{</span>
					<span class=n>String</span> <span class=n>key</span> <span class=o>=</span> <span class=s>&#34;seckill:&#34;</span> <span class=o>+</span> <span class=n>seckill</span><span class=o>.</span><span class=na>getSeckillId</span><span class=o>();</span>
					<span class=kt>byte</span><span class=o>[]</span> <span class=n>bytes</span> <span class=o>=</span> <span class=n>ProtostuffIOUtil</span><span class=o>.</span><span class=na>toByteArray</span><span class=o>(</span><span class=n>seckill</span><span class=o>,</span> <span class=n>schema</span><span class=o>,</span>
							<span class=n>LinkedBuffer</span><span class=o>.</span><span class=na>allocate</span><span class=o>(</span><span class=n>LinkedBuffer</span><span class=o>.</span><span class=na>DEFAULT_BUFFER_SIZE</span><span class=o>));</span>
					<span class=c1>// 超时缓存
</span><span class=c1></span>					<span class=kt>int</span> <span class=n>timeout</span> <span class=o>=</span> <span class=n>60</span> <span class=o>*</span> <span class=n>60</span><span class=o>;</span><span class=c1>// 1小时
</span><span class=c1></span>					<span class=n>String</span> <span class=n>result</span> <span class=o>=</span> <span class=n>jedis</span><span class=o>.</span><span class=na>setex</span><span class=o>(</span><span class=n>key</span><span class=o>.</span><span class=na>getBytes</span><span class=o>(),</span> <span class=n>timeout</span><span class=o>,</span> <span class=n>bytes</span><span class=o>);</span>
	
					<span class=k>return</span> <span class=n>result</span><span class=o>;</span>
				<span class=o>}</span> <span class=k>finally</span> <span class=o>{</span>
					<span class=n>jedis</span><span class=o>.</span><span class=na>close</span><span class=o>();</span>
				<span class=o>}</span>
			<span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
	
			<span class=o>}</span>
	
			<span class=k>return</span> <span class=kc>null</span><span class=o>;</span>
		<span class=o>}</span>
	<span class=o>}</span>
</code></pre></td></tr></table></div></div><blockquote><p><strong>注意</strong></p></blockquote><p>使用protostuff序列化工具时，被序列化的对象必须是pojo对象（具备setter/getter）</p><blockquote><p><strong>在spring-dao.xml中手动注入RedisDao</strong></p></blockquote><p>由于RedisDao和MyBatis的DAO没有关系，MyBatis不会帮我们自动实现该接口，所以我们需要在spring-dao.xml中手动注入RedisDao。由于我们在RedisDao是通过构造方法来注入ip和port两个参数的，所以需要配置<constructor-arg>，如果不配置这个标签，我们需要为ip和port提供各自的setter和getter（注入时可以没有getter）。</p><p>在这里我们直接把value的值写死在标签里边了，实际开发中需要把ip和port参数的值写到配置文件里，通过读取配置文件的方式读取它们的值。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-xml data-lang=xml>	<span class=c>&lt;!--redisDao --&gt;</span>
	<span class=nt>&lt;bean</span> <span class=na>id=</span><span class=s>&#34;redisDao&#34;</span> <span class=na>class=</span><span class=s>&#34;com.lewis.dao.cache.RedisDao&#34;</span><span class=nt>&gt;</span>
		<span class=nt>&lt;constructor-arg</span> <span class=na>index=</span><span class=s>&#34;0&#34;</span> <span class=na>value=</span><span class=s>&#34;localhost&#34;</span> <span class=nt>/&gt;</span>
		<span class=nt>&lt;constructor-arg</span> <span class=na>index=</span><span class=s>&#34;1&#34;</span> <span class=na>value=</span><span class=s>&#34;6379&#34;</span> <span class=nt>/&gt;</span>
	<span class=nt>&lt;/bean&gt;</span>
</code></pre></td></tr></table></div></div><blockquote><p><strong>修改SeckillServiceImpl</strong></p></blockquote><p>使用注解注入RedisDao属性</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java>	 <span class=nd>@Autowired</span>
	 <span class=kd>private</span> <span class=n>RedisDao</span> <span class=n>redisDao</span><span class=o>;</span>
</code></pre></td></tr></table></div></div><p>修改<code>exportSeckillURI()</code></p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java>	<span class=kd>public</span> <span class=n>Exposer</span> <span class=nf>exportSeckillUrl</span><span class=o>(</span><span class=kt>long</span> <span class=n>seckillId</span><span class=o>)</span> <span class=o>{</span>
		<span class=c1>// 优化点:缓存优化:超时的基础上维护一致性
</span><span class=c1></span>		<span class=c1>// 1.访问redis
</span><span class=c1></span>
		<span class=n>Seckill</span> <span class=n>seckill</span> <span class=o>=</span> <span class=n>redisDao</span><span class=o>.</span><span class=na>getSeckill</span><span class=o>(</span><span class=n>seckillId</span><span class=o>);</span>
		<span class=k>if</span> <span class=o>(</span><span class=n>seckill</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
			<span class=c1>// 2.访问数据库
</span><span class=c1></span>			<span class=n>seckill</span> <span class=o>=</span> <span class=n>seckillDao</span><span class=o>.</span><span class=na>queryById</span><span class=o>(</span><span class=n>seckillId</span><span class=o>);</span>
			<span class=k>if</span> <span class=o>(</span><span class=n>seckill</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span><span class=c1>// 说明查不到这个秒杀产品的记录
</span><span class=c1></span>				<span class=k>return</span> <span class=k>new</span> <span class=n>Exposer</span><span class=o>(</span><span class=kc>false</span><span class=o>,</span> <span class=n>seckillId</span><span class=o>);</span>
			<span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
				<span class=c1>// 3.放入redis
</span><span class=c1></span>				<span class=n>redisDao</span><span class=o>.</span><span class=na>putSeckill</span><span class=o>(</span><span class=n>seckill</span><span class=o>);</span>
			<span class=o>}</span>
		<span class=o>}</span>

		<span class=c1>// 若是秒杀未开启
</span><span class=c1></span>		<span class=n>Date</span> <span class=n>startTime</span> <span class=o>=</span> <span class=n>seckill</span><span class=o>.</span><span class=na>getStartTime</span><span class=o>();</span>
		<span class=n>Date</span> <span class=n>endTime</span> <span class=o>=</span> <span class=n>seckill</span><span class=o>.</span><span class=na>getEndTime</span><span class=o>();</span>
		<span class=c1>// 系统当前时间
</span><span class=c1></span>		<span class=n>Date</span> <span class=n>nowTime</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Date</span><span class=o>();</span>
		<span class=k>if</span> <span class=o>(</span><span class=n>startTime</span><span class=o>.</span><span class=na>getTime</span><span class=o>()</span> <span class=o>&gt;</span> <span class=n>nowTime</span><span class=o>.</span><span class=na>getTime</span><span class=o>()</span> <span class=o>||</span> <span class=n>endTime</span><span class=o>.</span><span class=na>getTime</span><span class=o>()</span> <span class=o>&lt;</span> <span class=n>nowTime</span><span class=o>.</span><span class=na>getTime</span><span class=o>())</span> <span class=o>{</span>
			<span class=k>return</span> <span class=k>new</span> <span class=n>Exposer</span><span class=o>(</span><span class=kc>false</span><span class=o>,</span> <span class=n>seckillId</span><span class=o>,</span> <span class=n>nowTime</span><span class=o>.</span><span class=na>getTime</span><span class=o>(),</span> <span class=n>startTime</span><span class=o>.</span><span class=na>getTime</span><span class=o>(),</span> <span class=n>endTime</span><span class=o>.</span><span class=na>getTime</span><span class=o>());</span>
		<span class=o>}</span>

		<span class=c1>// 秒杀开启，返回秒杀商品的id、用给接口加密的md5
</span><span class=c1></span>		<span class=n>String</span> <span class=n>md5</span> <span class=o>=</span> <span class=n>getMD5</span><span class=o>(</span><span class=n>seckillId</span><span class=o>);</span>
		<span class=k>return</span> <span class=k>new</span> <span class=n>Exposer</span><span class=o>(</span><span class=kc>true</span><span class=o>,</span> <span class=n>md5</span><span class=o>,</span> <span class=n>seckillId</span><span class=o>);</span>
	<span class=o>}</span>
</code></pre></td></tr></table></div></div><h3 id=25-测试类redisdaotest><strong>2.5 测试类RedisDaoTest</strong></h3><p>通过IDE工具快速生成测试类RedisDaoTest，新写一个<code>testSeckill()</code>，对getSeckill和putSeckill方法进行全局测试。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java>	<span class=nd>@RunWith</span><span class=o>(</span><span class=n>SpringJUnit4ClassRunner</span><span class=o>.</span><span class=na>class</span><span class=o>)</span>
	<span class=c1>// 告诉junit spring的配置文件
</span><span class=c1></span>	<span class=nd>@ContextConfiguration</span><span class=o>({</span> <span class=s>&#34;classpath:spring/spring-dao.xml&#34;</span> <span class=o>})</span>
	<span class=kd>public</span> <span class=kd>class</span> <span class=nc>RedisDaoTest</span> <span class=o>{</span>
		<span class=kd>private</span> <span class=kd>final</span> <span class=n>Logger</span> <span class=n>logger</span> <span class=o>=</span> <span class=n>LoggerFactory</span><span class=o>.</span><span class=na>getLogger</span><span class=o>(</span><span class=k>this</span><span class=o>.</span><span class=na>getClass</span><span class=o>());</span>
	
		<span class=kd>private</span> <span class=kt>long</span> <span class=n>id</span> <span class=o>=</span> <span class=n>1001</span><span class=o>;</span>
	
		<span class=nd>@Autowired</span>
		<span class=kd>private</span> <span class=n>RedisDao</span> <span class=n>redisDao</span><span class=o>;</span>
	
		<span class=nd>@Autowired</span>
		<span class=kd>private</span> <span class=n>SeckillDao</span> <span class=n>seckillDao</span><span class=o>;</span>
	
		<span class=nd>@Test</span>
		<span class=kd>public</span> <span class=kt>void</span> <span class=nf>testSeckill</span><span class=o>()</span> <span class=o>{</span>
	
			<span class=n>Seckill</span> <span class=n>seckill</span> <span class=o>=</span> <span class=n>redisDao</span><span class=o>.</span><span class=na>getSeckill</span><span class=o>(</span><span class=n>id</span><span class=o>);</span>
			<span class=k>if</span> <span class=o>(</span><span class=n>seckill</span> <span class=o>==</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
				<span class=n>seckill</span> <span class=o>=</span> <span class=n>seckillDao</span><span class=o>.</span><span class=na>queryById</span><span class=o>(</span><span class=n>id</span><span class=o>);</span>
				<span class=k>if</span> <span class=o>(</span><span class=n>seckill</span> <span class=o>!=</span> <span class=kc>null</span><span class=o>)</span> <span class=o>{</span>
					<span class=n>String</span> <span class=n>result</span> <span class=o>=</span> <span class=n>redisDao</span><span class=o>.</span><span class=na>putSeckill</span><span class=o>(</span><span class=n>seckill</span><span class=o>);</span>
					<span class=n>logger</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;result={}&#34;</span><span class=o>,</span> <span class=n>result</span><span class=o>);</span>
					<span class=n>seckill</span> <span class=o>=</span> <span class=n>redisDao</span><span class=o>.</span><span class=na>getSeckill</span><span class=o>(</span><span class=n>id</span><span class=o>);</span>
					<span class=n>logger</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;seckill={}&#34;</span><span class=o>,</span> <span class=n>seckill</span><span class=o>);</span>
				<span class=o>}</span>
			<span class=o>}</span>
		<span class=o>}</span>
	
	<span class=o>}</span>
</code></pre></td></tr></table></div></div><p>如果测试通过了，会输出<code>result={}OK</code>以及id为1001的商品信息，如果输出的都是null，那说明你没有开启Redis服务器，所以在内存中没有存取到缓存。</p><blockquote><p><strong>为什么不用Redis的hash来存储对象？</strong></p></blockquote><p>第一：通过Jedis储存对象的方式有大概三种</p><ol><li>本项目采用的方式：将对象序列化成byte字节，最终存byte字节；</li><li>对象转hashmap，也就是你想表达的hash的形式，最终存map；</li><li>对象转json，最终存json，其实也就是字符串</li></ol><p>第二：其实如果你是平常的项目，并发不高，三个选择都可以，这种情况下以hash的形式更加灵活，可以对象的单个属性，但是问题来了，在秒杀的场景下，三者的效率差别很大。</p><p>第三：结果如下</p><table><thead><tr><th>10w数据</th><th>时间</th><th>内存占用</th></tr></thead><tbody><tr><td>存json</td><td>10s</td><td>14M</td></tr><tr><td>存byte</td><td>6s</td><td>6M</td></tr><tr><td>存jsonMap</td><td>10s</td><td>20M</td></tr><tr><td>存byteMap</td><td>4s</td><td>4M</td></tr><tr><td>取json</td><td>7s</td><td></td></tr><tr><td>取byte</td><td>4s</td><td></td></tr><tr><td>取jsonmap</td><td>7s</td><td></td></tr><tr><td>取bytemap</td><td>4s</td><td></td></tr></tbody></table><p>第四：你该说了，bytemap最快啊，为啥不用啊，因为项目用了超级强悍的序列化工具啊，以上测试是基于java的序列化，如果改了序列化工具，你可以测试下。</p><p>以上问答源自<a href=http://www.imooc.com/qadetail/233457 target=_blank rel="noopener noreffer">慕课网的一道问答</a></p><blockquote><p><strong>教学视频中张老师对于Redis暴露接口地址的补充</strong></p></blockquote><ol><li>redis事务与RDBMS事务有本质区别，详情见<a href=http://redis.io/topics/transactions target=_blank rel="noopener noreffer">http://redis.io/topics/transactions</a></li><li>关于spring整合redis。原生Jedis API已经足够清晰。笔者所在的团队不使用任何spring-data整合API，而是直接对接原生Client并做二次开发调优，如Jedis,Hbase等。</li><li>这里使用redis缓存方法用于暴露秒杀地址场景，该方法存在瞬时压力，为了降低DB的primary key QPS，且没有使用库存字段所以不做一致性维护。</li><li>跨数据源的严格一致性需要2PC支持，性能不尽如人意。线上产品一般使用最终一致性去解决，这块相关知识较多，所以没有讲。</li><li>本课程的重点其实不是SSM，只是一个快速开发的方式。重点根据业务场景分析通信成本，瓶颈点的过程和优化思路。</li><li>初学者不要纠结于事务。事务可以降低一致性维护难度，但扩展性灵活性存在不足。技术是死的，人是活的。比如京东抢购使用Redis+LUA+MQ方案，就是一种技术反思。</li></ol><h2 id=3-秒杀操作并发优化><strong>3. 秒杀操作——并发优化</strong></h2><h3 id=31-简单优化><strong>3.1 简单优化</strong></h3><blockquote><p><strong>回顾事务执行</strong></p></blockquote><p><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e5%9b%9e%e9%a1%be%e4%ba%8b%e5%8a%a1%e6%89%a7%e8%a1%8c.jpg title=回顾事务执行 data-thumbnail=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/回顾事务执行.jpg data-sub-html="<h2> </h2><p>回顾事务执行</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e5%9b%9e%e9%a1%be%e4%ba%8b%e5%8a%a1%e6%89%a7%e8%a1%8c.jpg data-srcset="https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e5%9b%9e%e9%a1%be%e4%ba%8b%e5%8a%a1%e6%89%a7%e8%a1%8c.jpg, https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e5%9b%9e%e9%a1%be%e4%ba%8b%e5%8a%a1%e6%89%a7%e8%a1%8c.jpg 1.5x, https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e5%9b%9e%e9%a1%be%e4%ba%8b%e5%8a%a1%e6%89%a7%e8%a1%8c.jpg 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/回顾事务执行.jpg></a><figcaption class=image-caption>回顾事务执行</figcaption></figure></p><blockquote><p><strong>sql语句的简单优化</strong></p></blockquote><p><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e7%ae%80%e5%8d%95%e4%bc%98%e5%8c%96.jpg title=简单优化 data-thumbnail=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/简单优化.jpg data-sub-html="<h2> </h2><p>简单优化</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e7%ae%80%e5%8d%95%e4%bc%98%e5%8c%96.jpg data-srcset="https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e7%ae%80%e5%8d%95%e4%bc%98%e5%8c%96.jpg, https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e7%ae%80%e5%8d%95%e4%bc%98%e5%8c%96.jpg 1.5x, https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e7%ae%80%e5%8d%95%e4%bc%98%e5%8c%96.jpg 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/简单优化.jpg></a><figcaption class=image-caption>简单优化</figcaption></figure></p><blockquote><p><strong>优化SeckillServiceImpl的<code>executeSeckill()</code></strong></p></blockquote><p>用户的秒杀操作分为两步：减库存、插入购买明细，我们在这里进行简单的优化，就是将原本先update（减库存）再进行insert（插入购买明细）的步骤改成：先insert再update。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java>	<span class=kd>public</span> <span class=n>SeckillExecution</span> <span class=nf>executeSeckill</span><span class=o>(</span><span class=kt>long</span> <span class=n>seckillId</span><span class=o>,</span> <span class=kt>long</span> <span class=n>userPhone</span><span class=o>,</span> <span class=n>String</span> <span class=n>md5</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>SeckillException</span><span class=o>,</span>
			<span class=n>RepeatKillException</span><span class=o>,</span> <span class=n>SeckillCloseException</span> <span class=o>{</span>

		<span class=k>if</span> <span class=o>(</span><span class=n>md5</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=o>!</span><span class=n>md5</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>getMD5</span><span class=o>(</span><span class=n>seckillId</span><span class=o>)))</span> <span class=o>{</span>
			<span class=k>throw</span> <span class=k>new</span> <span class=n>SeckillException</span><span class=o>(</span><span class=s>&#34;seckill data rewrite&#34;</span><span class=o>);</span><span class=c1>// 秒杀数据被重写了
</span><span class=c1></span>		<span class=o>}</span>
		<span class=c1>// 执行秒杀逻辑:减库存+增加购买明细
</span><span class=c1></span>		<span class=n>Date</span> <span class=n>nowTime</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Date</span><span class=o>();</span>

		<span class=k>try</span> <span class=o>{</span>

			<span class=c1>// 否则更新了库存，秒杀成功,增加明细
</span><span class=c1></span>			<span class=kt>int</span> <span class=n>insertCount</span> <span class=o>=</span> <span class=n>successKilledDao</span><span class=o>.</span><span class=na>insertSuccessKilled</span><span class=o>(</span><span class=n>seckillId</span><span class=o>,</span> <span class=n>userPhone</span><span class=o>);</span>
			<span class=c1>// 看是否该明细被重复插入，即用户是否重复秒杀
</span><span class=c1></span>			<span class=k>if</span> <span class=o>(</span><span class=n>insertCount</span> <span class=o>&lt;=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
				<span class=k>throw</span> <span class=k>new</span> <span class=n>RepeatKillException</span><span class=o>(</span><span class=s>&#34;seckill repeated&#34;</span><span class=o>);</span>
			<span class=o>}</span> <span class=k>else</span> <span class=o>{</span>

				<span class=c1>// 减库存,热点商品竞争
</span><span class=c1></span>				<span class=kt>int</span> <span class=n>updateCount</span> <span class=o>=</span> <span class=n>seckillDao</span><span class=o>.</span><span class=na>reduceNumber</span><span class=o>(</span><span class=n>seckillId</span><span class=o>,</span> <span class=n>nowTime</span><span class=o>);</span>
				<span class=k>if</span> <span class=o>(</span><span class=n>updateCount</span> <span class=o>&lt;=</span> <span class=n>0</span><span class=o>)</span> <span class=o>{</span>
					<span class=c1>// 没有更新库存记录，说明秒杀结束 rollback
</span><span class=c1></span>					<span class=k>throw</span> <span class=k>new</span> <span class=n>SeckillCloseException</span><span class=o>(</span><span class=s>&#34;seckill is closed&#34;</span><span class=o>);</span>
				<span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
					<span class=c1>// 秒杀成功,得到成功插入的明细记录,并返回成功秒杀的信息 commit
</span><span class=c1></span>					<span class=n>SuccessKilled</span> <span class=n>successKilled</span> <span class=o>=</span> <span class=n>successKilledDao</span><span class=o>.</span><span class=na>queryByIdWithSeckill</span><span class=o>(</span><span class=n>seckillId</span><span class=o>,</span> <span class=n>userPhone</span><span class=o>);</span>
					<span class=k>return</span> <span class=k>new</span> <span class=n>SeckillExecution</span><span class=o>(</span><span class=n>seckillId</span><span class=o>,</span> <span class=n>SeckillStatEnum</span><span class=o>.</span><span class=na>SUCCESS</span><span class=o>,</span> <span class=n>successKilled</span><span class=o>);</span>
				<span class=o>}</span>
			<span class=o>}</span>
		<span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>SeckillCloseException</span> <span class=n>e1</span><span class=o>)</span> <span class=o>{</span>
			<span class=k>throw</span> <span class=n>e1</span><span class=o>;</span>
		<span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>RepeatKillException</span> <span class=n>e2</span><span class=o>)</span> <span class=o>{</span>
			<span class=k>throw</span> <span class=n>e2</span><span class=o>;</span>
		<span class=o>}</span> <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span> <span class=o>{</span>
			<span class=n>logger</span><span class=o>.</span><span class=na>error</span><span class=o>(</span><span class=n>e</span><span class=o>.</span><span class=na>getMessage</span><span class=o>(),</span> <span class=n>e</span><span class=o>);</span>
			<span class=c1>// 将编译期异常转化为运行期异常
</span><span class=c1></span>			<span class=k>throw</span> <span class=k>new</span> <span class=n>SeckillException</span><span class=o>(</span><span class=s>&#34;seckill inner error :&#34;</span> <span class=o>+</span> <span class=n>e</span><span class=o>.</span><span class=na>getMessage</span><span class=o>());</span>
		<span class=o>}</span>

	<span class=o>}</span>
</code></pre></td></tr></table></div></div><blockquote><p><strong>为什么要先insert再update</strong></p></blockquote><p>首先是在更新操作的时候给行加锁，插入并不会加锁，如果更新操作在前，那么就需要执行完更新和插入以后事务提交或回滚才释放锁。而如果插入在前，更新在后，那么只有在更新时才会加行锁，之后在更新完以后事务提交或回滚释放锁。</p><p>在这里，插入是可以并行的，而更新由于会加行级锁是串行的。</p><p>也就是说是更新在前加锁和释放锁之间两次的网络延迟和GC，如果插入在前则加锁和释放锁之间只有一次的网络延迟和GC，也就是减少的持有锁的时间。</p><p>这里先insert并不是忽略了库存不足的情况，而是因为insert和update是在同一个事务里，光是insert并不一定会提交，只有在update成功才会提交，所以并不会造成过量插入秒杀成功记录。</p><h3 id=32-深度优化><strong>3.2 深度优化</strong></h3><p>前边通过调整insert和update的执行顺序来实现简单优化，但依然存在着Java客户端和服务器通信时的网络延迟和GC影响，我们可以将执行秒杀操作时的insert和update放到MySQL服务端的存储过程里，而Java客户端直接调用这个存储过程，这样就可以避免网络延迟和可能发生的GC影响。另外，由于我们使用了存储过程，也就使用不到Spring的事务管理了，因为在存储过程里我们会直接启用一个事务。</p><h4 id=321-写一个存储过程procedure然后在mysql控制台里执行它><strong>3.2.1 写一个存储过程procedure，然后在MySQL控制台里执行它</strong></h4><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sql data-lang=sql>	<span class=c1>-- 秒杀执行储存过程
</span><span class=c1></span>	<span class=k>DELIMITER</span> <span class=err>$$</span> <span class=c1>-- 将定界符从;转换为$$
</span><span class=c1></span>	<span class=c1>-- 定义储存过程
</span><span class=c1></span>	<span class=c1>-- 参数： in输入参数   out输出参数
</span><span class=c1></span>	<span class=c1>-- row_count() 返回上一条修改类型sql(delete,insert,update)的影响行数
</span><span class=c1></span>	<span class=c1>-- row_count:0:未修改数据 ; &gt;0:表示修改的行数； &lt;0:sql错误
</span><span class=c1></span>	<span class=k>CREATE</span> <span class=k>PROCEDURE</span> <span class=o>`</span><span class=n>seckill</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>execute_seckill</span><span class=o>`</span>
	  <span class=p>(</span><span class=k>IN</span> <span class=n>v_seckill_id</span> <span class=nb>BIGINT</span><span class=p>,</span> <span class=k>IN</span> <span class=n>v_phone</span> <span class=nb>BIGINT</span><span class=p>,</span>
	   <span class=k>IN</span> <span class=n>v_kill_time</span>  <span class=k>TIMESTAMP</span><span class=p>,</span> <span class=k>OUT</span> <span class=n>r_result</span> <span class=nb>INT</span><span class=p>)</span>
	  <span class=k>BEGIN</span>
	    <span class=k>DECLARE</span> <span class=n>insert_count</span> <span class=nb>INT</span> <span class=k>DEFAULT</span> <span class=mi>0</span><span class=p>;</span>
	    <span class=k>START</span> <span class=k>TRANSACTION</span><span class=p>;</span>
	    <span class=k>INSERT</span> <span class=k>IGNORE</span> <span class=k>INTO</span> <span class=n>success_killed</span>
	    <span class=p>(</span><span class=n>seckill_id</span><span class=p>,</span> <span class=n>user_phone</span><span class=p>,</span> <span class=k>state</span><span class=p>)</span>
	    <span class=k>VALUES</span> <span class=p>(</span><span class=n>v_seckill_id</span><span class=p>,</span> <span class=n>v_phone</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
	    <span class=k>SELECT</span> <span class=k>row_count</span><span class=p>()</span> <span class=k>INTO</span> <span class=n>insert_count</span><span class=p>;</span>
	    <span class=k>IF</span> <span class=p>(</span><span class=n>insert_count</span> <span class=o>=</span> <span class=mi>0</span><span class=p>)</span> <span class=k>THEN</span>
	      <span class=k>ROLLBACK</span><span class=p>;</span>
	      <span class=k>SET</span> <span class=n>r_result</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
	    <span class=n>ELSEIF</span> <span class=p>(</span><span class=n>insert_count</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=k>THEN</span>
	        <span class=k>ROLLBACK</span><span class=p>;</span>
	        <span class=k>SET</span> <span class=n>r_result</span> <span class=o>=</span> <span class=o>-</span><span class=mi>2</span><span class=p>;</span>
	    <span class=k>ELSE</span>
	      <span class=k>UPDATE</span> <span class=n>seckill</span>
	      <span class=k>SET</span> <span class=nb>number</span> <span class=o>=</span> <span class=nb>number</span> <span class=o>-</span> <span class=mi>1</span>
	      <span class=k>WHERE</span> <span class=n>seckill_id</span> <span class=o>=</span> <span class=n>v_seckill_id</span>
	            <span class=k>AND</span> <span class=n>end_time</span> <span class=o>&gt;</span> <span class=n>v_kill_time</span>
	            <span class=k>AND</span> <span class=n>start_time</span> <span class=o>&lt;</span> <span class=n>v_kill_time</span>
	            <span class=k>AND</span> <span class=nb>number</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>;</span>
	      <span class=k>SELECT</span> <span class=k>row_count</span><span class=p>()</span> <span class=k>INTO</span> <span class=n>insert_count</span><span class=p>;</span>
	      <span class=k>IF</span> <span class=p>(</span><span class=n>insert_count</span> <span class=o>=</span> <span class=mi>0</span><span class=p>)</span> <span class=k>THEN</span>
	        <span class=k>ROLLBACK</span><span class=p>;</span>
	        <span class=k>SET</span> <span class=n>r_result</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
	      <span class=n>ELSEIF</span> <span class=p>(</span><span class=n>insert_count</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=k>THEN</span>
	          <span class=k>ROLLBACK</span><span class=p>;</span>
	          <span class=k>SET</span> <span class=n>r_result</span> <span class=o>=</span> <span class=o>-</span><span class=mi>2</span><span class=p>;</span>
	      <span class=k>ELSE</span>
	        <span class=k>COMMIT</span><span class=p>;</span>
	        <span class=k>SET</span> <span class=n>r_result</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
	      <span class=k>END</span> <span class=k>IF</span><span class=p>;</span>
	    <span class=k>END</span> <span class=k>IF</span><span class=p>;</span>
	  <span class=k>END</span><span class=p>;</span>
	<span class=err>$$</span>
	<span class=c1>-- 储存过程定义结束
</span><span class=c1></span>	<span class=c1>-- 将定界符重新改为;
</span><span class=c1></span>	<span class=k>DELIMITER</span> <span class=p>;</span>

	<span class=c1>-- 定义一个用户变量r_result
</span><span class=c1></span>	<span class=k>SET</span> <span class=o>@</span><span class=n>r_result</span> <span class=o>=</span> <span class=o>-</span><span class=mi>3</span><span class=p>;</span>
	<span class=c1>-- 执行储存过程
</span><span class=c1></span>	<span class=k>CALL</span> <span class=n>execute_seckill</span><span class=p>(</span><span class=mi>1003</span><span class=p>,</span> <span class=mi>13502178891</span><span class=p>,</span> <span class=n>now</span><span class=p>(),</span> <span class=o>@</span><span class=n>r_result</span><span class=p>);</span>
	<span class=c1>-- 获取结果
</span><span class=c1></span>	<span class=k>SELECT</span> <span class=o>@</span><span class=n>r_result</span><span class=p>;</span>
</code></pre></td></tr></table></div></div><blockquote><p><strong>注意点</strong></p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sql data-lang=sql>	<span class=k>CREATE</span> <span class=k>PROCEDURE</span> <span class=o>`</span><span class=n>seckill</span><span class=o>`</span><span class=p>.</span><span class=o>`</span><span class=n>execute_seckill</span><span class=o>`</span>
</code></pre></td></tr></table></div></div><p>上边这句语句的意思是为一个名为<code>seckill</code>的数据库定义一个名为<code>execute_seckill</code>的存储过程，如果你在连接数据库后使用了这个数据库（即<code>use seckill;</code>），那么这里的定义句子就不能这样写了，会报错（因为存储过程是依赖于数据库的），改成下边这样：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-sql data-lang=sql>	<span class=k>CREATE</span> <span class=k>PROCEDURE</span> <span class=o>`</span><span class=n>execute_seckill</span><span class=o>`</span>
</code></pre></td></tr></table></div></div><blockquote><p><strong>row_count()</strong></p></blockquote><p>存储过程中，<code>row_count()</code>函数用来返回上一条sql（delete,insert,update）影响的行数。</p><p>根据row_count()返回值，可以进行接下来的流程判断：</p><p><code>0</code>：未修改数据；</p><p><code>>0</code>: 表示修改的行数；</p><p><code>&lt;0</code>: 表示SQL错误或未执行修改SQL</p><h4 id=322-修改源码以调用存储过程><strong>3.2.2 修改源码以调用存储过程</strong></h4><blockquote><p><strong>在<code>SeckillDao</code>里添加调用存储过程的方法声明</strong></p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java>	<span class=cm>/**
</span><span class=cm>     *  使用储存过程执行秒杀
</span><span class=cm>     * @param paramMap
</span><span class=cm>     */</span>
    <span class=kt>void</span> <span class=nf>killByProcedure</span><span class=o>(</span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span><span class=n>Object</span><span class=o>&gt;</span> <span class=n>paramMap</span><span class=o>);</span>
</code></pre></td></tr></table></div></div><blockquote><p><strong>接着在<code>SeckillDao.xml</code>里添加该方法对应的sql语句</strong></p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-xml data-lang=xml>	<span class=c>&lt;!--调用储存过程 --&gt;</span>
	<span class=nt>&lt;select</span> <span class=na>id=</span><span class=s>&#34;killByProcedure&#34;</span> <span class=na>statementType=</span><span class=s>&#34;CALLABLE&#34;</span><span class=nt>&gt;</span>
		CALL execute_seckill(
			#{seckillId,jdbcType=BIGINT,mode=IN},
			#{phone,jdbcType=BIGINT,mode=IN},
			#{killTime,jdbcType=TIMESTAMP,mode=IN},
			#{result,jdbcType=INTEGER,mode=OUT}
		)
	<span class=nt>&lt;/select&gt;</span>
</code></pre></td></tr></table></div></div><blockquote><p><strong>在<code>SeckillService</code>接口里添加一个方法声明</strong></p></blockquote><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java>	<span class=cm>/**
</span><span class=cm>	 * 调用存储过程来执行秒杀操作，不需要抛出异常
</span><span class=cm>	 * 
</span><span class=cm>	 * @param seckillId 秒杀的商品ID
</span><span class=cm>	 * @param userPhone 手机号码
</span><span class=cm>	 * @param md5 md5加密值
</span><span class=cm>	 * @return 根据不同的结果返回不同的实体信息
</span><span class=cm>	 */</span>
	<span class=n>SeckillExecution</span> <span class=nf>executeSeckillProcedure</span><span class=o>(</span><span class=kt>long</span> <span class=n>seckillId</span><span class=o>,</span><span class=kt>long</span> <span class=n>userPhone</span><span class=o>,</span><span class=n>String</span> <span class=n>md5</span><span class=o>);</span>
</code></pre></td></tr></table></div></div><blockquote><p><strong>为什么这个方法不需要抛出异常？</strong></p></blockquote><p>原本没有调用存储过程的执行秒杀操作之所以要抛出RuntimException，是为了让Spring事务管理器能够在秒杀不成功的时候进行回滚操作。而现在我们使用了存储过程，有关事务的提交或回滚已经在procedure里完成了，前面也解释了不需要再使用到Spring的事务了，既然如此，我们也就不需要在这个方法里抛出异常来让Spring帮我们回滚了。</p><blockquote><p><strong>在<code>SeckillServiceImpl</code>里实现这个方法</strong></p></blockquote><p>我们需要使用到第三方工具类，所以在pom.xml里导入commons-collections工具类</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-xml data-lang=xml>	<span class=c>&lt;!--导入apache工具类--&gt;</span>
    <span class=nt>&lt;dependency&gt;</span>
        <span class=nt>&lt;groupId&gt;</span>commons-collections<span class=nt>&lt;/groupId&gt;</span>
        <span class=nt>&lt;artifactId&gt;</span>commons-collections<span class=nt>&lt;/artifactId&gt;</span>
        <span class=nt>&lt;version&gt;</span>3.2.2<span class=nt>&lt;/version&gt;</span>
    <span class=nt>&lt;/dependency&gt;</span>
</code></pre></td></tr></table></div></div><p>在接口的实现类里对<code>executeSeckillProcedure</code>进行实现</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java>	<span class=nd>@Override</span>
	<span class=kd>public</span> <span class=n>SeckillExecution</span> <span class=nf>executeSeckillProcedure</span><span class=o>(</span><span class=kt>long</span> <span class=n>seckillId</span><span class=o>,</span> <span class=kt>long</span> <span class=n>userPhone</span><span class=o>,</span> <span class=n>String</span> <span class=n>md5</span><span class=o>)</span> <span class=o>{</span>
		<span class=k>if</span> <span class=o>(</span><span class=n>md5</span> <span class=o>==</span> <span class=kc>null</span> <span class=o>||</span> <span class=o>!</span><span class=n>md5</span><span class=o>.</span><span class=na>equals</span><span class=o>(</span><span class=n>getMD5</span><span class=o>(</span><span class=n>seckillId</span><span class=o>)))</span> <span class=o>{</span>
			<span class=k>return</span> <span class=k>new</span> <span class=n>SeckillExecution</span><span class=o>(</span><span class=n>seckillId</span><span class=o>,</span> <span class=n>SeckillStatEnum</span><span class=o>.</span><span class=na>DATE_REWRITE</span><span class=o>);</span>
		<span class=o>}</span>
		<span class=n>Date</span> <span class=n>killTime</span> <span class=o>=</span> <span class=k>new</span> <span class=n>Date</span><span class=o>();</span>
		<span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=o>,</span> <span class=n>Object</span><span class=o>&gt;</span> <span class=n>map</span> <span class=o>=</span> <span class=k>new</span> <span class=n>HashMap</span><span class=o>&lt;&gt;();</span>
		<span class=n>map</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=s>&#34;seckillId&#34;</span><span class=o>,</span> <span class=n>seckillId</span><span class=o>);</span>
		<span class=n>map</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=s>&#34;phone&#34;</span><span class=o>,</span> <span class=n>userPhone</span><span class=o>);</span>
		<span class=n>map</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=s>&#34;killTime&#34;</span><span class=o>,</span> <span class=n>killTime</span><span class=o>);</span>
		<span class=n>map</span><span class=o>.</span><span class=na>put</span><span class=o>(</span><span class=s>&#34;result&#34;</span><span class=o>,</span> <span class=kc>null</span><span class=o>);</span>
		<span class=c1>// 执行储存过程,result被复制
</span><span class=c1></span>		<span class=n>seckillDao</span><span class=o>.</span><span class=na>killByProcedure</span><span class=o>(</span><span class=n>map</span><span class=o>);</span>
		<span class=c1>// 获取result
</span><span class=c1></span>		<span class=kt>int</span> <span class=n>result</span> <span class=o>=</span> <span class=n>MapUtils</span><span class=o>.</span><span class=na>getInteger</span><span class=o>(</span><span class=n>map</span><span class=o>,</span> <span class=s>&#34;result&#34;</span><span class=o>,</span> <span class=o>-</span><span class=n>2</span><span class=o>);</span>
		<span class=k>if</span> <span class=o>(</span><span class=n>result</span> <span class=o>==</span> <span class=n>1</span><span class=o>)</span> <span class=o>{</span>
			<span class=n>SuccessKilled</span> <span class=n>successKilled</span> <span class=o>=</span> <span class=n>successKilledDao</span><span class=o>.</span><span class=na>queryByIdWithSeckill</span><span class=o>(</span><span class=n>seckillId</span><span class=o>,</span> <span class=n>userPhone</span><span class=o>);</span>
			<span class=k>return</span> <span class=k>new</span> <span class=n>SeckillExecution</span><span class=o>(</span><span class=n>seckillId</span><span class=o>,</span> <span class=n>SeckillStatEnum</span><span class=o>.</span><span class=na>SUCCESS</span><span class=o>,</span> <span class=n>successKilled</span><span class=o>);</span>
		<span class=o>}</span> <span class=k>else</span> <span class=o>{</span>
			<span class=k>return</span> <span class=k>new</span> <span class=n>SeckillExecution</span><span class=o>(</span><span class=n>seckillId</span><span class=o>,</span> <span class=n>SeckillStatEnum</span><span class=o>.</span><span class=na>stateOf</span><span class=o>(</span><span class=n>result</span><span class=o>));</span>
		<span class=o>}</span>
	<span class=o>}</span>
</code></pre></td></tr></table></div></div><p>接着对该方法进行测试，在原本的<code>SeckillServiceTest</code>测试类里添加测试方法</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java>	<span class=nd>@Test</span>
	<span class=kd>public</span> <span class=kt>void</span> <span class=nf>executeSeckillProcedure</span><span class=o>(){</span>
		<span class=kt>long</span> <span class=n>seckillId</span> <span class=o>=</span> <span class=n>1001</span><span class=o>;</span>
        <span class=kt>long</span> <span class=n>phone</span> <span class=o>=</span> <span class=n>13680115101L</span><span class=o>;</span>
        <span class=n>Exposer</span> <span class=n>exposer</span> <span class=o>=</span> <span class=n>seckillService</span><span class=o>.</span><span class=na>exportSeckillUrl</span><span class=o>(</span><span class=n>seckillId</span><span class=o>);</span>
        <span class=k>if</span> <span class=o>(</span><span class=n>exposer</span><span class=o>.</span><span class=na>isExposed</span><span class=o>())</span> <span class=o>{</span>
            <span class=n>String</span> <span class=n>md5</span> <span class=o>=</span> <span class=n>exposer</span><span class=o>.</span><span class=na>getMd5</span><span class=o>();</span>
            <span class=n>SeckillExecution</span> <span class=n>execution</span> <span class=o>=</span> <span class=n>seckillService</span><span class=o>.</span><span class=na>executeSeckillProcedure</span><span class=o>(</span><span class=n>seckillId</span><span class=o>,</span> <span class=n>phone</span><span class=o>,</span> <span class=n>md5</span><span class=o>);</span>
            <span class=n>logger</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;execution={}&#34;</span><span class=o>,</span> <span class=n>execution</span><span class=o>);</span>
        <span class=o>}</span>
	<span class=o>}</span>
</code></pre></td></tr></table></div></div><p>经过测试，发现没有问题，测试通过。然后我们需要把Controller里的执行秒杀操作改成调用存储过程的方法。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre class=chroma><code class=language-java data-lang=java>	    <span class=nd>@RequestMapping</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=s>&#34;/{seckillId}/{md5}/execution&#34;</span><span class=o>,</span>
	            <span class=n>method</span> <span class=o>=</span> <span class=n>RequestMethod</span><span class=o>.</span><span class=na>POST</span><span class=o>,</span>
	            <span class=n>produces</span> <span class=o>=</span> <span class=o>{</span><span class=s>&#34;application/json;charset=UTF-8&#34;</span><span class=o>})</span>
	    <span class=nd>@ResponseBody</span>
	    <span class=kd>public</span> <span class=n>SeckillResult</span><span class=o>&lt;</span><span class=n>SeckillExecution</span><span class=o>&gt;</span> <span class=nf>execute</span><span class=o>(</span><span class=nd>@PathVariable</span><span class=o>(</span><span class=s>&#34;seckillId&#34;</span><span class=o>)</span> <span class=n>Long</span> <span class=n>seckillId</span><span class=o>,</span>
	                                                   <span class=nd>@PathVariable</span><span class=o>(</span><span class=s>&#34;md5&#34;</span><span class=o>)</span> <span class=n>String</span> <span class=n>md5</span><span class=o>,</span>
	                                                   <span class=nd>@CookieValue</span><span class=o>(</span><span class=n>value</span> <span class=o>=</span> <span class=s>&#34;userPhone&#34;</span><span class=o>,</span><span class=n>required</span> <span class=o>=</span> <span class=kc>false</span><span class=o>)</span> <span class=n>Long</span> <span class=n>userPhone</span><span class=o>)</span>
	    <span class=o>{</span>
	        <span class=k>if</span> <span class=o>(</span><span class=n>userPhone</span><span class=o>==</span><span class=kc>null</span><span class=o>)</span>
	        <span class=o>{</span>
	            <span class=k>return</span> <span class=k>new</span> <span class=n>SeckillResult</span><span class=o>&lt;</span><span class=n>SeckillExecution</span><span class=o>&gt;(</span><span class=kc>false</span><span class=o>,</span><span class=s>&#34;未注册&#34;</span><span class=o>);</span>
	        <span class=o>}</span>
	
	        <span class=k>try</span> <span class=o>{</span>
	        	<span class=c1>//这里改为调用存储过程
</span><span class=c1></span>	<span class=c1>//            SeckillExecution execution = seckillService.executeSeckill(seckillId, userPhone, md5);
</span><span class=c1></span>	            <span class=n>SeckillExecution</span> <span class=n>execution</span> <span class=o>=</span> <span class=n>seckillService</span><span class=o>.</span><span class=na>executeSeckillProcedure</span><span class=o>(</span><span class=n>seckillId</span><span class=o>,</span> <span class=n>userPhone</span><span class=o>,</span> <span class=n>md5</span><span class=o>);</span>
	            <span class=k>return</span> <span class=k>new</span> <span class=n>SeckillResult</span><span class=o>&lt;</span><span class=n>SeckillExecution</span><span class=o>&gt;(</span><span class=kc>true</span><span class=o>,</span> <span class=n>execution</span><span class=o>);</span>
	        <span class=o>}</span><span class=k>catch</span> <span class=o>(</span><span class=n>RepeatKillException</span> <span class=n>e1</span><span class=o>)</span>
	        <span class=o>{</span>
	            <span class=n>SeckillExecution</span> <span class=n>execution</span><span class=o>=</span><span class=k>new</span> <span class=n>SeckillExecution</span><span class=o>(</span><span class=n>seckillId</span><span class=o>,</span> <span class=n>SeckillStatEnum</span><span class=o>.</span><span class=na>REPEAT_KILL</span><span class=o>);</span>
	            <span class=k>return</span> <span class=k>new</span> <span class=n>SeckillResult</span><span class=o>&lt;</span><span class=n>SeckillExecution</span><span class=o>&gt;(</span><span class=kc>true</span><span class=o>,</span><span class=n>execution</span><span class=o>);</span>
	        <span class=o>}</span><span class=k>catch</span> <span class=o>(</span><span class=n>SeckillCloseException</span> <span class=n>e2</span><span class=o>)</span>
	        <span class=o>{</span>
	            <span class=n>SeckillExecution</span> <span class=n>execution</span><span class=o>=</span><span class=k>new</span> <span class=n>SeckillExecution</span><span class=o>(</span><span class=n>seckillId</span><span class=o>,</span> <span class=n>SeckillStatEnum</span><span class=o>.</span><span class=na>END</span><span class=o>);</span>
	            <span class=k>return</span> <span class=k>new</span> <span class=n>SeckillResult</span><span class=o>&lt;</span><span class=n>SeckillExecution</span><span class=o>&gt;(</span><span class=kc>true</span><span class=o>,</span><span class=n>execution</span><span class=o>);</span>
	        <span class=o>}</span>
	        <span class=k>catch</span> <span class=o>(</span><span class=n>Exception</span> <span class=n>e</span><span class=o>)</span>
	        <span class=o>{</span>
	            <span class=n>SeckillExecution</span> <span class=n>execution</span><span class=o>=</span><span class=k>new</span> <span class=n>SeckillExecution</span><span class=o>(</span><span class=n>seckillId</span><span class=o>,</span> <span class=n>SeckillStatEnum</span><span class=o>.</span><span class=na>INNER_ERROR</span><span class=o>);</span>
	            <span class=k>return</span> <span class=k>new</span> <span class=n>SeckillResult</span><span class=o>&lt;</span><span class=n>SeckillExecution</span><span class=o>&gt;(</span><span class=kc>true</span><span class=o>,</span><span class=n>execution</span><span class=o>);</span>
	        <span class=o>}</span>
	    <span class=o>}</span>
</code></pre></td></tr></table></div></div><blockquote><p><strong>存储过程优化总结</strong></p></blockquote><ol><li>存储过程优化:事务行级锁持有的时间</li><li>不要过度依赖存储过程</li><li>简单的逻辑依赖存储过程</li><li>QPS:一个秒杀单6000/qps</li></ol><p>经过简单优化和深度优化之后，本项目大概能达到一个秒杀单6000qps（慕课网视频中张老师说的），这个数据对于一个秒杀商品来说其实已经挺ok了，注意这里是指同一个秒杀商品6000qps，如果是不同商品不存在行级锁竞争的问题。</p><h3 id=33-系统部署架构><strong>3.3 系统部署架构</strong></h3><p><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e7%b3%bb%e7%bb%9f%e5%8f%af%e8%83%bd%e7%94%a8%e5%88%b0%e7%9a%84%e6%9c%8d%e5%8a%a1.jpg title=系统可能用到的服务 data-thumbnail=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/系统可能用到的服务.jpg data-sub-html="<h2> </h2><p>系统可能用到的服务</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e7%b3%bb%e7%bb%9f%e5%8f%af%e8%83%bd%e7%94%a8%e5%88%b0%e7%9a%84%e6%9c%8d%e5%8a%a1.jpg data-srcset="https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e7%b3%bb%e7%bb%9f%e5%8f%af%e8%83%bd%e7%94%a8%e5%88%b0%e7%9a%84%e6%9c%8d%e5%8a%a1.jpg, https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e7%b3%bb%e7%bb%9f%e5%8f%af%e8%83%bd%e7%94%a8%e5%88%b0%e7%9a%84%e6%9c%8d%e5%8a%a1.jpg 1.5x, https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e7%b3%bb%e7%bb%9f%e5%8f%af%e8%83%bd%e7%94%a8%e5%88%b0%e7%9a%84%e6%9c%8d%e5%8a%a1.jpg 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/系统可能用到的服务.jpg></a><figcaption class=image-caption>系统可能用到的服务</figcaption></figure></p><p>CDN：放置一些静态化资源，或者可以将动态数据分离。一些js依赖直接用公网的CDN，自己开发的一些页面也做静态化处理推送到CDN。用户在CDN获取到的数据不需要再访问我们的服务器，动静态分离可以降低服务器请求量。比如秒杀详情页，做成HTML放在cdn上，动态数据可以通过ajax请求后台获取。</p><p>Nginx：作为http服务器，响应客户请求，为后端的servlet容器做反向代理，以达到负载均衡的效果。</p><p>Redis：用来做服务器端的缓存，通过Jedis提供的API来达到热点数据的一个快速存取的过程，减少数据库的请求量。</p><p>MySQL：保证秒杀过程的数据一致性与完整性。</p><p>智能DNS解析+智能CDN加速+Nginx并发+Redis缓存+MySQL分库分表</p><p><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e5%a4%a7%e5%9e%8b%e7%b3%bb%e7%bb%9f%e9%83%a8%e7%bd%b2%e6%9e%b6%e6%9e%84.jpg title=大型系统部署架构 data-thumbnail=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/大型系统部署架构.jpg data-sub-html="<h2> </h2><p>大型系统部署架构</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e5%a4%a7%e5%9e%8b%e7%b3%bb%e7%bb%9f%e9%83%a8%e7%bd%b2%e6%9e%b6%e6%9e%84.jpg data-srcset="https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e5%a4%a7%e5%9e%8b%e7%b3%bb%e7%bb%9f%e9%83%a8%e7%bd%b2%e6%9e%b6%e6%9e%84.jpg, https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e5%a4%a7%e5%9e%8b%e7%b3%bb%e7%bb%9f%e9%83%a8%e7%bd%b2%e6%9e%b6%e6%9e%84.jpg 1.5x, https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e5%a4%a7%e5%9e%8b%e7%b3%bb%e7%bb%9f%e9%83%a8%e7%bd%b2%e6%9e%b6%e6%9e%84.jpg 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/大型系统部署架构.jpg></a><figcaption class=image-caption>大型系统部署架构</figcaption></figure></p><p>大型系统部署架构，逻辑集群就是开发的部分。</p><ol><li>Nginx做负载均衡</li><li>分库分表：在秒杀系统中，一般通过关键的秒杀商品id取模进行分库分表，以512为一张表，1024为一张表。分库分表一般采用开源架构，如阿里巴巴的tddl分库分表框架。</li><li>统计分析：一般使用hadoop等架构进行分析</li></ol><p>在这样一个架构中，可能参与的角色如下：</p><p><figure><a class=lightgallery href=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e9%a1%b9%e7%9b%ae%e8%a7%92%e8%89%b2.jpg title=项目角色 data-thumbnail=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/项目角色.jpg data-sub-html="<h2> </h2><p>项目角色</p>"><img class=lazyload src=/svg/loading.min.svg data-src=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e9%a1%b9%e7%9b%ae%e8%a7%92%e8%89%b2.jpg data-srcset="https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e9%a1%b9%e7%9b%ae%e8%a7%92%e8%89%b2.jpg, https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e9%a1%b9%e7%9b%ae%e8%a7%92%e8%89%b2.jpg 1.5x, https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/%e9%a1%b9%e7%9b%ae%e8%a7%92%e8%89%b2.jpg 2x" data-sizes=auto alt=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/posts/project/seckill/项目角色.jpg></a><figcaption class=image-caption>项目角色</figcaption></figure></p><blockquote><p><strong>本节结语</strong></p></blockquote><p>至此，关于该SSM实战项目——Java高并发秒杀API已经全部完成，感谢观看本文。</p><blockquote><p><strong>项目笔记相关链接</strong></p></blockquote><ul><li><a href=http://blog.csdn.net/lewky_liu/article/details/78159983 target=_blank rel="noopener noreffer"><strong>Java高并发秒杀API(一)之业务分析与DAO层</strong></a></li><li><a href=http://blog.csdn.net/lewky_liu/article/details/78162149 target=_blank rel="noopener noreffer"><strong>Java高并发秒杀API(二)之Service层</strong></a></li><li><a href=http://blog.csdn.net/lewky_liu/article/details/78162153 target=_blank rel="noopener noreffer"><strong>Java高并发秒杀API(三)之Web层</strong></a></li><li><a href=http://blog.csdn.net/lewky_liu/article/details/78166080 target=_blank rel="noopener noreffer"><strong>Java高并发秒杀API(四)之高并发优化</strong></a></li></ul><blockquote><p><strong>项目源码</strong></p></blockquote><ul><li><a href=http://download.csdn.net/download/lewky_liu/10013556 target=_blank rel="noopener noreffer"><strong>源码下载</strong></a></li><li><a href=https://github.com/lewky/Seckill target=_blank rel="noopener noreffer"><strong>GitHub地址</strong></a></li></ul><blockquote><p><strong>项目视频教程链接</strong></p></blockquote><p>这是慕课网上的一个免费项目教学视频，名为Java高并发秒杀API，一共有如下四节课程，附带视频传送门（在视频中老师是用IDEA，本文用的是Eclipse）</p><ul><li><a href=http://www.imooc.com/learn/587 target=_blank rel="noopener noreffer">Java高并发秒杀API之业务分析与DAO层</a></li><li><a href=http://www.imooc.com/learn/631 target=_blank rel="noopener noreffer">Java高并发秒杀API之Service层</a></li><li><a href=http://www.imooc.com/learn/630 target=_blank rel="noopener noreffer">Java高并发秒杀API之Web层</a></li><li><a href=http://www.imooc.com/learn/632 target=_blank rel="noopener noreffer">Java高并发秒杀API之高并发优化</a></li></ul><div class="details admonition warning open"><div class="details-summary admonition-title"><i class="icon fas fa-exclamation-triangle fa-fwwarning"></i>警告<i class="details-icon fas fa-angle-right fa-fw"></i></div><div class=details-content><div class=admonition-content>本文最后更新于 <span class=timeago datetime=2017-10-06T17:07:54 title="October 6, 2017">October 6, 2017</span>，文中内容可能已过时，请谨慎使用。</div></div></div><div class=post-reward><input type=checkbox name=reward id=reward hidden>
<label class=reward-button for=reward>赞赏支持</label><div class=qr-code><label class=qr-code-image for=reward><img class=image src=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/common/wechat.png>
<span>微信打赏</span></label>
<label class=qr-code-image for=reward><img class=image src=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/common/alipay.png>
<span>支付宝打赏</span></label></div></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>更新于 2017-10-06</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/posts/43941.html/index.md target=_blank>阅读原始文档</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=https://lewky.cn/posts/43941.html/ data-title=Java高并发秒杀API(四)之高并发优化 data-hashtags=项目笔记,SSM实战项目,秒杀><i class="fab fa-twitter fa-fw"></i></a><a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://lewky.cn/posts/43941.html/ data-hashtag=项目笔记><i class="fab fa-facebook-square fa-fw"></i></a><a href=javascript:void(0); title="分享到 Hacker News" data-sharer=hackernews data-url=https://lewky.cn/posts/43941.html/ data-title=Java高并发秒杀API(四)之高并发优化><i class="fab fa-hacker-news fa-fw"></i></a><a href=javascript:void(0); title="分享到 Line" data-sharer=line data-url=https://lewky.cn/posts/43941.html/ data-title=Java高并发秒杀API(四)之高并发优化><i data-svg-src=https://cdn.jsdelivr.net/npm/simple-icons@2.14.0/icons/line.svg></i></a><a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://lewky.cn/posts/43941.html/ data-title=Java高并发秒杀API(四)之高并发优化><i class="fab fa-weibo fa-fw"></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw"></i>&nbsp;<a href=/tags/%E9%A1%B9%E7%9B%AE%E7%AC%94%E8%AE%B0/>项目笔记</a>,&nbsp;<a href=/tags/ssm%E5%AE%9E%E6%88%98%E9%A1%B9%E7%9B%AE/>SSM实战项目</a>,&nbsp;<a href=/tags/%E7%A7%92%E6%9D%80/>秒杀</a></section><section><span><a href=javascript:void(0); onclick=window.history.back();>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/33818.html/ class=prev rel=prev title=Java高并发秒杀API(三)之Web层><i class="fas fa-angle-left fa-fw"></i>Java高并发秒杀API(三)之Web层</a>
<a href=/posts/ppk-to-ssh-key.html/ class=next rel=next title=Putty的ppk文件转成Xshell使用的key文件>Putty的ppk文件转成Xshell使用的key文件<i class="fas fa-angle-right fa-fw"></i></a></div></div><div id=comments><div id=waline></div><script src=https://cdn.jsdelivr.net/npm/@waline/client/dist/Waline.min.js></script><script>new Waline({el:'#waline',meta:["nick","mail","link"],placeholder:"提交评论较慢，请等待几秒~",serverURL:"https://comment.lewky.cn/",avatarCDN:"https://sdn.geekzu.org/avatar/",requiredFields:["nick","mail"],pageSize:10,avatar:"retro",lang:"zh-CN",visitor:true,highlight:true,emojiCDN:'https:\/\/cdn.jsdelivr.net\/gh\/lewky\/lewky.github.io@master/images/emoji/',emojiMaps:{"good":"weibo/2018new_good_org.png","no way":"weibo/2018new_kuxiao_org.png","smile":"weibo/2018new_weixioa02_org.png","ok":"weibo/2018new_ok_org.png","laugh and cry":"weibo/2018new_xiaoku_thumb.png","doge":"weibo/2018new_doge02_org.png","whee":"weibo/2018new_xixi_thumb.png","happy":"weibo/2018new_taikaixin_org.png","sweat":"weibo/2018new_han_org.png","cat":"weibo/2018new_miaomiao_thumb.png","dog":"weibo/2018new_erha_org.png","lovely":"weibo/2018new_keai_org.png","QQ-0":"qq/0.gif","QQ-1":"qq/1.gif","QQ-3":"qq/3.gif","QQ-6":"qq/6.gif","QQ-10":"qq/10.gif","QQ-12":"qq/12.gif","QQ-13":"qq/13.gif","QQ-26":"qq/26.gif","QQ-31":"qq/31.gif","QQ-37":"qq/37.gif","QQ-71":"qq/71.gif","QQ-72":"qq/72.gif","QQ-74":"qq/74.gif","QQ-85":"qq/85.gif","QQ-146":"qq/146.gif","QQ-147":"qq/147.gif","QQ-148":"qq/148.gif","QQ-149":"qq/149.gif","QQ-150":"qq/150.gif","QQ-151":"qq/151.gif","QQ-152":"qq/152.gif","QQ-153":"qq/153.gif","QQ-154":"qq/154.gif","QQ-155":"qq/155.gif","QQ-172":"qq/172.gif","QQ-207":"qq/207.gif","QQ-jin_li":"qq/jin_li.gif","QQ-zheng_yan":"qq/zheng_yan.gif","aru-1":"aru/1.png","aru-22":"aru/22.png","aru-45":"aru/45.png","aru-47":"aru/47.png","aru-52":"aru/52.png","aru-53":"aru/53.png","aru-54":"aru/54.png","aru-55":"aru/55.png","aru-56":"aru/56.png","aru-57":"aru/57.png","aru-58":"aru/58.png","aru-61":"aru/61.png","aru-100":"aru/100.png","aru-101":"aru/101.png","aru-103":"aru/103.png","aru-104":"aru/104.png","aru-107":"aru/107.png","aru-108":"aru/108.png","aru-110":"aru/110.png","aru-112":"aru/112.png","aru-122":"aru/122.png","aru-123":"aru/123.png","aru-134":"aru/134.png","aru-135":"aru/135.png","aru-144":"aru/144.png","aru-150":"aru/150.png","aru-151":"aru/151.png","aru-152":"aru/152.png","aru-153":"aru/153.png","aru-155":"aru/155.png","aru-156":"aru/156.png","aru-160":"aru/160.png","aru-162":"aru/162.png","aru-164":"aru/164.png","aru-166":"aru/166.png","aru-167":"aru/167.png","aru-168":"aru/168.png","aru-170":"aru/170.png","aru-171":"aru/171.png","aru-172":"aru/172.png","aru-173":"aru/173.png","aru-174":"aru/174.png","aru-175":"aru/175.png","aru-176":"aru/176.png","aru-178":"aru/178.png","aru-213":"aru/213.png","aru-240":"aru/240.png","aru-241":"aru/241.png","aru-249":"aru/249.png","aru-257":"aru/257.png","aru-258":"aru/258.png","aru-259":"aru/259.png","aru-265":"aru/265.png","aru-266":"aru/266.png","aru-267":"aru/267.png","aru-285":"aru/285.png","aru-286":"aru/286.png","aru-287":"aru/287.png","aru-288":"aru/288.png","aru-295":"aru/295.png","aru-296":"aru/296.png","aru-297":"aru/297.png","aru-298":"aru/298.png","aru-299":"aru/299.png","aru-300":"aru/300.png","aru-301":"aru/301.png","aru-302":"aru/302.png","aru-303":"aru/303.png","aru-304":"aru/304.png","aru-305":"aru/305.png","aru-306":"aru/306.png","bilibili_2233-卖萌":"bilibili_2233/卖萌.png","bilibili_2233-吃惊":"bilibili_2233/吃惊.png","bilibili_2233-吐魂":"bilibili_2233/吐魂.png","bilibili_2233-喝水":"bilibili_2233/喝水.png","bilibili_2233-困惑":"bilibili_2233/困惑.png","bilibili_2233-大哭":"bilibili_2233/大哭.png","bilibili_2233-大笑":"bilibili_2233/大笑.png","bilibili_2233-委屈":"bilibili_2233/委屈.png","bilibili_2233-怒":"bilibili_2233/怒.png","bilibili_2233-无言":"bilibili_2233/无言.png","bilibili_2233-汗":"bilibili_2233/汗.png","bilibili_2233-疑问":"bilibili_2233/疑问.png","bilibili_2233-第一":"bilibili_2233/第一.png","bilibili_2233-耶":"bilibili_2233/耶.png","bilibili_2233-郁闷":"bilibili_2233/郁闷.png","bilibili_tv_gif-doge":"bilibili_tv_gif/doge.gif","bilibili_tv_gif-亲亲":"bilibili_tv_gif/亲亲.gif","bilibili_tv_gif-偷笑":"bilibili_tv_gif/偷笑.gif","bilibili_tv_gif-再见":"bilibili_tv_gif/再见.gif","bilibili_tv_gif-发怒":"bilibili_tv_gif/发怒.gif","bilibili_tv_gif-发财":"bilibili_tv_gif/发财.gif","bilibili_tv_gif-可爱":"bilibili_tv_gif/可爱.gif","bilibili_tv_gif-吐血":"bilibili_tv_gif/吐血.gif","bilibili_tv_gif-呆":"bilibili_tv_gif/呆.gif","bilibili_tv_gif-呕吐":"bilibili_tv_gif/呕吐.gif","bilibili_tv_gif-困":"bilibili_tv_gif/困.gif","bilibili_tv_gif-坏笑":"bilibili_tv_gif/坏笑.gif","bilibili_tv_gif-大佬":"bilibili_tv_gif/大佬.gif","bilibili_tv_gif-大哭":"bilibili_tv_gif/大哭.gif","bilibili_tv_gif-委屈":"bilibili_tv_gif/委屈.gif","bilibili_tv_gif-害羞":"bilibili_tv_gif/害羞.gif","bilibili_tv_gif-尴尬":"bilibili_tv_gif/尴尬.gif","bilibili_tv_gif-微笑":"bilibili_tv_gif/微笑.gif","bilibili_tv_gif-思考":"bilibili_tv_gif/思考.gif","bilibili_tv_gif-惊吓":"bilibili_tv_gif/惊吓.gif","bilibili_tv_gif-打脸":"bilibili_tv_gif/打脸.gif","bilibili_tv_gif-抓狂":"bilibili_tv_gif/抓狂.gif","bilibili_tv_gif-抠鼻子":"bilibili_tv_gif/抠鼻子.gif","bilibili_tv_gif-斜眼笑":"bilibili_tv_gif/斜眼笑.gif","bilibili_tv_gif-无奈":"bilibili_tv_gif/无奈.gif","bilibili_tv_gif-晕":"bilibili_tv_gif/晕.gif","bilibili_tv_gif-流汗":"bilibili_tv_gif/流汗.gif","bilibili_tv_gif-流鼻血":"bilibili_tv_gif/流鼻血.gif","bilibili_tv_gif-点赞":"bilibili_tv_gif/点赞.gif","bilibili_tv_gif-生气":"bilibili_tv_gif/生气.gif","bilibili_tv_gif-生病":"bilibili_tv_gif/生病.gif","bilibili_tv_gif-疑问":"bilibili_tv_gif/疑问.gif","bilibili_tv_gif-白眼":"bilibili_tv_gif/白眼.gif","bilibili_tv_gif-睡着":"bilibili_tv_gif/睡着.gif","bilibili_tv_gif-笑哭":"bilibili_tv_gif/笑哭.gif","bilibili_tv_gif-腼腆":"bilibili_tv_gif/腼腆.gif","bilibili_tv_gif-色":"bilibili_tv_gif/色.gif","bilibili_tv_gif-调皮":"bilibili_tv_gif/调皮.gif","bilibili_tv_gif-鄙视":"bilibili_tv_gif/鄙视.gif","bilibili_tv_gif-闭嘴":"bilibili_tv_gif/闭嘴.gif","bilibili_tv_gif-难过":"bilibili_tv_gif/难过.gif","bilibili_tv_gif-馋":"bilibili_tv_gif/馋.gif","bilibili_tv_gif-黑人问号":"bilibili_tv_gif/黑人问号.gif","bilibili_tv_gif-鼓掌":"bilibili_tv_gif/鼓掌.gif","滑稽-001":"滑稽/001.jpg","滑稽-002":"滑稽/002.jpg","滑稽-003":"滑稽/003.jpg","滑稽-004":"滑稽/004.jpg","滑稽-005":"滑稽/005.jpg","滑稽-006":"滑稽/006.jpg","滑稽-007":"滑稽/007.jpg","滑稽-008":"滑稽/008.jpg","滑稽-009":"滑稽/009.jpg","滑稽-010":"滑稽/010.jpg","滑稽-011":"滑稽/011.jpg","滑稽-012":"滑稽/012.jpg","滑稽-013":"滑稽/013.jpg","滑稽-014":"滑稽/014.jpg","滑稽-015":"滑稽/015.jpg","滑稽-016":"滑稽/016.jpg","滑稽-017":"滑稽/017.jpg","滑稽-018":"滑稽/018.jpg","滑稽-019":"滑稽/019.jpg","滑稽-020":"滑稽/020.jpg","滑稽-021":"滑稽/021.jpg","滑稽-022":"滑稽/022.jpg","滑稽-023":"滑稽/023.jpg","滑稽-024":"滑稽/024.jpg","滑稽-025":"滑稽/025.jpg","滑稽-026":"滑稽/026.jpg","滑稽-027":"滑稽/027.jpg","滑稽-028":"滑稽/028.jpg","滑稽-029":"滑稽/029.jpg","滑稽-030":"滑稽/030.jpg","滑稽-031":"滑稽/031.jpg","滑稽-032":"滑稽/032.jpg","滑稽-033":"滑稽/033.jpg","滑稽-034":"滑稽/034.jpg","滑稽-035":"滑稽/035.jpg","滑稽-036":"滑稽/036.jpg","滑稽-037":"滑稽/037.jpg","滑稽-038":"滑稽/038.jpg","滑稽-039":"滑稽/039.jpg","滑稽-040":"滑稽/040.jpg","滑稽-041":"滑稽/041.jpg","滑稽-042":"滑稽/042.jpg","滑稽-043":"滑稽/043.jpg","滑稽-044":"滑稽/044.jpg","滑稽-045":"滑稽/045.jpg","滑稽-046":"滑稽/046.jpg","滑稽-047":"滑稽/047.jpg","default-01":"default/01.webp","default-010":"default/010.webp","default-011":"default/011.webp","default-012":"default/012.webp","default-013":"default/013.webp","default-014":"default/014.webp","default-016":"default/016.webp","default-017":"default/017.webp","default-018":"default/018.jpg","default-019":"default/019.webp","default-02":"default/02.webp","default-020":"default/020.webp","default-021":"default/021.webp","default-022":"default/022.webp","default-023":"default/023.webp","default-024":"default/024.webp","default-025":"default/025.jpg","default-026":"default/026.webp","default-027":"default/027.webp","default-028":"default/028.webp","default-029":"default/029.webp","default-03":"default/03.jpg","default-030":"default/030.gif","default-031":"default/031.webp","default-04":"default/04.jpg","default-05":"default/05.gif","default-06":"default/06.gif","default-07":"default/07.webp","default-08":"default/08.webp","default-09":"default/09.webp"}});</script></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line><span id=run-time></span></div><div class=footer-line><i class="far fa-copyright fa-fw"></i><span itemprop=copyrightYear>2018 - 2021</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/ target=_blank>雨临Lewis</a></span>&nbsp;|&nbsp;<span class=license><a rel="license external nofollow noopener noreffer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span><span class=icp-splitter>&nbsp;|&nbsp;</span><br class=icp-br><span class=icp><a target=_blank href=http://www.beian.miit.gov.cn/ style=font-weight:700>粤ICP备19103822</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title=回到顶部><i class="fas fa-arrow-up fa-fw"></i></a><a href=# id=view-comments class=fixed-button title=查看评论><i class="fas fa-comment fa-fw"></i></a></div><div class=sidebar_wo><div id=leimu><img src=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/b2t/leimuA.png alt=雷姆 onmouseover="this.src='https:\/\/cdn.jsdelivr.net\/gh\/lewky\/lewky.github.io@master/images/b2t/leimuB.png'" onmouseout="this.src='https:\/\/cdn.jsdelivr.net\/gh\/lewky\/lewky.github.io@master/images/b2t/leimuA.png'" title=回到顶部></div><div class=sidebar_wo id=lamu><img src=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/b2t/lamuA.png alt=雷姆 onmouseover="this.src='https:\/\/cdn.jsdelivr.net\/gh\/lewky\/lewky.github.io@master/images/b2t/lamuB.png'" onmouseout="this.src='https:\/\/cdn.jsdelivr.net\/gh\/lewky\/lewky.github.io@master/images/b2t/lamuA.png'" title=回到底部></div></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/css/lightgallery.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/smooth-scroll@16.1.3/dist/smooth-scroll.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.2.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lightgallery.js@1.2.0/dist/js/lightgallery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lg-thumbnail.js@1.2.0/dist/lg-thumbnail.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lg-zoom.js@1.2.0/dist/lg-zoom.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.4.0/sharer.min.js></script><script type=text/javascript>window.config={"code":{"copyTitle":"复制到剪贴板","maxShownLines":15},"comment":{},"lightGallery":{"actualSize":false,"exThumbImage":"data-thumbnail","hideBarsDelay":2000,"selector":".lightgallery","speed":400,"thumbContHeight":80,"thumbWidth":80,"thumbnail":true}};</script><script type=text/javascript src=/js/theme.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/jquery@2.1.3/dist/jquery.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/jquery-backstretch@2.1.18/jquery.backstretch.min.js></script><script>$(function(){$(".site-avatar-plug-bilibili").attr("src","https:\/\/cdn.jsdelivr.net\/gh\/lewky\/lewky.github.io@master/images/avatar-plug/bilibili_"+(~~(128*Math.random())+1)+".png");});var avatar_plug=0;var avatar_click=1;jQuery(document).ready(function($){var frequency=1;var plug_count=128;$("div.home-avatar a").click(function(e){if(avatar_click%frequency===0){avatar_plug++;$(".site-avatar-plug-bilibili").attr("src","https:\/\/cdn.jsdelivr.net\/gh\/lewky\/lewky.github.io@master/images/avatar-plug/bilibili_"+avatar_plug+".png");}
if(avatar_plug===plug_count){avatar_plug=0;}
$("div.home-avatar a").attr("alt","再点击"+(frequency-avatar_click%frequency)+"次头像试试看~~");avatar_click++;});});</script><script>var $cdnPrefix="https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master";</script><script type=text/javascript src=/js/custom.js></script><script>var _hmt=_hmt||[];(function(){var hm=document.createElement("script");hm.src="https://hm.baidu.com/hm.js?6f278ed0fdb01edb3b1e7398379e5432";var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(hm,s);})();</script><div class="GalMenu GalDropDown"><div class=circle id=gal><div class=ring><a href=/ target=_blank style=background-image:url(https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/rightmenu/rightmenu1.jpg) class=menuItem>首页</a><a href=/funny/mikutap/ target=_blank style=background-image:url(https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/rightmenu/rightmenu2.jpg) class=menuItem>音乐游戏</a><a href=/funny/high/ target=_blank style=background-image:url(https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/rightmenu/rightmenu3.jpg) class=menuItem>前方高能</a><a href=/posts/e62c38c4.html target=_blank style=background-image:url(https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/rightmenu/rightmenu4.jpg) class=menuItem>建站日志</a><a href=/posts/d65a1577.html target=_blank style=background-image:url(https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/rightmenu/rightmenu5.jpg) class=menuItem>随笔</a><a href=/friends/ target=_blank style=background-image:url(https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/images/rightmenu/rightmenu6.jpg) class=menuItem>友链</a></div><audio id=audio src=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/audio/niconiconi.mp3></audio></div></div><script type=text/javascript>var items=document.querySelectorAll('.menuItem');for(var i=0,l=items.length;i<l;i++){items[i].style.left=(50-35*Math.cos(-0.5*Math.PI-2*(1/l)*i*Math.PI)).toFixed(4)+"%";items[i].style.top=(50+35*Math.sin(-0.5*Math.PI-2*(1/l)*i*Math.PI)).toFixed(4)+"%"}</script><link rel=stylesheet href=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/css/GalMenu.css><script type=text/javascript src=https://cdn.jsdelivr.net/gh/lewky/lewky.github.io@master/js/GalMenu.js></script><script type=text/javascript>$(document).ready(function(){$('body').GalMenu({'menu':'GalDropDown'})});</script></body></html>